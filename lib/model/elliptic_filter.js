import LowpassFilter from"./lowpass.js";const t2=(t,r)=>{let e=0;for(let s=0;s<1e3;s++){const i=r**(s*(s+1))*Math.cos(t*(2*s+1));if(e+=i,Math.abs(i/e)<1e-15)break}return 2*e*r**(1/4)},t3=(t,r)=>{let e=0;for(let s=1;s<1e3;s++){const i=r**(s**2)*Math.cos(2*s*t);if(e+=i,Math.abs(i/e)<1e-15)break}return 1+2*e};export default class EllipticFilter extends LowpassFilter{constructor(t=1,r=2,e=1,s=.5){super(s),this._n=r,this._xi=e,this._e=t}_K(t){if(1===t)return 1/0;let r=Math.PI/2,e=t;for(;e>1e-15;)e=(1-Math.sqrt(1-e**2))/(1+Math.sqrt(1-e**2)),r*=1+e;return r}_nome(t){return Math.exp(-Math.PI*this._K(Math.sqrt(1-t**2))/this._K(t))}_Ln(t,r){if(1===t)return r;if(2===t)return(r+Math.sqrt(r**2-1))**2;if(3===t){const t=r**2,e=Math.sqrt(4*t+(4*t*(t-1))**(2/3)),s=2*t*Math.sqrt(e)/(Math.sqrt(8*t*(t+1)+12*e*t-e**3)-e**1.5);return r**3*((1-s)/(r**2-s))**2}if(Number.isInteger(t/2))return this._Ln(2,this._Ln(t/2,r));if(Number.isInteger(t/3))return this._Ln(3,this._Ln(t/3,r));const e=this._nome(1/r)**t;let s=1,i=0;for(;s-i>1e-14;){const t=(s+i)/2,r=this._nome(t);if(e===r)return 1/t;e<r?s=t:i=t}return 1/s}_cd(t,r){const e=this._nome(r),s=Math.PI*t/(2*this._K(r));return t3(0,e)/t2(0,e)*t2(s,e)/t3(s,e)}_elliptic(t,r,e){if(1===t)return e;if(1===e)return 1;const s=r**2;if(2===t){const t=Math.sqrt(1-1/s);return((t+1)*e**2-1)/((t-1)*e**2+1)}if(3===t){const t=Math.sqrt(4*s+(4*s*(s-1))**(2/3)),r=2*s*Math.sqrt(t)/(Math.sqrt(8*s*(s+1)+12*t*s-t**3)-t**1.5),i=s/r;return e*(1-r)*(e**2-i)/(1-i)/(e**2-r)}if(Number.isInteger(t/2))return this._elliptic(2,this._elliptic(t/2,r,r),this._elliptic(t/2,r,e));if(Number.isInteger(t/3))return this._elliptic(3,this._elliptic(t/3,r,r),this._elliptic(t/3,r,e));const i=this._K(1/r),n=[];for(let e=1;e<=t;e++)n.push(this._cd(i*(2*e-1)/t,1/r));const h=t%2==0?t:t-1;let l=1;for(let t=0;t<h;t++)l*=(1-n[t])/(1-r/n[t]);let o=(t%2==0?1:e)/l;for(let t=0;t<h;t++)o*=(e-n[t])/(e-r/n[t]);return o}_cutoff(t,r,e,s){const i=Math.sqrt(1+(this._e*this._elliptic(this._n,this._xi,t/r))**2);return[e/i,s/i]}}