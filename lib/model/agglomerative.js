class AgglomerativeClustering{constructor(e="euclid"){switch(this._root=null,this._metric=e,this._metric){case"euclid":this._d=(e,t)=>Math.sqrt(e.reduce(((e,s,i)=>e+(s-t[i])**2),0));break;case"manhattan":this._d=(e,t)=>e.reduce(((e,s,i)=>e+Math.abs(s-t[i])),0);break;case"chebyshev":this._d=(e,t)=>e.reduce(((e,s,i)=>Math.max(e,Math.abs(s-t[i]))),-1/0)}}fit(e){const t=[];e.forEach(((s,i)=>{t.push({point:s,index:i,distances:e.map((e=>this._d(s,e))),size:1})}));const s=[];for(let e=0;e<t.length;e++){s[e]||(s[e]=[]);for(let i=0;i<e;i++)s[e][i]||(s[e][i]=s[i][e]=this.distance(t[e],t[i]))}for(;t.length>1;){let e=t.length,i=0,l=1,r=s[0][1];for(let t=1;t<e;t++)s[t].forEach(((e,s)=>{e<r&&(i=t,l=s,r=e)}));let a=t[i].size,n=t[l].size;s.forEach(((e,r)=>{r!=l&&r!=i&&(e[i]=this.update(a,n,t[r].size,e[i],e[l],s[l][i]),s[i][r]=e[i],e.splice(l,1))})),s[i].splice(l,1),s.splice(l,1),t[i]={distance:r,size:t[i].size+t[l].size,children:[t[i],t[l]]},t.splice(l,1)}this._root=t[0]}getClusters(e){const t=[this._root];for(;t.length<e;){let e=0,s=-1;for(let i=0;i<t.length;i++){const l=t[i];l.children&&l.distance>e&&(s=i,e=l.distance)}if(-1===s)break;const i=t[s];t.splice(s,1,i.children[0],i.children[1])}return t}predict(e){const t=[],s=this.getClusters(e);for(let e=0;e<s.length;e++){const i=this._leafs(s[e]);for(let s=0;s<i.length;s++)t[i[s].index]=e}return t}distance(e,t){throw new Error("Not Implemented")}_leafs(e){let t=[e];for(;t.some((e=>e.children));){const e=[];for(let s=0;s<t.length;s++)t[s].children?e.push(...t[s].children):e.push(t[s]);t=e}return t}_mean(e){const t=Array(e[0].length).fill(0);for(let s=0;s<e.length;s++)for(let i=0;i<e[s].length;i++)t[i]+=e[s][i];return t.map((t=>t/e.length))}_lanceWilliamsUpdater(e,t,s,i){return(l,r,a)=>e*l+t*r+s*a+i*Math.abs(l-r)}update(e,t,s,i,l,r){throw new Error("Not Implemented")}}export class CompleteLinkageAgglomerativeClustering extends AgglomerativeClustering{distance(e,t){let s=this._leafs(e),i=this._leafs(t);return Math.max.apply(null,s.map((e=>Math.max.apply(null,i.map((t=>e.distances[t.index]))))))}update(e,t,s,i,l,r){return this._lanceWilliamsUpdater(.5,.5,0,.5)(i,l,r)}}export class SingleLinkageAgglomerativeClustering extends AgglomerativeClustering{distance(e,t){let s=this._leafs(e),i=this._leafs(t);return Math.min.apply(null,s.map((e=>Math.min.apply(null,i.map((t=>e.distances[t.index]))))))}update(e,t,s,i,l,r){return this._lanceWilliamsUpdater(.5,.5,0,-.5)(i,l,r)}}export class GroupAverageAgglomerativeClustering extends AgglomerativeClustering{distance(e,t){let s=this._leafs(e),i=this._leafs(t);return s.reduce(((e,t)=>e+i.reduce(((e,s)=>e+t.distances[s.index]),0)),0)/(s.length*i.length)}update(e,t,s,i,l,r){return this._lanceWilliamsUpdater(e/(e+t),t/(e+t),0,0)(i,l,r)}}export class WardsAgglomerativeClustering extends AgglomerativeClustering{distance(e,t){let s=this._leafs(e).map((e=>e.point)),i=this._leafs(t).map((e=>e.point)),l=s.concat(i),r=this._mean(s),a=this._mean(i),n=this._mean(l),h=s.reduce(((e,t)=>e+this._d(t,r)**2),0),c=i.reduce(((e,t)=>e+this._d(t,a)**2),0);return l.reduce(((e,t)=>e+this._d(t,n)**2),0)-h-c}update(e,t,s,i,l,r){return this._lanceWilliamsUpdater((s+e)/(s+e+t),(s+t)/(s+e+t),-s/(s+e+t),0)(i,l,r)}}export class CentroidAgglomerativeClustering extends AgglomerativeClustering{distance(e,t){let s=this._leafs(e).map((e=>e.point)),i=this._leafs(t).map((e=>e.point)),l=this._d(this._mean(s),this._mean(i));return l*l}update(e,t,s,i,l,r){return this._lanceWilliamsUpdater(e/(e+t),t/(e+t),-e*t/((e+t)*(e+t)),0)(i,l,r)}}export class WeightedAverageAgglomerativeClustering extends AgglomerativeClustering{distance(e,t){return function e(t,s){return 1===t.size&&1===s.size?t.distances[s.index]:1===s.size?(e(s,t.children[0])+e(s,t.children[1]))/2:(e(t,s.children[0])+e(t,s.children[1]))/2}(e,t)}update(e,t,s,i,l,r){return this._lanceWilliamsUpdater(.5,.5,0,0)(i,l,r)}}export class MedianAgglomerativeClustering extends AgglomerativeClustering{distance(e,t){let s=this._mean(this._leafs(e).map((e=>e.point))),i=this._mean(this._leafs(t).map((e=>e.point))),l=s.map(((e,t)=>(e+i[t])/2));return this._d(l,i)**2}update(e,t,s,i,l,r){return this._lanceWilliamsUpdater(.5,.5,-.25,0)(i,l,r)}}