import Matrix from"../util/matrix.js";import{KMeans}from"./kmeans.js";const argmin=function(t,e){return 0===t.length?-1:(t=e?t.map(e):t).indexOf(Math.min(...t))},cvTable=[[.514,.578,.683,.779,.926],[.528,.591,.704,.815,.969],[.546,.616,.735,.861,1.021],[.559,.631,.754,.884,1.047],[.576,.656,.787,.918,1.092]],AndersonDarling=(t,e)=>{t.sort(((t,e)=>t-e));const r=t.length,s=t.reduce(((t,e)=>t+e),0)/r,n=t.reduce(((t,e)=>t+(e-s)**2),0)/(r-1),i=Math.sqrt(n),o=t.map((t=>(t-s)/i)).map((t=>1/(1+Math.exp(-1.7*t))));let c=0;for(let t=0;t<r;t++)c+=(2*(t+1)-1)*(Math.log(o[t])+Math.log(1-o[r-t-1]));return(-r-c/r)*(1+4/r-25/r**2)<=cvTable[r<=10?0:r<=20?1:r<=50?2:r<=100?3:4][15===e?0:10===e?1:5===e?2:2.5===e?3:1===e?4:-1]};export default class GMeans{constructor(){this._centroids=[],this._init_k=2}get centroids(){return this._centroids}get size(){return this._centroids.length}_distance(t,e){return Math.sqrt(t.reduce(((t,r,s)=>t+(r-e[s])**2),0))}clear(){this._centroids=[]}fit(t,e=-1){let r=null;0===this._centroids.length?(r=this._split_cluster(t,this._init_k),e--):r=this._create_clusters(this,t);const s=[];for(;r.length>0&&(e<0||e-- >0);){const t=[];for(;r.length>0;){const e=r.shift();if(e.size<=3){s.push(e.centroid);continue}const n=Matrix.fromArray(e.data),[i,o]=n.cov().eigenPowerIteration();o.mult(Math.sqrt(2*i/Math.PI));const c=o.copyMult(2),a=n.dot(c);a.div(c.norm());if(AndersonDarling(a.value,5))s.push(e.centroid);else{const[r,s]=this._split_cluster(e.data);t.push(r,s)}}r=t}r.length>0&&s.push(...r.map((t=>t.centroid))),this._centroids=s}_split_cluster(t,e=2){const r=new KMeans;for(let s=0;s<e;s++)r.add(t);for(;r.fit(t)>0;);return this._create_clusters(r,t)}_create_clusters(t,e){const r=t.size,s=t.predict(e),n=[];for(let t=0;t<r;n[t++]=[]);e.forEach(((t,e)=>n[s[e]].push(t)));const i=[];for(let e=0;e<r;e++)i[e]={size:n[e].length,data:n[e],centroid:t.centroids[e]};return i}predict(t){if(0!==this._centroids.length)return t.map((t=>{return e=this._centroids,r=e=>this._distance(t,e),0===e.length?-1:(e=r?e.map(r):e).indexOf(Math.min(...e));var e,r}))}}