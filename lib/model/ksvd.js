var u=Object.defineProperty;var f=(m,o)=>u(m,"name",{value:o,configurable:!0});import e from"../util/matrix.js";export default class p{static{f(this,"KSVD")}constructor(o,n,t=n){this._y=e.fromArray(o),this._m=n,this._k=t,this._d=e.randn(this._y.cols,n),this._d.div(e.map(e.map(this._d,s=>s**2).mean(0),Math.sqrt))}fit(){const o=new e(this._y.rows,this._m);for(let t=0;t<this._y.rows;t++){const s=this._omp(this._y.row(t).t);o.set(t,0,s.t)}for(let t=0;t<this._m;t++){const s=o.col(t).value.map(r=>r!==0),_=this._y.row(s);_.sub(o.row(s).dot(this._d.t));const[c,l,h]=_.svd();this._d.set(0,t,h.row(0).t);for(let r=0,i=0;r<s.length;r++)s[r]&&(o.set(r,t,c.at(i,0)*l[0]),i++)}return this._r=o,e.sub(this._y,this._r.dot(this._d.t)).norm()**2}_omp(o){let n=e.zeros(this._m,1),t=o;const s=[];for(let _=0;_<this._k;_++){let c=1/0,l=-1;for(let i=0;i<this._m;i++){if(s.includes(i))continue;const a=this._d.col(i),d=t.norm()**2-a.tDot(t).toScaler()**2/(a.norm()**2+1e-12);d<c&&(c=d,l=i)}s.push(l);const h=this._d.col(s),r=h.tDot(h).solve(h.tDot(o));for(let i=0;i<s.length;i++)n.set(s[i],0,r.row(i));if(t=e.sub(o,h.dot(r)),t.norm()<1e-8)break}return n}predict(){return this._r.toArray()}}
