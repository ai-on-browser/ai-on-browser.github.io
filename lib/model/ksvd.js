var u=Object.defineProperty;var f=(m,t)=>u(m,"name",{value:t,configurable:!0});import e from"../util/matrix.js";export default class p{static{f(this,"KSVD")}constructor(t,n=t){this._m=t,this._k=n}init(t){this._y=e.fromArray(t),this._d=e.randn(this._y.cols,this._m),this._d.div(e.map(e.map(this._d,n=>n**2).mean(0),Math.sqrt))}fit(){const t=new e(this._y.rows,this._m);for(let s=0;s<this._y.rows;s++){const i=this._omp(this._y.row(s).t);t.set(s,0,i.t)}for(let s=0;s<this._m;s++){const i=t.col(s).value.map(r=>r!==0),_=this._y.row(i);_.sub(t.row(i).dot(this._d.t));const[c,l,h]=_.svd();this._d.set(0,s,h.row(0).t);for(let r=0,o=0;r<i.length;r++)i[r]&&(t.set(r,s,c.at(o,0)*l[0]),o++)}return this._r=t,e.sub(this._y,this._r.dot(this._d.t)).norm()**2}_omp(t){const n=e.zeros(this._m,1);let s=t;const i=[];for(let _=0;_<this._k;_++){let c=1/0,l=-1;for(let o=0;o<this._m;o++){if(i.includes(o))continue;const a=this._d.col(o),d=s.norm()**2-a.tDot(s).toScaler()**2/(a.norm()**2+1e-12);d<c&&(c=d,l=o)}i.push(l);const h=this._d.col(i),r=h.tDot(h).solve(h.tDot(t));for(let o=0;o<i.length;o++)n.set(i[o],0,r.row(o));if(s=e.sub(t,h.dot(r)),s.norm()<1e-8)break}return n}predict(){return this._r.toArray()}}
