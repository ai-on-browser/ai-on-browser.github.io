var p=Object.defineProperty;var l=(o,s)=>p(o,"name",{value:s,configurable:!0});import c,{NeuralnetworkLayerException as v}from"./base.js";import w from"../../../util/tensor.js";import h from"../../../util/matrix.js";export default class f extends c{static{l(this,"GRULayer")}constructor({size:s,return_sequences:t=!1,w_z:_=null,w_r:r=null,w_h:e=null,u_z:i=null,u_r:d=null,u_h:u=null,b_z:a=null,b_r:z=null,b_h:b=null,sequence_dim:m=1,...g}){if(super(g),this._size=s,this._unit=new y({layer:this,size:s,w_z:_,w_r:r,w_h:e,u_z:i,u_r:d,u_h:u,b_z:a,b_r:z,b_h:b}),this._return_sequences=t,this._sequence_dim=m,this._sequence_dim!==0&&this._sequence_dim!==1)throw new v("Invalid sequence dimension.")}get dependentLayers(){return this._unit.dependentLayers}calc(s){this._sequence_dim===1&&(s=s.transpose(1,0,2)),this._x=[];for(let _=0;_<s.sizes[0];_++)this._x[_]=s.index(_).toMatrix();const t=[];for(let _=0;_<this._x.length;_++)t[_]=this._unit.calc(this._x[_],_);if(this._return_sequences){const _=w.fromArray(t.map(r=>r.toArray()));return this._sequence_dim===1?_.transpose(1,0,2):_}return t[t.length-1]}grad(s){return this._grad_bptt(s)}_grad_bptt(s){const t=this._x.length;if(this._bo=Array(t),this._return_sequences){this._sequence_dim===1&&(s=s.transpose(1,0,2));for(let i=0;i<t;i++)this._bo[i]=s.index(i).toMatrix()}else this._bo[t-1]=s;const _=[];let r=null;for(let i=t-1;i>=0;i--){const d=this._unit.grad(this._bo[i],i);i===0&&Array.isArray(d)?(_[i]=d[0],r=d[1]):_[i]=d}let e=w.fromArray(_.map(i=>i.toArray()));return this._sequence_dim===1&&(e=e.transpose(1,0,2)),r?[e,r]:e}update(s){this._unit.update(s)}toObject(){return{type:"gru",size:this._size,return_sequences:this._return_sequences,sequence_dim:this._sequence_dim,...this._unit.toObject()}}}class y extends c{static{l(this,"GRUUnitLayer")}constructor({layer:s,size:t,w_z:_=null,w_r:r=null,w_h:e=null,u_z:i=null,u_r:d=null,u_h:u=null,b_z:a=null,b_r:z=null,b_h:b=null,...m}){super(m),this._size=t,this._w_z=new n(s,_),this._w_r=new n(s,r),this._w_h=new n(s,e),this._u_z=new n(s,i,[this._size,this._size]),this._u_r=new n(s,d,[this._size,this._size]),this._u_h=new n(s,u,[this._size,this._size]),this._b_z=new n(s,a,[1,this._size]),this._b_r=new n(s,z,[1,this._size]),this._b_h=new n(s,b,[1,this._size]),this._s0=h.zeros(1,this._size),this._x=[],this._h=[],this._s=[],this._z=[],this._r=[],this._bo=[],this._dy=[],this._dr=[],this._dz=[],this._dh=[]}get dependentLayers(){const s=[];return this._w_z.name&&s.push(this._w_z.name),this._w_r.name&&s.push(this._w_r.name),this._w_h.name&&s.push(this._w_h.name),this._u_z.name&&s.push(this._u_z.name),this._u_r.name&&s.push(this._u_r.name),this._u_h.name&&s.push(this._u_h.name),this._b_z.name&&s.push(this._b_z.name),this._b_r.name&&s.push(this._b_r.name),this._b_h.name&&s.push(this._b_h.name),s}_sigmoid(s){return h.map(s,t=>1/(1+Math.exp(-t)))}_grad_sigmoid(s){return h.map(s,t=>t*(1-t))}_tanh(s){return h.map(s,Math.tanh)}_grad_tanh(s){return h.map(s,t=>1-t**2)}calc(s,t){t===0&&(this._s=[]),this._x[t]=s;const _=t===0?this._s0:this._s[t-1],r=this._x[t].dot(this._w_z.get(s.cols,this._size));r.add(_.dot(this._u_z.get())),r.add(this._b_z.get());const e=this._sigmoid(r);this._z[t]=e;const i=this._x[t].dot(this._w_r.get(s.cols,this._size));i.add(_.dot(this._u_r.get())),i.add(this._b_r.get());const d=this._sigmoid(i);this._r[t]=d;const u=this._x[t].dot(this._w_h.get(s.cols,this._size));u.add(h.mult(d,_).dot(this._u_h.get())),u.add(this._b_h.get());const a=this._tanh(u);return this._h[t]=a,this._s[t]=h.sub(1,e),this._s[t].mult(a),this._s[t].add(h.mult(e,_)),this._s[t]}grad(s,t){return this._grad_bptt(s,t)}_grad_bptt(s,t){const _=this._s.length;this._bo[t]=s;const r=t===0?this._s0:this._s[t-1];this._dy[t]=this._bo[t]||h.zeros(1,1),t<_-1&&(this._dy[t].add(this._dz[t+1].dot(this._u_z.value.t)),this._dy[t].add(this._dr[t+1].dot(this._u_r.value.t)),this._dy[t].add(h.mult(this._dh[t+1].dot(this._u_h.value.t),this._r[t+1])),this._dy[t].add(h.mult(this._z[t+1],this._dy[t+1]))),this._dz[t]=h.mult(r,this._dy[t]),this._dz[t].sub(h.mult(this._h[t],this._dy[t])),this._dz[t].mult(this._grad_sigmoid(this._z[t])),this._dh[t]=h.sub(1,this._z[t]),this._dh[t].mult(this._dy[t]),this._dh[t].mult(this._grad_tanh(this._h[t])),this._dr[t]=this._dh[t].dot(this._u_h.value.t),this._dr[t].mult(r),this._dr[t].mult(this._grad_sigmoid(this._r[t]));const e=this._dh[t].dot(this._w_h.value.t);if(e.add(this._dz[t].dot(this._w_z.value.t)),e.add(this._dr[t].dot(this._w_r.value.t)),t===0){this._diff_bptt();const i={};if(this._w_r.name&&(i[this._w_r.name]=this._dw_r),this._w_z.name&&(i[this._w_z.name]=this._dw_z),this._w_h.name&&(i[this._w_h.name]=this._dw_h),this._b_r.name&&(i[this._b_r.name]=this._db_r),this._b_z.name&&(i[this._b_z.name]=this._db_z),this._b_h.name&&(i[this._b_h.name]=this._db_h),this._u_r.name&&(i[this._u_r.name]=this._du_r),this._u_z.name&&(i[this._u_z.name]=this._du_z),this._u_h.name&&(i[this._u_h.name]=this._du_h),Object.keys(i).length>0)return[e,i]}return e}_diff_bptt(){const s=this._s.length,t=this._x[0].rows;this._dw_r=h.zeros(...this._w_r.sizes),this._dw_z=h.zeros(...this._w_z.sizes),this._dw_h=h.zeros(...this._w_h.sizes),this._db_r=h.zeros(1,this._size),this._db_z=h.zeros(1,this._size),this._db_h=h.zeros(1,this._size);for(let _=0;_<s;_++){const r=this._x[_].tDot(this._dr[_]);r.div(t),this._dw_r.add(r);const e=this._x[_].tDot(this._dz[_]);e.div(t),this._dw_z.add(e);const i=this._x[_].tDot(this._dh[_]);i.div(t),this._dw_h.add(i),this._db_r.add(this._dr[_].mean(0)),this._db_z.add(this._dz[_].mean(0)),this._db_h.add(this._dh[_].mean(0))}this._du_r=h.zeros(this._size,this._size),this._du_z=h.zeros(this._size,this._size),this._du_h=h.zeros(this._size,this._size);for(let _=0;_<s-1;_++){const r=this._s[_].tDot(this._dr[_+1]);r.div(t),this._du_r.add(r);const e=this._s[_].tDot(this._dz[_+1]);e.div(t),this._du_z.add(e);const i=this._s[_].tDot(this._dh[_+1]);i.div(t),this._du_h.add(i)}}update(s){this._update_bptt(s)}_update_bptt(s){this._w_r.name||this._w_r.value.sub(s.delta("w_r",this._dw_r)),this._w_z.name||this._w_z.value.sub(s.delta("w_z",this._dw_z)),this._w_h.name||this._w_h.value.sub(s.delta("w_h",this._dw_h)),this._b_r.name||this._b_r.value.sub(s.delta("b_r",this._db_r)),this._b_z.name||this._b_z.value.sub(s.delta("b_z",this._db_z)),this._b_h.name||this._b_h.value.sub(s.delta("b_h",this._db_h)),this._u_r.name||this._u_r.value.sub(s.delta("u_r",this._du_r)),this._u_z.name||this._u_z.value.sub(s.delta("u_z",this._du_z)),this._u_h.name||this._u_h.value.sub(s.delta("u_h",this._du_h))}toObject(){return{w_z:this._w_z?.toObject(),w_r:this._w_r?.toObject(),w_h:this._w_h?.toObject(),u_z:this._u_z?.toObject(),u_r:this._u_r?.toObject(),u_h:this._u_h?.toObject(),b_z:this._b_z?.toObject(),b_r:this._b_r?.toObject(),b_h:this._b_h?.toObject()}}}class n{static{l(this,"Variable")}constructor(s,t,_){this._layer=s,this._sizes=_,typeof t=="string"?this._name=t:t&&(this._value=h.fromArray(t))}get name(){return this._name}get value(){return this._value}get sizes(){return this._value.sizes}get(...s){return s.length===0&&(s=this._sizes),this._name?this._value=this._layer.graph.getNode(this._name).outputValue:this._value?this._value:this._value=h.randn(...s)}toObject(){return this._name?this._name:this._value?.toArray()}}f.registLayer("gru");
