import Layer from"./base.js";import Tensor from"../../../util/tensor.js";import Matrix from"../../../util/matrix.js";export default class GRULayer extends Layer{constructor({size:t,return_sequences:s=!1,w_z:_=null,w_r:i=null,w_h:r=null,u_z:h=null,u_r:a=null,u_h:e=null,b_z:d=null,b_r:o=null,b_h:u=null,...n}){super(n),this._size=t,this._unit=new GRUUnitLayer({size:t,w_z:_,w_r:i,w_h:r,u_z:h,u_r:a,u_h:e,b_z:d,b_r:o,b_h:u}),this._return_sequences=s}calc(t){t=t.transpose(1,0,2),this._x=[];for(let s=0;s<t.sizes[0];s++)this._x[s]=t.at(s).toMatrix();const s=[];for(let t=0;t<this._x.length;t++)s[t]=this._unit.calc(this._x[t],t);if(this._return_sequences){return Tensor.fromArray(s.map((t=>t.toArray()))).transpose(1,0,2)}return s[s.length-1]}grad(t){return this._grad_bptt(t)}_grad_bptt(t){const s=this._x.length;if(this._bo=Array(s),this._return_sequences){t=t.transpose(1,0,2);for(let _=0;_<s;_++)this._bo[_]=t.at(_).toMatrix()}else this._bo[s-1]=t;const _=[];for(let t=s-1;t>=0;t--)_[t]=this._unit.grad(this._bo[t],t);return Tensor.fromArray(_.map((t=>t.toArray()))).transpose(1,0,2)}update(t){this._unit.update(t)}toObject(){return{type:"gru",size:this._size,return_sequences:this._return_sequences,...this._unit.toObject()}}}class GRUUnitLayer extends Layer{constructor({size:t,w_z:s=null,w_r:_=null,w_h:i=null,u_z:r=null,u_r:h=null,u_h:a=null,b_z:e=null,b_r:d=null,b_h:o=null,...u}){super(u),this._size=t,this._w_z=s?Matrix.fromArray(s):null,this._w_r=_?Matrix.fromArray(_):null,this._w_h=i?Matrix.fromArray(i):null,this._u_z=r?Matrix.fromArray(r):Matrix.randn(this._size,this._size),this._u_r=h?Matrix.fromArray(h):Matrix.randn(this._size,this._size),this._u_h=a?Matrix.fromArray(a):Matrix.randn(this._size,this._size),this._b_z=e?Matrix.fromArray(e):Matrix.zeros(1,this._size),this._b_r=d?Matrix.fromArray(d):Matrix.zeros(1,this._size),this._b_h=o?Matrix.fromArray(o):Matrix.zeros(1,this._size),this._s0=Matrix.zeros(1,this._size),this._x=[],this._h=[],this._s=[],this._z=[],this._r=[],this._bo=[],this._dy=[],this._dr=[],this._dz=[],this._dh=[]}_sigmoid(t){return t.copyMap((t=>1/(1+Math.exp(-t))))}_grad_sigmoid(t){return t.copyMap((t=>t*(1-t)))}_tanh(t){return t.copyMap(Math.tanh)}_grad_tanh(t){return t.copyMap((t=>1-t**2))}calc(t,s){this._w_z||(this._w_z=Matrix.randn(t.cols,this._size)),this._w_r||(this._w_r=Matrix.randn(t.cols,this._size)),this._w_h||(this._w_h=Matrix.randn(t.cols,this._size)),0===s&&(this._s=[]),this._x[s]=t;const _=0===s?this._s0:this._s[s-1],i=this._x[s].dot(this._w_z);i.add(_.dot(this._u_z)),i.add(this._b_h);const r=this._sigmoid(i);this._z[s]=r;const h=this._x[s].dot(this._w_r);h.add(_.dot(this._u_r)),h.add(this._b_r);const a=this._sigmoid(h);this._r[s]=a;const e=this._x[s].dot(this._w_h);e.add(a.copyMult(_).dot(this._u_h)),e.add(this._b_h);const d=this._tanh(e);return this._h[s]=d,this._s[s]=r.copyIsub(1),this._s[s].mult(d),this._s[s].add(r.copyMult(_)),this._s[s]}grad(t,s){return this._grad_bptt(t,s)}_grad_bptt(t,s){const _=this._s.length;this._bo[s]=t;const i=0===s?this._s0:this._s[s-1];this._dy[s]=this._bo[s]||Matrix.zeros(1,1),s<_-1&&(this._dy[s].add(this._dz[s+1].dot(this._u_z.t)),this._dy[s].add(this._dr[s+1].dot(this._u_r.t)),this._dy[s].add(this._dh[s+1].dot(this._u_h.t).copyMult(this._r[s+1])),this._dy[s].add(this._z[s+1].copyMult(this._dy[s+1]))),this._dz[s]=i.copyMult(this._dy[s]),this._dz[s].sub(this._h[s].copyMult(this._dy[s])),this._dz[s].mult(this._grad_sigmoid(this._z[s])),this._dh[s]=this._z[s].copyIsub(1),this._dh[s].mult(this._dy[s]),this._dh[s].mult(this._grad_tanh(this._h[s])),this._dr[s]=this._dh[s].dot(this._u_h.t),this._dr[s].mult(i),this._dr[s].mult(this._grad_sigmoid(this._r[s]));const r=this._dh[s].dot(this._w_h.t);return r.add(this._dz[s].dot(this._w_z.t)),r.add(this._dr[s].dot(this._w_r.t)),r}update(t){this._update_bptt(t)}_update_bptt(t){const s=this._s.length,_=this._x[0].rows,i=Matrix.zeros(...this._w_r.sizes),r=Matrix.zeros(...this._w_z.sizes),h=Matrix.zeros(...this._w_h.sizes),a=Matrix.zeros(1,this._size),e=Matrix.zeros(1,this._size),d=Matrix.zeros(1,this._size);for(let t=0;t<s;t++){const s=this._x[t].tDot(this._dr[t]);s.div(_),i.add(s);const o=this._x[t].tDot(this._dz[t]);o.div(_),r.add(o);const u=this._x[t].tDot(this._dh[t]);u.div(_),h.add(u),a.add(this._dr[t].mean(0)),e.add(this._dz[t].mean(0)),d.add(this._dh[t].mean(0))}this._w_r.sub(t.delta("w_r",i)),this._w_z.sub(t.delta("w_z",r)),this._w_h.sub(t.delta("w_h",h)),this._b_r.sub(t.delta("b_r",a)),this._b_z.sub(t.delta("b_z",e)),this._b_h.sub(t.delta("b_h",d));const o=Matrix.zeros(this._size,this._size),u=Matrix.zeros(this._size,this._size),n=Matrix.zeros(this._size,this._size);for(let t=0;t<s-1;t++){const s=this._s[t].tDot(this._dr[t+1]);s.div(_),o.add(s);const i=this._s[t].tDot(this._dz[t+1]);i.div(_),u.add(i);const r=this._s[t].tDot(this._dh[t+1]);r.div(_),n.add(r)}this._u_r.sub(t.delta("u_r",o)),this._u_z.sub(t.delta("u_z",u)),this._u_h.sub(t.delta("u_h",n))}toObject(){return{w_z:this._w_z?.toArray(),w_r:this._w_r?.toArray(),w_h:this._w_h?.toArray(),u_z:this._u_z.toArray(),u_r:this._u_r.toArray(),u_h:this._u_h.toArray(),b_z:this._b_z.toArray(),b_r:this._b_r.toArray(),b_h:this._b_h.toArray()}}}GRULayer.registLayer("gru");