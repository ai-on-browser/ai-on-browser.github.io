import Layer from"./base.js";import Matrix from"../../../util/matrix.js";export default class SoftargmaxLayer extends Layer{constructor({beta:t=1e4,...s}){super(s),this._beta=t}calc(t){this._i=t,this._o=Matrix.map(this._i,(t=>this._beta*t)),this._o.sub(this._o.max(1)),this._o.map(Math.exp),this._o.div(this._o.sum(1));const s=Matrix.zeros(1,this._o.cols);for(let t=0;t<s.cols;t++)s.set(0,t,t);return Matrix.mult(this._o,s).sum(1)}grad(t){this._bo=new Matrix(this._o.rows,this._o.cols);for(let s=0;s<this._o.cols;s++)this._bo.set(0,s,Matrix.mult(t,s));const s=this._i.copy();s.sub(s.max(1)),s.map(Math.exp),s.div(s.sum(1)),this._bi=new Matrix(this._o.rows,this._o.cols);for(let t=0;t<this._bo.rows;t++)for(let o=0;o<this._bo.cols;o++){const i=s.at(t,o);let r=0;for(let a=0;a<this._bo.cols;a++){const e=o===a?1-i:-i;r+=s.at(t,a)*e*this._bo.at(t,a)}this._bi.set(t,o,r)}return this._bi}toObject(){return{type:"softargmax",beta:this._beta}}}SoftargmaxLayer.registLayer();