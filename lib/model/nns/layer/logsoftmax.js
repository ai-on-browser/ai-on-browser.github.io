import Layer from"./base.js";export default class LogSoftmaxLayer extends Layer{constructor({axis:s=-1,...t}){super(t),this._axis=s}calc(s){const t=this._axis<0?this._axis+s.dimension:this._axis;this._s=s.copy();const i=this._s.reduce(((s,t)=>Math.max(s,t)),-1/0,t,!0);this._s.broadcastOperate(i,((s,t)=>s-t)),this._s.map(Math.exp);const e=this._s.reduce(((s,t)=>s+t),0,t,!0);return this._s.broadcastOperate(e,((s,t)=>s/t)),this._o=this._s.copy(),this._o.map(Math.log),this._o}grad(s){this._bi=s.copy();const t=this._axis<0?this._axis+s.dimension:this._axis,i=Array(s.dimension).fill(0);do{for(let e=0;e<s.sizes[t];e++){i[t]=e;const a=this._s.at(i);let o=0;const r=i.concat();for(let i=0;i<s.sizes[t];i++){r[t]=i;o+=(e===i?1-a:-a)*s.at(r)}this._bi.set(i,o)}for(let e=0;e<i.length;e++)if(e!==t){if(i[e]++,i[e]<s.sizes[e])break;i[e]=0}else i[e]=0}while(i.some((s=>s>0)));return this._bi}toObject(){return{type:"log_softmax",axis:this._axis}}}LogSoftmaxLayer.registLayer();