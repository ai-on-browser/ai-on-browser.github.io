import Layer from"./base.js";import Matrix from"../../../util/matrix.js";import Tensor from"../../../util/tensor.js";export default class MeanLayer extends Layer{constructor({axis:s=-1,keepdims:i=!0,...e}){super(e),this._axis=null,"string"==typeof s?this._axisname=s:this._axis="number"==typeof s?[s]:s,this._keepdims=i}calc(s){if(this._axisname&&(this._axis=this.graph.getNode(this._axisname).outputValue.toArray()),this._axis.includes(-1))this._size=Array(s.dimension).fill(1);else{this._size=s.sizes.concat();for(let s=0;s<this._axis.length;s++)this._size[this._axis[s]]=1}if(this._i=s,!this._keepdims&&this._axis.includes(-1))return new Tensor([],s.reduce(((s,i)=>s+i),0)/s.length);!this._keepdims&&s instanceof Matrix&&(s=Tensor.fromArray(s));const i=this._axis.includes(-1)?s.length:this._axis.reduce(((i,e)=>i*s.sizes[e]),1),e=s.reduce(((s,i)=>s+i),0,this._axis,this._keepdims);return e.map((s=>s/i)),e}grad(s){s.reshape(...this._size);const i=this._axis.includes(-1)?this._i.length:this._axis.reduce(((s,i)=>s*this._i.sizes[i]),1),e=this._i.copy();return e.broadcastOperate(s,((s,e)=>e/i)),e}toObject(){return{type:"mean",axis:this._axisname||this._axis,keepdims:this._keepdims}}}MeanLayer.registLayer();