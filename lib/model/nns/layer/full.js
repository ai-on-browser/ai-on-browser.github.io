import Layer from"./base.js";import Matrix from"../../../util/matrix.js";import ActivationLayer from"./activation.js";export default class FullyConnected extends Layer{constructor({out_size:t,w:i=null,b:s=null,activation:a=null,l2_decay:_=0,l1_decay:o=0,activation_params:e={},...h}){super(h),this._out_size=t,this._w=i?Matrix.fromArray(i):null,this._b=s?Matrix.fromArray(s):"string"!=typeof t?Matrix.randn(1,t):null,this._activation=a,a&&(this._activation_func=new ActivationLayer({activation:a,...e})),this._l2_decay=_,this._l1_decay=o}calc(t){if(!this._w){const i="string"==typeof this._out_size?this.graph.getNode(this._out_size).lastOutputSize[1]:this._out_size;this._w=Matrix.randn(t.cols,i)}if(!this._b){const t=this.graph.getNode(this._out_size).lastOutputSize[1];this._b=Matrix.randn(1,t)}return this._i=t,this._o=t.dot(this._w),this._o.add(this._b),this._activation_func?this._activation_func.calc(this._o):this._o}grad(t){return this._bo=t,this._activation_func&&(this._bo=this._activation_func.grad(t)),this._bi=this._bo.dot(this._w.t),this._bi}update(t){const i=this._i.tDot(this._bo);if(i.div(this._i.rows),this._l2_decay>0||this._l1_decay>0)for(let t=0;t<i.rows;t++)for(let s=0;s<i.cols;s++){const a=this._w.at(t,s);i.addAt(t,s,a*this._l2_decay+Math.sign(a)*this._l1_decay)}this._w.sub(t.delta("w",i));const s=this._bo.sum(0);s.div(this._i.rows),this._b.sub(t.delta("b",s))}toObject(){return{type:"full",out_size:this._out_size,w:this._w?.toArray(),b:this._b.toArray(),activation:this._activation,l2_decay:this._l2_decay,l1_decay:this._l1_decay,activation_params:this._activation_func?.toObject()}}}FullyConnected.registLayer("full");