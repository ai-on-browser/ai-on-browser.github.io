var f=Object.defineProperty;var r=(n,t)=>f(n,"name",{value:t,configurable:!0});import o from"./base.js";import a from"../../../util/matrix.js";export default class d extends o{static{r(this,"FullyConnected")}constructor({out_size:t,w:i=null,b:s=null,activation:_=null,l2_decay:e=0,l1_decay:h=0,...l}){super(l),this._out_size=t,this._w=null,typeof i=="string"?this._wname=i:i&&(this._w=a.fromArray(i)),this._b=null,typeof s=="string"?this._bname=s:s&&(this._b=a.fromArray(s)),typeof _=="string"?this._activation=o.fromObject({type:_}):_&&(this._activation=o.fromObject(_)),this._l2_decay=e,this._l1_decay=h}get dependentLayers(){const t=[];return this._wname&&t.push(this._wname),this._bname&&t.push(this._bname),this._activation&&t.push(...this._activation.dependentLayers),t}calc(t){if(this._wname&&(this._w=this.graph.getNode(this._wname).outputValue,this._out_size||(this._out_size=this._w.sizes.at(-1))),this._bname&&(this._b=this.graph.getNode(this._bname).outputValue),!this._w||!this._b){const i=typeof this._out_size=="string"?this.graph.getNode(this._out_size).lastOutputSize.at(-1):this._out_size;this._w||(this._w=a.randn(t.sizes.at(-1),i)),this._b||(this._b=a.zeros(1,i))}return this._i=t,this._o=t.dot(this._w),this._o.broadcastOperate(this._b,(i,s)=>i+s),this._activation?this._activation.calc(this._o):this._o}grad(t){this._activation&&(t=this._activation.grad(t));let i=this._i;this._i.dimension!==2&&(i=this._i.copy(),i.reshape(-1,this._w.rows),i=i.toMatrix());let s=t;if(s.dimension!==2&&(s=t.copy(),s.reshape(-1,this._w.cols),s=s.toMatrix()),this._dw=i.tDot(s),this._dw.div(this._i.rows),this._l2_decay>0||this._l1_decay>0)for(let _=0;_<this._dw.rows;_++)for(let e=0;e<this._dw.cols;e++){const h=this._w.at(_,e);this._dw.addAt(_,e,h*this._l2_decay+Math.sign(h)*this._l1_decay)}if(this._db=s.sum(0),this._db.div(this._i.rows),this._bi=t.dot(this._w.t),this._wname||this._bname){const _={};return this._wname&&(_[this._wname]=this._dw),this._bname&&(_[this._bname]=this._db),[this._bi,_]}return this._bi}update(t){this._wname||this._w.sub(t.delta("w",this._dw)),this._bname||this._b.sub(t.delta("b",this._db))}toObject(){return{type:"full",out_size:this._out_size,w:this._wname||this._w?.toArray(),b:this._bname||this._b?.toArray(),activation:this._activation?.toObject(),l2_decay:this._l2_decay,l1_decay:this._l1_decay}}}d.registLayer("full");
