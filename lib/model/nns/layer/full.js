import Layer from"./base.js";import Matrix from"../../../util/matrix.js";export default class FullyConnected extends Layer{constructor({out_size:t,w:i=null,b:s=null,activation:_=null,l2_decay:a=0,l1_decay:h=0,activation_params:e={},...o}){super(o),this._out_size=t,this._w=null,"string"==typeof i?this._wname=i:i&&(this._w=Matrix.fromArray(i)),this._b=null,"string"==typeof s?this._bname=s:s&&(this._b=Matrix.fromArray(s)),this._activation=_,_&&(this._activation_func=Layer.fromObject({type:_,...e})),this._l2_decay=a,this._l1_decay=h}calc(t){if(this._wname&&(this._w=this.graph.getNode(this._wname).outputValue,this._out_size||(this._out_size=this._w.sizes.at(-1))),this._bname&&(this._b=this.graph.getNode(this._bname).outputValue),!this._w||!this._b){const i="string"==typeof this._out_size?this.graph.getNode(this._out_size).lastOutputSize.at(-1):this._out_size;this._w||(this._w=Matrix.randn(t.sizes.at(-1),i)),this._b||(this._b=Matrix.zeros(1,i))}return this._i=t,this._o=t.dot(this._w),this._o.broadcastOperate(this._b,((t,i)=>t+i)),this._activation_func?this._activation_func.calc(this._o):this._o}grad(t){this._activation_func&&(t=this._activation_func.grad(t));let i=this._i;2!==this._i.dimension&&(i=this._i.copy(),i.reshape(-1,this._w.rows),i=i.toMatrix());let s=t;if(2!==s.dimension&&(s=t.copy(),s.reshape(-1,this._w.cols),s=s.toMatrix()),this._dw=i.tDot(s),this._dw.div(this._i.rows),this._l2_decay>0||this._l1_decay>0)for(let t=0;t<this._dw.rows;t++)for(let i=0;i<this._dw.cols;i++){const s=this._w.at(t,i);this._dw.addAt(t,i,s*this._l2_decay+Math.sign(s)*this._l1_decay)}if(this._db=s.sum(0),this._db.div(this._i.rows),this._bi=t.dot(this._w.t),this._wname||this._bname){const t={};return this._wname&&(t[this._wname]=this._dw),this._bname&&(t[this._bname]=this._db),[this._bi,t]}return this._bi}update(t){this._wname||this._w.sub(t.delta("w",this._dw)),this._bname||this._b.sub(t.delta("b",this._db))}toObject(){return{type:"full",out_size:this._out_size,w:this._wname||this._w?.toArray(),b:this._bname||this._b?.toArray(),activation:this._activation,l2_decay:this._l2_decay,l1_decay:this._l1_decay,activation_params:this._activation_func?.toObject()}}}FullyConnected.registLayer("full");