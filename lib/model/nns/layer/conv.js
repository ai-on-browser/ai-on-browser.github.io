var u=Object.defineProperty;var w=(m,i)=>u(m,"name",{value:i,configurable:!0});import f,{NeuralnetworkLayerException as o}from"./base.js";import c from"../../../util/tensor.js";export default class p extends f{static{w(this,"ConvLayer")}constructor({kernel:i,channel:r=null,stride:_=null,padding:a=null,w:e=null,activation:s=null,l2_decay:h=0,l1_decay:t=0,channel_dim:n=-1,...l}){if(super(l),this._in_channel=null,this._out_channel=r,this._kernel=i,this._stride=_||1,this._padding=a||0,this._channel_dim=n,this._channel_dim!==-1&&this._channel_dim!==1)throw new o("Invalid channel dimension.");this._w=null,this._wname=null,typeof e=="string"?this._wname=e:e&&(this._w=c.fromArray(e),this._in_channel=this._w.sizes[1],this._out_channel||(this._out_channel=this._w.sizes[0])),typeof s=="string"?this._activation=f.fromObject({type:s}):s&&(this._activation=f.fromObject(s)),this._l2_decay=h,this._l1_decay=t}_index(i,r,_){return this._channel_dim===-1?[i,..._,r]:[i,r,..._]}calc(i){if(i.dimension<=2)throw new o("Invalid input.");if(Array.isArray(this._kernel)||(this._kernel=Array(i.dimension-2).fill(this._kernel)),i.dimension!==this._kernel.length+2)throw new o("Invalid kernel size",[this,i]);if(Array.isArray(this._stride)||(this._stride=Array(i.dimension-2).fill(this._stride)),i.dimension!==this._stride.length+2)throw new o("Invalid stride size",[this,i]);if(Array.isArray(this._padding)?Array.isArray(this._padding[0])||(this._padding=this._padding.map(a=>[a,a])):this._padding=Array.from({length:i.dimension-2},()=>[this._padding,this._padding]),i.dimension!==this._padding.length+2)throw new o("Invalid padding size",[this,i]);this._wname&&(this._w=this.graph.getNode(this._wname).outputValue,this._in_channel||(this._in_channel=this._w.sizes[1]),this._out_channel||(this._out_channel=this._w.sizes[0])),this._w||(this._in_channel=i.sizes[this._channel_dim===-1?i.dimension-1:1],this._out_channel||(this._out_channel=this._in_channel*2),this._w=c.randn([this._out_channel,this._in_channel,...this._kernel])),this._i=i;const r=this._channel_dim===-1?1:2,_=[i.sizes[0],...this._kernel.map((a,e)=>Math.ceil(Math.max(0,i.sizes[e+r]+this._padding[e][0]+this._padding[e][1]-a)/this._stride[e])+1)];this._channel_dim===-1?_.push(this._out_channel):this._channel_dim===1&&_.splice(1,0,this._out_channel),this._o=new c(_);for(let a=0;a<i.sizes[0];a++)for(let e=0;e<this._out_channel;e++){const s=Array(this._kernel.length).fill(0);do{let h=0;const t=Array(this._kernel.length).fill(0);do{const n=t.map((l,d)=>s[d]*this._stride[d]-this._padding[d][0]+l);if(n.every((l,d)=>0<=l&&l<i.sizes[d+r]))for(let l=0;l<this._in_channel;l++)h+=i.at(this._index(a,l,n))*this._w.at(e,l,...t);for(let l=0;l<t.length&&(t[l]++,!(t[l]<this._kernel[l]));l++)t[l]=0}while(t.some(n=>n>0));this._o.set(this._index(a,e,s),h);for(let n=0;n<s.length&&(s[n]++,!(s[n]<_[n+r]));n++)s[n]=0}while(s.some(h=>h>0))}return this._activation?this._activation.calc(this._o):this._o}grad(i){this._bo=i,this._activation&&(this._bo=this._activation.grad(i)),this._bi=new c(this._i.sizes),this._dw=new c(this._w.sizes);const r=this._channel_dim===-1?1:2;for(let _=0;_<this._i.sizes[0];_++)for(let a=0;a<this._out_channel;a++){const e=Array(this._kernel.length).fill(0);do{const s=Array(this._kernel.length).fill(0);do{const h=s.map((t,n)=>e[n]*this._stride[n]-this._padding[n][0]+t);if(h.every((t,n)=>0<=t&&t<this._i.sizes[n+r]))for(let t=0;t<this._in_channel;t++)this._bi.operateAt(this._index(_,t,h),n=>n+this._w.at(a,t,...s)*this._bo.at(this._index(_,a,e))),this._dw.operateAt([a,t,...s],n=>n+this._i.at(this._index(_,t,h))*this._bo.at(this._index(_,a,e)));for(let t=0;t<s.length&&(s[t]++,!(s[t]<this._kernel[t]));t++)s[t]=0}while(s.some(h=>h>0));for(let h=0;h<e.length&&(e[h]++,!(e[h]<this._o.sizes[h+r]));h++)e[h]=0}while(e.some(s=>s>0))}return this._wname?[this._bi,{[this._wname]:this._dw}]:this._bi}update(i){this._wname||this._w.broadcastOperate(i.delta("w",this._dw),(r,_)=>r-_)}toObject(){return{type:"conv",w:this._wname||this._w?.toArray(),channel:this._out_channel,kernel:this._kernel,stride:this._stride,padding:this._padding,activation:this._activation?.toObject(),l2_decay:this._l2_decay,l1_decay:this._l1_decay,channel_dim:this._channel_dim}}}p.registLayer();
