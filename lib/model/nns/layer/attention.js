var y=Object.defineProperty;var p=(c,t)=>y(c,"name",{value:t,configurable:!0});import u from"../../../util/matrix.js";import b from"../../../util/tensor.js";import M from"./base.js";export default class z extends M{static{p(this,"AttentionLayer")}constructor({dk:t=null,dv:h=null,wq:_=null,wk:d=null,wv:e=null,...r}){super(r),this._dk=t,this._dv=h,this._wq=null,typeof _=="string"?this._wqname=_:_&&(this._wq=u.fromArray(_)),this._wk=null,typeof d=="string"?this._wkname=d:d&&(this._wk=u.fromArray(d)),this._wv=null,typeof e=="string"?this._wvname=e:e&&(this._wv=u.fromArray(e))}get dependentLayers(){const t=[];return this._wqname&&t.push(this._wqname),this._wkname&&t.push(this._wkname),this._wvname&&t.push(this._wvname),t}calc(t,h){this._selfattention=!h,h||(h=t),this._dk??=t.sizes.at(-1),this._wqname&&(this._wq=this.graph.getNode(this._wqname).outputValue),this._wq||(this._wq=u.randn(t.sizes[2],this._dk)),this._wkname&&(this._wk=this.graph.getNode(this._wkname).outputValue),this._wk||(this._wk=u.randn(h.sizes[2],this._dk)),this._dv??=t.sizes.at(-1),this._wvname&&(this._wv=this.graph.getNode(this._wvname).outputValue),this._wv||(this._wv=u.randn(h.sizes[2],this._dv)),this._i=t,this._m=h,this._q=t.dot(this._wq),this._k=h.dot(this._wk),this._v=h.dot(this._wv);const _=this._matmul(this._q,this._k,!1,!0);this._atn=_.copy();for(let e=0;e<_.sizes[0];e++)for(let r=0;r<_.sizes[1];r++){let w=[];for(let i=0;i<_.sizes[2];i++)w[i]=_.at(e,r,i)/Math.sqrt(this._dk);const o=w.reduce((i,f)=>Math.max(i,f),-1/0);let n=0;for(let i=0;i<_.sizes[2];i++)w[i]=Math.exp(w[i]-o),n+=w[i];for(let i=0;i<_.sizes[2];i++)this._atn.set([e,r,i],w[i]/n)}return this._matmul(this._atn,this._v)}_matmul(t,h,_=!1,d=!1){const e=[t.sizes[0],_?t.sizes[2]:t.sizes[1],d?h.sizes[1]:h.sizes[2]],r=_?t.sizes[1]:t.sizes[2],w=new b(e);for(let o=0;o<e[0];o++)for(let n=0;n<e[1];n++)for(let i=0;i<e[2];i++){let f=0;for(let l=0;l<r;l++)f+=(_?t.at(o,l,n):t.at(o,n,l))*(d?h.at(o,i,l):h.at(o,l,i));w.set([o,n,i],f)}return w}grad(t){const h=t.sizes[0],_=this._matmul(this._atn,t,!0),d=this._matmul(this._m,_,!0);this._dwv=d.reduce((s,a)=>s+a,0,0).toMatrix(),this._dwv.map(s=>s/h);const e=this._matmul(t,this._v,!1,!0),r=e.copy();for(let s=0;s<e.sizes[0];s++)for(let a=0;a<e.sizes[1];a++)for(let m=0;m<e.sizes[2];m++){const v=e.at(s,a,m);let q=0;for(let k=0;k<e.sizes[2];k++){const g=m===k?1-v:-v;q+=this._atn.at(s,a,k)*g*e.at(s,a,k)}r.set([s,a,m],q/Math.sqrt(this._dk))}const w=this._matmul(r,this._k),o=this._matmul(this._i,w,!0);this._dwq=o.reduce((s,a)=>s+a,0,0).toMatrix(),this._dwq.map(s=>s/h);const n=w.dot(this._wq.t),i=this._matmul(r,this._q,!0),f=this._matmul(this._m,i,!0);this._dwk=f.reduce((s,a)=>s+a,0,0).toMatrix(),this._dwk.map(s=>s/h);const l=i.dot(this._wk.t);if(l.broadcastOperate(_.dot(this._wv.t),(s,a)=>s+a),this._selfattention&&n.broadcastOperate(l,(s,a)=>s+a),this._wqname||this._wkname||this._wvname){const s={};return this._wqname&&(s[this._wqname]=this._dwq),this._wkname&&(s[this._wkname]=this._dwk),this._wvname&&(s[this._wvname]=this._dwv),this._selfattention?[n,s]:[n,l,s]}return this._selfattention?n:[n,l]}update(t){this._wqname||this._wq.sub(t.delta("wq",this._dwq)),this._wkname||this._wk.sub(t.delta("wk",this._dwk)),this._wvname||this._wv.sub(t.delta("wv",this._dwv))}toObject(){return{type:"attention",dk:this._dk,dv:this._dv,wq:this._wqname||this._wq?.toArray(),wk:this._wkname||this._wk?.toArray(),wv:this._wvname||this._wv?.toArray()}}}z.registLayer();
