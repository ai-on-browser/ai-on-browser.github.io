var y=Object.defineProperty;var p=(c,s)=>y(c,"name",{value:s,configurable:!0});import u from"../../../util/matrix.js";import b from"../../../util/tensor.js";import M from"./base.js";export default class z extends M{static{p(this,"AttentionLayer")}constructor({dk:s=null,dv:h=null,wq:_=null,wk:d=null,wv:e=null,...r}){super(r),this._dk=s,this._dv=h,this._wq=null,typeof _=="string"?this._wqname=_:_&&(this._wq=u.fromArray(_)),this._wk=null,typeof d=="string"?this._wkname=d:d&&(this._wk=u.fromArray(d)),this._wv=null,typeof e=="string"?this._wvname=e:e&&(this._wv=u.fromArray(e))}calc(s,h){this._selfattention=!h,h||(h=s),this._dk??=s.sizes.at(-1),this._wqname&&(this._wq=this.graph.getNode(this._wqname).outputValue),this._wq||(this._wq=u.randn(s.sizes[2],this._dk)),this._wkname&&(this._wk=this.graph.getNode(this._wkname).outputValue),this._wk||(this._wk=u.randn(h.sizes[2],this._dk)),this._dv??=s.sizes.at(-1),this._wvname&&(this._wv=this.graph.getNode(this._wvname).outputValue),this._wv||(this._wv=u.randn(h.sizes[2],this._dv)),this._i=s,this._m=h,this._q=s.dot(this._wq),this._k=h.dot(this._wk),this._v=h.dot(this._wv);const _=this._matmul(this._q,this._k,!1,!0);this._atn=_.copy();for(let e=0;e<_.sizes[0];e++)for(let r=0;r<_.sizes[1];r++){let o=[];for(let i=0;i<_.sizes[2];i++)o[i]=_.at(e,r,i)/Math.sqrt(this._dk);const l=o.reduce((i,f)=>Math.max(i,f),-1/0);let n=0;for(let i=0;i<_.sizes[2];i++)o[i]=Math.exp(o[i]-l),n+=o[i];for(let i=0;i<_.sizes[2];i++)this._atn.set([e,r,i],o[i]/n)}return this._matmul(this._atn,this._v)}_matmul(s,h,_=!1,d=!1){const e=[s.sizes[0],_?s.sizes[2]:s.sizes[1],d?h.sizes[1]:h.sizes[2]],r=_?s.sizes[1]:s.sizes[2],o=new b(e);for(let l=0;l<e[0];l++)for(let n=0;n<e[1];n++)for(let i=0;i<e[2];i++){let f=0;for(let w=0;w<r;w++)f+=(_?s.at(l,w,n):s.at(l,n,w))*(d?h.at(l,i,w):h.at(l,w,i));o.set([l,n,i],f)}return o}grad(s){const h=s.sizes[0],_=this._matmul(this._atn,s,!0),d=this._matmul(this._m,_,!0);this._dwv=d.reduce((t,a)=>t+a,0,0).toMatrix(),this._dwv.map(t=>t/h);const e=this._matmul(s,this._v,!1,!0),r=e.copy();for(let t=0;t<e.sizes[0];t++)for(let a=0;a<e.sizes[1];a++)for(let m=0;m<e.sizes[2];m++){const v=e.at(t,a,m);let q=0;for(let k=0;k<e.sizes[2];k++){const g=m===k?1-v:-v;q+=this._atn.at(t,a,k)*g*e.at(t,a,k)}r.set([t,a,m],q/Math.sqrt(this._dk))}const o=this._matmul(r,this._k),l=this._matmul(this._i,o,!0);this._dwq=l.reduce((t,a)=>t+a,0,0).toMatrix(),this._dwq.map(t=>t/h);const n=o.dot(this._wq.t),i=this._matmul(r,this._q,!0),f=this._matmul(this._m,i,!0);this._dwk=f.reduce((t,a)=>t+a,0,0).toMatrix(),this._dwk.map(t=>t/h);const w=i.dot(this._wk.t);if(w.broadcastOperate(_.dot(this._wv.t),(t,a)=>t+a),this._selfattention&&n.broadcastOperate(w,(t,a)=>t+a),this._wqname||this._wkname||this._wvname){const t={};return this._wqname&&(t[this._wqname]=this._dwq),this._wkname&&(t[this._wkname]=this._dwk),this._wvname&&(t[this._wvname]=this._dwv),this._selfattention?[n,t]:[n,w,t]}return this._selfattention?n:[n,w]}update(s){this._wqname||this._wq.sub(s.delta("wq",this._dwq)),this._wkname||this._wk.sub(s.delta("wk",this._dwk)),this._wvname||this._wv.sub(s.delta("wv",this._dwv))}toObject(){return{type:"attention",dk:this._dk,dv:this._dv,wq:this._wqname||this._wq?.toArray(),wk:this._wkname||this._wk?.toArray(),wv:this._wvname||this._wv?.toArray()}}}z.registLayer();
