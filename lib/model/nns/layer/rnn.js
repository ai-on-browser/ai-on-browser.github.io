import Layer from"./base.js";import Tensor from"../../../util/tensor.js";import Matrix from"../../../util/matrix.js";export default class RNNLayer extends Layer{constructor({size:t,out_size:i=null,activation:s="tanh",recurrent_activation:_="sigmoid",return_sequences:h=!1,w_xh:r=null,w_hh:e=null,w_hy:a=null,b_xh:o=null,b_hh:n=null,b_hy:u=null,...c}){super(c),this._size=t,this._out_size=i||t,this._w_hy=a?Matrix.fromArray(a):Matrix.randn(t,this._out_size),this._b_hy=u?Matrix.fromArray(u):Matrix.zeros(1,this._out_size),this._unit=new RNNUnitLayer({size:t,recurrent_activation:_,w_xh:r,w_hh:e,b_xh:o,b_hh:n}),"string"==typeof s?this._activation=Layer.fromObject({type:s}):s&&(this._activation=Layer.fromObject(s)),this._return_sequences=h}calc(t){t=t.transpose(1,0,2),this._i=[];for(let i=0;i<t.sizes[0];i++)this._i[i]=t.index(i).toMatrix();this._o=[],this._z=[],this._v=[];for(let t=0;t<this._i.length;t++)this._z[t]=this._unit.calc(this._i[t],t),this._o[t]=this._z[t].dot(this._w_hy),this._o[t].add(this._b_hy),this._activation&&(this._v[t]=this._o[t],this._o[t]=this._activation.calc(this._o[t]));if(this._return_sequences){return Tensor.fromArray(this._o.map((t=>t.toArray()))).transpose(1,0,2)}return this._o[this._o.length-1]}grad(t){return this._grad_bptt(t)}_grad_bptt(t){const i=this._o.length;if(this._bo=Array(i),this._return_sequences){t=t.transpose(1,0,2);for(let s=0;s<i;s++)this._bo[s]=t.index(s).toMatrix()}else this._bo[i-1]=t;this._activation&&(this._bo=this._bo.map(((t,i)=>t?(this._activation.calc(this._v[i]),this._activation.grad(t)):t)));const s=[];for(let t=i-1;t>=0;t--)s[t]=this._unit.grad(this._bo[t]?.dot(this._w_hy.t),t);return Tensor.fromArray(s.map((t=>t.toArray()))).transpose(1,0,2)}update(t){this._update_bptt(t)}_update_bptt(t){const i=this._o.length,s=Matrix.zeros(this._size,this._out_size),_=Matrix.zeros(1,this._out_size);for(let t=0;t<i;t++)if(this._bo[t]){const i=this._z[t].tDot(this._bo[t]);i.div(this._z[t].rows),s.add(i),_.add(this._bo[t].mean(0))}s.div(i),_.div(i),this._w_hy.sub(t.delta("w_hy",s)),this._b_hy.sub(t.delta("b_hy",_)),this._unit.update(t)}toObject(){return{type:"rnn",size:this._size,out_size:this._out_size,return_sequences:this._return_sequences,w_hy:this._w_hy.toArray(),b_hy:this._b_hy.toArray(),activation:this._activation?.toObject(),...this._unit.toObject()}}}class RNNUnitLayer extends Layer{constructor({size:t,recurrent_activation:i="sigmoid",w_xh:s=null,w_hh:_=null,b_xh:h=null,b_hh:r=null,...e}){super(e),this._size=t,this._w_xh=s?Matrix.fromArray(s):null,this._w_hh=_?Matrix.fromArray(_):Matrix.randn(t,t),this._b_xh=h?Matrix.fromArray(h):Matrix.zeros(1,t),this._b_hh=r?Matrix.fromArray(r):Matrix.zeros(1,t),this._z0=Matrix.zeros(1,t),this._i=[],this._z=[],this._u=[],this._bo=[],this._bh=[],"string"==typeof i?this._recurrent_activation=Layer.fromObject({type:i}):i&&(this._recurrent_activation=Layer.fromObject(i))}calc(t,i){this._w_xh||(this._w_xh=Matrix.randn(t.cols,this._size)),0===i&&(this._z=[]),this._i[i]=t,this._z[i]=t.dot(this._w_xh);const s=0===i?this._z0:this._z[i-1];return this._z[i].add(s.dot(this._w_hh)),this._z[i].add(this._b_xh),this._z[i].add(this._b_hh),this._recurrent_activation&&(this._u[i]=this._z[i],this._z[i]=this._recurrent_activation.calc(this._z[i])),this._z[i]}grad(t,i){return this._grad_bptt(t,i)}_grad_bptt(t,i){const s=this._z.length;return this._bo[i]=t,this._bh[i]=this._bo[i]||Matrix.zeros(1,1),i<s-1&&this._bh[i].add(this._bh[i+1].dot(this._w_hh.t)),this._recurrent_activation&&(this._recurrent_activation.calc(this._u[i]),this._bh[i]=this._recurrent_activation.grad(this._bh[i])),this._bh[i].dot(this._w_xh.t)}update(t){this._update_bptt(t)}_update_bptt(t){const i=this._z.length,s=Matrix.zeros(...this._w_xh.sizes),_=Matrix.zeros(1,this._size);for(let t=0;t<i;t++){const i=this._i[t].tDot(this._bh[t]);i.div(this._i[t].rows),s.add(i),_.add(this._bh[t].mean(0))}s.div(i),_.div(i),this._w_xh.sub(t.delta("w_xh",s)),this._b_xh.sub(t.delta("b_xh",_));const h=Matrix.zeros(this._size,this._size),r=Matrix.zeros(1,this._size);for(let t=0;t<i-1;t++){const i=this._z[t].tDot(this._bh[t+1]);i.div(this._z[t].rows),h.add(i),r.add(this._bh[t+1].mean(0))}h.div(i-1),r.div(i-1),this._w_hh.sub(t.delta("w_hh",h)),this._b_hh.sub(t.delta("b_hh",r))}toObject(){return{w_xh:this._w_xh?.toArray(),w_hh:this._w_hh.toArray(),b_xh:this._b_xh.toArray(),b_hh:this._b_hh.toArray(),recurrent_activation:this._recurrent_activation?.toObject()}}}RNNLayer.registLayer("rnn");