var q=Object.defineProperty;var b=(c,_)=>q(c,"name",{value:_,configurable:!0});import y,{NeuralnetworkLayerException as A}from"./base.js";import j from"../../../util/tensor.js";import h from"../../../util/matrix.js";export default class O extends y{static{b(this,"LSTMLayer")}constructor({size:_,return_sequences:t=!1,w_z:i=null,w_in:d=null,w_for:s=null,w_out:e=null,r_z:n=null,r_in:u=null,r_for:r=null,r_out:l=null,p_in:a=null,p_for:f=null,p_out:z=null,b_z:m=null,b_in:w=null,b_for:p=null,b_out:g=null,sequence_dim:v=1,...x}){if(super(x),this._size=_,this._unit=new D({layer:this,size:_,w_z:i,w_in:d,w_for:s,w_out:e,r_z:n,r_in:u,r_for:r,r_out:l,p_in:a,p_for:f,p_out:z,b_z:m,b_in:w,b_for:p,b_out:g}),this._return_sequences=t,this._sequence_dim=v,this._sequence_dim!==0&&this._sequence_dim!==1)throw new A("Invalid sequence dimension.")}calc(_){this._sequence_dim===1&&(_=_.transpose(1,0,2)),this._x=[];for(let t=0;t<_.sizes[0];t++)this._x[t]=_.index(t).toMatrix();this._y=[];for(let t=0;t<this._x.length;t++)this._y[t]=this._unit.calc(this._x[t],t);if(this._return_sequences){const t=j.fromArray(this._y.map(i=>i.toArray()));return this._sequence_dim===1?t.transpose(1,0,2):t}return this._y[this._y.length-1]}grad(_){return this._grad_bptt(_)}_grad_bptt(_){const t=this._y.length;if(this._bo=Array(t),this._return_sequences){this._sequence_dim===1&&(_=_.transpose(1,0,2));for(let e=0;e<t;e++)this._bo[e]=_.index(e).toMatrix()}else this._bo[t-1]=_;const i=[];let d=null;for(let e=t-1;e>=0;e--){const n=this._unit.grad(this._bo[e],e);e===0&&Array.isArray(n)?(i[e]=n[0],d=n[1]):i[e]=n}let s=j.fromArray(i.map(e=>e.toArray()));return this._sequence_dim===1&&(s=s.transpose(1,0,2)),d?[s,d]:s}update(_){this._unit.update(_)}toObject(){return{type:"lstm",size:this._size,return_sequences:this._return_sequences,sequence_dim:this._sequence_dim,...this._unit.toObject()}}}class D extends y{static{b(this,"LSTMUnitLayer")}constructor({layer:_,size:t,w_z:i=null,w_in:d=null,w_for:s=null,w_out:e=null,r_z:n=null,r_in:u=null,r_for:r=null,r_out:l=null,p_in:a=null,p_for:f=null,p_out:z=null,b_z:m=null,b_in:w=null,b_for:p=null,b_out:g=null,...v}){super(v),this._size=t,this._w_z=new o(_,i),this._w_in=new o(_,d),this._w_for=new o(_,s),this._w_out=new o(_,e),this._r_z=new o(_,n,[this._size,this._size]),this._r_in=new o(_,u,[this._size,this._size]),this._r_for=new o(_,r,[this._size,this._size]),this._r_out=new o(_,l,[this._size,this._size]),this._p_in=new o(_,a,[1,this._size]),this._p_for=new o(_,f,[1,this._size]),this._p_out=new o(_,z,[1,this._size]),this._b_z=new o(_,m,[1,this._size]),this._b_in=new o(_,w,[1,this._size]),this._b_for=new o(_,p,[1,this._size]),this._b_out=new o(_,g,[1,this._size]),this._c0=h.zeros(1,this._size),this._y0=h.zeros(1,this._size),this._x=[],this._c=[],this._y=[],this._ob=[],this._o=[],this._fb=[],this._f=[],this._ib=[],this._i=[],this._zb=[],this._z=[],this._bo=[],this._dy=[],this._do=[],this._dc=[],this._df=[],this._di=[],this._dz=[]}_sigmoid(_){return h.map(_,t=>1/(1+Math.exp(-t)))}_grad_sigmoid(_,t){return h.map(t,i=>i*(1-i))}_tanh(_){return h.map(_,Math.tanh)}_grad_tanh(_){return h.map(_,t=>1/Math.cosh(t)**2)}calc(_,t){t===0&&(this._y=[]),this._x[t]=_;const i=t===0?this._y0:this._y[t-1],d=t===0?this._c0:this._c[t-1],s=this._x[t].dot(this._w_z.get(_.cols,this._size));s.add(i.dot(this._r_z.get())),s.add(this._b_z.get()),this._zb[t]=s;const e=this._tanh(s);this._z[t]=e;const n=this._x[t].dot(this._w_in.get(_.cols,this._size));n.add(i.dot(this._r_in.get())),n.add(h.mult(this._p_in.get(),d)),n.add(this._b_in.get()),this._ib[t]=n;const u=this._sigmoid(n);this._i[t]=u;const r=this._x[t].dot(this._w_for.get(_.cols,this._size));r.add(i.dot(this._r_for.get())),r.add(h.mult(this._p_for.get(),d)),r.add(this._b_for.get()),this._fb[t]=r;const l=this._sigmoid(r);this._f[t]=l,this._c[t]=h.mult(u,e),this._c[t].add(h.mult(l,d));const a=this._x[t].dot(this._w_out.get(_.cols,this._size));a.add(i.dot(this._r_out.get())),a.add(h.mult(this._p_out.get(),this._c[t])),a.add(this._b_out.get()),this._ob[t]=a;const f=this._sigmoid(a);return this._o[t]=f,this._y[t]=this._tanh(this._c[t]),this._y[t].mult(f),this._y[t]}grad(_,t){return this._grad_bptt(_,t)}_grad_bptt(_,t){const i=this._y.length;this._bo[t]=_,this._dy[t]=this._bo[t]||h.zeros(1,1),t<i-1&&(this._dy[t].add(this._dz[t+1].dot(this._r_z.value.t)),this._dy[t].add(this._di[t+1].dot(this._r_in.value.t)),this._dy[t].add(this._df[t+1].dot(this._r_for.value.t)),this._dy[t].add(this._do[t+1].dot(this._r_out.value.t))),this._do[t]=this._dy[t].copy(),this._do[t].mult(this._tanh(this._c[t])),this._do[t].mult(this._grad_sigmoid(this._ob[t],this._o[t])),this._dc[t]=this._dy[t].copy(),this._dc[t].mult(this._o[t]),this._dc[t].mult(this._grad_tanh(this._c[t])),this._dc[t].add(h.mult(this._p_out.value,this._do[t])),t<i-1&&(this._dc[t].add(h.mult(this._p_in.value,this._di[t+1])),this._dc[t].add(h.mult(this._p_for.value,this._df[t+1])),this._dc[t].add(h.mult(this._dc[t+1],this._f[t+1]))),this._df[t]=this._dc[t].copy(),this._df[t].mult(t===0?this._c0:this._c[t-1]),this._df[t].mult(this._grad_sigmoid(this._fb[t],this._f[t])),this._di[t]=this._dc[t].copy(),this._di[t].mult(this._z[t]),this._di[t].mult(this._grad_sigmoid(this._ib[t],this._i[t])),this._dz[t]=this._dc[t].copy(),this._dz[t].mult(this._i[t]),this._dz[t].mult(this._grad_tanh(this._zb[t]));const d=this._dz[t].dot(this._w_z.value.t);if(d.add(this._di[t].dot(this._w_in.value.t)),d.add(this._df[t].dot(this._w_for.value.t)),d.add(this._do[t].dot(this._w_out.value.t)),t===0){this._diff_bptt();const s={};if(this._w_z.name&&(s[this._w_z.name]=this._dw_z),this._w_in.name&&(s[this._w_in.name]=this._dw_in),this._w_for.name&&(s[this._w_for.name]=this._dw_for),this._w_out.name&&(s[this._w_out.name]=this._dw_out),this._r_z.name&&(s[this._r_z.name]=this._dr_z),this._r_in.name&&(s[this._r_in.name]=this._dr_in),this._r_for.name&&(s[this._r_for.name]=this._dr_for),this._r_out.name&&(s[this._r_out.name]=this._dr_out),this._p_in.name&&(s[this._p_in.name]=this._dp_in),this._p_for.name&&(s[this._p_for.name]=this._dp_for),this._p_out.name&&(s[this._p_out.name]=this._dp_out),this._b_z.name&&(s[this._b_z.name]=this._db_z),this._b_in.name&&(s[this._b_in.name]=this._db_in),this._b_for.name&&(s[this._b_for.name]=this._db_for),this._b_out.name&&(s[this._b_out.name]=this._db_out),Object.keys(s).length>0)return[d,s]}return d}_diff_bptt(){const _=this._y.length,t=this._x[0].rows;this._dw_z=h.zeros(...this._w_z.sizes),this._dw_in=h.zeros(...this._w_in.sizes),this._dw_out=h.zeros(...this._w_out.sizes),this._dw_for=h.zeros(...this._w_for.sizes),this._db_z=h.zeros(1,this._size),this._db_in=h.zeros(1,this._size),this._db_out=h.zeros(1,this._size),this._db_for=h.zeros(1,this._size),this._dp_out=h.zeros(1,this._size);for(let i=0;i<_;i++){const d=this._x[i].tDot(this._dz[i]);d.div(t),this._dw_z.add(d);const s=this._x[i].tDot(this._di[i]);s.div(t),this._dw_in.add(s);const e=this._x[i].tDot(this._do[i]);e.div(t),this._dw_out.add(e);const n=this._x[i].tDot(this._df[i]);n.div(t),this._dw_for.add(n),this._db_z.add(this._dz[i].mean(0)),this._db_in.add(this._di[i].mean(0)),this._db_out.add(this._do[i].mean(0)),this._db_for.add(this._df[i].mean(0));const u=h.mult(this._dc[i],this._do[i]);this._dp_out.add(u.mean(0))}this._dr_z=h.zeros(this._size,this._size),this._dr_in=h.zeros(this._size,this._size),this._dr_out=h.zeros(this._size,this._size),this._dr_for=h.zeros(this._size,this._size),this._dp_in=h.zeros(1,this._size),this._dp_for=h.zeros(1,this._size);for(let i=0;i<_-1;i++){const d=this._y[i].tDot(this._dz[i+1]);d.div(t),this._dr_z.add(d);const s=this._y[i].tDot(this._di[i+1]);s.div(t),this._dr_in.add(s);const e=this._y[i].tDot(this._do[i+1]);e.div(t),this._dr_out.add(e);const n=this._y[i].tDot(this._df[i+1]);n.div(t),this._dr_for.add(n);const u=h.mult(this._dc[i],this._di[i+1]);this._dp_in.add(u.mean(0));const r=h.mult(this._dc[i],this._df[i+1]);this._dp_for.add(r.mean(0))}}update(_){this._w_z.name||this._w_z.value.sub(_.delta("w_z",this._dw_z)),this._w_in.name||this._w_in.value.sub(_.delta("w_i",this._dw_in)),this._w_out.name||this._w_out.value.sub(_.delta("w_o",this._dw_out)),this._w_for.name||this._w_for.value.sub(_.delta("w_f",this._dw_for)),this._r_z.name||this._r_z.value.sub(_.delta("r_z",this._dr_z)),this._r_in.name||this._r_in.value.sub(_.delta("r_i",this._dr_in)),this._r_out.name||this._r_out.value.sub(_.delta("r_o",this._dr_out)),this._r_for.name||this._r_for.value.sub(_.delta("r_f",this._dr_for)),this._p_out.name||this._p_out.value.sub(_.delta("p_o",this._dp_out)),this._p_in.name||this._p_in.value.sub(_.delta("p_i",this._dp_in)),this._p_for.name||this._p_for.value.sub(_.delta("p_f",this._dp_for)),this._b_z.name||this._b_z.value.sub(_.delta("b_z",this._db_z)),this._b_in.name||this._b_in.value.sub(_.delta("b_i",this._db_in)),this._b_out.name||this._b_out.value.sub(_.delta("b_o",this._db_out)),this._b_for.name||this._b_for.value.sub(_.delta("b_f",this._db_for))}toObject(){return{w_z:this._w_z?.toObject(),w_in:this._w_in?.toObject(),w_for:this._w_for?.toObject(),w_out:this._w_out?.toObject(),r_z:this._r_z?.toObject(),r_in:this._r_in?.toObject(),r_for:this._r_for?.toObject(),r_out:this._r_out?.toObject(),p_in:this._p_in?.toObject(),p_for:this._p_for?.toObject(),p_out:this._p_out?.toObject(),b_z:this._b_z?.toObject(),b_in:this._b_in?.toObject(),b_for:this._b_for?.toObject(),b_out:this._b_out?.toObject()}}}class o{static{b(this,"Variable")}constructor(_,t,i){this._layer=_,this._sizes=i,typeof t=="string"?this._name=t:t&&(this._value=h.fromArray(t))}get name(){return this._name}get value(){return this._value}get sizes(){return this._value.sizes}get(..._){return _.length===0&&(_=this._sizes),this._name?this._value=this._layer.graph.getNode(this._name).outputValue:this._value?this._value:this._value=h.randn(..._)}toObject(){return this._name?this._name:this._value?.toArray()}}O.registLayer("lstm");
