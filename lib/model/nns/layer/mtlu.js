var u=Object.defineProperty;var l=(a,s)=>u(a,"name",{value:s,configurable:!0});import o from"./base.js";export default class n extends o{static{l(this,"MultibinTrainableLinearUnitLayer")}constructor({a:s=1,b:h=0,c:i=null,k:t=10,...r}){super(r),this._k=t,this._a=Array.isArray(s)?s:Array(t+1).fill(s),this._b=Array.isArray(h)?h:Array(t+1).fill(h),this._c=i==null||Array.isArray(i)?i:Array(t).fill(i)}calc(s){if(!this._c){this._c=Array(this._k);const i=s.reduce((_,e)=>Math.max(_,e),-1/0),t=s.reduce((_,e)=>Math.min(_,e),1/0),r=(i-t)/(this._k+1);for(let _=0;_<this._k;_++)this._c[_]=t+r*(_+1)}this._i=s;const h=s.copy();return h.map(i=>{if(i<=this._c[0])return this._a[0]*i+this._b[0];for(let t=1;t<this._k;t++)if(i<=this._c[t])return this._a[t]*i+this._b[t];return this._a[this._k]*i+this._b[this._k]}),h}grad(s){this._bo=s;const h=s.copy();return h.broadcastOperate(this._i,(i,t)=>{if(t<=this._c[0])return i*this._a[0];for(let r=1;r<this._k;r++)if(t<=this._c[r])return i*this._a[r];return i*this._a[this._k]}),h}update(s){const h=Array(this._k+1).fill(0),i=Array(this._k+1).fill(0);for(let t=0;t<this._i.length;t++)if(this._i.value[t]<=this._c[0])h[0]+=this._bo.value[t]*this._i.value[t],i[0]+=this._bo.value[t];else if(this._i.value[t]>this._c[this._k-1])h[this._k]+=this._bo.value[t]*this._i.value[t],i[this._k]+=this._bo.value[t];else for(let r=1;r<this._k;r++)if(this._i.value[t]<=this._c[r]){h[r]+=this._bo.value[t]*this._i.value[t],i[r]+=this._bo.value[t];break}for(let t=0;t<=this._k;t++)this._a[t]-=s.delta(`a${t}`,h[t]/this._i.length),this._b[t]-=s.delta(`b${t}`,i[t]/this._i.length)}toObject(){return{type:"mtlu",a:this._a,b:this._b,c:this._c,k:this._k}}}n.registLayer("mtlu");
