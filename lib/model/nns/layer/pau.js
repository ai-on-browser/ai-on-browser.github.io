import Layer from"./base.js";export default class PadeActivationUnitLayer extends Layer{constructor({m:t=2,n:i=2,a:s=.1,b:a=0,...e}){super(e),this._m=t,this._n=i,this._a=Array.isArray(s)?s:Array(t+1).fill(s),this._b=Array.isArray(a)?a:Array(i).fill(a),this._l2_decay=.001}calc(t){this._i=t;const i=t.copy();return i.map((t=>this._a.reduce(((i,s,a)=>i+s*t**a),0)/(1+Math.abs(this._b.reduce(((i,s,a)=>i+s*t**(a+1)),0))))),i}grad(t){this._bo=t;const i=t.copy();return i.broadcastOperate(this._i,((t,i)=>{const s=this._a.reduce(((t,s,a)=>t+s*i**a),0),a=this._b.reduce(((t,s,a)=>t+s*i**(a+1)),0),e=1+Math.abs(a);return t*(this._a.reduce(((t,s,a)=>t+s*a*i**(a-1)),0)/e-Math.sign(a)*this._b.reduce(((t,s,a)=>t+s*(a+1)*i**a),0)*(s/e**2))})),i}update(t){const i=Array(this._m+1).fill(0),s=Array(this._n).fill(0);for(let t=0;t<this._i.length;t++){const a=this._a.reduce(((i,s,a)=>i+s*this._i.value[t]**a),0),e=this._b.reduce(((i,s,a)=>i+s*this._i.value[t]**(a+1)),0),r=1+Math.abs(e);for(let s=0;s<this._m;s++)i[s]+=this._bo.value[t]*this._i.value[t]**s;for(let i=0;i<this._n;i++)s[i]+=this._bo.value[t]*(-(this._i.value[t]**(i+1))*Math.sign(e)*(a/r**2))}for(let s=0;s<this._m+1;s++)this._a[s]-=t.delta(`a${s}`,i[s]/this._i.length);for(let i=0;i<this._n;i++)this._b[i]-=t.delta(`b${i+1}`,s[i]/this._i.length)}toObject(){return{type:"pau",m:this._m,n:this._n,a:this._a,b:this._b}}}PadeActivationUnitLayer.registLayer("pau");