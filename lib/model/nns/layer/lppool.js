var y=Object.defineProperty;var m=(f,i)=>y(f,"name",{value:i,configurable:!0});import k,{NeuralnetworkLayerException as p}from"./base.js";import c from"../../../util/tensor.js";export default class g extends k{static{m(this,"LpPoolLayer")}constructor({p:i=2,kernel:_,stride:d=null,padding:o=null,channel_dim:n=-1,...e}){if(super(e),this._p=i,this._kernel=_,this._stride=d||_,this._padding=o||0,this._channel_dim=n,this._channel_dim!==-1&&this._channel_dim!==1)throw new p("Invalid channel dimension.")}_index(i,_,d){return this._channel_dim===-1?[i,...d,_]:[i,_,...d]}calc(i){if(Array.isArray(this._kernel)||(this._kernel=Array(i.dimension-2).fill(this._kernel)),i.dimension!==this._kernel.length+2)throw new p("Invalid kernel size",[this,i]);if(Array.isArray(this._stride)||(this._stride=Array(i.dimension-2).fill(this._stride)),i.dimension!==this._stride.length+2)throw new p("Invalid stride size",[this,i]);if(Array.isArray(this._padding)?Array.isArray(this._padding[0])||(this._padding=this._padding.map(n=>[n,n])):this._padding=Array.from({length:i.dimension-2},()=>[this._padding,this._padding]),i.dimension!==this._padding.length+2)throw new p("Invalid padding size",[this,i]);this._i=i;const _=this._channel_dim===-1?1:2,d=[i.sizes[0],...this._kernel.map((n,e)=>Math.ceil(Math.max(0,i.sizes[e+_]+this._padding[e][0]+this._padding[e][1]-n)/this._stride[e])+1)];this._channel_dim===-1?d.push(i.sizes[i.dimension-1]):this._channel_dim===1&&d.splice(1,0,i.sizes[1]);const o=this._channel_dim===-1?i.sizes[i.dimension-1]:i.sizes[1];this._sp=new c(d);for(let n=0;n<i.sizes[0];n++)for(let e=0;e<o;e++){const h=Array(i.dimension-2).fill(0);do{const a=Array(i.dimension-2).fill(0);let r=0;do{const s=h.map((t,l)=>t*this._stride[l]-this._padding[l][0]+a[l]);s.every((t,l)=>0<=t&&t<i.sizes[l+_])&&(r+=Math.abs(i.at(this._index(n,e,s)))**this._p);for(let t=0;t<a.length&&(a[t]++,!(a[t]<this._kernel[t]));t++)a[t]=0}while(a.some(s=>s>0));this._sp.set(this._index(n,e,h),r);for(let s=0;s<h.length&&(h[s]++,!(h[s]<d[s+_]));s++)h[s]=0}while(h.some(a=>a>0))}return this._o=this._sp.copy(),this._o.map(n=>n**(1/this._p)),this._o}grad(i){this._bo=i,this._bi=new c(this._i.sizes);const _=this._channel_dim===-1?1:2,d=this._channel_dim===-1?this._i.sizes[this._i.dimension-1]:this._i.sizes[1];for(let o=0;o<this._i.sizes[0];o++)for(let n=0;n<d;n++){const e=Array(this._i.dimension-2).fill(0);do{const h=Array(this._i.dimension-2).fill(0),a=[];do{const r=e.map((s,t)=>s*this._stride[t]-this._padding[t][0]+h[t]);r.every((s,t)=>0<=s&&s<this._i.sizes[t+_])&&a.push(r);for(let s=0;s<h.length&&(h[s]++,!(h[s]<this._kernel[s]));s++)h[s]=0}while(h.some(r=>r>0));for(const r of a){const s=this._index(o,n,r),t=this._index(o,n,e);this._bi.operateAt(s,l=>l+this._bo.at(t)*this._sp.at(t)**(1/this._p-1)*this._i.at(s)**(this._p-1)*Math.sign(this._i.at(s))**this._p)}for(let r=0;r<e.length&&(e[r]++,!(e[r]<this._o.sizes[r+_]));r++)e[r]=0}while(e.some(h=>h>0))}return this._bi}toObject(){return{type:"lp_pool",p:this._p,kernel:this._kernel,stride:this._stride,padding:this._padding,channel_dim:this._channel_dim}}}g.registLayer();
