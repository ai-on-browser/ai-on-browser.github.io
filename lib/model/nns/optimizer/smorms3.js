var O=Object.defineProperty;var b=(i,o)=>O(i,"name",{value:o,configurable:!0});import d from"../../../util/matrix.js";export class SMORMS3Optimizer{static{b(this,"SMORMS3Optimizer")}constructor(o=.001){this._learningrate=o}set learningRate(o){this._learningrate=o}manager(){const o=this;return{get lr(){return o._learningrate},params:{},delta(r,s){const m=typeof s=="number";if(m&&(s=new d(1,1,s)),!this.params[r]){const t=s.copy();t.fill(0);const a=s.copy();a.fill(1),this.params[r]={s:a,m:t.copy(),v:t.copy()}}const p=this.params[r].s.copy();p.map(t=>1/(t+1)),this.params[r].m.broadcastOperate(p,(t,a)=>t*(1-a));const n=p.copy();n.broadcastOperate(s,(t,a)=>t*a),this.params[r].m.broadcastOperate(n,(t,a)=>t+a),this.params[r].v.broadcastOperate(p,(t,a)=>t*(1-a));const h=p.copy();h.broadcastOperate(s,(t,a)=>t*a**2),this.params[r].v.broadcastOperate(h,(t,a)=>t+a);const e=this.params[r].m.copy();e.broadcastOperate(this.params[r].v,(t,a)=>t**2/(a+1e-12)),this.params[r].s.broadcastOperate(e,(t,a)=>1+(1-a)*t);const c=e.copy();return c.broadcastOperate(this.params[r].v,(t,a)=>Math.min(this.lr,t)/Math.sqrt(a+1e-12)),c.broadcastOperate(s,(t,a)=>t*a),m?c.toScaler():c}}}}
