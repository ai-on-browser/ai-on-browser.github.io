var O=Object.defineProperty;var L=(A,t)=>O(A,"name",{value:t,configurable:!0});import e from"../util/matrix.js";export default class q{static{L(this,"Lasso")}constructor(t=.1,o="CD"){this._w=null,this._lambda=t,this._method=o}_soft_thresholding(t,o){t.map(s=>s<-o?s+o:s>o?s-o:0)}_calc_b0(t,o){const s=this._w.copy();for(let i=0;i<s.cols;i++)s.set(s.rows-1,i,0);const a=t.dot(s);a.isub(o);const h=a.sum(0);h.div(t.rows),this._w.set(this._w.rows-1,0,h)}fit(t,o){t=e.fromArray(t),o=e.fromArray(o),this._w||(this._w=e.randn(t.cols,o.cols)),this._method==="ISTA"?this._ista(t,o):this._method==="CD"?this._cd(t,o):this._method==="LARS"&&this._lars(t,o)}_ista(t,o){let s=t.tDot(t);s.map(n=>Math.abs(n)),s=s.sum(0);const h=Math.max.apply(null,s.value)/this._lambda;let i=t.dot(this._w);i.isub(o),i=t.tDot(i),i.div(this._lambda*h),this._w.add(i),this._soft_thresholding(this._w,1/h)}_cd(t,o){for(let s=0;s<this._w.rows;s++){const a=t.col(s);let h=this._w.copy();for(let n=0;n<this._w.cols;n++)h.set(s,n,0);h=t.dot(h),h.isub(o);const i=a.tDot(h);this._soft_thresholding(i,this._lambda),i.div(a.tDot(a)),this._w.set(s,0,i)}}_lars(t,o){const s=[],a=Array.from({length:t.cols},(r,_)=>_),h=e.zeros(t.rows,this._w.cols),i=e.zeros(this._w.rows,this._w.cols);let n=!1,k=0;for(;a.length>0;){let r=null;const _=t.tDot(e.sub(o,h));n||(r=a[e.map(_.row(a),Math.abs).argmax(0).toScaler()],s.push(r),a.splice(a.indexOf(r),1));const u=e.map(_,Math.abs).argmax(0).toScaler(),S=e.map(_.row(s),Math.sign),g=e.mult(t.col(s),S.t),y=g.tDot(g).inv(),w=1/Math.sqrt(y.sum()),b=y.sum(1);b.mult(w);const p=g.dot(b),z=t.tDot(p),D=e.mult(S,b);let m=u/w;if(k<t.cols-1){const l=e.zeros(a.length,2);for(let c=0;c<a.length;c++)l.set(c,0,(u-_.at(a[c],0))/(w-z.at(a[c],0))),l.set(c,1,(u+_.at(a[c],0))/(w+z.at(a[c],0)));m=e.map(l,c=>c<=0?1/0:c).min()}const d=i.row(s);d.div(D),d.mult(-1),d.map(l=>l<=0?1/0:l);const j=d.min();n=!1,j<m&&(m=j,r=s[d.argmin(0).toScaler()],n=!0);const M=i.row(s);M.add(e.mult(D,m));const v=r!==0?0:1,C=e.zeros(this._w.rows,this._w.cols);for(let l=0;l<s.length;l++)C.set(s[l],0,M.at(l,0));const I=Math.abs(t.col(v).tDot(e.sub(o,t.dot(C))).toScaler())*2/t.rows;if(I<this._lambda){const l=Math.abs(t.col(v).tDot(e.sub(o,t.dot(this._w))).toScaler())*2/t.rows;if(s.length<2&&l<this._lambda)break;const c=m*(this._lambda-l)/(I-l);for(let f=0;f<s.length;f++)i[s[f]]+=D.at(f,0)*c;h.add(e.mult(p,c)),this._w=i.copy();break}h.add(e.mult(p,m));for(let l=0;l<s.length;l++)i.addAt(s[l],0,M.at(l,0));this._w=i.copy(),n&&(s.splice(s.indexOf(r),1),a.push(r)),k=s.length}}predict(t){return t=e.fromArray(t),t.dot(this._w).toArray()}importance(){return this._w.value}}
