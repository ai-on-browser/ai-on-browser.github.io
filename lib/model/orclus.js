var y=Object.defineProperty;var u=(k,i)=>y(k,"name",{value:i,configurable:!0});import M from"../util/matrix.js";export default class A{static{u(this,"ORCLUS")}constructor(i,c,r){this._k=i,this._k0=c,this._l=r,this._alpha=.5,this._beta=null,this._d=(e,h)=>Math.sqrt(e.reduce((t,s,f)=>t+(s-h[f])**2,0))}_pdist(i,c,r){return Math.sqrt(r.reduce((e,h)=>e+(h.reduce((t,s,f)=>t+s*i[f],0)-h.reduce((t,s,f)=>t+s*c[f],0))**2,0))}fit(i){this._x=i;const c=this._x[0].length,r=[];for(let t=0;t<this._k0;t++)r.push(Math.floor(Math.random()*(this._x.length-t)));for(let t=r.length-1;t>=0;t--)for(let s=r.length-1;s>t;s--)r[t]<=r[s]&&r[s]++;this._s=r.map(t=>this._x[t]);let e=c,h=this._k0;this._e=[];for(let t=0;t<h;t++){this._e[t]=[];for(let s=0;s<e;s++)this._e[t][s]=Array(c).fill(0),this._e[t][s][s]=1}for(this._beta=Math.exp(-Math.log(c/this._l)*Math.log(1/this._alpha)/Math.log(this._k0/this._k));h>this._k;){const[t,s]=this._assign();this._s=t;for(let a=0;a<h;a++)this._e[a]=this._findVectors(s[a],e);const f=Math.max(this._k,h*this._alpha),m=Math.max(this._l,e*this._beta),[l,,n]=this._merge(s,f,m);this._s=l,this._e=n,e=m,h=this._s.length}}_assign(){const i=this._x[0].length,c=Array.from(this._s,()=>[]);for(let e=0;e<this._x.length;e++){let h=1/0,t=-1;for(let s=0;s<this._s.length;s++){const f=this._pdist(this._x[e],this._s[s],this._e[s]);f<h&&(h=f,t=s)}c[t].push(e)}const r=[];for(let e=0;e<c.length;e++){r[e]=Array(i).fill(0);for(let h=0;h<c[e].length;h++)for(let t=0;t<i;t++)r[e][t]+=this._x[c[e][h]][t];r[e]=r[e].map(h=>h/c[e].length)}return[r,c]}_findVectors(i,c){const r=this._x[0].length;return M.fromArray(i.map(t=>this._x[t])).cov().eigenVectors().slice(r-Math.ceil(c),r,1).t.toArray()}_merge(i,c,r){const e=this._x[0].length,h=Array.from(i,()=>[]),t=Array.from(i,()=>[]),s=Array.from(i,()=>[]);for(let l=0;l<i.length;l++)for(let n=l+1;n<i.length;n++){const a=i[l].concat(i[n]);h[l][n]=this._findVectors(a,r),t[l][n]=Array(e).fill(0);for(let o=0;o<a.length;o++)for(let _=0;_<e;_++)t[l][n][_]+=this._x[a[o]][_];t[l][n]=t[l][n].map(o=>o/a.length),s[l][n]=0;for(let o=0;o<a.length;o++)s[l][n]+=this._pdist(this._x[a[o]],t[l][n],h[l][n])**2;s[l][n]/=a.length}i=i.concat();const f=this._s.concat(),m=this._e.concat();for(;f.length>c;){let l=-1,n=-1,a=1/0;for(let o=0;o<s.length;o++)for(let _=o+1;_<s.length;_++)s[o][_]<a&&(a=s[o][_],l=o,n=_);f[l]=t[l][n],i[l]=i[l].concat(i[n]),m[l]=h[l][n],f.splice(n,1),i.splice(n,1),m.splice(n,1),t.splice(n,1),h.splice(n,1),s.splice(n,1);for(let o=0;o<f.length;o++)if(t[o].splice(n,1),h[o].splice(n,1),s[o].splice(n,1),o!==l){const _=o<l?o:l,g=o<l?l:o,p=i[_].concat(i[g]);h[_][g]=this._findVectors(p,r),t[_][g]=Array(e).fill(0);for(let d=0;d<p.length;d++)for(let x=0;x<e;x++)t[_][g][x]+=this._x[p[d]][x];t[_][g]=t[_][g].map(d=>d/p.length),s[_][g]=0;for(let d=0;d<p.length;d++)s[_][g]+=this._pdist(this._x[p[d]],t[_][g],h[_][g])**2;s[_][g]/=p.length}}return[f,i,m]}predict(i){const c=[];for(let r=0;r<i.length;r++){let e=1/0,h=-1;for(let t=0;t<this._s.length;t++){const s=this._pdist(i[r],this._s[t],this._e[t]);s<e&&(e=s,h=t)}c[r]=h}return c}}
