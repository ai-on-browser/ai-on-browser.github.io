import Matrix from"../util/matrix.js";const normal_random=function(t=0,r=1){const e=Math.sqrt(r),l=Math.random(),o=Math.random();return[Math.sqrt(-2*Math.log(l))*Math.cos(2*Math.PI*o)*e+t,Math.sqrt(-2*Math.log(l))*Math.sin(2*Math.PI*o)*e+t]};export class SNE{constructor(t,r=1){this._x=t,this._epoch=0,this._rd=r,this._learning_rate=.1,this._perplexity=100,this._y=[];for(let e=0;e<t.length;e++){this._y[e]=[];for(let t=0;t<r;t++)this._y[e][t]=normal_random(0,1e-4)[0]}}_pj_i(t){const r=t.length,e=[],l=[];for(let t=0;t<r;l[t++]=Array(r).fill(0));for(let e=0;e<r;e++)for(let o=e+1;o<r;o++)l[e][o]=l[o][e]=t[e].reduce(((r,e,l)=>r+(e-t[o][l])**2),0);for(let t=0;t<r;t++){let o=1,i=0,s=null;const n=1e-8;let a=Array(r).fill(0);for(;;){let e=0;const h=2*o**2;a[t]=0;for(let o=0;o<r;o++)t!==o&&(e+=a[o]=Math.exp(-l[t][o]/h));let f=0;for(let t=0;t<r;t++)a[t]/=e,a[t]>n&&(f-=a[t]*Math.log2(a[t]));if(!isFinite(o))break;const _=2**f;if(Math.abs(_-this._perplexity)<n)break;_<this._perplexity?(i=o,o=null===s?2*o:(o+s)/2):(s=o,o=(o+i)/2)}e.push(a)}return e}fit(){const t=this._x,r=this._y,e=t.length,l=this._pj_i(t),o=[];for(let t=0;t<e;t++){let l=0;o[t]=Array(e).fill(0);for(let i=0;i<e;i++){if(t===i)continue;const e=Math.exp(-r[t].reduce(((t,e,l)=>t+(e-r[i][l])**2),0));o[t][i]=e,l+=e}l>0&&(o[t]=o[t].map((t=>t/l)))}const i=this._rd,s=[];for(let t=0;t<e;t++){s[t]=Array(i).fill(0);for(let n=0;n<e;n++){if(n===t)continue;const e=l[t][n]-o[t][n]+l[n][t]-o[n][t];for(let l=0;l<i;l++)s[t][l]+=e*(r[t][l]-r[n][l])}}for(let t=0;t<e;t++)for(let e=0;e<i;e++)r[t][e]-=2*s[t][e]*this._learning_rate;return this._epoch+=1,new Matrix(e,i,this._y).toArray()}predict(){return Matrix.fromArray(this._y).toArray()}}export class tSNE{constructor(t,r=1){this._x=t,this._epoch=0,this._rd=r,this._learning_rate=200,this._perplexity=30,this._y=[];for(let e=0;e<t.length;e++){this._y[e]=[];for(let t=0;t<r;t++)this._y[e][t]=normal_random(0,1e-4)[0]}}_pj_i(t){const r=t.length,e=[],l=[];for(let t=0;t<r;l[t++]=Array(r).fill(0));for(let e=0;e<r;e++)for(let o=e+1;o<r;o++)l[e][o]=l[o][e]=t[e].reduce(((r,e,l)=>r+(e-t[o][l])**2),0);for(let t=0;t<r;t++){let o=1,i=0,s=null;const n=1e-8;let a=Array(r).fill(0);for(;;){let e=0;const h=2*o**2;a[t]=0;for(let o=0;o<r;o++)t!==o&&(e+=a[o]=Math.exp(-l[t][o]/h));let f=0;for(let t=0;t<r;t++)a[t]/=e,a[t]>n&&(f-=a[t]*Math.log2(a[t]));if(!isFinite(o))break;const _=2**f;if(Math.abs(_-this._perplexity)<n)break;_<this._perplexity?(i=o,o=null===s?2*o:(o+s)/2):(s=o,o=(o+i)/2)}e.push(a)}return e}fit(){const t=this._x,r=this._y,e=t.length,l=this._pj_i(t),o=[];for(let t=0;t<e;o[t++]=Array(e));for(let t=0;t<e;t++)for(let r=t;r<e;r++)o[t][r]=o[r][t]=(l[t][r]+l[r][t])/(2*e);const i=[];let s=0;for(let t=0;t<e;i[t++]=Array(e));for(let t=0;t<e;t++)for(let l=t;l<e;l++){const e=1/(1+r[t].reduce(((t,e,o)=>t+(e-r[l][o])**2),0));i[t][l]=i[l][t]=e,t!==l&&(s+=2*e)}const n=i.map((t=>t.map((t=>t/s)))),a=this._rd,h=[];for(let t=0;t<e;t++){h[t]=Array(a).fill(0);for(let l=0;l<e;l++){if(l===t)continue;const e=(o[t][l]-n[t][l])*i[t][l];for(let o=0;o<a;o++)h[t][o]+=e*(r[t][o]-r[l][o])}}for(let t=0;t<e;t++)for(let e=0;e<a;e++)r[t][e]-=4*h[t][e]*this._learning_rate;return this._epoch+=1,new Matrix(e,a,this._y).toArray()}predict(){return Matrix.fromArray(this._y).toArray()}}