var x=Object.defineProperty;var g=(u,a)=>x(u,"name",{value:a,configurable:!0});import j from"../util/matrix.js";const M=g(function(u=0,a=1){const l=Math.sqrt(a),c=Math.random(),s=Math.random(),h=Math.sqrt(-2*Math.log(c))*Math.cos(2*Math.PI*s),e=Math.sqrt(-2*Math.log(c))*Math.sin(2*Math.PI*s);return[h*l+u,e*l+u]},"normal_random");export class SNE{static{g(this,"SNE")}constructor(a,l=1,c=30){this._x=a,this._epoch=0,this._rd=l,this._learning_rate=.1,this._perplexity=c,this._y=[];for(let s=0;s<a.length;s++){this._y[s]=[];for(let h=0;h<l;h++)this._y[s][h]=M(0,1e-4)[0]}}_pj_i(a){const l=a.length,c=[],s=[];let h=1;for(let e=0;e<l;e++){s[e]=[],s[e][e]=0;for(let i=0;i<e;i++)s[e][i]=s[i][e]=a[e].reduce((r,n,_)=>r+(n-a[i][_])**2,0),s[e][i]>h&&(h=s[e][i])}for(let e=0;e<l;e++){let i=h,r=0,n=null;const _=1e-8;let t=Array(l).fill(0);for(;;){let o=0;const y=2*i**2;t[e]=0;for(let f=0;f<l;f++)e!==f&&(o+=t[f]=Math.exp(-s[e][f]/y));let p=0;for(let f=0;f<l;f++)t[f]/=o,t[f]>_&&(p-=t[f]*Math.log2(t[f]));if(!isFinite(i))break;const m=2**p;if(Math.abs(m-this._perplexity)<_)break;m<this._perplexity?(r=i,i=n===null?i*2:(i+n)/2):(n=i,i=(i+r)/2)}c.push(t)}return c}fit(){const a=this._x,l=this._y,c=a.length,s=this._pj_i(a),h=[];for(let r=0;r<c;r++){let n=0;h[r]=Array(c).fill(0);for(let _=0;_<c;_++){if(r===_)continue;const t=Math.exp(-l[r].reduce((o,y,p)=>o+(y-l[_][p])**2,0));h[r][_]=t,n+=t}n>0&&(h[r]=h[r].map(_=>_/n))}const e=this._rd,i=[];for(let r=0;r<c;r++){i[r]=Array(e).fill(0);for(let n=0;n<c;n++){if(n===r)continue;const _=s[r][n]-h[r][n]+s[n][r]-h[n][r];for(let t=0;t<e;t++)i[r][t]+=_*(l[r][t]-l[n][t])}}for(let r=0;r<c;r++)for(let n=0;n<e;n++)l[r][n]-=i[r][n]*2*this._learning_rate;return this._epoch+=1,new j(c,e,this._y).toArray()}predict(){return j.fromArray(this._y).toArray()}}export class tSNE{static{g(this,"tSNE")}constructor(a,l=1,c=30){this._x=a,this._epoch=0,this._rd=l,this._learning_rate=200,this._perplexity=c,this._y=[];for(let s=0;s<a.length;s++){this._y[s]=[];for(let h=0;h<l;h++)this._y[s][h]=M(0,1e-4)[0]}}_pj_i(a){const l=a.length,c=[],s=[];let h=1;for(let e=0;e<l;e++){s[e]=[],s[e][e]=0;for(let i=0;i<e;i++)s[e][i]=s[i][e]=a[e].reduce((r,n,_)=>r+(n-a[i][_])**2,0),s[e][i]>h&&(h=s[e][i])}for(let e=0;e<l;e++){let i=h,r=0,n=null;const _=1e-8;let t=Array(l).fill(0);for(;;){let o=0;const y=2*i**2;t[e]=0;for(let f=0;f<l;f++)e!==f&&(o+=t[f]=Math.exp(-s[e][f]/y));let p=0;for(let f=0;f<l;f++)t[f]/=o,t[f]>_&&(p-=t[f]*Math.log2(t[f]));if(!isFinite(i))break;const m=2**p;if(Math.abs(m-this._perplexity)<_)break;m<this._perplexity?(r=i,i=n===null?i*2:(i+n)/2):(n=i,i=(i+r)/2)}c.push(t)}return c}fit(){const a=this._x,l=this._y,c=a.length,s=this._pj_i(a),h=[];for(let t=0;t<c;t++){h[t]=[];for(let o=0;o<=t;o++)h[t][o]=h[o][t]=(s[t][o]+s[o][t])/(2*c)}const e=[];let i=0;for(let t=0;t<c;t++){e[t]=[];for(let o=0;o<=t;o++){const y=1/(1+l[t].reduce((p,m,f)=>p+(m-l[o][f])**2,0));e[t][o]=e[o][t]=y,t!==o&&(i+=y*2)}}const r=e.map(t=>t.map(o=>o/i)),n=this._rd,_=[];for(let t=0;t<c;t++){_[t]=Array(n).fill(0);for(let o=0;o<c;o++){if(o===t)continue;const y=(h[t][o]-r[t][o])*e[t][o];for(let p=0;p<n;p++)_[t][p]+=y*(l[t][p]-l[o][p])}}for(let t=0;t<c;t++)for(let o=0;o<n;o++)l[t][o]-=_[t][o]*4*this._learning_rate;return this._epoch+=1,new j(c,n,this._y).toArray()}predict(){return j.fromArray(this._y).toArray()}}
