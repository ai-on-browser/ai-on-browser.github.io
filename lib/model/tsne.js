var M=Object.defineProperty;var u=(g,h)=>M(g,"name",{value:h,configurable:!0});import d from"../util/matrix.js";const j=u((g=0,h=1)=>{const r=Math.sqrt(h),l=Math.random(),a=Math.random(),_=Math.sqrt(-2*Math.log(l))*Math.cos(2*Math.PI*a),e=Math.sqrt(-2*Math.log(l))*Math.sin(2*Math.PI*a);return[_*r+g,e*r+g]},"normal_random");export class SNE{static{u(this,"SNE")}constructor(h=1,r=30){this._epoch=0,this._rd=h,this._learning_rate=.1,this._perplexity=r}init(h){this._x=h,this._y=[];for(let r=0;r<h.length;r++){this._y[r]=[];for(let l=0;l<this._rd;l++)this._y[r][l]=j(0,1e-4)[0]}}_pj_i(h){const r=h.length,l=[],a=[];let _=1;for(let e=0;e<r;e++){a[e]=[],a[e][e]=0;for(let i=0;i<e;i++)a[e][i]=a[i][e]=h[e].reduce((s,n,f)=>s+(n-h[i][f])**2,0),a[e][i]>_&&(_=a[e][i])}for(let e=0;e<r;e++){let i=_,s=0,n=null;const f=1e-8,t=Array(r).fill(0);for(;;){let o=0;const y=2*i**2;t[e]=0;for(let c=0;c<r;c++)e!==c&&(o+=t[c]=Math.exp(-a[e][c]/y));let p=0;for(let c=0;c<r;c++)t[c]/=o,t[c]>f&&(p-=t[c]*Math.log2(t[c]));if(!isFinite(i))break;const m=2**p;if(Math.abs(m-this._perplexity)<f)break;m<this._perplexity?(s=i,i=n===null?i*2:(i+n)/2):(n=i,i=(i+s)/2)}l.push(t)}return l}fit(){const h=this._x,r=this._y,l=h.length,a=this._pj_i(h),_=[];for(let s=0;s<l;s++){let n=0;_[s]=Array(l).fill(0);for(let f=0;f<l;f++){if(s===f)continue;const t=Math.exp(-r[s].reduce((o,y,p)=>o+(y-r[f][p])**2,0));_[s][f]=t,n+=t}n>0&&(_[s]=_[s].map(f=>f/n))}const e=this._rd,i=[];for(let s=0;s<l;s++){i[s]=Array(e).fill(0);for(let n=0;n<l;n++){if(n===s)continue;const f=a[s][n]-_[s][n]+a[n][s]-_[n][s];for(let t=0;t<e;t++)i[s][t]+=f*(r[s][t]-r[n][t])}}for(let s=0;s<l;s++)for(let n=0;n<e;n++)r[s][n]-=i[s][n]*2*this._learning_rate;return this._epoch+=1,new d(l,e,this._y).toArray()}predict(){return d.fromArray(this._y).toArray()}}export class tSNE{static{u(this,"tSNE")}constructor(h=1,r=30){this._epoch=0,this._rd=h,this._learning_rate=200,this._perplexity=r}init(h){this._x=h,this._y=[];for(let r=0;r<h.length;r++){this._y[r]=[];for(let l=0;l<this._rd;l++)this._y[r][l]=j(0,1e-4)[0]}}_pj_i(h){const r=h.length,l=[],a=[];let _=1;for(let e=0;e<r;e++){a[e]=[],a[e][e]=0;for(let i=0;i<e;i++)a[e][i]=a[i][e]=h[e].reduce((s,n,f)=>s+(n-h[i][f])**2,0),a[e][i]>_&&(_=a[e][i])}for(let e=0;e<r;e++){let i=_,s=0,n=null;const f=1e-8,t=Array(r).fill(0);for(;;){let o=0;const y=2*i**2;t[e]=0;for(let c=0;c<r;c++)e!==c&&(o+=t[c]=Math.exp(-a[e][c]/y));let p=0;for(let c=0;c<r;c++)t[c]/=o,t[c]>f&&(p-=t[c]*Math.log2(t[c]));if(!isFinite(i))break;const m=2**p;if(Math.abs(m-this._perplexity)<f)break;m<this._perplexity?(s=i,i=n===null?i*2:(i+n)/2):(n=i,i=(i+s)/2)}l.push(t)}return l}fit(){const h=this._x,r=this._y,l=h.length,a=this._pj_i(h),_=[];for(let t=0;t<l;t++){_[t]=[];for(let o=0;o<=t;o++)_[t][o]=_[o][t]=(a[t][o]+a[o][t])/(2*l)}const e=[];let i=0;for(let t=0;t<l;t++){e[t]=[];for(let o=0;o<=t;o++){const y=1/(1+r[t].reduce((p,m,c)=>p+(m-r[o][c])**2,0));e[t][o]=e[o][t]=y,t!==o&&(i+=y*2)}}const s=e.map(t=>t.map(o=>o/i)),n=this._rd,f=[];for(let t=0;t<l;t++){f[t]=Array(n).fill(0);for(let o=0;o<l;o++){if(o===t)continue;const y=(_[t][o]-s[t][o])*e[t][o];for(let p=0;p<n;p++)f[t][p]+=y*(r[t][p]-r[o][p])}}for(let t=0;t<l;t++)for(let o=0;o<n;o++)r[t][o]-=f[t][o]*4*this._learning_rate;return this._epoch+=1,new d(l,n,this._y).toArray()}predict(){return d.fromArray(this._y).toArray()}}
