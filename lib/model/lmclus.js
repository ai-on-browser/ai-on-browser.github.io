var w=Object.defineProperty;var j=(b,t)=>w(b,"name",{value:t,configurable:!0});import y from"../util/matrix.js";export default class q{static{j(this,"LMCLUS")}constructor(t,l,n){this._k=t,this._s=l,this._gamma=n}get size(){return this._c.length}fit(t){this._c=[],this._dims=[];const l=t.concat(),n=Array(l.length).fill(!1);for(;n.some(e=>!e);){let e=[];for(let r=0;r<n.length;r++)n[r]||e.push(r);let o=e.map(r=>l[r]),g=1;for(let r=1;r<=this._k;r++){const[m,h,c,f]=this._findSeparation(o,r,this._s);if(m<=this._gamma)break;const i=[],u=[];for(let a=0;a<o.length;a++){const d=new y(o[a].length,1,o[a].map((_,M)=>_-c[M])),s=f.dot(d);d.tDot(d).toScaler()-s.tDot(s).toScaler()<h&&(i.push(o[a]),u.push(e[a]))}o=i,g=r,e=u}if(o.length!==0){this._c.push(e),this._dims.push(g);for(let r=0;r<e.length;r++)n[e[r]]=!0}}}_sampleidx(t,l){const n=[];for(let e=0;e<l;e++)n.push(Math.floor(Math.random()*(t-e)));for(let e=n.length-1;e>=0;e--)for(let o=n.length-1;o>e;o--)n[e]<=n[o]&&n[o]++;return n}_findSeparation(t,l,n){let e=-1/0,o=-1/0,g=null,r=null;const c=Math.min(Math.log(1e-8)/Math.log(1-(1/n)**l),1*t.length);for(let f=0;f<c;f++){const i=this._sampleidx(t.length,l+1),u=i.map(p=>t[p]),[a]=y.fromArray(u).qrGramSchmidt(),d=[];for(let p=0;p<t.length;p++){if(i.includes(p))continue;const x=new y(t[p].length,1,t[p]),S=a.dot(x),k=x.tDot(x).toScaler()-S.tDot(S).toScaler();d.push(k)}const[s,I]=this._makeHistogram(d),[_,M]=this._findMinimumErrorThreshold(s,I);M>e&&(e=M,o=_,g=u[0],r=a)}return[e,o,g,r]}_makeHistogram(t){let l=-1/0,n=1/0,e=0;for(let i=0;i<t.length;i++)l=Math.max(l,t[i]),n=Math.min(n,t[i]),e+=t[i];const o=e/t.length;let g=0;for(let i=0;i<t.length;i++)g+=(o-t[i])**2;g/=t.length;const m=Math.sqrt(g)*Math.cbrt(24*Math.sqrt(Math.PI)/t.length),h=[n];for(;h[h.length-1]<l;)h[h.length]=h[h.length-1]+m;const c=h.length-1,f=Array(c).fill(0);for(let i=0;i<t.length;i++)t[i]===l?f[c-1]++:f[Math.floor((t[i]-n)/m)]++;return[f,h]}_findMinimumErrorThreshold(t,l){let n=-1,e=1/0,o=-1/0,g=0;for(let m=0;m<t.length-1;m++){let h=0,c=0,f=0,i=0;for(let s=0;s<t.length;s++)s<=m?(h+=t[s],f+=s*t[s]):(c+=t[s],i+=s*t[s]);f/=h,i/=c;let u=0,a=0;for(let s=0;s<t.length;s++)s<=m?u+=(s-f)**2*t[s]:a+=(s-i)**2*t[s];u/=h,a/=c;const d=1+2*(h*Math.log(Math.sqrt(u))+c*Math.log(Math.sqrt(a)))-2*(h*Math.log(h)+c*Math.log(c));d<e&&(e=d,n=m,g=(f-i)**2/(u+a)),o=Math.max(o,d)}const r=g*(o-e);return[l[n+1],r]}predict(){const t=[];for(let l=0;l<this._c.length;l++)for(let n=0;n<this._c[l].length;n++)t[this._c[l][n]]=l;return t}}
