var M=Object.defineProperty;var j=(v,m)=>M(v,"name",{value:m,configurable:!0});import d from"../util/matrix.js";export default class W{static{j(this,"MLLE")}constructor(m=1){this._k=m}predict(m,k=0){const u=d.fromArray(m),y=u.cols,r=u.rows,a=[],p=[];for(let t=0;t<r;a[t++]=[]);for(let t=0;t<r;t++){for(let e=t+1;e<r;e++){let i=0;for(let n=0;n<y;n++)i+=(u.at(t,n)-u.at(e,n))**2;a[t][e]=a[e][t]=i}const s=[];for(let e=0;e<r;e++){if(e===t)continue;const i=a[t][e];if(s.length<this._k||i<s[this._k-1].dt){s.length===this._k&&s.pop(),s.push({dt:i,idx:e});for(let n=s.length-1;n>0;n--)s[n].dt<s[n-1].dt&&([s[n],s[n-1]]=[s[n-1],s[n]])}}p.push(s)}const b=[],_=[],w=[],l=[],z=1e-8;for(let t=0;t<r;t++){const s=u.row(p[t].map(c=>c.idx));s.sub(u.row(t));const e=s.dot(s.t),[i,n]=e.eigen();b.push(n),_.push(i);const h=i.slice(k).reduce((c,o)=>c+o,0)/i.slice(0,k).reduce((c,o)=>c+o,0);l.push(h);const g=s.norm();for(let c=0;c<this._k;c++)e.addAt(c,c,z*g);const f=e.inv().sum(1);f.div(f.sum()),w.push(f)}l.sort((t,s)=>t-s);const L=l.length%2===1?l[(l.length-1)/2]:(l[l.length/2]+l[l.length/2+1])/2,x=d.zeros(r,r);for(let t=0;t<r;t++){let s=-1;const e=[_[t][0]];for(let o=1;o<this._k;o++)e[o]=e[o-1]+_[t][o];for(let o=1;o<this._k-k&&!((e[this._k-1]-e[this._k-o-1])/e[this._k-o-1]>=L);o++)s=o;const i=b[t].slice(this._k-s,null,1),n=i.sum(0).norm(),h=i.sum(0);h.isub(n),h.div(h.norm());const g=d.eye(s,s);g.sub(d.mult(h.dot(h.t),2));const f=i.dot(g);f.add(d.mult(w[t],1-n));const c=d.zeros(r,s);for(let o=0;o<this._k;o++)c.set(p[t][o].idx,0,f.row(o));for(let o=0;o<s;o++)c.subAt(t,o,1);x.sub(c.dot(c.t))}const A=x.eigenVectors();return A.flip(1),A.slice(1,k+1,1).toArray()}}
