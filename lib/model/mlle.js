var M=Object.defineProperty;var y=(v,m)=>M(v,"name",{value:m,configurable:!0});import f from"../util/matrix.js";export default class W{static{y(this,"MLLE")}constructor(m,h=null){this._k=m,this._rd=h}predict(m){const h=f.fromArray(m),b=h.cols,c=h.rows,k=this._rd||b,a=[],p=[];for(let t=0;t<c;a[t++]=[]);for(let t=0;t<c;t++){for(let e=t+1;e<c;e++){let i=0;for(let n=0;n<b;n++)i+=(h.at(t,n)-h.at(e,n))**2;a[t][e]=a[e][t]=i}const s=[];for(let e=0;e<c;e++){if(e===t)continue;const i=a[t][e];if(s.length<this._k||i<s[this._k-1].dt){s.length===this._k&&s.pop(),s.push({dt:i,idx:e});for(let n=s.length-1;n>0;n--)s[n].dt<s[n-1].dt&&([s[n],s[n-1]]=[s[n-1],s[n]])}}p.push(s)}const w=[],_=[],x=[],l=[],z=1e-8;for(let t=0;t<c;t++){const s=h.row(p[t].map(r=>r.idx));s.sub(h.row(t));const e=s.dot(s.t),[i,n]=e.eigen();w.push(n),_.push(i);const d=i.slice(k).reduce((r,o)=>r+o,0)/i.slice(0,k).reduce((r,o)=>r+o,0);l.push(d);const g=s.norm();for(let r=0;r<this._k;r++)e.addAt(r,r,z*g);const u=e.inv().sum(1);u.div(u.sum()),x.push(u)}l.sort((t,s)=>t-s);const L=l.length%2===1?l[(l.length-1)/2]:(l[l.length/2]+l[l.length/2+1])/2,A=f.zeros(c,c);for(let t=0;t<c;t++){let s=-1;const e=[_[t][0]];for(let o=1;o<this._k;o++)e[o]=e[o-1]+_[t][o];for(let o=1;o<this._k-k&&!((e[this._k-1]-e[this._k-o-1])/e[this._k-o-1]>=L);o++)s=o;const i=w[t].slice(this._k-s,null,1),n=i.sum(0).norm(),d=i.sum(0);d.isub(n),d.div(d.norm());const g=f.eye(s,s);g.sub(f.mult(d.dot(d.t),2));const u=i.dot(g);u.add(f.mult(x[t],1-n));const r=f.zeros(c,s);for(let o=0;o<this._k;o++)r.set(p[t][o].idx,0,u.row(o));for(let o=0;o<s;o++)r.subAt(t,o,1);A.sub(r.dot(r.t))}const j=A.eigenVectors();return j.flip(1),j.slice(1,k+1,1).toArray()}}
