import{Matrix}from"../util/math.js";const f=(t,r,l,e,s,o)=>{const n=t/2,h=2*Math.PI/t;if(t>1){for(let t=0;t<n;t++){const e=Math.cos(t*h),o=-Math.sin(t*h),a=r[t+s],f=l[t+s],i=r[t+s+n],c=l[t+s+n];r[t+s]=a+i,l[t+s]=f+c,r[t+s+n]=(a-i)*e-(f-c)*o,l[t+s+n]=(f-c)*e+(a-i)*o}f(t/2,r,l,2*e,s,o),f(t/2,r,l,2*e,s+n,o+e)}else s>o&&([r[s],r[o]]=[r[o],r[s]],[l[s],l[o]]=[l[o],l[s]])},fft=(t,r=null)=>{const l=t.length;if(!Number.isInteger(Math.log2(l)))throw"Invalid value length.";return r||(r=Array(l).fill(0)),f(l,t,r,1,0,0),[t,r]},ifft=(t,r)=>(r=r.map((t=>-t)),f(t.length,t,r,1,0,0),t=t.map((r=>r/t.length)),r=r.map((r=>-r/t.length)),[t,r]);export class LowpassFilter{constructor(t=.5){this._c=t}_cutoff(t,r,l,e){return t>=r?[0,0]:[l,e]}_lowpass(t){const[r,l]=fft(t),e=t.length/2,s=Math.floor(e*(1-this._c));for(let o=1;o<=e;o++)[r[o],l[o]]=this._cutoff(o,s,r[o],l[o]),o!==e&&([r[t.length-o],l[t.length-o]]=this._cutoff(o,s,r[t.length-o],l[t.length-o]));const[o,n]=(h=r,a=(a=l).map((t=>-t)),f(h.length,h,a,1,0,0),h=h.map((t=>t/h.length)),a=a.map((t=>-t/h.length)),[h,a]);var h,a;return o}_predict(t){const r=t.length,l=Math.log2(r);if(Number.isInteger(l))return this._lowpass(t);const e=2**Math.floor(l),s=t.length-e,o=Math.floor(s/2),n=this._lowpass(t.slice(0,e)),h=this._lowpass(t.slice(o,o+e)),a=this._lowpass(t.slice(s)),f=[];for(let t=0;t<e/2;t++)f[t]=f[e-t-1]=t+1;const i=[];for(let t=0;t<r;t++)i[t]=t<o?n[t]:t<s?(n[t]*f[t]+h[t-o]*f[t-o])/(f[t]+f[t-o]):t>=o+e?a[t-s]:t>=e?(h[t-o]*f[t-o]+a[t-s]*f[t-s])/(f[t-o]+f[t-s]):(n[t]*f[t]+h[t-o]*f[t-o]+a[t-s]*f[t-s])/(f[t]+f[t-o]+f[t-s]);return i}predict(t){t=Matrix.fromArray(t);for(let r=0;r<t.cols;r++){const l=Matrix.fromArray(this._predict(t.col(r).value));t.set(0,r,l)}return t.toArray()}}