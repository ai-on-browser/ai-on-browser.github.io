import{Matrix}from"../util/math.js";export class ProbabilisticPCA{constructor(t="analysis",s){this._method=t,this._rd=s}fit(t){t=Matrix.fromArray(t),"analysis"===this._method?this._analysis(t):"em"===this._method?this._em(t):"bayes"===this._method&&this._bayes(t)}_analysis(t){this._m=t.mean(0);const s=t.cov(),[i,h]=s.eigen();this._sigma=0;for(let t=this._rd;t<i.length;t++)this._sigma+=i[t]/(i.length-this._rd);const _=i.slice(0,this._rd).map((t=>Math.sqrt(t-this._sigma)));this._w=h.slice(0,this._rd,1).dot(Matrix.diag(_))}_em(t){this._w||(this._w=Matrix.eye(t.cols,this._rd),this._sigma=0,this._m=t.mean(0)),t=t.copySub(this._m);const s=this._w.tDot(this._w);s.add(Matrix.eye(this._rd,this._rd,this._sigma));const i=s.inv(),h=t.dot(this._w).dot(i.t),_=i.copyMult(this._sigma*t.rows);_.add(h.tDot(h)),this._w=t.tDot(h).dot(_.inv()),this._sigma=(t.copyMult(t).sum()-2*h.copyMult(t.dot(this._w)).sum()+_.copyMult(this._w.tDot(this._w).t).sum())/(t.rows*t.cols)}_bayes(t){this._w||(this._w=Matrix.eye(t.cols,this._rd),this._sigma=0,this._m=t.mean(0),this._alpha=Matrix.ones(1,this._rd).value),t=t.copySub(this._m);const s=this._w.tDot(this._w);s.add(Matrix.eye(this._rd,this._rd,this._sigma));const i=s.inv(),h=t.dot(this._w).dot(i.t),_=i.copyMult(this._sigma*t.rows);_.add(h.tDot(h));const o=Matrix.diag(this._alpha);o.mult(this._sigma),this._w=t.tDot(h).dot(_.copyAdd(o).inv()),this._sigma=(t.copyMult(t).sum()-2*h.copyMult(t.dot(this._w)).sum()+_.copyMult(this._w.tDot(this._w).t).sum())/(t.rows*t.cols),this._alpha=this._w.copyMult(this._w).sum(0).value.map((s=>t.cols/s))}predict(t){(t=Matrix.fromArray(t)).sub(this._m);const s=this._w.tDot(this._w),i=this._w.cols;return s.add(Matrix.eye(i,i,this._sigma)),t.dot(this._w).dot(s.inv()).toArray()}}