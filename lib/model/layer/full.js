import Layer from"./base.js";import{Matrix}from"../../util/math.js";import ActivationLayer from"./activation.js";export default class FullyConnected extends Layer{constructor({in_size:t=null,out_size:i,w:s=null,b:a=null,activation:_=null,l2_decay:o=0,l1_decay:c=0,activation_params:h={},...e}){super(e),this._in_size=t,this._out_size=i,this._w=s?Matrix.fromArray(s):null,this._b=a?Matrix.fromArray(a):Matrix.randn(1,i),this._activation=_,_&&(this._activation_func=new ActivationLayer({activation:_,...h})),this._l2_decay=o,this._l1_decay=c}calc(t){return this._w||(this._w=Matrix.randn(t.cols,this._out_size)),this._i=t,this._o=t.dot(this._w),this._o.add(this._b),this._activation_func?this._activation_func.calc(this._o):this._o}grad(t){return this._bo=t,this._activation_func&&(this._bo=this._activation_func.grad(t)),this._bi=this._bo.dot(this._w.t),this._bi}update(t){const i=this._i.tDot(this._bo);if(i.div(this._i.rows),this._l2_decay>0||this._l1_decay>0)for(let t=0;t<i.rows;t++)for(let s=0;s<i.cols;s++){const a=this._w.at(t,s);i.addAt(t,s,a*this._l2_decay+Math.sign(a)*this._l1_decay)}this._w.sub(t.delta("w",i));const s=this._bo.sum(0);s.div(this._i.rows),this._b.sub(t.delta("b",s))}toObject(){return{type:"full",in_size:this._in_size,out_size:this._out_size,w:this._w?.toArray(),b:this._b.toArray(),activation:this._activation,l2_decay:this._l2_decay,l1_decay:this._l1_decay,activation_params:this._activation_func?.toObject()}}}FullyConnected.registLayer("full");