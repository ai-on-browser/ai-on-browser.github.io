import Layer from"./base.js";import{Matrix}from"../../util/math.js";import ActivationLayer from"./activation.js";export default class FullyConnected extends Layer{constructor({in_size:t=null,out_size:i,w:s=null,b:_=null,activation:a=null,l2_decay:o=0,l1_decay:h=0,activation_params:c={},...e}){super(e),this._in_size=t,this._out_size=i,this._w=s?Matrix.fromArray(s):null,this._b=_?Matrix.fromArray(_):Matrix.randn(1,i),this._activation=a,a&&(this._activation_func=new ActivationLayer({activation:a,...c})),this._l2_decay=o,this._l1_decay=h}calc(t){return this._w||(this._w=Matrix.randn(t.cols,this._out_size)),this._i=t,this._o=t.dot(this._w),this._o.add(this._b),this._activation_func?this._activation_func.calc(this._o):this._o}grad(t){return this._bo=t,this._activation_func&&(this._bo=this._activation_func.grad(t)),this._bi=this._bo.dot(this._w.t),this._bi}update(){const t=this._i.tDot(this._bo);if(t.div(this._i.rows),this._l2_decay>0||this._l1_decay>0)for(let i=0;i<t.rows;i++)for(let s=0;s<t.cols;s++){const _=this._w.at(i,s);t.addAt(i,s,_*this._l2_decay+Math.sign(_)*this._l1_decay)}this._w.sub(this._opt.delta("w",t));const i=this._bo.sum(0);i.div(this._i.rows),this._b.sub(this._opt.delta("b",i))}toObject(){return{type:"full",in_size:this._in_size,out_size:this._out_size,w:this._w?.toArray(),b:this._b.toArray(),activation:this._activation,l2_decay:this._l2_decay,l1_decay:this._l1_decay,activation_params:this._activation_func?.toObject()}}}FullyConnected.registLayer("full");