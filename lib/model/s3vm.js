var b=Object.defineProperty;var p=(l,i)=>b(l,"name",{value:i,configurable:!0});import u from"../util/matrix.js";const k={gaussian:(l=1)=>(i,o)=>{let _=i.reduce((e,t,h)=>e+(t-o[h])**2,0);return Math.exp(-_/(2*l*l))},linear:()=>(l,i)=>l.reduce((o,_,e)=>o+_*i[e],0)};export default class C{static{p(this,"S3VM")}constructor(i){this._b=0,this._s=3,this._gammas=null,this._rate=.1,this._C=1,this._Cs=1,typeof i=="function"?this._kernel=i:(typeof i=="string"&&(i={name:i}),i.name==="gaussian"?this._kernel=k.gaussian(i.d):this._kernel=k.linear())}init(i,o){this._x=i.map(t=>t.concat()),this._t=o;const _=this._x.length;this._a=u.randn(_,1).value,this._m=Array(this._x[0].length).fill(0);let e=0;for(let t=0;t<_;t++)if(this._t[t])this._b+=this._t[t];else{for(let h=0;h<this._x[t].length;h++)this._m[h]+=this._x[t][h];e++}this._m=this._m.map(t=>t/e);for(let t=0;t<_;t++)for(let h=0;h<this._x[t].length;h++)this._x[t][h]-=this._m[h];this._b/=this._x.length-e,this._k=[];for(let t=0;t<_;this._k[t++]=[]);for(let t=0;t<_;t++)for(let h=t;h<_;h++)this._k[t][h]=this._k[h][t]=this._kernel(this._x[t],this._x[h])}fit(){this._fit_continuation()}_fit_continuation(){const i=this._x.length;if(!this._gammas){const s=u.zeros(i,i);let n=0;for(let r=0;r<i;r++){if(this._t[r])continue;const x=new u(i,1,this._k[r]),d=x.dot(x.t),g=x.norm();d.div(g**3),s.add(d),n<g&&(n=g)}const[a]=s.eigenPowerIteration(),c=Math.cbrt((this._Cs*a)**2/(2*this._s)),f=1/(20*this._s*n**2);this._gammas=[];const M=11;for(let r=0;r<=10;r++)this._gammas[r]=(f/c)**(r/(M-1))*c;this._gamma_idx=0}const o=this._gammas[this._gamma_idx],_=[],e=[],t=[];for(let s=0;s<i;s++){const n=this._k[s].reduce((a,c)=>a+c**2,0);_[s]=this._k[s].reduce((a,c,f)=>a+this._a[f]*c,0)+this._b,e[s]=1+2*o*this._s*n,this._t[s]&&(t[s]=(this._t[s]*_[s]-1)/Math.sqrt(2*o*n))}const h=this._a.concat();for(let s=0;s<i;s++){let n;this._t[s]?n=this._C/2*this._erfc(t[s])*this._t[s]:n=this._Cs*(2*this._s*_[s]/e[s]**(3/2))*Math.exp(-this._s*_[s]**2/e[s]);for(let a=0;a<i;a++)h[a]-=n*this._k[s][a]}const m=h.reduce((s,n)=>s+n**2,0);this._a=this._a.map((s,n)=>s-this._rate*h[n]),m<1e-4&&this._gamma_idx<this._gammas.length-1&&this._gamma_idx++}_erfc(i){const o=.3275911,_=.254829592,e=-.284496736,t=1.421413741,h=-1.453152027,m=1.061405429,s=i<0?-1:1,n=Math.abs(i),a=1/(1+o*n),c=1-((((m*a+h)*a+t)*a+e)*a+_)*a*Math.exp(-n*n);return 1-s*c}predict(i){const o=this._x.length;return i.map(_=>{_=_.map((t,h)=>t-this._m[h]);let e=0;for(let t=0;t<o;t++)e+=this._a[t]*this._kernel(_,this._x[t]);return e+this._b})}}
