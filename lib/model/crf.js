var u=Object.defineProperty;var p=(c,n)=>u(c,"name",{value:n,configurable:!0});import g from"../util/matrix.js";export default class w{static{p(this,"CRF")}constructor(){this._xn=0,this._yn=0,this._w=null,this._e=.1,this._x_cand=[],this._y_cand=[],this._phi=(n,s,h)=>{n=this._x_cand.indexOf(n),s=s===void 0?this._yn-1:this._y_cand.indexOf(s),h=h===void 0?this._yn-1:this._y_cand.indexOf(h);const _=Array(this._xn*this._yn*this._yn).fill(0);n>=0&&s>=0&&h>=0&&(_[n*this._yn*this._yn+s*this._yn+h]=1);const i=Array(this._xn*this._yn).fill(0);n>=0&&s>=0&&(i[n*this._yn+s]=1);const l=Array(this._yn*this._yn).fill(0);return s>=0&&h>=0&&(l[s*this._yn+h]=1),[].concat(l,i,_)}}_psi(n,s,h){const _=this._phi(n,s,h);let i=0;for(let l=0;l<_.length;l++)i+=this._w[l]*_[l];return Math.exp(i)}_alpha(n,s=!1){const h=[Array(this._yn).fill(1)],_=s&&[1];for(let i=0;i<n.length;i++){const l=[];for(let t=0;t<this._yn;t++){l[t]=0;for(let e=0;e<this._yn;e++)l[t]+=h[i][e]*this._psi(n[i],this._y_cand[t],this._y_cand[e])}h[i+1]=l,_&&(_[i]=l.reduce((t,e)=>t+e,0),h[i+1]=l.map(t=>t/_[i]))}return s?[h,_]:h}_beta(n,s=!1){const h=[];h[n.length]=Array(this._yn).fill(1);const _=s&&[];s&&(_[n.length]=1);for(let i=n.length-1;i>=0;i--){const l=[];for(let t=0;t<this._yn;t++){l[t]=0;for(let e=0;e<this._yn;e++)l[t]+=h[i+1][e]*this._psi(n[i],this._y_cand[e],this._y_cand[t])}h[i]=l,_&&(_[i]=l.reduce((t,e)=>t+e,0),h[i]=l.map(t=>t/_[i]))}return s?[h,_]:h}_z(n){const s=this._alpha(n);return s[s.length-1].reduce((_,i)=>_+i,0)}_p(n,s=!1){let h,_;s?[h,_]=this._alpha(n,!0):h=this._alpha(n);let i,l;s?[i,l]=this._beta(n,!0):i=this._beta(n);let t;s?t=1:t=1/this._z(n);const e=[];for(let r=n.length-1;r>=0;r--){e[r]=[],s&&(t*=l[r]/_[r]);for(let f=0;f<this._yn;f++){e[r][f]=[];for(let a=0;a<this._yn;a++)e[r][f][a]=this._psi(n[r],this._y_cand[f],this._y_cand[a])*h[r][a]*i[r][f]*t}}return e}fit(n,s){if(!this._w){const i=new Set,l=new Set;for(let e=0;e<n.length;e++)for(let r=0;r<n[e].length;r++)i.add(n[e][r]),l.add(s[e][r]);this._x_cand=[...i],this._y_cand=[...l],this._xn=this._x_cand.length,this._yn=this._y_cand.length+1;const t=this._phi(n[0][1],s[0][1],s[0][0]);this._w=g.randn(t.length,1).value}const h=this._w.length,_=Array(h).fill(0);for(let i=0;i<n.length;i++){const l=this._p(n[i],!0);for(let t=0;t<n[i].length;t++){const e=this._phi(n[i][t],s[i][t],s[i][t-1]);for(let r=0;r<this._yn;r++)for(let f=0;f<this._yn;f++){const a=this._phi(n[i][t],this._y_cand[r],this._y_cand[f]);for(let o=0;o<h;o++)e[o]-=l[t][r][f]*a[o]}for(let r=0;r<h;r++)_[r]+=e[r]}}for(let i=0;i<h;i++)this._w[i]+=this._e*_[i]/n.length}probability(n,s){const h=this._z(n),_=this._phi(n[0],s[0],void 0);for(let i=1;i<n.length;i++){const l=this._phi(n[i],s[i],s[i-1]);for(let t=0;t<l.length;t++)_[t]+=l[t]}return Math.exp(_.reduce((i,l,t)=>i+l*this._w[t],0))/h}predict(n){const s=[];for(let h=0;h<n.length;h++){const _=[Array(this._yn).fill(0)],i=[];for(let t=0;t<n[h].length;t++){_[t+1]=[],i[t]=[];for(let e=0;e<this._yn;e++){_[t+1][e]=-1/0,i[t][e]=null;for(let r=0;r<this._yn;r++){const f=this._phi(n[h][t],this._y_cand[e],this._y_cand[r]),a=_[t][r]+f.reduce((o,y,d)=>o+y*this._w[d],0);_[t+1][e]<a&&(_[t+1][e]=a,i[t][e]=r)}}}s[h]=[];let l=-1/0;for(let t=0;t<this._yn;t++)l<_[n[h].length][t]&&(l=_[n[h].length][t],s[h][n[h].length-1]=t);for(let t=n[h].length-2;t>=0;t--)s[h][t]=i[t+1][s[h][t+1]];s[h]=s[h].map(t=>this._y_cand[t]??null)}return s}}
