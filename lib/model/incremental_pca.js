import Matrix from"../util/matrix.js";export default class IncrementalPCA{constructor(t=.95){this._f=t,this._batch_size=0,this._u=null,this._s=null,this._m=null,this._n=0}update(t){if(!this._u){this._m=t.mean(1),t.sub(this._m);const[s,i]=t.svd();return this._u=s,this._s=i,void(this._n=t.cols)}const s=t.cols,i=t.mean(1),h=Matrix.sub(t,i),_=Matrix.sub(i,this._m);_.mult(Math.sqrt(s*this._n/(s+this._n))),h.concat(_,1);const r=this._u.dot(this._u.tDot(h));r.isub(h);const[o]=r.qr(),a=Matrix.diag([...this._s.map((t=>t*this._f)),o.dot(r)]);a.set(0,this._s.length,this._u.tDot(h));const[n,u]=a.svd();this._s=u,this._u=Matrix.concat(this._u,o,1).dot(n),this._m.mult(this._n*this._f),this._m.add(Matrix.mult(i,s)),this._m.div(this._n=this._n*this._f+s)}fit(t){t=Matrix.fromArray(t),this._batch_size<=0&&(this._batch_size=5*t.cols);for(let s=0;s<t.rows;s+=this._batch_size){const i=[];for(let h=0;h<this._batch_size&&s+h<t.rows;h++)i[h]=s+h;this.update(t.row(i).t)}}predict(t,s){t=Matrix.fromArray(t);const i=this._u;return s>0&&s<i.cols&&i.resize(i.rows,s),t.dot(i).toArray()}}