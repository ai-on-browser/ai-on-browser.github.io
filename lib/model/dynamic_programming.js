import{QTableBase}from"./q_learning.js";const argmax=function(t,s){return 0===t.length?-1:(t=s?t.map(s):t).indexOf(Math.max(...t))};class DPTable extends QTableBase{constructor(t,s=20,e=.9){super(t,s);let i=this._state_sizes.reduce(((t,s)=>t*s),1);this._v=Array(i).fill(0),this._gamma=e}_step_index(t,s){for(let e=0;e<s.length;e++){if(s[e]++,s[e]<t[e])return!0;s[e]=0}return!1}update(t="value"){"value"===t?this.valueIteration():this.policyIteration()}policyIteration(){const t=[].concat(this._v),s=[].concat(this._table),e=Array(this.states.length).fill(0),i=Array(this.actions.length);do{let h=[];i.fill(0);do{const{state:a,reward:_,done:n}=this._env.test(this._state_value(e),this._action_value(i)),o=this._state_index(a),[l,r]=this._to_position(this._state_sizes,o),c=_+this._gamma*t[l],[d,u]=this._q(e,i);this._table[u]=c,h.push([c,s[u]])}while(this._step_index(this._action_sizes,i));const[n,o]=this._to_position(this._state_sizes,e),l=(_=t=>t[1],0===(a=h).length?-1:(a=_?a.map(_):a).indexOf(Math.max(...a)));this._v[n]=h.reduce(((t,s,e)=>t+s[0]*(e===l?.95:.05/(h.length-1))),0)}while(this._step_index(this._state_sizes,e));var a,_}valueIteration(){const t=[].concat(this._v),s=Array(this.states.length).fill(0),e=Array(this.actions.length);do{let i=-1/0;e.fill(0);const a=this._state_value(s);do{const{state:_,reward:h,done:n}=this._env.test(a,this._action_value(e)),o=this._state_index(_),[l,r]=this._to_position(this._state_sizes,o),c=h+this._gamma*t[l],[d,u]=this._q(s,e);this._table[u]=c,i=Math.max(c,i)}while(this._step_index(this._action_sizes,e));const[_,h]=this._to_position(this._state_sizes,s);this._v[_]=i}while(this._step_index(this._state_sizes,s))}}export default class DPAgent{constructor(t,s=20){this._table=new DPTable(t,s)}get_score(){return this._table.toArray()}get_action(t){return this._table.best_action(t)}update(t){this._table.update(t)}}