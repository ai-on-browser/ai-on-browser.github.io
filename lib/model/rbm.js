import{Matrix}from"../util/math.js";export class RBM{constructor(t,h=.01){this._hidden=t,this._visible=null,this._w=null,this._a=[],this._b=[],this._lr=h,this._k=1}_normalize(t){let h=-1/0,i=1/0;for(let s=0;s<t.length;s++)for(let e=0;e<t[s].length;e++)h=Math.max(h,t[s][e]),i=Math.min(i,t[s][e]);for(let s=0;s<t.length;s++)for(let e=0;e<t[s].length;e++)t[s][e]=t[s][e]<(h+i)/2?0:1}_sgm(t){return 1/(1+Math.exp(-t))}_h(t,h=!1){const i=[];for(let s=0;s<t.length;s++){i[s]=[];for(let e=0;e<this._w[0].length;e++){let l=this._b[e];for(let h=0;h<this._w.length;h++)l+=this._w[h][e]*t[s][h];i[s][e]=this._sgm(l),h&&(i[s][e]=i[s][e]>Math.random()?1:0)}}return i}_v(t,h=!1){const i=[];for(let s=0;s<t.length;s++){i[s]=[];for(let e=0;e<this._w.length;e++){let l=this._a[e];for(let h=0;h<this._w[e].length;h++)l+=this._w[e][h]*t[s][h];i[s][e]=this._sgm(l),h&&(i[s][e]=i[s][e]>Math.random()?1:0)}}return i}fit(t){this._normalize(t),this._w||(this._visible=t[0].length,this._w=Matrix.randn(this._visible,this._hidden).toArray(),this._a=Array(this._visible).fill(0),this._b=Array(this._hidden).fill(0));const h=t,i=this._h(h);let s=this._v(i),e=this._h(s);for(let t=1;t<this._k;t++)s=this._v(e),e=this._h(s);for(let l=0;l<this._w.length;l++)for(let _=0;_<this._w[l].length;_++){let r=0;for(let n=0;n<t.length;n++)r+=h[n][l]*i[n][_]-s[n][l]*e[n][_];this._w[l][_]+=this._lr*r/t.length}for(let i=0;i<this._w.length;i++){let e=0;for(let l=0;l<t.length;l++)e+=h[l][i]-s[l][i];this._a[i]+=this._lr*e/t.length}for(let h=0;h<this._w[0].length;h++){let s=0;for(let l=0;l<t.length;l++)s+=i[l][h]-e[l][h];this._b[h]+=this._lr*s/t.length}}energy(t,h){this._normalize([t,h]);let i=0;for(let s=0;s<this._w.length;s++)for(let e=0;e<this._w[s].length;e++)i-=this._w[s][e]*t[s]*h[e];for(let h=0;h<this._w.length;h++)i-=this._a[h]*t[h];for(let t=0;t<this._w[0].length;t++)i-=this._b[t]*h[t];return i}predict(t){this._normalize(t);const h=this._h(t,!0);return this._v(h,!0)}}export class GBRBM{constructor(t,h=.01,i=!1){this._hidden=t,this._visible=null,this._w=null,this._b=[],this._z=[],this._c=[],this._lr=h,this._fixSigma=i,this._k=1}_randn(){return Math.sqrt(-2*Math.log(Math.random()))*Math.cos(2*Math.PI*Math.random())}get _s(){return this._z.map(Math.exp)}_h(t,h=!1){const i=[],s=this._s;for(let e=0;e<t.length;e++){i[e]=[];for(let l=0;l<this._w[0].length;l++){let _=this._c[l];for(let h=0;h<this._w.length;h++)_+=this._w[h][l]*t[e][h]/s[h];i[e][l]=1/(1+Math.exp(-_)),h&&(i[e][l]=i[e][l]>Math.random()?1:0)}}return i}_v(t,h=!1){const i=[],s=this._s;for(let e=0;e<t.length;e++){i[e]=[];for(let l=0;l<this._w.length;l++){let _=this._b[l];for(let h=0;h<this._w[l].length;h++)_+=this._w[l][h]*t[e][h];i[e][l]=_,h&&(i[e][l]+=this._randn()*Math.sqrt(s[l]))}}return i}fit(t){this._w||(this._visible=t[0].length,this._w=Matrix.randn(this._visible,this._hidden).toArray(),this._b=Array(this._visible).fill(0),this._z=Array(this._visible).fill(0),this._c=Array(this._hidden).fill(0));const h=t,i=this._h(t);let s=this._v(i,!0),e=this._h(s,!0);for(let t=0;t<this._k;t++)s=this._v(e,!0),e=this._h(s,!0);const l=this._s;if(!this._fixSigma)for(let _=0;_<this._w.length;_++){let r=0,n=0;for(let l=0;l<t.length;l++){r+=(h[l][_]-this._b[_])**2/2,n+=(s[l][_]-this._b[_])**2/2;for(let t=0;t<this._w[0].length;t++)r-=i[l][t]*this._w[_][t]*h[l][_],n-=e[l][t]*this._w[_][t]*s[l][_]}this._z[_]+=this._lr*(r-n)/l[_]/t.length}for(let _=0;_<this._w.length;_++)for(let r=0;r<this._w[_].length;r++){let n=0;for(let l=0;l<t.length;l++)n+=h[l][_]*i[l][r]-s[l][_]*e[l][r];this._w[_][r]+=this._lr*n/l[_]/t.length}for(let i=0;i<this._w.length;i++){let e=0;for(let l=0;l<t.length;l++)e+=h[l][i]-s[l][i];this._b[i]+=this._lr*e/l[i]/t.length}for(let h=0;h<this._w[0].length;h++){let s=0;for(let l=0;l<t.length;l++)s+=i[l][h]-e[l][h];this._c[h]+=this._lr*s/t.length}}energy(t,h){let i=0;for(let s=0;s<this._w.length;s++)for(let e=0;e<this._w[s].length;e++)i-=this._w[s][e]*t[s]*h[e]/Math.exp(this._z[s]);for(let h=0;h<this._w.length;h++)i+=(t[h]-this._b[h])**2/(2*Math.exp(this._z[h]));for(let t=0;t<this._w[0].length;t++)i-=this._c[t]*h[t];return i}predict(t){const h=this._h(t);return this._v(h,!0)}}