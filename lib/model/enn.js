export default class ENN{constructor(s=1,t=5,i="euclid"){switch(this._k=t,this._v=s,this._metric=i,this._metric){case"euclid":this._d=(s,t)=>Math.sqrt(s.reduce(((s,i,h)=>s+(i-t[h])**2),0));break;case"manhattan":this._d=(s,t)=>s.reduce(((s,i,h)=>s+Math.abs(i-t[h])),0);break;case"chebyshev":this._d=(s,t)=>Math.max(...s.map(((s,i)=>Math.abs(s-t[i]))));break;case"minkowski":this._dp=2,this._d=(s,t)=>Math.pow(s.reduce(((s,i,h)=>s+(i-t[h])**this._dp),0),1/this._dp)}}fit(s,t){this._x=s,this._c=t,this._classes=[...new Set(this._c)],this._nears=[],this._n=Array(this._classes.length).fill(0);for(let s=0;s<this._x.length;s++){const t=this._x.map(((t,i)=>({d:this._d(this._x[s],t),idx:i})));t.sort(((s,t)=>s.d-t.d)),this._nears[s]=t,this._n[this._classes.indexOf(this._c[s])]++}if(this._v>=1){this._t=[];for(let s=0;s<this._classes.length;s++){let t=0;for(let i=0;i<this._nears.length;i++)if(this._c[i]===this._classes[s])for(let h=1;h<=this._k;h++)this._c[this._nears[i][h].idx]===this._classes[s]&&t++;this._t[s]=t/(this._n[s]*this._k)}}}predict(s){const t=[];for(let i=0;i<s.length;i++)0===this._v?t[i]=this._predict0(s[i]):1===this._v?t[i]=this._predict1(s[i]):2===this._v&&(t[i]=this._predict2(s[i]));return t}_predict0(s){const t=[],i=[{d:0,idx:-1}];for(let h=0;h<this._x.length;h++){const e=this._d(s,this._x[h]);i.push({d:e,idx:h}),t[h]=[];let _=!1;for(let s=0;s<this._nears[h].length;s++)!_&&e<this._nears[h][s].d&&(t[h].push({d:e,idx:-1}),_=!0),t[h].push(this._nears[h][s])}i.sort(((s,t)=>s.d-t.d)),t.push(i);let h=-1,e=0;for(let s=0;s<this._classes.length;s++){let i=0;for(let h=0;h<this._classes.length;h++){let e=0;for(let i=0;i<t.length;i++){if(i<this._c.length){if(this._c[i]!==this._classes[h])continue}else if(s!==h)continue;for(let _=1;_<=this._k;_++)t[i][_].idx<0?s===h&&e++:this._c[t[i][_].idx]===this._classes[h]&&e++}i+=e/((this._n[h]+(s===h?1:0))*this._k)}e<i&&(e=i,h=s)}return this._classes[h]}_predict1(s){const t=[{d:0,idx:-1}],i=[];for(let h=0;h<this._x.length;h++){const e=this._d(s,this._x[h]);t.push({d:e,idx:h}),i[h]=e}t.sort(((s,t)=>s.d-t.d));let h=-1/0,e=-1;for(let s=0;s<this._classes.length;s++){let _=0;for(let h=0;h<this._classes.length;h++){let e=0;for(let s=1;s<=this._k;s++)this._c[t[s].idx]===this._classes[h]&&e++;let l=0;for(let t=0;t<this._nears.length;t++)i[t]<this._nears[t][this._k].d&&(s===h&&this._c[this._nears[t][this._k].idx]!==this._classes[h]||s!==h&&this._c[this._nears[t][this._k].idx]===this._classes[h])&&l++;s===h?_+=(l+e-this._k*this._t[h])/((this._n[h]+1)*this._k):_-=l/(this._n[h]*this._k)}h<_&&(h=_,e=s)}return this._classes[e]}_predict2(s){const t=[{d:0,idx:-1}],i=[];for(let h=0;h<this._x.length;h++){const e=this._d(s,this._x[h]);t.push({d:e,idx:h}),i[h]=e}t.sort(((s,t)=>s.d-t.d));let h=-1/0,e=-1;for(let s=0;s<this._classes.length;s++){let _=0;for(let i=1;i<=this._k;i++)this._c[t[i].idx]===this._classes[s]&&_++;let l=0;for(let s=0;s<this._nears.length;s++)i[s]<this._nears[s][this._k].d&&l++;const c=l+_-this._k*this._t[s];h<c&&(h=c,e=s)}return this._classes[e]}}