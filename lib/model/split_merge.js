var M=Object.defineProperty;var S=(v,a)=>M(v,"name",{value:a,configurable:!0});import j from"../util/matrix.js";export default class x{static{S(this,"SplitAndMerge")}constructor(a="variance",i=.1){this._method=a,this._threshold=i}_shouldSplit(a){if(a=j.fromArray(a.flat()),this._method==="variance"){if(a.variance(0).mean()>this._threshold)return!0}else if(this._method==="uniformity"){const i=a.mean(1);if(i.sub(i.mean()),i.map(Math.abs),i.max()>this._threshold)return!0}return!1}predict(a){this._x=a;let i=0;const p={data:a,category:i++,range:[[0,a.length],[0,a[0].length]],children:[],get leafs(){return this.children.length===0?[this]:this.children.reduce((e,r)=>e.concat(r.leafs),[])}},m=[p];for(;m.length>0;){const e=m.pop(),r=e.data;if(r.length<=1||r[0].length<=1)continue;const n=e.range;if(this._shouldSplit(r)){const s=n.map(o=>o[1]-o[0]),f=s.map(o=>Math.floor(o/2)),g=[];for(let o=0;o<2**s.length;o++){const t=o.toString(2).padStart(s.length,"0").split("").map(l=>!!+l);g.push(t.map((l,c)=>l?[0,f[c]]:[f[c],s[c]]))}for(const[o,t]of g){const l=[];for(let u=o[0];u<o[1];u++){const d=[];for(let _=t[0];_<t[1];_++)d.push(r[u][_]);l.push(d)}const c={data:l,category:i++,range:[[n[0][0]+o[0],n[0][0]+o[1]],[n[1][0]+t[0],n[1][0]+t[1]]],children:[],get leafs(){return this.children.length===0?[this]:this.children.reduce((u,d)=>u.concat(d.leafs),[])}};e.children.push(c),m.push(c)}}}const h=p.leafs;for(let e=0;e<h.length;e++){const r=h[e].range;for(let n=0;n<h.length;n++){if(h[e].category===h[n].category)continue;const s=h[n].range;let f=!1;for(let t=0;t<s.length;t++)(s[t][0]===r[t][1]||s[t][1]===r[t][0])&&s.every((l,c)=>c===t||s[c][0]<r[c][1]&&r[c][0]<s[c][1])&&(f=!0);if(!f)continue;const g=h.filter(t=>t.category===h[e].category||t.category===h[n].category),o=[];for(const t of g)o.push(...t.data.flat());if(!this._shouldSplit(o)){const t=Math.min(h[e].category,h[n].category);for(const l of g)l.category=t}}}const y=[];for(let e=0;e<this._x.length;y[e++]=[]);return p.leafs.forEach(e=>{const r=e.range;for(let n=r[0][0];n<r[0][1];n++)for(let s=r[1][0];s<r[1][1];s++)y[n][s]=e.category}),y}}
