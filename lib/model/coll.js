var m=Object.defineProperty;var a=(f,n)=>m(f,"name",{value:n,configurable:!0});import u from"../util/matrix.js";const g={gaussian:a(({s:f=1})=>(n,h)=>Math.exp(-(n.reduce((_,e,r)=>_+(e-h[r])**2,0)**2)/f**2),"gaussian"),polynomial:a(({d:f=2})=>(n,h)=>(1+n.reduce((_,e,r)=>_+e*h[r]))**f,"polynomial")};export default class w{static{a(this,"COLL")}constructor(n,h=1,_="gaussian"){this._c=n,this._eta=h,typeof _=="function"?this._kernel=_:(typeof _=="string"&&(_={name:_}),this._kernel=g[_.name](_))}init(n){this._datas=n;const h=n.length;this._k=[],this._nu=[],this._t=0,this._nk=Array(this._c).fill(0);for(let t=0;t<h;t++){this._nu[t]=Math.floor(Math.random()*this._c),this._nk[this._nu[t]]++,this._k[t]=[],this._k[t][t]=this._kernel(n[t],n[t]);for(let s=0;s<t;s++)this._k[t][s]=this._k[s][t]=this._kernel(n[t],n[s])}this._f=this._nk.map(t=>t/h);const _=u.zeros(this._c,h);for(let t=0;t<h;t++)_.set(this._nu[t],t,1/this._nk[this._nu[t]]);const e=u.fromArray(this._k),r=_.dot(e);this._w=new u(this._c,h+1),this._w.set(0,0,r);for(let t=0;t<this._c;t++){let s=0;for(let i=0;i<h;i++)s+=r.at(t,i)*_.at(t,i);this._w.set(t,h,s)}}fit(){const n=this._datas.length,h=Array.from({length:this._c},()=>[]),_=Array.from({length:n},(t,s)=>s);for(let t=_.length-1;t>0;t--){const s=Math.floor(Math.random()*(t+1));[_[t],_[s]]=[_[s],_[t]]}this._t++;const e=this._eta/this._t;for(let t=0;t<n;t++){const s=_[t];let i=-1,l=1/0;for(let o=0;o<this._c;o++){const c=this._f[o]*(this._k[s][s]+this._w.at(o,n)-2*this._w.at(o,s));c<l&&(l=c,i=o)}this._nu[s]=i,h[i].push(s);for(let o=0;o<n;o++)this._w.set(i,o,(1-e)*this._w.at(i,o)+e*this._k[s][o]);this._w.set(i,n,(1-e)**2*this._w.at(i,n)+e**2*this._k[s][s]+2*(1-e)*e*this._w.at(i,s)),this._nk[i]+=1;const k=this._nk.reduce((o,c)=>o+c,0);this._f=this._nk.map(o=>o/k)}if(e===1)return 1/0;let r=0;for(let t=0;t<this._c;t++){r+=(1-1/(1-e)**h[t].length)**2*this._w.at(t,n);for(let i=0;i<h[t].length;i++)for(let l=0;l<h[t].length;l++)r+=e**2*this._k[h[t][i]][h[t][l]]/(1-e)**(i+l);const s=2*e*(1-1/(1-e)**h[t].length);for(let i=0;i<h[t].length;i++)r+=s*this._w.at(t,h[t][i])/(1-e)**i}return r}predict(){return this._nu}}
