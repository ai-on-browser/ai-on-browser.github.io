var m=Object.defineProperty;var u=(c,e)=>m(c,"name",{value:e,configurable:!0});import a from"../util/matrix.js";export default class w{static{u(this,"COLL")}constructor(e,h=1,_="gaussian"){if(this._c=e,this._eta=h,typeof _=="function")this._kernel=_;else switch(typeof _=="string"&&(_={name:_}),_.name){case"gaussian":this._s=_.s??1,this._kernel=(n,o)=>Math.exp(-(n.reduce((t,s,i)=>t+(s-o[i])**2,0)**2)/this._s**2);break;case"polynomial":this._d=_.d??2,this._kernel=(n,o)=>(1+n.reduce((t,s,i)=>t+s*o[i]))**this._d;break}}init(e){this._datas=e;const h=e.length;this._k=[],this._nu=[],this._t=0,this._nk=Array(this._c).fill(0);for(let t=0;t<h;t++){this._nu[t]=Math.floor(Math.random()*this._c),this._nk[this._nu[t]]++,this._k[t]=[],this._k[t][t]=this._kernel(e[t],e[t]);for(let s=0;s<t;s++)this._k[t][s]=this._k[s][t]=this._kernel(e[t],e[s])}this._f=this._nk.map(t=>t/h);const _=a.zeros(this._c,h);for(let t=0;t<h;t++)_.set(this._nu[t],t,1/this._nk[this._nu[t]]);const n=a.fromArray(this._k),o=_.dot(n);this._w=new a(this._c,h+1),this._w.set(0,0,o);for(let t=0;t<this._c;t++){let s=0;for(let i=0;i<h;i++)s+=o.at(t,i)*_.at(t,i);this._w.set(t,h,s)}}fit(){const e=this._datas.length,h=Array.from({length:this._c},()=>[]),_=Array.from({length:e},(t,s)=>s);for(let t=_.length-1;t>0;t--){const s=Math.floor(Math.random()*(t+1));[_[t],_[s]]=[_[s],_[t]]}this._t++;const n=this._eta/this._t;for(let t=0;t<e;t++){const s=_[t];let i=-1,l=1/0;for(let r=0;r<this._c;r++){const f=this._f[r]*(this._k[s][s]+this._w.at(r,e)-2*this._w.at(r,s));f<l&&(l=f,i=r)}this._nu[s]=i,h[i].push(s);for(let r=0;r<e;r++)this._w.set(i,r,(1-n)*this._w.at(i,r)+n*this._k[s][r]);this._w.set(i,e,(1-n)**2*this._w.at(i,e)+n**2*this._k[s][s]+2*(1-n)*n*this._w.at(i,s)),this._nk[i]+=1;const k=this._nk.reduce((r,f)=>r+f,0);this._f=this._nk.map(r=>r/k)}if(n===1)return 1/0;let o=0;for(let t=0;t<this._c;t++){o+=(1-1/(1-n)**h[t].length)**2*this._w.at(t,e);for(let i=0;i<h[t].length;i++)for(let l=0;l<h[t].length;l++)o+=n**2*this._k[h[t][i]][h[t][l]]/(1-n)**(i+l);const s=2*n*(1-1/(1-n)**h[t].length);for(let i=0;i<h[t].length;i++)o+=s*this._w.at(t,h[t][i])/(1-n)**i}return o}predict(){return this._nu}}
