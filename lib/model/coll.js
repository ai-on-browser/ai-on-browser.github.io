var w=Object.defineProperty;var k=(a,e)=>w(a,"name",{value:e,configurable:!0});import f from"../util/matrix.js";export default class m{static{k(this,"COLL")}constructor(e,h=1,r="gaussian"){if(this._c=e,this._eta=h,typeof r=="function")this._kernel=r;else switch(r){case"gaussian":this._s=1,this._kernel=(_,o)=>Math.exp(-(_.reduce((t,s,i)=>t+(s-o[i])**2,0)**2)/this._s**2);break;case"polynomial":this._d=2,this._kernel=(_,o)=>(1+_.reduce((t,s,i)=>t+s*o[i]))**this._d;break}}init(e){this._datas=e;const h=e.length;this._k=[],this._nu=[],this._t=0,this._nk=Array(this._c).fill(0);for(let t=0;t<h;t++){this._nu[t]=Math.floor(Math.random()*this._c),this._nk[this._nu[t]]++,this._k[t]=[],this._k[t][t]=this._kernel(e[t],e[t]);for(let s=0;s<t;s++)this._k[t][s]=this._k[s][t]=this._kernel(e[t],e[s])}this._f=this._nk.map(t=>t/h);const r=f.zeros(this._c,h);for(let t=0;t<h;t++)r.set(this._nu[t],t,1/this._nk[this._nu[t]]);const _=f.fromArray(this._k),o=r.dot(_);this._w=new f(this._c,h+1),this._w.set(0,0,o);for(let t=0;t<this._c;t++){let s=0;for(let i=0;i<h;i++)s+=o.at(t,i)*r.at(t,i);this._w.set(t,h,s)}}fit(){const e=this._datas.length,h=Array.from({length:this._c},()=>[]),r=Array.from({length:e},(t,s)=>s);for(let t=r.length-1;t>0;t--){const s=Math.floor(Math.random()*(t+1));[r[t],r[s]]=[r[s],r[t]]}this._t++;const _=this._eta/this._t;for(let t=0;t<e;t++){const s=r[t];let i=-1,l=1/0;for(let n=0;n<this._c;n++){const c=this._f[n]*(this._k[s][s]+this._w.at(n,e)-2*this._w.at(n,s));c<l&&(l=c,i=n)}this._nu[s]=i,h[i].push(s);for(let n=0;n<e;n++)this._w.set(i,n,(1-_)*this._w.at(i,n)+_*this._k[s][n]);this._w.set(i,e,(1-_)**2*this._w.at(i,e)+_**2*this._k[s][s]+2*(1-_)*_*this._w.at(i,s)),this._nk[i]+=1;const u=this._nk.reduce((n,c)=>n+c,0);this._f=this._nk.map(n=>n/u)}if(_===1)return 1/0;let o=0;for(let t=0;t<this._c;t++){o+=(1-1/(1-_)**h[t].length)**2*this._w.at(t,e);for(let i=0;i<h[t].length;i++)for(let l=0;l<h[t].length;l++)o+=_**2*this._k[h[t][i]][h[t][l]]/(1-_)**(i+l);const s=2*_*(1-1/(1-_)**h[t].length);for(let i=0;i<h[t].length;i++)o+=s*this._w.at(t,h[t][i])/(1-_)**i}return o}predict(){return this._nu}}
