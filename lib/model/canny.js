export default class Canny{constructor(t,e){this._bigth=t,this._smlth=e}_convolute(t,e){const l=[];for(let n=0;n<t.length;n++){l[n]=[];for(let h=0;h<t[n].length;h++){let o=0;for(let l=0;l<e.length;l++){let r=n+l-Math.floor(e.length/2);r=Math.max(0,Math.min(t.length-1,r));for(let n=0;n<e[l].length;n++){let g=h+n-Math.floor(e[l].length/2);g=Math.max(0,Math.min(t[r].length-1,g)),o+=t[r][g]*e[l][n]}}l[n][h]=o}}return l}_gaussian(t){return this._convolute(t,[[1/16,2/16,1/16],[2/16,.25,2/16],[1/16,2/16,1/16]])}predict(t){for(let e=0;e<t.length;e++)for(let l=0;l<t[e].length;l++){let n=t[e][l].reduce(((t,e)=>t+e),0)/t[e][l].length;t[e][l]=n}t=this._gaussian(t);const e=this._convolute(t,[[1,0,-1],[2,0,-2],[1,0,-1]]),l=this._convolute(t,[[1,2,1],[0,0,0],[-1,-2,-1]]),n=[],h=[];for(let t=0;t<e.length;t++){n[t]=[],h[t]=[];for(let o=0;o<e[t].length;o++)n[t][o]=Math.sqrt(e[t][o]**2+l[t][o]**2),h[t][o]=360*Math.atan2(l[t][o],e[t][o])/(2*Math.PI)}const o=[];for(let t=0;t<n.length;t++){o[t]=[];for(let e=0;e<n[t].length;e++){if(0===t||t===n.length-1||0===e||e===n[t].length-1){o[t][e]=0;continue}o[t][e]=n[t][e];const l=h[t][e];-22.5<=l&&l<22.5||157.5<=l||l<-157.5?(n[t][e]<n[t][e-1]||n[t][e]<n[t][e+1])&&(o[t][e]=0):22.5<=l&&l<67.5||-157.5<=l&&l<-112.5?(n[t][e]<n[t+1][e-1]||n[t][e]<n[t-1][e+1])&&(o[t][e]=0):67.5<=l&&l<112.5||-112.5<=l&&l<-67.5?(n[t][e]<n[t+1][e]||n[t][e]<n[t-1][e])&&(o[t][e]=0):(112.5<=l&&l<157.5||-67.5<=l&&l<-22.5)&&(n[t][e]<n[t+1][e+1]||n[t][e]<n[t-1][e-1])&&(o[t][e]=0)}}const r=[];for(let t=0;t<o.length;t++)r[t]=Array(o[t].length).fill(!1);for(let t=0;t<o.length;t++)for(let e=0;e<o[t].length;e++)if(o[t][e]>=this._bigth){const l=[[t,e]];for(;l.length>0;){const[t,e]=l.pop();t<0||o.length<=t||e<0||o[t].length<=e||(r[t][e]||o[t][e]<this._smlth||(r[t][e]=!0,l.push([t+1,e],[t-1,e],[t,e+1],[t,e-1])))}}return r}}