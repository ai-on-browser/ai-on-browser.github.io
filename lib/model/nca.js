var _=Object.defineProperty;var d=(h,r)=>_(h,"name",{value:r,configurable:!0});import e from"../util/matrix.js";export default class p{static{d(this,"NeighbourhoodComponentsAnalysis")}constructor(r=null,c=.1){this._w=null,this._d=r,this._lr=c}fit(r,c){r=e.fromArray(r),this._w||(this._w=e.randn(this._d||r.cols,r.cols)),r.sub(r.mean(0)),r.div(r.variance(0));const n=r.rows,a=[];for(let t=0;t<n;a[t++]=[]);for(let t=0;t<n;t++){const s=r.row(t);a[t][t]=e.sub(s,s);for(let o=0;o<t;o++){const i=e.sub(s,r.row(o));a[t][o]=i,a[o][t]=e.map(i,m=>-m)}}const l=new e(n,n);for(let t=0;t<n;t++){l.set(t,t,0);for(let s=0;s<t;s++){const o=e.mult(a[t][s],this._w),i=Math.exp(-(o.norm()**2));l.set(t,s,i),l.set(s,t,i)}}l.div(l.sum(1));const u=[];for(let t=0;t<n;t++){u[t]=0;for(let s=0;s<n;s++)c[t]===c[s]&&(u[t]+=l.at(t,s))}const f=e.zeros(this._w.cols,this._w.cols);for(let t=0;t<n;t++){const s=[];for(let o=0;o<n;o++){const i=a[t][o];s[o]=i.tDot(i),f.add(e.mult(s[o],l.at(t,o)*u[t]))}for(let o=0;o<n;o++){if(c[t]!==c[o])continue;const i=s[o];i.mult(l.at(t,o)),f.sub(i)}}const w=this._w.dot(f);w.mult(2*this._lr),this._w.sub(w)}importance(){return this._w.mean(0).value}predict(r){return e.fromArray(r).dot(this._w.t).toArray()}}
