var x=Object.defineProperty;var f=(l,o)=>x(l,"name",{value:o,configurable:!0});import u from"../util/matrix.js";export default class y{static{f(this,"IKNN")}constructor(o,n){this._k=o,this._i=n,this._gamma=2}_pr(o,n){let e=0;for(let i=0;i<o.length;i++)e+=this._w[i]*(n[i]-o[i])**2;return Math.exp(-e/this._gamma)}fit(o,n){this._x=o,this._y=n,this._c=[...new Set(n)];const e=o[0].length;this._w=Array(e).fill(0),this._eta=[];for(let i=0;i<this._c.length;i++){const s=this._x.filter((r,a)=>this._y[a]===this._c[i]),_=u.fromArray(s).variance(0).value;for(let r=0;r<e;r++)this._w[r]+=_[r];this._eta[i]=s.length}this._w=this._w.map(i=>i/this._c.length),this._eta=this._eta.map(i=>i/this._x.length),this._logp2t=Array(this._x.length).fill(0);for(let i=0;i<this._x.length;i++){for(let s=0;s<this._x.length;s++)i!==s&&(this._logp2t[i]+=Math.log(1-this._pr(this._x[i],this._x[s])));for(let s=0;s<this._c.length;s++)this._y[i]===this._c[s]&&(this._logp2t[i]*=1-this._eta[s])}}predict(o){return o.map(n=>{const e=this._x.map((t,h)=>({i:h,d:Math.sqrt(t.reduce((p,g,m)=>p+(n[m]-g)**2,0)),pr:this._pr(t,n)})),i=e.reduce((t,h)=>t+h.pr,0);e.sort((t,h)=>t.d-h.d);const s=[];for(let t=0;t<this._k;t++){const h=Math.exp(this._eta*Math.log(e[t].pr)+this._logp2t[e[t].i]-i);s.push({info:-Math.log(1-h)*h,i:e[t].i})}s.sort((t,h)=>h.info-t.info);const _={};for(let t=0;t<this._i&&t<this._k;t++){const h=s[t].i;_[this._y[h]]?(_[this._y[h]].count++,_[this._y[h]].max_info=Math.max(_[this._y[h]].max_info,s[t].info)):_[this._y[h]]={category:this._y[h],count:1,max_info:s[t].info}}let r=0,a=-1/0,c=null;for(const t of Object.keys(_))(r<_[t].count||r===_[t].count&&_[t].max_info<a)&&(r=_[t].count,a=_[t].max_info,c=_[t].category);return c})}}
