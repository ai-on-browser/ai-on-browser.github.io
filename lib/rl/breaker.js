import{RLEnvironmentBase,RLRealRange}from"./base.js";export default class BreakerRLEnvironment extends RLEnvironmentBase{constructor(){super(),this._size=[300,500],this._padding=[[30,30],[370,30]],this._block_size=[30,10],this._paddle_baseline=20,this._paddle_size=[60,8],this._ball_radius=3,this._ball_speed=3,this._paddle_speed=5,this._block_positions=[];for(let s=this._padding[0][0];s<this._size[0]-this._padding[0][1];s+=this._block_size[0])for(let t=this._padding[1][0];t<this._size[1]-this._padding[1][1];t+=this._block_size[1])this._block_positions.push([s+this._block_size[0]/2,t+this._block_size[1]/2]);this._ball_position=[0,0],this._paddle_position=0,this._ball_velocity=[0,0],this._block_existances=[],this._reward={break:100,step:.1,hit:100,goal:1e3,fail:-1e3}}get actions(){return[[-1,0,1]]}get states(){const s=[];for(let t=0;t<this._block_positions.length;t++)s[t]=[0,1];return[new RLRealRange(0,this._size[0]),new RLRealRange(0,this._size[1]),new RLRealRange(-this._ball_speed,this._ball_speed),new RLRealRange(-this._ball_speed,this._ball_speed),new RLRealRange(0,this._size[0]),...s]}set reward(s){}reset(){super.reset(),this._paddle_position=this._size[0]/2,this._ball_position=[this._size[0]/2,this._paddle_baseline+this._paddle_size[1]/2+2*this._ball_radius];const s=Math.random()*(this._ball_speed-.1)*2-(this._ball_speed-.1),t=Math.sqrt(Math.abs(s**2-this._ball_speed**2));this._ball_velocity=[s,t],this._block_existances=[];for(let s=0;s<this._block_positions.length;s++)this._block_existances[s]=1;return this.state()}state(){return[...this._ball_position,...this._ball_velocity,this._paddle_position,...this._block_existances]}step(s,t){super.step(s,t);const{state:i,reward:e,done:_}=this.test(this.state(),s,t);return this._ball_position[0]=i[0],this._ball_position[1]=i[1],this._ball_velocity[0]=i[2],this._ball_velocity[1]=i[3],this._paddle_position=i[4],this._block_existances=i.slice(5),{state:i,reward:e,done:_}}test(s,t){let i=s[4]+this._paddle_speed*t[0];i<this._paddle_size[0]/2?i=this._paddle_size[0]/2:i>this._size[0]-this._paddle_size[0]/2&&(i=this._size[0]-this._paddle_size[0]/2);const e=[s[0],s[1]],_=[s[2],s[3]];for(let s=0;s<2;s++)e[s]+=_[s];const l=s.slice(5);let a=1/0,h=_,o=!1;{const[s,t,l]=this._check_contact(e,[i,this._paddle_baseline],this._paddle_size);s<a&&(a=s,h=l?[Math.sin(l*Math.PI/2)*this._ball_speed,Math.cos(l*Math.PI/2)*this._ball_speed]:[_[0]*t[0],_[1]*t[1]],o=!0)}for(const s of[-10,this._size[0]+10]){const[t]=this._check_contact(e,[s,this._size[1]/2],[20,this._size[1]]);t<a&&(a=t,h=[-Math.sign(s)*Math.abs(_[0]),_[1]],o=!1)}{const[s]=this._check_contact(e,[this._size[0]/2,this._size[1]+10],[this._size[0],20]);s<a&&(a=s,h=[_[0],-Math.abs(_[1])],o=!1)}const[n]=this._check_contact(e,[this._size[0]/2,-10],[this._size[0],20]);let d=-1;for(let s=0;s<l.length;s++){if(0===l[s])continue;const[t,i]=this._check_contact(e,this._block_positions[s],this._block_size);t<a&&(a=t,h=[_[0]*i[0],_[1]*i[1]],d=s,o=!1)}let r=this._reward.step;d>=0&&(l[d]=0,r=this._reward.break),n<1/0?r=this._reward.fail:o&&(r=this._reward.hit);const c=l.every((s=>0===s))||n<1/0;return{state:[...e,...h,i,...l],reward:r,done:c}}_check_contact(s,t,i){for(let e=0;e<2;e++)if(s[e]+this._ball_radius<t[e]-i[e]/2||t[e]+i[e]/2<s[e]-this._ball_radius)return[1/0,[]];let e=1/0;for(const[_,l]of[[-1,-1],[-1,1],[1,-1],[1,1]]){if(_*s[0]<=_*t[0]+i[0]/2)continue;if(l*s[1]<=l*t[1]+i[1]/2)continue;const a=Math.sqrt((s[0]-(t[0]+_*i[0]/2))**2+(s[1]-(t[1]+l*i[1]/2))**2);if(a>this._ball_radius)return[1/0,[]];e=a}e===1/0&&(e=s[0]+this._ball_radius<t[0]-i[0]/2?t[0]-i[0]/2-s[0]:s[1]+this._ball_radius<t[1]-i[1]/2?t[1]-i[1]/2-s[1]:s[0]-this._ball_radius>t[0]+i[0]/2?s[0]-(t[0]+i[0]/2):s[1]-this._ball_radius>t[1]+i[1]/2?s[1]-(t[1]+i[1]/2):0);let _=null;return _=s[1]>=t[1]?s[1]-(t[1]+i[1]/2):t[1]-i[1]/2-s[1],t[0]-i[0]/2-_<s[0]&&s[0]<t[0]+i[0]/2+_?[e,[1,-1],(s[0]-t[0])/(i[0]/2+_+1)]:[e,[-1,1]]}}