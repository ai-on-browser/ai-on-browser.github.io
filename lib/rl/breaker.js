import{RLEnvironmentBase,RLRealRange}from"./base.js";export default class BreakerRLEnvironment extends RLEnvironmentBase{constructor(){super(),this._size=[300,500],this._padding=[[30,30],[370,30]],this._block_size=[30,10],this._paddle_baseline=20,this._paddle_size=[60,8],this._ball_radius=3,this._ball_speed=3,this._block_positions=[];for(let s=this._padding[0][0];s<this._size[0]-this._padding[0][1];s+=this._block_size[0])for(let t=this._padding[1][0];t<this._size[1]-this._padding[1][1];t+=this._block_size[1])this._block_positions.push([s+this._block_size[0]/2,t+this._block_size[1]/2]);this._ball_position=[0,0],this._paddle_position=0,this._ball_velocity=[0,0],this._block_existances=[],this._reward={break:100,step:.1,goal:1e3,fail:-1e3}}get actions(){return[[-1,0,1]]}get states(){const s=[];for(let t=0;t<this._block_positions.length;t++)s[t]=[0,1];return[new RLRealRange(0,this._size[0]),new RLRealRange(0,this._size[1]),new RLRealRange(-2,2),new RLRealRange(-2,2),new RLRealRange(0,this._size[0]),...s]}set reward(s){}reset(){super.reset(),this._paddle_position=this._size[0]/2,this._ball_position=[this._size[0]/2,this._paddle_baseline+this._paddle_size[1]/2+2*this._ball_radius];const s=4*Math.random()-2,t=Math.sqrt(Math.abs(s**2-this._ball_speed**2));this._ball_velocity=[s,t],this._block_existances=[];for(let s=0;s<this._block_positions.length;s++)this._block_existances[s]=1;return this.state()}state(){return[...this._ball_position,...this._ball_velocity,this._paddle_position,...this._block_existances]}step(s,t){super.step(s,t);const{state:i,reward:e,done:_}=this.test(this.state(),s,t);return this._ball_position[0]=i[0],this._ball_position[1]=i[1],this._ball_velocity[0]=i[2],this._ball_velocity[1]=i[3],this._paddle_position=i[4],this._block_existances=i.slice(5),{state:i,reward:e,done:_}}test(s,t,i){let e=s[4]+2*t[0];e<this._paddle_size[0]/2?e=this._paddle_size[0]/2:e>this._size[0]-this._paddle_size[0]/2&&(e=this._size[0]-this._paddle_size[0]/2);const _=[s[0],s[1]],a=[s[2],s[3]];for(let s=0;s<2;s++)_[s]+=a[s];const l=s.slice(5);let h=1/0,o=a;{const[s,t]=this._check_contact(_,[e,this._paddle_baseline],this._paddle_size);s<h&&(h=s,o=[a[0]*t[0],a[1]*t[1]])}for(const s of[-10,this._size[0]+10]){const[t,i]=this._check_contact(_,[s,this._size[1]/2],[20,this._size[1]]);t<h&&(h=t,o=[-Math.sign(s)*Math.abs(a[0]),a[1]])}{const[s,t]=this._check_contact(_,[this._size[0]/2,this._size[1]+10],[this._size[0],20]);s<h&&(h=s,o=[a[0],-Math.abs(a[1])])}const[n,c]=this._check_contact(_,[this._size[0]/2,-10],[this._size[0],20]);let r=-1;for(let s=0;s<l.length;s++){if(0===l[s])continue;const[t,i]=this._check_contact(_,this._block_positions[s],this._block_size);t<h&&(h=t,o=[a[0]*i[0],a[1]*i[1]],r=s)}let d=this._reward.step;r>=0&&(l[r]=0,d=this._reward.break),n<1/0&&(d=this._reward.fail);const b=l.every((s=>0===s))||n<1/0;return{state:[..._,...o,e,...l],reward:d,done:b}}_check_contact(s,t,i){for(let e=0;e<2;e++)if(s[e]+this._ball_radius<t[e]-i[e]/2||t[e]+i[e]/2<s[e]-this._ball_radius)return[1/0,[]];let e=1/0;for(const[_,a]of[[-1,-1],[-1,1],[1,-1],[1,1]]){if(_*s[0]<=_*t[0]+i[0]/2)continue;if(a*s[1]<=a*t[1]+i[1]/2)continue;const l=Math.sqrt((s[0]-(t[0]+_*i[0]/2))**2+(s[1]-(t[1]+a*i[1]/2))**2);if(l>this._ball_radius)return[1/0,[]];e=l}e===1/0&&(e=s[0]+this._ball_radius<t[0]-i[0]/2?t[0]-i[0]/2-s[0]:s[1]+this._ball_radius<t[1]-i[1]/2?t[1]-i[1]/2-s[1]:s[0]-this._ball_radius>t[0]+i[0]/2?s[0]-(t[0]+i[0]/2):s[1]-this._ball_radius>t[1]+i[1]/2?s[1]-(t[1]+i[1]/2):0);let _=null;return _=s[1]>=t[1]?s[1]-(t[1]+i[1]/2):t[1]-i[1]/2-s[1],t[0]-i[0]/2-_<s[0]&&s[0]<t[0]+i[0]/2+_?[e,[1,-1]]:[e,[-1,1]]}}