import{RLEnvironmentBase}from"./base.js";const EMPTY=1,BLACK=2,WHITE=3;export default class GomokuRLEnvironment extends RLEnvironmentBase{constructor(){super(),this._size=[8,8],this._board=new GomokuBoard(this._size,this._evaluation),this._reward={win:1,lose:-1,step:0}}static BLACK=2;static WHITE=3;static EMPTY=1;static OWN=2;static OTHER=3;get actions(){const t=[];for(let s=0;s<this._size[0];s++)for(let e=0;e<this._size[1];e++)t.push(`${s}_${e}`);return[t]}get states(){const t=[[2,3]];for(let s=0;s<this._size[0]*this._size[1];s++)t.push([1,GomokuRLEnvironment.OWN,GomokuRLEnvironment.OTHER]);return t}set evaluation(t){this._board._evaluator=this._evaluation=t?(s,e)=>t(this._makeState(s,e,this._turn)):null}_makeState(t,s,e){const i=[e];for(let e=0;e<this._size[0];e++)for(let r=0;r<this._size[1];r++){const n=t.at([e,r]);i.push(1===n?n:n===s?GomokuRLEnvironment.OWN:GomokuRLEnvironment.OTHER)}return i}_state2board(t,s){const e=new GomokuBoard(this._size,this._evaluation),i=e.nextTurn(s);for(let r=0,n=1;r<this._size[0];r++)for(let o=0;o<this._size[1];o++,n++)t[n]===GomokuRLEnvironment.OWN?e.set([r,o],s):t[n]===GomokuRLEnvironment.OTHER&&e.set([r,o],i);return e}_checkAgent(t){if(!this._agents)throw new Error("Agent does not exist. Call reset to set agents.");if(2!==t&&3!==t)throw new Error("Unknown agent.")}reset(){return super.reset(),this._agents=[2,3],this._board.reset(),this._turn=2,this.state(2)}state(t){return t||(t=this._turn),this._checkAgent(t),this._makeState(this._board,t,this._turn)}setState(t,s){this._turn=t[0],this._board=this._state2board(t,s)}step(t,s){return s||(s=this._turn),super.step(t,s)}test(t,s,e){e||(e=this._turn),this._checkAgent(e);const i=t[0],r=t=>t?n.winner===e?this._reward.win:this._reward.lose:this._reward.step,n=this._state2board(t,e);if(e!==i){const s=n.finish;return{state:t,reward:r(s),done:s,invalid:!0}}const o=s[0].split("_").map((t=>+t)),h=n.set(o,e),a=n.finish;return h?{state:this._makeState(n,e,n.nextTurn(i)),reward:r(a),done:a}:{state:t,reward:r(a),done:a,invalid:!0}}}class GomokuBoard{constructor(t,s){this._evaluator=s,this._size=t,this._a=5,this._count=0,this.reset()}get size(){return this._size}get finish(){return null!==this.winner||this._count===this._size[0]*this._size[1]}get winner(){return this.row(3,this._a).length>0?3:this.row(2,this._a).length>0?2:null}nextTurn(t){return 2===t?3:2}copy(){const t=new GomokuBoard(this._size,this._evaluator);for(let s=0;s<this._size[0];s++)for(let e=0;e<this._size[1];e++)t._board[s][e]=this._board[s][e];return t._count=this._count,t}score(t){if(this._evaluator)return this._evaluator(this,t);const s=this.winner,e=this.nextTurn(t);return s===t?this._size[0]*this._size[1]*100-this._count:s===e?-this._size[0]*this._size[1]*100+this._count:0}at(t){return this._board[t[0]][t[1]]}set(t,s){return 1===this.at(t)&&(this._board[t[0]][t[1]]=s,this._count++,!0)}reset(){this._count=0,this._board=[];for(let t=0;t<this._size[0];t++)this._board[t]=Array(this._size[1]).fill(1)}choices(t){const s=[];if(this.finish)return s;for(let t=0;t<this._size[0];t++)for(let e=0;e<this._size[1];e++)1===this._board[t][e]&&s.push([t,e]);return s}row(t,s,e=!1){const i=[],r=(t,s)=>0<=t&&t<this._size[0]&&0<=s&&s<this._size[1],n=[[1,1],[1,0],[1,-1],[0,1]];for(let o=0;o<this._size[0];o++)for(let h=0;h<this._size[1];h++)if(this._board[o][h]===t)for(const[a,_]of n){if(r(o-a,h-_)&&this._board[o-a][h-_]===t)continue;if(!r(o+a*(s-1),h+_*(s-1)))continue;const n=[[o,h]];let u=o+a,c=h+_,l=!1;const d=[];for(let f=1;f<s&&r(u,c);f++,u+=a,c+=_)if(!e||l||1!==this._board[u][c]){if(this._board[u][c]!==t)break;if(n.push([u,c]),f===s-1){if(u+=a,c+=_,r(u,c)&&this._board[u][c]===t)break;l||(r(u,c)&&1===this._board[u][c]&&d.push([u,c]),r(o-a,h-_)&&1===this._board[o-a][h-_]&&d.push([o-a,h-_])),i.push({path:n,s:d})}}else l=!0,f--,d.push([u,c])}return i}}