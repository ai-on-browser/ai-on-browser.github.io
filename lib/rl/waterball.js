var I=Object.defineProperty;var m=(b,_)=>I(b,"name",{value:_,configurable:!0});import{RLEnvironmentBase as k,RLRealRange as u,RLStepResult as P}from"./base.js";export default class S extends k{static{m(this,"WaterballRLEnvironment")}constructor(_,i){super(),this._width=_,this._height=i,this._agent_p=[this._width/2,this._height/2],this._agent_v=[0,0],this._balls=[],this._ball_min_velocity=.1,this._ball_max_velocity=.5,this._ball_radius=10,this._sensor_length=80,this._sensor_count=20,this._agent_radius=10,this._agent_max_velocity=1,this._agent_velocity_step=.1,this._min_position=[0,0],this._max_position=[this._width,this._height],this._max_size=30,this._history_state_size=1,this._history_state=[];const s=2*Math.PI/this._sensor_count;this._sin=[],this._cos=[];for(let e=0;e<this._sensor_count;e++)this._sin[e]=this._sensor_length*Math.sin(s*e),this._cos[e]=this._sensor_length*Math.cos(s*e);for(let e=0;e<this._max_size;e++)this.addBall()}get actions(){return[[0,1,2,3]]}get states(){if(this.__states)return this.__states;this.__states=[new u(-this._agent_max_velocity,this._agent_max_velocity),new u(-this._agent_max_velocity,this._agent_max_velocity)];for(let _=0;_<this._history_state_size;_++)for(let i=0;i<this._sensor_count;i++)this.__states.push(new u(0,this._sensor_length),["none","wall","apple","poison"],new u(-this._ball_max_velocity,this._ball_max_velocity),new u(-this._ball_max_velocity,this._ball_max_velocity));return this.__states}get current_state(){const _=[];_.push(...this._agent_v);const i=this._agent_p,s=this._balls.filter(e=>Math.sqrt(e.c.reduce((t,p,o)=>t+(p-i[o])**2,0))<=this._sensor_length+this._ball_radius);for(let e=0;e<this._sensor_count;e++){const h=[i[0]+this._cos[e],i[1]+this._sin[e]],t=[h[0]-i[0],h[1]-i[1]],p=Math.sqrt(t[0]**2+t[1]**2),o=[t[0]/p,t[1]/p];let l=1/0,r=null;for(let n=0;n<2;n++)if(h[n]<this._min_position[n]||this._max_position[n]<h[n]){const v=h[n]<this._min_position[n]?this._min_position[n]:this._max_position[n];l=Math.min(l,this._sensor_length*(i[n]-v)/(i[n]-h[n])),r={type:"wall",v:[0,0]}}for(let n=0;n<s.length;n++){const v=s[n],y=v.c,a=[y[0]-i[0],y[1]-i[1]],B=Math.sqrt(a[0]**2+a[1]**2),d=[y[0]-h[0],y[1]-h[1]],x=o[0]*a[1]-a[0]*o[1];if(Math.abs(x)>this._ball_radius)continue;const L=t[0]*a[0]+t[1]*a[1],E=t[0]*d[0]+t[1]*d[1];if(L*E>0){const c=Math.sqrt(d[0]**2+d[1]**2);if(B>this._ball_radius&&c>this._ball_radius)continue}let g;if(t[0]===0)g=[t[0],a[1]];else if(t[1]===0)g=[a[0],t[1]];else{const c=t[1]/t[0],q=t[1]-c*t[0],f=-1/c,R=a[1]-f*a[0];g=[(R-q)/(c-f),(R*c-q*f)/(c-f)]}const M=Math.sqrt(this._ball_radius**2-x**2),w=[g[0]-o[0]*M,g[1]-o[1]*M],z=Math.sqrt(w[0]**2+w[1]**2);z<l&&(l=z,r=v)}_.push(l<1/0?l:this._sensor_length,r?r.type:"none",r?r.v[0]:0,r?r.v[1]:0)}return _}addBall(){const _=m(t=>Math.random()*(this._max_position[t]-this._min_position[t])+this._min_position[t],"random_position"),i=m(()=>(Math.random()*(this._ball_max_velocity-this._ball_min_velocity)+this._ball_min_velocity)*(Math.random()<.5?-1:1),"random_velocity"),s=Math.random()<.5?"apple":"poison",e=[_(0),_(1)],h={type:s,c:e,v:[i(),i()],update:m(()=>{for(let t=0;t<2;t++)h.c[t]+=h.v[t],(h.c[t]<=this._min_position[t]||this._max_position[t]<=h.c[t])&&(h.v[t]*=-1)},"update")};this._balls.push(h)}reset(){super.reset(),this._balls=[];for(let _=0;_<this._max_size;_++)this.addBall();return this.state()}state(){if(this.__state)return this.__state;const _=this.current_state;for(this._history_state.push(this.current_state),this._history_state.length>this._history_state_size&&this._history_state.shift();this._history_state.length<this._history_state_size;)this._history_state.push(_);this.__state=this._history_state[0].concat();for(let i=1;i<this._history_state.length;i++)this.__state.push(...this._history_state[i].slice(2));return this.__state}step(_){this._epoch++,this.__state=null,this._balls.forEach(s=>s.update()),_[0]===0?this._agent_v[0]+=this._agent_velocity_step:_[0]===1?this._agent_v[0]-=this._agent_velocity_step:_[0]===2?this._agent_v[1]+=this._agent_velocity_step:_[0]===3&&(this._agent_v[1]-=this._agent_velocity_step);for(let s=0;s<2;s++)this._agent_v[s]>this._agent_max_velocity&&(this._agent_v[s]=this._agent_max_velocity),this._agent_v[s]<-this._agent_max_velocity&&(this._agent_v[s]=-this._agent_max_velocity);this._agent_p[0]+=this._agent_v[0],this._agent_p[1]+=this._agent_v[1];let i=-.01;for(let s=this._balls.length-1;s>=0;s--){const e=this._balls[s],h=e.c;Math.sqrt(this._agent_p.reduce((p,o,l)=>p+(o-h[l])**2,0))<=this._agent_radius+this._ball_radius&&(e.type==="apple"?i+=1:i-=1,this._balls.splice(s,1))}for(let s=0;s<2;s++)this._agent_p[s]<this._min_position[s]?(this._agent_p[s]=this._min_position[s],i-=1):this._agent_p[s]>this._max_position[s]&&(this._agent_p[s]=this._max_position[s],i-=1);return this._balls.length<this._max_size&&Math.random()<.01&&this.addBall(),new P(this,this.state(),i,!1)}}
