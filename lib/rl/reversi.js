var p=Object.defineProperty;var f=(d,t)=>p(d,"name",{value:t,configurable:!0});import{RLEnvironmentBase as A}from"./base.js";const a=1,n=2,_=3,b=f(d=>d===n?_:d===_?n:a,"flipPiece");export default class u extends A{static{f(this,"ReversiRLEnvironment")}constructor(){super(),this._size=[8,8],this._board=new z(this._size,this._evaluation),this._turn=n,this._reward={win:1,lose:-1,step:0}}static BLACK=n;static WHITE=_;static EMPTY=a;static OWN=2;static OTHER=3;get actions(){const t=[a];for(let s=0;s<this._size[0];s++)for(let e=0;e<this._size[1];e++)t.push(`${String.fromCharCode(97+s)}${s+1}`);return[t]}get states(){const t=[[n,_]];for(let s=0;s<this._size[0]*this._size[1];s++)t.push([a,u.OWN,u.OTHER]);return t}set evaluation(t){t?this._board._evaluator=this._evaluation=(s,e)=>t(this._makeState(s,e,this._turn)):this._board._evaluator=this._evaluation=null}_makeState(t,s,e){const i=[e];for(let r=0;r<this._size[0];r++)for(let o=0;o<this._size[1];o++){const h=t.at([r,o]);i.push(h===a?h:h===s?u.OWN:u.OTHER)}return i}_state2board(t,s){const e=new z(this._size,this._evaluation),i=b(s);for(let r=0,o=1;r<this._size[0];r++)for(let h=0;h<this._size[1];h++,o++)t[o]===a?e._board[r][h]=a:t[o]===u.OWN?e._board[r][h]=s:e._board[r][h]=i;return e}_checkAgent(t){if(!this._agents)throw new Error("Agent does not exist. Call reset to set agents.");if(t!==n&&t!==_)throw new Error("Unknown agent.")}reset(){return super.reset(),this._agents=[n,_],this._board.reset(),this._turn=n,this.state(n)}state(t){return t||(t=this._turn),this._checkAgent(t),this._makeState(this._board,t,this._turn)}setState(t,s){this._turn=t[0],this._board=this._state2board(t,s)}step(t,s){return s||(s=this._turn),super.step(t,s)}test(t,s,e){e||(e=this._turn),this._checkAgent(e);const i=t[0],r=f(c=>c?o.winner===e?this._reward.win:this._reward.lose:this._reward.step,"getreward"),o=this._state2board(t,e);if(e!==i){const c=o.finish;return{state:t,reward:r(c),done:c,invalid:!0}}if(s[0]===a){const c=o.choices(e),w=o.finish,k=c.length>0;return{state:k?t:this._makeState(o,e,b(i)),reward:r(w),done:w,invalid:k}}const h=o.set(s[0],e),l=o.finish;return h?{state:this._makeState(o,e,b(i)),reward:r(l),done:l}:{state:t,reward:r(l),done:l,invalid:!0}}}class z{static{f(this,"ReversiBoard")}constructor(t,s){this._evaluator=s,this._size=t,this.reset()}get size(){return this._size}get count(){let t=0,s=0;for(let e=0;e<this._size[0];e++)for(let i=0;i<this._size[1];i++)this._board[e][i]===_?s++:this._board[e][i]===n&&t++;return{black:t,white:s}}get finish(){return this.choices(n).length+this.choices(_).length===0}get winner(){if(!this.finish)return null;const t=this.count;return t.black>t.white?n:t.black<t.white?_:null}toString(){let t="";for(let s=0;s<this._size[0];s++){for(let e=0;e<this._size[1];e++)e>0&&(t+=" "),this._board[s][e]===n?t+="x":this._board[s][e]===_?t+="o":t+="-";t+=`
`}return t}nextTurn(t){return b(t)}copy(){const t=new z(this._size,this._evaluator);for(let s=0;s<this._size[0];s++)for(let e=0;e<this._size[1];e++)t._board[s][e]=this._board[s][e];return t}score(t){if(this._evaluator)return this._evaluator(this,t);const s=this.count;return t===n?s.black-s.white:s.white-s.black}at(t){return typeof t=="string"&&(t=[t[1]-1,t.charCodeAt(0)-97]),this._board[t[0]][t[1]]}set(t,s){typeof t=="string"&&(t=[t[1]-1,t.charCodeAt(0)-97]);const e=this.flipPositions(t[0],t[1],s);if(e.length===0)return!1;this._board[t[0]][t[1]]=s;for(const[i,r]of e)this._board[i][r]=s;return!0}reset(){this._board=[];for(let e=0;e<this._size[0];e++)this._board[e]=Array(this._size[1]).fill(a);const t=Math.floor(this._size[0]/2),s=Math.floor(this._size[1]/2);this._board[t-1][s-1]=_,this._board[t-1][s]=n,this._board[t][s-1]=n,this._board[t][s]=_}choices(t){const s=[];for(let e=0;e<this._size[0];e++)for(let i=0;i<this._size[1];i++)this.flipPositions(e,i,t).length>0&&s.push([e,i]);return s}flipPositions(t,s,e){if(t<0||s<0||this._size[0]<=t||this._size[1]<=s)return[];if(e===a||this._board[t][s]!==a)return[];const i=[];for(const[r,o]of[[1,1],[1,0],[1,-1],[0,-1],[-1,-1],[-1,0],[-1,1],[0,1]]){let h=t,l=s;const c=[];for(;h+=r,l+=o,!(h<0||l<0||this._size[0]<=h||this._size[1]<=l);){if(this._board[h][l]===e){i.push(...c);break}else if(this._board[h][l]===a)break;c.push([h,l])}}return i}}
