var W=Object.defineProperty;var j=(E,t)=>W(E,"name",{value:t,configurable:!0});import{RLEnvironmentBase as H,RLStepResult as z}from"./base.js";const l=1,c=2,_=4,d=8,M=c|d,N=_|d;export default class b extends H{static{j(this,"DraughtsRLEnvironment")}constructor(){super(),this._size=[8,8],this._board=new g(this._size),this._reward={win:1,lose:-1,step:0}}static EMPTY=l;static RED=c;static WHITE=_;static KING=d;static OWN=2;static OTHER=4;get actions(){const t=[l],s=[[1,1],[-1,1],[-1,-1],[1,-1]],e=j((n,o)=>0<=n&&n<this._size[0]&&0<=o&&o<this._size[1],"checkBound");for(let n=0;n<this._size[0];n++)for(let o=n%2===1?0:1;o<this._size[1];o+=2){let i=[];for(const[r,a]of s){const f=n+r,h=o+a;e(f,h)&&t.push({from:[n,o],path:[[f,h]],jump:[]});const u=f+r,p=h+a;if(e(u,p)){const m={from:[n,o],path:[[u,p]],jump:[[f,h]]};t.push(m),i.push(m)}}for(;i.length>0;){const r=[];for(const a of i){const f=a.path[a.path.length-1];for(const[h,u]of s){const p=f[0]+h,m=f[1]+u,k=p+h,T=m+u;if(e(k,T)&&a.jump.every(([w,O])=>w!==p||O!==m)){const w={from:[n,o],path:[...a.path,[k,T]],jump:[...a.jump,[p,m]]};t.push(w),r.push(w)}}}i=r}}return[t]}get states(){const t=[[c,_]];for(let s=0;s<this._size[0];s++)for(let e=s%2===0?1:0;e<this._size[1];e+=2)t.push([l,b.OWN,b.OWN|d,b.OTHER,b.OTHER|d]);return t}_makeState(t,s,e){const n=[e];for(let o=0;o<this._size[0];o++)for(let i=o%2===0?1:0;i<this._size[1];i+=2){const r=t.at([o,i]);if(r===l)n.push(l);else{const a=r&s?b.OWN:b.OTHER;r&d?n.push(a|d):n.push(a)}}return n}_state2board(t,s){const e=new g(this._size),n=s===c?_:c;for(let o=0,i=1;o<this._size[0];o++)for(let r=o%2===0?1:0;r<this._size[1];r+=2,i++)t[i]===l?e._board[o][r]=l:(e._board[o][r]=t[i]&b.OWN?s:n,t[i]&d&&(e._board[o][r]|=d));return e}_checkAgent(t){if(!this._agents)throw new Error("Agent does not exist. Call reset to set agents.");if(t!==c&&t!==_)throw new Error("Unknown agent.")}reset(){return super.reset(),this._agents=[c,_],this._board.reset(),this._turn=c,this.state(c)}state(t){return t||(t=this._turn),this._checkAgent(t),this._makeState(this._board,t,this._turn)}setState(t,s){this._turn=t[0],this._board=this._state2board(t,s)}step(t,s){return s||(s=this._turn),super.step(t,s)}test(t,s,e){e||(e=this._turn),this._checkAgent(e);const n=t[0],o=j(u=>u?i.winner===e?this._reward.win:this._reward.lose:this._reward.step,"getreward"),i=this._state2board(t,e),r=i.finish;if(e!==n)return new z(this,t,o(r),r,!0);const a=i.choices(e);if(s[0]===l){const u=a.length>0;return new z(this,u?t:this._makeState(i,e,n===c?_:c),o(r),r,u)}if(a.some(u=>u.jump.length>0)&&s[0].jump.length===0)return new z(this,t,o(r),r,!0);const f=i.set(s[0],e),h=i.finish;return f?new z(this,this._makeState(i,e,n===c?_:c),o(h),h):new z(this,t,o(h),h,!0)}}class g{static{j(this,"DraughtsBoard")}constructor(t){this._size=t,this._lines=3,this.reset()}get size(){return this._size}get count(){const t={};for(let s=0;s<this._size[0];s++)for(let e=0;e<this._size[1];e++)t[this._board[s][e]]||(t[this._board[s][e]]=0),t[this._board[s][e]]++;return{red:t[c]||0,white:t[_]||0,redking:t[M]||0,whiteking:t[N]||0}}get finish(){return this.choices(c).length===0||this.choices(_).length===0}get winner(){return this.choices(c).length===0?_:this.choices(_).length===0?c:null}toString(){let t="";for(let s=0;s<this._size[0];s++){for(let e=0;e<this._size[1];e++)e>0&&(t+=" "),this._board[s][e]&c?t+="x":this._board[s][e]&_?t+="o":t+="-";t+=`
`}return t}nextTurn(t){return t===_?c:_}copy(){const t=new g(this._size);for(let s=0;s<this._size[0];s++)t._board[s]=this._board[s].concat();return t}score(t){const s=this.count;return t===c?s.red+s.redking*2-s.white-s.whiteking*4:s.white+s.whiteking*2-s.red-s.redking*4}_num_to_pos(t){if(typeof t!="number")return t;const s=Math.floor((t-1)/this._size[1]),e=(t-1)%this._size[1];return e<(this._size[1]-1)/2?[s*2,e*2+1]:[s*2+1,(e-Math.floor(this._size[1]/2))*2]}at(t){return typeof t=="number"&&(t=this._num_to_pos(t)),this._board[t[0]][t[1]]}set(t,s){t={from:this._num_to_pos(t.from),path:t.path.map(i=>this._num_to_pos(i)),jump:t.jump.map(i=>this._num_to_pos(i))};let e=this.at(t.from);if(!(s&e)||(t.jump.length!==0||t.path.length!==1)&&t.jump.length!==t.path.length)return!1;const n=this.nextTurn(s);if(t.jump.some(i=>!(this.at(i)&n))||t.path.some(i=>this.at(i)!==l))return!1;if(!(e&d)){const i=t.path[0][0]-t.from[0];if(s===c&&i<0||s===_&&i>0)return!1}if(t.jump.length===0){for(let i=0;i<2;i++)if(Math.abs(t.from[i]-t.path[0][i])!==1)return!1}else{let i=t.from;for(let r=0;r<t.path.length;r++){for(let a=0;a<2;a++)if(Math.abs(i[a]-t.jump[r][a])!==1||Math.abs(t.jump[r][a]-t.path[r][a])!==1)return!1;i=t.path[r]}}this._board[t.from[0]][t.from[1]]=l;for(const[i,r]of t.jump)this._board[i][r]=l;const o=t.path[t.path.length-1];return(s===c&&o[0]===this._size[0]-1||s===_&&o[0]===0)&&(e|=d),this._board[o[0]][o[1]]=e,!0}reset(){this._board=[];for(let t=0;t<this._size[0];t++)this._board[t]=Array(this._size[1]).fill(l);for(let t=0;t<this._size[0];t++)for(let s=t%2===0?1:0;s<this._size[1];s+=2)t<this._lines?this._board[t][s]=c:this._size[0]-this._lines<=t&&(this._board[t][s]=_)}choices(t){const s=[];for(let e=0;e<this._size[0];e++)for(let n=0;n<this._size[1];n++)this._board[e][n]&t&&s.push(...this.allPath(e,n,t));return s.some(e=>e.jump.length>0)?s.filter(e=>e.jump.length>0):s}allPath(t,s,e,n=!0){if(!(this._board[t][s]&e))return[];const o=j((f,h)=>0<=f&&f<this._size[0]&&0<=h&&h<this._size[1],"checkBound"),i=e===c?_:c,r=[];this._board[t][s]&d?r.push([1,1],[-1,1],[-1,-1],[1,-1]):e===c?r.push([1,1],[1,-1]):r.push([-1,1],[-1,-1]);const a=[];for(const[f,h]of r)if(o(t+f,s+h)&&(n&&this._board[t+f][s+h]===l&&a.push({from:[t,s],path:[[t+f,s+h]],jump:[]}),!!(this._board[t+f][s+h]&i)&&o(t+f*2,s+h*2)&&this._board[t+f*2][s+h*2]===l)){const u=this.copy();u._board[t+f*2][s+h*2]=this._board[t][s],u._board[t][s]=l,u._board[t+f][s+h]=l,(e===c&&t+f*2===this._size[0]-1||e===_&&t+f*2===0)&&(u._board[t+f*2][s+h*2]|=d);const p=u.allPath(t+f*2,s+h*2,e,!1);if(p.length===0)a.push({from:[t,s],path:[[t+f*2,s+h*2]],jump:[[t+f,s+h]]});else for(const m of p)a.push({from:[t,s],path:[[t+f*2,s+h*2],...m.path],jump:[[t+f,s+h],...m.jump]})}return a}}
