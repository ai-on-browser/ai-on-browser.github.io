var E=Object.defineProperty;var j=(v,t)=>E(v,"name",{value:t,configurable:!0});import{RLEnvironmentBase as O}from"./base.js";const c=1,f=2,l=4,d=8,W=f|d,H=l|d;export default class b extends O{static{j(this,"DraughtsRLEnvironment")}constructor(){super(),this._size=[8,8],this._board=new w(this._size,this._evaluation),this._reward={win:1,lose:-1,step:0}}static EMPTY=c;static RED=f;static WHITE=l;static KING=d;static OWN=2;static OTHER=4;get actions(){const t=[c],s=[[1,1],[-1,1],[-1,-1],[1,-1]],e=j((n,o)=>0<=n&&n<this._size[0]&&0<=o&&o<this._size[1],"checkBound");for(let n=0;n<this._size[0];n++)for(let o=n%2===1?0:1;o<this._size[1];o+=2){let i=[];for(const[r,_]of s){const a=n+r,h=o+_;e(a,h)&&t.push({from:[n,o],path:[[a,h]],jump:[]});const u=a+r,p=h+_;if(e(u,p)){const m={from:[n,o],path:[[u,p]],jump:[[a,h]]};t.push(m),i.push(m)}}for(;i.length>0;){const r=[];for(const _ of i){const a=_.path[_.path.length-1];for(const[h,u]of s){const p=a[0]+h,m=a[1]+u,g=p+h,k=m+u;if(e(g,k)&&_.jump.every(([z,T])=>z!==p||T!==m)){const z={from:[n,o],path:[..._.path,[g,k]],jump:[..._.jump,[p,m]]};t.push(z),r.push(z)}}}i=r}}return[t]}get states(){const t=[[f,l]];for(let s=0;s<this._size[0];s++)for(let e=s%2===0?1:0;e<this._size[1];e+=2)t.push([c,b.OWN,b.OWN|d,b.OTHER,b.OTHER|d]);return t}set evaluation(t){t?this._board._evaluator=this._evaluation=(s,e)=>t(this._makeState(s,e,this._turn)):this._board._evaluator=this._evaluation=null}_makeState(t,s,e){const n=[e];for(let o=0;o<this._size[0];o++)for(let i=o%2===0?1:0;i<this._size[1];i+=2){const r=t.at([o,i]);if(r===c)n.push(c);else{const _=r&s?b.OWN:b.OTHER;r&d?n.push(_|d):n.push(_)}}return n}_state2board(t,s){const e=new w(this._size,this._evaluation),n=s===f?l:f;for(let o=0,i=1;o<this._size[0];o++)for(let r=o%2===0?1:0;r<this._size[1];r+=2,i++)t[i]===c?e._board[o][r]=c:(e._board[o][r]=t[i]&b.OWN?s:n,t[i]&d&&(e._board[o][r]|=d));return e}_checkAgent(t){if(!this._agents)throw new Error("Agent does not exist. Call reset to set agents.");if(t!==f&&t!==l)throw new Error("Unknown agent.")}reset(){return super.reset(),this._agents=[f,l],this._board.reset(),this._turn=f,this.state(f)}state(t){return t||(t=this._turn),this._checkAgent(t),this._makeState(this._board,t,this._turn)}setState(t,s){this._turn=t[0],this._board=this._state2board(t,s)}step(t,s){return s||(s=this._turn),super.step(t,s)}test(t,s,e){e||(e=this._turn),this._checkAgent(e);const n=t[0],o=j(u=>u?i.winner===e?this._reward.win:this._reward.lose:this._reward.step,"getreward"),i=this._state2board(t,e),r=i.finish;if(e!==n)return{state:t,reward:o(r),done:r,invalid:!0};const _=i.choices(e);if(s[0]===c){const u=_.length>0;return{state:u?t:this._makeState(i,e,n===f?l:f),reward:o(r),done:r,invalid:u}}if(_.some(u=>u.jump.length>0)&&s[0].jump.length===0)return{state:t,reward:o(r),done:r,invalid:!0};const a=i.set(s[0],e),h=i.finish;return a?{state:this._makeState(i,e,n===f?l:f),reward:o(h),done:h}:{state:t,reward:o(h),done:h,invalid:!0}}}class w{static{j(this,"DraughtsBoard")}constructor(t,s){this._evaluator=s,this._size=t,this._lines=3,this.reset()}get size(){return this._size}get count(){const t={};for(let s=0;s<this._size[0];s++)for(let e=0;e<this._size[1];e++)t[this._board[s][e]]||(t[this._board[s][e]]=0),t[this._board[s][e]]++;return{red:t[f]||0,white:t[l]||0,redking:t[W]||0,whiteking:t[H]||0}}get finish(){return this.choices(f).length===0||this.choices(l).length===0}get winner(){return this.choices(f).length===0?l:this.choices(l).length===0?f:null}toString(){let t="";for(let s=0;s<this._size[0];s++){for(let e=0;e<this._size[1];e++)e>0&&(t+=" "),this._board[s][e]&f?t+="x":this._board[s][e]&l?t+="o":t+="-";t+=`
`}return t}nextTurn(t){return t===l?f:l}copy(){const t=new w(this._size,this._evaluator);for(let s=0;s<this._size[0];s++)t._board[s]=this._board[s].concat();return t}score(t){if(this._evaluator)return this._evaluator(this,t);const s=this.count;return t===f?s.red+s.redking*2-s.white-s.whiteking*4:s.white+s.whiteking*2-s.red-s.redking*4}_num_to_pos(t){if(typeof t!="number")return t;const s=Math.floor((t-1)/this._size[1]),e=(t-1)%this._size[1];return e<(this._size[1]-1)/2?[s*2,e*2+1]:[s*2+1,(e-Math.floor(this._size[1]/2))*2]}at(t){return typeof t=="number"&&(t=this._num_to_pos(t)),this._board[t[0]][t[1]]}set(t,s){t={from:this._num_to_pos(t.from),path:t.path.map(i=>this._num_to_pos(i)),jump:t.jump.map(i=>this._num_to_pos(i))};let e=this.at(t.from);if(!(s&e)||(t.jump.length!==0||t.path.length!==1)&&t.jump.length!==t.path.length)return!1;const n=this.nextTurn(s);if(t.jump.some(i=>!(this.at(i)&n))||t.path.some(i=>this.at(i)!==c))return!1;if(!(e&d)){const i=t.path[0][0]-t.from[0];if(s===f&&i<0||s===l&&i>0)return!1}if(t.jump.length===0){for(let i=0;i<2;i++)if(Math.abs(t.from[i]-t.path[0][i])!==1)return!1}else{let i=t.from;for(let r=0;r<t.path.length;r++){for(let _=0;_<2;_++)if(Math.abs(i[_]-t.jump[r][_])!==1||Math.abs(t.jump[r][_]-t.path[r][_])!==1)return!1;i=t.path[r]}}this._board[t.from[0]][t.from[1]]=c;for(const[i,r]of t.jump)this._board[i][r]=c;const o=t.path[t.path.length-1];return(s===f&&o[0]===this._size[0]-1||s===l&&o[0]===0)&&(e|=d),this._board[o[0]][o[1]]=e,!0}reset(){this._board=[];for(let t=0;t<this._size[0];t++)this._board[t]=Array(this._size[1]).fill(c);for(let t=0;t<this._size[0];t++)for(let s=t%2===0?1:0;s<this._size[1];s+=2)t<this._lines?this._board[t][s]=f:this._size[0]-this._lines<=t&&(this._board[t][s]=l)}choices(t){const s=[];for(let e=0;e<this._size[0];e++)for(let n=0;n<this._size[1];n++)this._board[e][n]&t&&s.push(...this.allPath(e,n,t));return s.some(e=>e.jump.length>0)?s.filter(e=>e.jump.length>0):s}allPath(t,s,e,n=!0){if(!(this._board[t][s]&e))return[];const o=j((a,h)=>0<=a&&a<this._size[0]&&0<=h&&h<this._size[1],"checkBound"),i=e===f?l:f,r=[];this._board[t][s]&d?r.push([1,1],[-1,1],[-1,-1],[1,-1]):e===f?r.push([1,1],[1,-1]):r.push([-1,1],[-1,-1]);const _=[];for(const[a,h]of r)if(o(t+a,s+h)&&(n&&this._board[t+a][s+h]===c&&_.push({from:[t,s],path:[[t+a,s+h]],jump:[]}),!!(this._board[t+a][s+h]&i)&&o(t+a*2,s+h*2)&&this._board[t+a*2][s+h*2]===c)){const u=this.copy();u._board[t+a*2][s+h*2]=this._board[t][s],u._board[t][s]=c,u._board[t+a][s+h]=c,(e===f&&t+a*2===this._size[0]-1||e===l&&t+a*2===0)&&(u._board[t+a*2][s+h*2]|=d);const p=u.allPath(t+a*2,s+h*2,e,!1);if(p.length===0)_.push({from:[t,s],path:[[t+a*2,s+h*2]],jump:[[t+a,s+h]]});else for(const m of p)_.push({from:[t,s],path:[[t+a*2,s+h*2],...m.path],jump:[[t+a,s+h],...m.jump]})}return _}}
