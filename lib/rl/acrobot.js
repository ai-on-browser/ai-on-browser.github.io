import{RLRealRange,RLEnvironmentBase}from"./base.js";export default class AcrobotRLEnvironment extends RLEnvironmentBase{constructor(){super(),this._theta1=0,this._theta2=0,this._dtheta1=0,this._dtheta2=0,this._link_len1=1,this._link_len2=1,this._link_mass1=1,this._link_mass2=1,this._link_com_pos1=.5,this._link_com_pos2=.5,this._moi=1,this._max_vel1=4*Math.PI,this._max_vel2=9*Math.PI,this._g=9.8,this._dt=.1,this._max_step=200,this._reward={goal:0,step:-1,fail:0}}get actions(){return[[-1,0,1]]}get states(){return[new RLRealRange(-Math.PI,Math.PI),new RLRealRange(-Math.PI,Math.PI),new RLRealRange(-this._max_vel1,this._max_vel1),new RLRealRange(-this._max_vel2,this._max_vel2)]}set reward(t){this._reward={goal:0,step:-1,fail:0},"achieve"===t&&(this._reward={goal:0,step:-1,fail:0})}reset(){return super.reset(),this._theta1=.2*Math.random()-.1,this._theta2=.2*Math.random()-.1,this._dtheta1=.2*Math.random()-.1,this._dtheta2=.2*Math.random()-.1,this.state()}state(){return[this._theta1,this._theta2,this._dtheta1,this._dtheta2]}step(t,s){super.step(t,s);const a=this.test(this.state(),t,s);return this._theta1=a.state[0],this._theta2=a.state[1],this._dtheta1=a.state[2],this._dtheta2=a.state[3],a}test(t,s,a){let[h,e,i,_]=t;const n=s[0],r=this._link_mass1,o=this._link_mass2,l=this._link_len1,m=this._link_com_pos1,M=this._link_com_pos2,d=this._moi,c=this._moi,p=this._g,R=r*m**2+o*(l**2+M**2+2*l*M*Math.cos(e))+d+c,I=o*(M**2+l*M*Math.cos(e))+c,P=o*M*p*Math.cos(h+e-Math.PI/2),v=(n+I/R*(-o*l*M*_**2*Math.sin(e)-2*o*l*M*_*i*Math.sin(e)+(r*m+o*l)*p*Math.cos(h-Math.PI/2)+P)-o*l*M*i**2*Math.sin(e)-P)/(o*M**2+c-I**2/R),x=-(I*v+P)/R,g=(t,s,a)=>t<s?s:t>a?a:t;h+=this._dt*i,h<-Math.PI&&(h+=2*Math.PI),h>Math.PI&&(h-=2*Math.PI),e+=this._dt*_,e<-Math.PI&&(e+=2*Math.PI),e>Math.PI&&(e-=2*Math.PI),i=g(i+this._dt*x,-this._max_vel1,this._max_vel1),_=g(_+this._dt*v,-this._max_vel2,this._max_vel2);const w=this.epoch>=this._max_step,k=-Math.cos(h)-Math.cos(e+h)>1||w;return{state:[h,e,i,_],reward:w?this._reward.fail:k?this._reward.goal:this._reward.step,done:k}}}