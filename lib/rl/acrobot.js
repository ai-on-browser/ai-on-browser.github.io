import{RLRealRange,RLEnvironmentBase}from"./base.js";export default class AcrobotRLEnvironment extends RLEnvironmentBase{constructor(){super(),this._theta1=0,this._theta2=0,this._dtheta1=0,this._dtheta2=0,this._link_len1=1,this._link_len2=1,this._link_mass1=1,this._link_mass2=1,this._link_com_pos1=.5,this._link_com_pos2=.5,this._moi=1,this._max_vel1=4*Math.PI,this._max_vel2=9*Math.PI,this._g=9.8,this._dt=.1,this._max_step=200,this._reward={goal:0,step:-1,fail:0}}get actions(){return[[-1,0,1]]}get states(){return[new RLRealRange(-Math.PI,Math.PI),new RLRealRange(-Math.PI,Math.PI),new RLRealRange(-this._max_vel1,this._max_vel1),new RLRealRange(-this._max_vel2,this._max_vel2)]}set reward(t){this._reward={goal:0,step:-1,fail:0},"achieve"===t&&(this._reward={goal:0,step:-1,fail:0})}reset(){return super.reset(),this._theta1=.2*Math.random()-.1,this._theta2=.2*Math.random()-.1,this._dtheta1=.2*Math.random()-.1,this._dtheta2=.2*Math.random()-.1,this.state()}state(){return[this._theta1,this._theta2,this._dtheta1,this._dtheta2]}step(t,s){super.step(t,s);const a=this.test(this.state(),t,s);return this._theta1=a.state[0],this._theta2=a.state[1],this._dtheta1=a.state[2],this._dtheta2=a.state[3],a}test(t,s){let[a,h,e,i]=t;const _=s[0],n=this._link_mass1,r=this._link_mass2,o=this._link_len1,l=this._link_com_pos1,m=this._link_com_pos2,M=this._moi,d=this._moi,c=this._g,p=n*l**2+r*(o**2+m**2+2*o*m*Math.cos(h))+M+d,R=r*(m**2+o*m*Math.cos(h))+d,I=r*m*c*Math.cos(a+h-Math.PI/2),P=(_+R/p*(-r*o*m*i**2*Math.sin(h)-2*r*o*m*i*e*Math.sin(h)+(n*l+r*o)*c*Math.cos(a-Math.PI/2)+I)-r*o*m*e**2*Math.sin(h)-I)/(r*m**2+d-R**2/p),v=-(R*P+I)/p,x=(t,s,a)=>t<s?s:t>a?a:t;a+=this._dt*e,a<-Math.PI&&(a+=2*Math.PI),a>Math.PI&&(a-=2*Math.PI),h+=this._dt*i,h<-Math.PI&&(h+=2*Math.PI),h>Math.PI&&(h-=2*Math.PI),e=x(e+this._dt*v,-this._max_vel1,this._max_vel1),i=x(i+this._dt*P,-this._max_vel2,this._max_vel2);const g=this.epoch>=this._max_step,w=-Math.cos(a)-Math.cos(h+a)>1||g;return{state:[a,h,e,i],reward:g?this._reward.fail:w?this._reward.goal:this._reward.step,done:w}}}