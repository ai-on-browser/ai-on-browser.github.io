import{DefaultPlatform}from"./platform/base.js";import{EmptyData}from"./data/base.js";import ManualData from"./data/manual.js";const loadedPlatform={"":DefaultPlatform},loadedData={"":EmptyData,manual:ManualData},loadedPreprocess={},loadedModel={};export default class AIManager{constructor(t){this._setting=t,this._platform=new DefaultPlatform(this),this._task="",this._datas=new ManualData(this),this._dataset="manual",this._preprocess=[],this._modelname="",this._listener=[]}get platform(){return this._platform}get task(){return this._task}get preprocesses(){return this._preprocess}get setting(){return this._setting}get datas(){return this._datas}onReady(t){if(this._platform&&this._datas)return t();this._listener.push(t)}resolveListeners(){for(const t of this._listener)t();this._listener=[]}resolveListenersIfCan(){this._platform&&this._datas&&this.resolveListeners()}requiredRenderers(t){this._requireRenderers=t,this._platform&&this._requireRenderers&&this._platform._renderer.push(...this._requireRenderers.map((t=>new t(this))))}async setTask(t){if(!this._platform)return;if(this._task===t)return void this._platform.init();this._platform.terminate(),this._platform=null,this._task=t;let s="";if("MD"===this._task||"GM"===this._task?s="rl":"TP"===this._task||"SM"===this._task||"CP"===this._task?s="series":"SG"===this._task||"DN"===this._task||"ED"===this._task?s="image":"WE"===this._task?s="document":"SC"===this._task?s="semisupervised":"RC"===this._task&&(s="recommend"),!loadedPlatform[s]){const t=await import(`./platform/${s}.js`);loadedPlatform[s]=t.default}if("MD"===t||"GM"===t)return new Promise((t=>{new loadedPlatform[s](this,(s=>{this._platform=s,this._platform.init(),this._setting.ml.modelName||s.render(),this.resolveListenersIfCan(),t()}))}));this._platform=new loadedPlatform[s](this),this._requireRenderers&&this._platform._renderer.push(...this._requireRenderers.map((t=>new t(this)))),this._platform.init(),this.resolveListenersIfCan()}async setPreprocess(t){if(this._preprocess.forEach((t=>t.terminate())),this._preprocess=[],t){if(!loadedPreprocess[t]){const s=await import(`./preprocess/${t}.js`);loadedPreprocess[t]=s.default}this._preprocess=[new loadedPreprocess[t](this)]}}async setData(t){if(this._datas.terminate(),this._datas=null,this._dataset=t,!loadedData[this._dataset]){const s=await import(`./data/${t}.js`);loadedData[t]=s.default}this._datas=new loadedData[this._dataset](this),this._platform?.init(),this.resolveListenersIfCan()}async setModel(t){if(this._modelname=t,t){if(!loadedModel[t]){const s=await import(`./view/${t}.js`);loadedModel[t]=s.default}try{loadedModel[t](this.platform)}catch(t){return console.error(t),t}}}}