import FittingMode from"../fitting.js";const scale=function(t,e,s,i,a){return isFinite(e)&&isFinite(s)&&e!==s?(t-e)/(s-e)*(a-i)+i:(a+i)/2};class DataRenderer{constructor(t){if(this._manager=t,this._r=this.setting.svg.select("g.points g.datas"),0===this._r.size()){const t=this.setting.svg.append("g").classed("points",!0);this._r=t.append("g").classed("datas",!0)}this._p=[],this._pad=10,this._clip_pad=-1/0,this._pred_count=0,this._observe_target=null,this._observer=new MutationObserver((t=>{this._observe_target&&this._p.forEach(((t,e)=>t.title=this.data._categorical_output?this.data._output_category_names[this.data.y[e]-1]:this.data.y[e]))})),this._observer.observe(this.setting.svg.node(),{childList:!0}),this._default_k=()=>this._series?[Math.min(1,this.data.dimension-1)]:1===this.data.dimension?[0]:[0,1],this._k=this._default_k,this._will_render=!1}get padding(){return Array.isArray(this._pad)?this._pad:[this._pad,this._pad]}set padding(t){this._pad=t,this.render()}set clipPadding(t){this._clip_pad=t,this.render()}get _series(){return this.data?.isSeries}get setting(){return this._manager.setting}get width(){return this._manager.platform.width}get height(){return this._manager.platform.height}get points(){return this._p}get data(){return this._manager.datas}_make_selector(t){let e=this.setting.data.configElement.select("div.column-selector");if(0===e.size()?e=this.setting.data.configElement.append("div").classed("column-selector",!0):e.selectAll("*").remove(),this.data.dimension<=2)this._k=this._default_k;else if(this.data.dimension<=4){const s=e.append("table").style("border-collapse","collapse");let i=s.append("tr").style("text-align","center");i.append("td"),i.append("td").text(">"),i.append("td").text("V").style("transform","rotate(180deg");const a=[],n=[];for(let e=0;e<this.data.dimension;e++){i=s.append("tr"),s.append("td").text(t[e]).style("text-align","right");const r=s.append("td").append("input").attr("type","radio").attr("name","data-d1").on("change",(()=>this.render()));a.push(r);const h=s.append("td").append("input").attr("type","radio").attr("name","data-d2").on("change",(()=>this.render()));n.push(h)}a[0].property("checked",!0),n[1].property("checked",!0),this._k=()=>{const t=[];for(let e=0;e<this.data.dimension;e++)a[e].property("checked")&&(t[0]=e),n[e].property("checked")&&(t[1]=e);return t}}else{t=t.map((t=>""+t)),e.append("span").text(">");const s=e.append("select").on("change",(()=>this.render()));s.selectAll("option").data(t).enter().append("option").attr("value",(t=>t)).text((t=>t)),s.property("value",t[0]),e.append("span").text("V").style("transform","rotate(180deg").style("display","inline-block");const i=e.append("select").on("change",(()=>this.render()));i.selectAll("option").data(t).enter().append("option").attr("value",(t=>t)).text((t=>t)),i.property("value",t[1]),this._k=()=>[t.indexOf(s.property("value")),t.indexOf(i.property("value"))]}this._k_data=this.data,this.render()}_clip(t){if(this._clip_pad===-1/0)return t;const e=[this.width,this.height];for(let s=0;s<t.length;s++)t[s]<this._clip_pad?t[s]=this._clip_pad:e[s]-this._clip_pad<t[s]&&(t[s]=e[s]-this._clip_pad);return t}render(){this._will_render||(this._will_render=!0,Promise.resolve().then((()=>{this._will_render&&(this._will_render=!1,this._render())})))}toPoint(t){const e=this._k(),s=this._series?this.data.series.domain:this.data.domain,i=[this.width,this.height],[a,n]=this.data.range,r=e.map(((e,a)=>scale(t[e],s[e][0],s[e][1],0,i[a]-2*this.padding[a])+this.padding[a]));if(this._series)if(Array.isArray(t[0])){const e=this.data.domain[0];r[1]=scale(t[1],a,n,0,i[1]-2*this.padding[1])+this.padding[1],r[0]=scale(t[0][0],e[0],e[1],0,i[0]-2*this.padding[0])+this.padding[0]}else{const a=Math.min(e[0],t[1].length-1);r[1]=scale(t[1][a],s[e[0]][0],s[e[0]][1],0,i[1]-2*this.padding[1])+this.padding[1],r[0]=scale(t[0],0,this.data.length+this._pred_count,0,i[0]-2*this.padding[0])+this.padding[0]}return 1===r.length&&t.length>1&&(r[1]=scale(t[1],a,n,0,i[1]-2*this.padding[1])+this.padding[1]),r.map((t=>isNaN(t)?0:t))}toValue(t){return t&&this._series?[scale(t[0]-this.padding[0],0,this.width-2*this.padding[0],0,this.data.length)]:[]}_render(){if(!this.data||0===this.data.dimension)return this._p.map((t=>t.remove())),void(this._p.length=0);this._k_data!==this.data&&(this._k_data=this.data,this._k=this._default_k);const t=this._k(),e=this.data.length,s=this._series?this.data.series.values:this.data.x,i=this._series?this.data.series.domain:this.data.domain,a=[this.width,this.height],[n,r]=this.data.range,h=Math.max(1,Math.min(5,Math.floor(2e3/e)));for(let d=0;d<e;d++){const o=t.map(((t,e)=>scale(s[d][t],i[t][0],i[t][1],0,a[e]-2*this.padding[e])+this.padding[e]));this._series&&(o[1]=scale(s[d][t[0]],i[t[0]][0],i[t[0]][1],0,a[1]-2*this.padding[1])+this.padding[1],o[0]=scale(d,0,e+this._pred_count,0,a[0]-2*this.padding[0])+this.padding[0]),1===o.length&&(o[1]=scale(this.data.y[d],n,r,0,a[1]-2*this.padding[1])+this.padding[1]);const l=this._clip(o),p=1===this.data.dimension?0:this.data.y[d];if(this._p[d]){const t=this._p[d].at;t[0]===l[0]&&t[1]===l[1]||(this._p[d].at=l),this._p[d].category!==p&&(this._p[d].category=p)}else this._p[d]=new DataPoint(this._r,l,p);this._p[d].title=this.data._categorical_output?this.data._output_category_names[this.data.y[d]-1]:this.data.y[d],this._p[d].radius=h}for(let t=e;t<this._p.length;t++)this._p[t].remove();this._p.length=e}predict(t){Array.isArray(t)||(t=[t,t]);const e=this.data.domain,s=[this.width,this.height],i=[];if(this.data.dimension<=2)for(let a=0;a<s[0]+t[0];a+=t[0]){const n=scale(a-this.padding[0],0,s[0]-2*this.padding[0],e[0][0],e[0][1]);if(1===this.data.dimension)i.push([n]);else for(let a=0;a<s[1]-t[1]/100;a+=t[1]){const t=scale(a-this.padding[1],0,s[1]-2*this.padding[1],e[1][0],e[1][1]);i.push([n,t])}}else for(let t=0;t<this.data.x.length;t++)i.push(this.data.x[t].concat());const a=this.setting.vue.mlTask;return[i,(n,r)=>{r.selectAll("*").remove();let h=n.some((t=>!Number.isInteger(t)));if(1===this.data.dimension){const d=[];if("IN"===a||h&&"DE"!==a){const[t,a]=this.data.range;for(let r=0;r<n.length;r++)d.push([scale(i[r],e[0][0],e[0][1],0,s[0]-2*this.padding[0])+this.padding[0],scale(n[r],t,a,0,s[1]-2*this.padding[1])+this.padding[1]]);const h=d3.line().x((t=>t[0])).y((t=>t[1]));r.append("path").attr("stroke","red").attr("fill-opacity",0).attr("d",h(d))}else{d.push([],[]);for(let e=0,i=0;i<s[0]+t[0];e++,i+=t[0])d[0][e]=n[e],d[1][e]=n[e];const e=r.append("g");new DataHulls(e,d,[t[0],1e3],h)}}else if(2===this.data.dimension){let e=0;const i=[];for(let a=0,r=0;r<s[0]+t[0];a++,r+=t[0])for(let r=0,h=0;h<s[1]-t[1]/100;r++,h+=t[1])i[r]||(i[r]=[]),i[r][a]=n[e++];!h&&n.length>100&&(h|=new Set(n).size>100);const d=r.append("g");new DataHulls(d,i,t,h||"DE"===a)}else{const t=r.append("g"),e=n.every(Number.isInteger);for(let s=0;s<n.length;s++){new DataCircle(t,this._p[s]).color=getCategoryColor(n[s]),e&&this.data._categorical_output?this._p[s].title=`true: ${this.data._output_category_names[this.data.y[s]-1]}\npred: ${this.data._output_category_names[n[s]-1]}`:this._p[s].title=`true: ${this.data.y[s]}\npred: ${n[s]}`}this._observe_target=r}}]}terminate(){this._p.forEach((t=>t.remove())),this.setting.data.configElement.select("div.column-selector").remove(),this._observer.disconnect(),this._will_render=!1}}export class BasePlatform{constructor(t,e){this._manager=e,this._task=t,this._renderer=new DataRenderer(e)}get task(){return this._task}get setting(){return this._manager.setting}get svg(){return this._manager.setting.svg}get width(){return this._width||(this._width=d3.select("#plot-area svg").node().getBoundingClientRect().width),this._width}set width(t){d3.select("#plot-area").style("width",t-2+"px"),this._width=null}get height(){return this._height||(this._height=d3.select("#plot-area svg").node().getBoundingClientRect().height),this._height}set height(t){d3.select("#plot-area").style("height",t-2+"px"),this._height=null}get datas(){return this._manager._datas}get params(){return{}}set params(t){}init(){}terminate(){this._renderer.terminate()}}export class DefaultPlatform extends BasePlatform{constructor(t,e){super(t,e);const s=this.setting.task.configElement;"DR"!==this._task&&"FS"!==this._task||(s.append("span").text("Target dimension"),s.append("input").attr("type","number").attr("min",1).attr("max",2).attr("value",2).attr("name","dimension"))}get dimension(){const t=this.setting.task.configElement.select("[name=dimension]");return t.node()?+t.property("value"):null}fit(t){const e="RG"===this._task?FittingMode.RG(this.setting.dimension):FittingMode[this._task];return this._cur_dimension!==this.setting.dimension&&this.init(),e.fit(this._r_task,this.datas,t)}predict(t,e=10){const[s,i]=this._renderer.predict(e);"CF"!==this._task&&"RG"!==this._task||s.push(...this.datas.x),t(s,(t=>{if("AD"===this._task&&(t=t.map((t=>t?specialCategory.error:specialCategory.errorRate(0)))),"CF"===this._task||"RG"===this._task){const e=t.slice(s.length-this.datas.length),i=this.datas.y;if(t=t.slice(0,s.length-this.datas.length),"CF"===this._task){let t=0;for(let s=0;s<i.length;s++)i[s]===e[s]&&t++;this.setting.footer.text("Accuracy:"+t/i.length)}else if("RG"===this._task){let t=0;for(let s=0;s<i.length;s++)t+=(i[s]-e[s])**2;this.setting.footer.text("RMSE:"+Math.sqrt(t/i.length))}}i(t,this._r_tile)}))}evaluate(t){"CF"!==this._task&&"RG"!==this._task||t(this.datas.x,(t=>{const e=this.datas.y;if("CF"===this._task){let s=0;for(let i=0;i<e.length;i++)e[i]===t[i]&&s++;this.setting.footer.text("Accuracy:"+s/e.length)}else if("RG"===this._task){let s=0;for(let i=0;i<e.length;i++)s+=(e[i]-t[i])**2;this.setting.footer.text("RMSE:"+Math.sqrt(s/e.length))}}))}init(){this._r&&this._r.remove(),this._cur_dimension=this.setting.dimension;const t=1===this.datas?.dimension&&("RG"===this._task||"IN"===this._task);this._r=t?this.svg.append("g"):this.svg.insert("g",":first-child"),this._r.classed("default-render",!0),this._r_task=this._r.append("g").classed("tasked-render",!0),this._r_tile=this._r.append("g").classed("tile-render",!0).attr("opacity",t?1:.5),this.setting.footer.text(""),this.svg.select("g.centroids").remove(),this.render()}render(){this._renderer.render()}centroids(t,e,{line:s=!1,duration:i=0}={}){let a=this.svg.select("g.centroids");0===a.size()&&(a=this.svg.append("g").classed("centroids",!0),a.append("g").classed("c-line",!0),this._centroids_line=[],this._centroids=null);const n=[];this._centroids&&this._centroids.forEach((t=>{Array.isArray(e)&&e.indexOf(t.category)<0?t.remove():n.push(t)}));const r=this._renderer.points;for(let t=0;t<r.length;t++)this._centroids_line[t]?._from===r[t]&&s||(this._centroids_line[t]?.remove(),this._centroids_line[t]=null);this._centroids=t.map(((t,i)=>{let r=Array.isArray(e)?n.find((t=>t.category===e[i])):n[i];if(r||(r=new DataPoint(a,t.map((t=>t/this.datas.scale)),Array.isArray(e)?e[i]:e),r.plotter(DataPointStarPlotter)),s){const t=this._renderer.points,s=this.datas.y;for(let n=0;n<t.length;n++)s[n]===e[i]&&(this._centroids_line[n]?this._centroids_line[n].to=r:this._centroids_line[n]=new DataLine(a.select(".c-line"),t[n],r))}return r})),Promise.resolve().then((()=>{this._centroids.forEach(((e,s)=>{e.move(t[s].map((t=>t/this.datas.scale)),i)}))}))}terminate(){this._r&&this._r.remove(),this.svg.select("g.centroids").remove(),this.svg.selectAll("g").style("visibility",null);this.setting.task.configElement.selectAll("*").remove(),this.setting.footer.text(""),super.terminate()}}