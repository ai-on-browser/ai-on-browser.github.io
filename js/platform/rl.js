var p=Object.defineProperty;var a=(r,t)=>p(r,"name",{value:t,configurable:!0});import o from"../../lib/rl/base.js";import d from"../renderer/rl.js";import _ from"../renderer/util/lineplot.js";import{EventEmitter as m}from"../utils.js";import{BasePlatform as c}from"./base.js";import l from"./game/base.js";const h={},u={MD:["grid","cartpole","mountaincar","acrobot","pendulum","maze","blackjack","waterball","breaker","gem_puzzle"],GM:["reversi","draughts","gomoku"]};export default class f extends c{static{a(this,"RLPlatform")}constructor(t){super(t),this._type="",this._epoch=0,this._env=new o,this._game=null,this._is_updated_reward=!1,this._cumulativeReward=0,this._rewardHistory=[],this._renderer.forEach(i=>i.terminate()),this._renderer=[new d(t)],this._emitter=new m,this._load_env().then(()=>this._emitter.emit("ready"));const e=this.setting.task.configElement;e.appendChild(document.createTextNode("Environment"));const s=document.createElement("select");s.name="env",s.onchange=()=>{this._plotter&&this._plotter.terminate(),this.setting.rl.configElement.replaceChildren(),this._type=s.value,this.setting.pushHistory(),this._load_env().then(()=>{this.setting.ml.refresh()})},s.appendChild(document.createElement("option"));for(const i of u[this.task]){const n=document.createElement("option");n.value=i,n.innerText=i,s.appendChild(n)}e.appendChild(s)}get params(){return{env:this._type}}set params(t){t.env&&this._type!==t.env&&(this._type=t.env,this._load_env().then(()=>{const e=this.setting.task.configElement.querySelector("[name=env]");e&&(e.value=this._type)}))}get epoch(){return this._epoch}get actions(){return this._env.actions}get states(){return this._env.states}get type(){return this._type}get env(){return this._env}set onready(t){this._emitter.on("ready",t)}async _load_env(){if(h[this.type])this._env=new h[this.type](960,500),this.init();else{if(this.type!=="")return import(`../../lib/rl/${this.type}.js`).then(t=>{this._env=new t.default(960,500),h[this.type]=t.default,this.init()});this._env=new o}}cumulativeReward(t){return this._cumulativeReward}rewardHistory(t){return this._rewardHistory}init(){this._game&&(this._game.terminate(),this._game=null),this.task==="GM"&&this._type!==""&&(this._game=new l(this)),this._loss&&(this._loss.terminate(),this._loss=null),this._renderer.forEach(t=>t.init())}reset(...t){return this._epoch=0,this._agents&&this._agents.some((e,s)=>e!==t[s])&&(this._is_updated_reward=!1,this._rewardHistory=[],this._loss&&(this._loss.terminate(),this._loss=null)),this._game&&this._manager._modelname!==""?(this._game.terminate(),this._game=null):!this._game&&this._manager._modelname===""&&(this._game=new l(this)),this._agents=t,this._is_updated_reward&&this._rewardHistory.push(this._cumulativeReward),this._is_updated_reward=!1,this._cumulativeReward=0,this._plotter&&(this._plotter.printEpisode(),this._plotter.printStep(),this._plotter.plotRewards()),this._env.reset()}render(t){this._renderer.forEach(e=>e.render(t))}terminate(){this._plotter?.terminate(),this._game?.terminate(),this.setting.rl.configElement.replaceChildren(),this.setting.task.configElement.replaceChildren(),this._loss&&(this._loss.terminate(),this._loss=null),super.terminate()}state(t){return this._env.state(t)}step(t,e){this._epoch++;const s=this._env.step(t,e);return this._is_updated_reward=!0,this._cumulativeReward+=s.reward,this._plotter&&(this._plotter.printEpisode(),this._plotter.printStep(),this._plotter.plotRewards()),s}test(t,e,s){return this._env.test(t,e,s)}sample_action(t){return this._env.sample_action(t)}plotRewards(t){this._plotter=new w(this,t),this._plotter.printEpisode(),this._plotter.printStep(),this._plotter.plotRewards()}plotLoss(t){this._loss||(this._loss=new _(this.setting.footer)),this._loss.add(t)}}class w{static{a(this,"RewardPlotter")}constructor(t,e){this._platform=t,this._r=e.querySelector("span.reward_plotarea"),this._r||(this._r=e.appendChild(document.createElement("span")),this._r.classList.add("reward_plotarea")),this._r.style.whiteSpace="nowrap",this._loss=null,this._plot_rewards_count=1e4,this._plot_smooth_window=20}terminate(){this._r.remove()}lastHistory(t=0){if(t<=0)return this._platform._rewardHistory;const e=this._platform._rewardHistory.length;return this._platform._rewardHistory.slice(Math.max(0,e-t),e)}printEpisode(){if(!this._episodetext){const t=this._r.appendChild(document.createElement("span"));t.setAttribute("name","episode"),this._episodetext=document.createTextNode("0"),t.append(" Episode: ",this._episodetext)}this._episodetext.data=this.lastHistory().length+1}printStep(){if(!this._steptext){const t=this._r.appendChild(document.createElement("span"));t.setAttribute("name","step"),this._steptext=document.createTextNode("0"),t.append(" Step: ",this._steptext)}this._steptext.data=this._platform.epoch}plotRewards(){this._loss||(this._loss=new _(this._r)),this._loss.setValues({"":this.lastHistory(this._plot_rewards_count)})}}
