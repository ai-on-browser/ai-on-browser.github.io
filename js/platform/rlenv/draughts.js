import{RLEnvironmentBase}from"../../../lib/rl/base.js";import{Game}from"../game/base.js";const EMPTY=1,RED=2,WHITE=4,KING=8,RED2=10,WHITE2=12;export default class DraughtsRLEnvironment extends RLEnvironmentBase{constructor(t){super(),this._platform=t,this._size=[8,8],this._game=new Draughts(this),this._board=this._game._board,this._reward={goal:1,step:1,fail:0},this._org_width=this._platform.width,this._org_height=this._platform.height}get actions(){const t=[];for(let s=0;s<this._size[0];s++)for(let e=0;e<this._size[1];e++)t.push(`${s}_${e}`);return[t]}get states(){const t=[];for(let s=0;s<this._size[0]*this._size[1]/2;s++)t.push([1,2,4]);return t}set reward(t){}init(t){this._platform.width=500,this._platform.height=500;const s=this._platform.width,e=this._platform.height,i=s/this._size[1],r=e/this._size[0];this._cells=[];for(let s=0;s<this._size[0];s++){this._cells[s]=[];for(let e=0;e<this._size[1];e++)this._cells[s][e]=t.append("g"),this._cells[s][e].append("rect").attr("x",e*i).attr("y",s*r).attr("width",i).attr("height",r).attr("fill",(s+e)%2==0?"#aa9977":"#eeddcc").attr("stroke","#333333").attr("stroke-width","1")}}reset(){return super.reset(),this._board.reset(),this.state()}render(t){const s=this._platform._grid();s.reset();for(let t=0;t<this._size[0];t++)for(let e=0;e<this._size[1];e++){if(1===this._board.at([t,e]))continue;const i=s.gridSize[1],r=s.gridSize[0],h=s.at(t,e).append("circle").attr("cx",i/2).attr("cy",r/2).attr("r",.4*Math.min(i,r)).attr("stroke","black").attr("stroke-width","1");4&this._board.at([t,e])?h.attr("fill","white"):2&this._board.at([t,e])&&h.attr("fill","red"),8&this._board.at([t,e])&&s.at(t,e).append("text").attr("x",i/2+"px").attr("y",r/2+"px").style("transform","translate(-0.4em, 0.3em)").text("K")}}state(t){const s=[];for(let t=0;t<this._size[0];t++)for(let e=0;e<this._size[1];e++)s.push(this._board.at([t,e]));return s}step(t,s){super.step(t,s);return this.test(this.state,t,s)}test(t,s,e){return{state:[],reward:0,done:!1}}evaluation(t){this._evaluation=t}game(...t){return t[0]||(t[0]=new ManualPlayer(this)),t[1]||(t[1]=new ManualPlayer(this)),t[0].turn=2,t[1].turn=4,this._game.players=t,this._game}close(){this._platform.width=this._org_width,this._platform.height=this._org_height}}class Draughts extends Game{constructor(t){super(t),this._board=new DraughtsBoard(t._size,t._evaluation),this.turns=[2,4]}_showResult(t){t.append("tspan").attr("x","0em").attr("y","0em").text(2===this._board.winner?"RED WIN":"WHITE WIN")}}class DraughtsBoard{constructor(t,s){this._evaluator=s,this._size=t,this.reset()}get size(){return this._size}get count(){const t={};for(let s=0;s<this._size[0];s++)for(let e=0;e<this._size[1];e++)t[this._board[s][e]]||(t[this._board[s][e]]=0),t[this._board[s][e]]++;return{red:t[2]||0,white:t[4]||0,redking:t[10]||0,whiteking:t[12]||0}}get finish(){return 0===this.choices(2).length||0===this.choices(4).length}get winner(){return 0===this.choices(2).length?4:0===this.choices(4).length?2:null}nextTurn(t){return 4===t?2:4}copy(){const t=new DraughtsBoard(this._size,this._evaluator);for(let s=0;s<this._size[0];s++)for(let e=0;e<this._size[1];e++)t._board[s][e]=this._board[s][e];return t}score(t){if(this._evaluator)return this._evaluator(this,t);const s=this.count;return 2===t?s.red+2*s.redking-s.white-4*s.whiteking:s.white+2*s.whiteking-s.red-4*s.redking}at(t){return this._board[t[0]][t[1]]}set(t,s){let e=this._board[t.from[0]][t.from[1]];this._board[t.from[0]][t.from[1]]=1;for(const[s,e]of t.jump)this._board[s][e]=1;const i=t.path[t.path.length-1];return(2===s&&i[0]===this._size[0]-1||4===s&&0===i[0])&&(e|=8),this._board[i[0]][i[1]]=e,!0}reset(){this._board=[];for(let t=0;t<this._size[0];t++)this._board[t]=Array(this._size[1]).fill(1);for(let t=0;t<this._size[0];t++)for(let s=0;s<this._size[1];s++)t<3&&(t+s)%2==0?this._board[t][s]=2:this._size[0]-3<=t&&(t+s)%2==0&&(this._board[t][s]=4)}choices(t){const s=[];for(let e=0;e<this._size[0];e++)for(let i=0;i<this._size[1];i++)this._board[e][i]&t&&s.push(...this.allPath(e,i,t));return s.some((t=>t.jump.length>0))?s.filter((t=>t.jump.length>0)):s}allPath(t,s,e,i=!0){if(!(this._board[t][s]&e))return[];const r=(t,s)=>0<=t&&t<this._size[0]&&0<=s&&s<this._size[1],h=2===e?4:2,a=[];8&this._board[t][s]?a.push([1,1],[-1,1],[-1,-1],[1,-1]):2===e?a.push([1,1],[1,-1]):a.push([-1,1],[-1,-1]);const o=[];for(const[n,_]of a)if(r(t+n,s+_)&&(i&&1===this._board[t+n][s+_]&&o.push({from:[t,s],path:[[t+n,s+_]],jump:[]}),this._board[t+n][s+_]&h&&r(t+2*n,s+2*_)&&1===this._board[t+2*n][s+2*_])){const i=this.copy();i._board[t+2*n][s+2*_]=this._board[t][s],i._board[t][s]=1,i._board[t+n][s+_]=1,(2===e&&t*n*2==this._size[0]-1||4===e&&t*n*2==0)&&(i._board[t+2*n][s+2*_]|=8);const r=i.allPath(t+2*n,s+2*_,e,!1);if(0===r.length)o.push({from:[t,s],path:[[t+2*n,s+2*_]],jump:[[t+n,s+_]]});else for(const e of r)o.push({from:[t,s],path:[[t+2*n,s+2*_],...e.path],jump:[[t+n,s+_],...e.jump]})}return o}}class ManualPlayer{constructor(t){this._turn=null,this._env=t,this._obj=null}set turn(t){this._turn=t}action(t,s){const e=this._env.platform.width,i=this._env.platform.height,r=e/t.size[1],h=i/t.size[0],a=t.choices(this._turn);this._obj=this._env.svg.append("g"),this._check=[];for(let e=0;e<t.size[0];e++){this._check[e]=[];for(let i=0;i<t.size[1];i++)if(!((e+i)%2>0)){this._check[e][i]=this._obj.append("rect").attr("x",r*i).attr("y",h*e).attr("width",r).attr("height",h).attr("fill","rgba(255, 255, 0, 0.5)").attr("opacity",0);for(let r=0;r<a.length;r++)a[r].from[0]===e&&a[r].from[1]===i&&this._check[e][i].attr("opacity",1).on("click",((e,i)=>()=>{this.nextPath(t,a.filter((t=>t.from[0]===e&&t.from[1]===i)),s)})(e,i))}}}nextPath(t,s,e,i=0){for(let t=0;t<this._check.length;t++)for(let s=0;s<this._check[t].length;s++)this._check[t][s]&&this._check[t][s].attr("opacity",0).on("click",null);for(let r=0;r<s.length;r++)this._check[s[r].path[i][0]][s[r].path[i][1]].attr("opacity",1).on("click",(r=>()=>{s[r].path.length===i+1?(e(s[r]),this._obj.remove(),this._obj=null):this.nextPath(t,s.filter((t=>t.path[i][0]===s[r].path[i][0]&&t.path[i][1]===s[r].path[i][1])),e,i+1)})(r))}close(){this._obj&&this._obj.remove()}}