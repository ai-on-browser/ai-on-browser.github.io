import GridMazeRLEnvironment from"../../../lib/rl/grid.js";const argmax=function(t,e){return 0===t.length?-1:(t=e?t.map(e):t).indexOf(Math.max(...t))};export default class GridMazeRenderer extends GridMazeRLEnvironment{constructor(t){super(),this.platform=t,this._points=[],this._q=null,this._show_max=!1,this._render_blocks=[],this._init_menu()}get _action_str(){return 1===this._dim?["→","←"]:["→","↓","←","↑"]}_init_menu(){const t=this.platform.setting.rl.configElement;t.replaceChildren(),t.appendChild(document.createTextNode("Columns "));const e=document.createElement("input");e.type="number",e.min=1,e.max=50,e.value=this._size[0],e.onchange=()=>{this._size[0]=+e.value,this.__map=null,this.platform.init(),this.platform.setting.ml.refresh()},t.appendChild(e),t.appendChild(document.createTextNode(" Rows "));const i=document.createElement("input");i.type="number",i.min=1,i.max=50,i.value=this._size[1],i.onchange=()=>{this._size[1]=+i.value,this.__map=null,this.platform.init(),this.platform.setting.ml.refresh()},t.appendChild(i)}init(t){const e=this.platform.width,i=this.platform.height,s=this,r=t.append("g").on("click",(t=>{const e=d3.pointer(t),i=s._size[0]/s.platform.width,r=s._size[1]/s.platform.height,a=Math.floor(e[0]*i),n=Math.floor(e[1]*r);s._points.push([a,n]),t.stopPropagation(),setTimeout((()=>{s.platform.render()}),0)})),a=e/this._size[0],n=i/this._size[1];this._render_blocks=[];for(let t=0;t<this._size[0];t++){this._render_blocks[t]=[];for(let e=0;e<this._size[1];e++){const i=this._render_blocks[t][e]=r.append("g").classed("grid",!0).attr("stroke-width",1).attr("stroke","black").attr("stroke-opacity",.2);if(this._show_max)i.append("rect").attr("x",a*t).attr("y",n*e).attr("width",a).attr("height",n).attr("fill","white"),i.append("text").classed("value",!0).attr("x",a*t).attr("y",n*(e+.8)).attr("font-size",14).style("user-select","none");else{const s=[a*(t+.5),n*(e+.5)],r=[[a*(t+1),n*e],[a*(t+1),n*(e+1)],[a*t,n*(e+1)],[a*t,n*e]];r[4]=r[0];for(let t=0;t<4;t++)i.append("polygon").attr("points",`${r[t][0]},${r[t][1]} ${r[t+1][0]},${r[t+1][1]} ${s[0]},${s[1]}`).attr("fill","white").append("title")}i.append("text").classed("action",!0).attr("x",a*(t+.5)).attr("y",n*(e+.5)).style("user-select","none").style("transform-box","fill-box").style("transform","translate(-50%, 25%)")}}t.append("circle").classed("agent",!0).attr("cx",.5*a).attr("cy",.5*n).attr("fill","gray").attr("fill-opacity",.8).attr("stroke-width",1).attr("stroke","black").attr("r",Math.min(a,n)/3)}_min(t){return Array.isArray(t[0])?Math.min(...t.map(this._min.bind(this))):Math.min(...t)}_max(t){return Array.isArray(t[0])?Math.max(...t.map(this._max.bind(this))):Math.max(...t)}render(t,e){const i=this.platform.width,s=this.platform.height,r=i/this._size[0],a=s/this._size[1],n=this.map;if(e&&(this._q=e()),this._q){const t=this._q,e=this._max(t),i=this._min(t),s=Math.max(Math.abs(e),Math.abs(i));for(let e=0;e<this._size[0];e++){if(!this._q[e])continue;const i=2===this._dim?t[e]:[t[e]];for(let t=0;t<this._size[1];t++){if(!i[t])continue;if(n[e][t]||e===this._size[0]-1&&t===this._size[1]-1)continue;const r=(l=i[t],o=void 0,0===l.length?-1:(l=o?l.map(o):l).indexOf(Math.max(...l))),a=t=>{const e=255*(1-Math.abs(t)/s);return t>0?`rgb(${e}, 255, ${e})`:t<0?`rgb(255, ${e}, ${e})`:"white"};if(this._render_blocks[e][t].select("text.action").text(this._action_str[r]),this._show_max){const s=Math.max(...i[t]);this._render_blocks[e][t].selectAll("rect").attr("fill",a(s)),this._render_blocks[e][t].select("text.value").text(`${s}`.slice(0,6))}else this._render_blocks[e][t].selectAll("polygon").each((function(e,s){const r=d3.select(this);r.attr("fill",a(i[t][s])),r.select("title").text(i[t][s])}))}}}else t.selectAll("g.grid rect, g.grid polygon").attr("fill","white");var l,o;for(let t=0;t<this._size[0];t++)for(let e=0;e<this._size[1];e++)n[t][e]&&this._render_blocks[t][e].selectAll("rect, polygon").attr("fill","black");this._render_blocks[this._size[0]-1][this._size[1]-1].selectAll("rect, polygon").attr("fill","yellow"),t.select("circle.agent").attr("cx",(this._position[0]+.5)*r).attr("cy",((this._position[1]||0)+.5)*a)}}