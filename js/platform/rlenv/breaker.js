import BreakerRLEnvironment from"../../../lib/rl/breaker.js";export default class BreakerRenderer extends BreakerRLEnvironment{constructor(t){super(),this._platform=t,this._width=this._platform.width,this._height=this._platform.height,this._org_width=this._platform.width,this._org_height=this._platform.height,this._render_blocks=[]}init(t){this._platform.width=this._size[0],this._platform.height=this._size[1],this._render_blocks=[];for(let e=0;e<this._block_positions.length;e++)this._render_blocks[e]=t.append("rect").attr("x",this._block_positions[e][0]-this._block_size[0]/2).attr("y",this._block_positions[e][1]-this._block_size[1]/2).attr("width",this._block_size[0]).attr("height",this._block_size[1]).attr("fill",`rgb(${Math.floor(128*Math.random())}, ${Math.floor(128*Math.random())}, ${Math.floor(128*Math.random())})`);this._render_ball=t.append("circle").attr("cx",this._ball_position[0]).attr("cy",this._ball_position[1]).attr("r",this._ball_radius).attr("fill","black"),this._render_paddle=t.append("rect").attr("x",this._paddle_position-this._paddle_size[0]/2).attr("y",this._paddle_baseline-this._paddle_size[1]/2).attr("width",this._paddle_size[0]).attr("height",this._paddle_size[1]).attr("fill","black");this._manualButton=t.append("g").style("transform",`translate(${this._size[0]/2-50}px, 100px)`).style("cursor","pointer").on("click",(async()=>{this._game=new BreakerGame(this),await this._game.start(),this._game=null,this._manualButton.attr("opacity",1)})),this._manualButton.append("rect").attr("x",0).attr("y",0).attr("width",100).attr("height",20).attr("fill-opacity",0).attr("stroke","gray"),this._manualButton.append("text").attr("x",50).attr("y",-10).attr("text-anchor","middle").attr("dominant-baseline","central").style("transform","scale(1, -1)").style("pointer-events","none").style("user-select","none").text("Start")}render(t){this._manualButton.attr("opacity",this._game||this._platform._manager._modelname?0:1);for(let t=0;t<this._block_positions.length;t++)this._block_existances[t]?this._render_blocks[t].style("display",null):this._render_blocks[t].style("display","none");this._render_ball.attr("cx",this._ball_position[0]).attr("cy",this._ball_position[1]),this._render_paddle.attr("x",this._paddle_position-this._paddle_size[0]/2)}close(){this._platform.width=this._org_width,this._platform.height=this._org_height}}class BreakerGame{constructor(t){this._env=t,this._act=0,this._keyDown=this.keyDown.bind(this),this._keyUp=this.keyUp.bind(this)}async start(){for(this._env.reset(),document.addEventListener("keydown",this._keyDown),document.addEventListener("keyup",this._keyUp);;){const{done:t}=this._env.step([this._act]);if(this._env.render(),t)break;await new Promise((t=>setTimeout(t,10)))}document.removeEventListener("keydown",this._keyDown),document.removeEventListener("keyup",this._keyUp)}keyDown(t){"ArrowLeft"===t.code?this._act=-1:"ArrowRight"===t.code&&(this._act=1)}keyUp(t){("ArrowLeft"===t.code||"ArrowRight"===t.code)&&(this._act=0)}}