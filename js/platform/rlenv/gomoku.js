import{RLEnvironmentBase}from"../../../lib/rl/base.js";import{Game}from"../game/base.js";const EMPTY=1,BLACK=2,WHITE=3;export default class GomokuRLEnvironment extends RLEnvironmentBase{constructor(t){super(),this._platform=t,this._size=[8,8],this._game=new Gomoku(this),this._board=this._game.board,this._reward={goal:1,step:1,fail:0},this._org_width=this._platform.width,this._org_height=this._platform.height}get actions(){const t=[];for(let s=0;s<this._size[0];s++)for(let i=0;i<this._size[1];i++)t.push(`${s}_${i}`);return[t]}get states(){const t=[];for(let s=0;s<this._size[0]*this._size[1];s++)t.push([1,2,3]);return t}set reward(t){}init(t){this._platform.width=500,this._platform.height=500;const s=this._platform.width,i=this._platform.height,e=s/this._size[1],r=i/this._size[0];this._cells=[];for(let s=0;s<this._size[0];s++){this._cells[s]=[];for(let i=0;i<this._size[1];i++)this._cells[s][i]=t.append("g"),this._cells[s][i].append("rect").attr("x",i*e).attr("y",s*r).attr("width",e).attr("height",r).attr("fill","#eeddcc").attr("stroke","#333333").attr("stroke-width","1")}}reset(){return super.reset(),this._board.reset(),this.state()}render(t){const s=this._platform._grid();s.reset();for(let t=0;t<this._cells.length;t++)for(let i=0;i<this._cells[t].length;i++){if(1===this._board.at([t,i]))continue;const e=this._cells[t][i].select("rect"),r=+e.attr("width"),h=+e.attr("height"),o=s.at(t,i).append("circle").attr("cx",r/2).attr("cy",h/2).attr("r",.4*Math.min(r,h)).attr("stroke","black").attr("stroke-width","1");3===this._board.at([t,i])?o.attr("fill","white"):2===this._board.at([t,i])&&o.attr("fill","black")}}state(t){const s=[];for(let t=0;t<this._size[0];t++)for(let i=0;i<this._size[1];i++)s.push(this._board.at([t,i]));return s}step(t,s){super.step(t,s);return this.test(this.state,t,s)}test(t,s,i){return{state:[],reward:0,done:!1}}evaluation(t){this._evaluation=t}game(...t){return t[0]||(t[0]=new ManualPlayer(this)),t[1]||(t[1]=new ManualPlayer(this)),t[0].turn=2,t[1].turn=3,this._game.players=t,this._game}close(){this._platform.width=this._org_width,this._platform.height=this._org_height}}class Gomoku extends Game{constructor(t){super(t),this._board=new GomokuBoard(t._size,t._evaluation),this.turns=[2,3]}_showResult(t){const s=this._board.winner;t.append("tspan").attr("x","0em").attr("y","0em").text(2===s?"BLACK WIN":3===s?"WHITE WIN":"DRAW")}}class GomokuBoard{constructor(t,s){this._evaluator=s,this._size=t,this._a=5,this._count=0,this.reset()}get size(){return this._size}get finish(){return null!==this.winner||this._count===this._size[0]*this._size[1]}get winner(){return this.row(3,this._a).length>0?3:this.row(2,this._a).length>0?2:null}nextTurn(t){return 2===t?3:2}copy(){const t=new GomokuBoard(this._size,this._evaluator);for(let s=0;s<this._size[0];s++)for(let i=0;i<this._size[1];i++)t._board[s][i]=this._board[s][i];return t._count=this._count,t}score(t){if(this._evaluator)return this._evaluator(this,t);const s=this.winner,i=this.nextTurn(t);return s===t?this._size[0]*this._size[1]*100-this._count:s===i?-this._size[0]*this._size[1]*100+this._count:0}at(t){return this._board[t[0]][t[1]]}set(t,s){return 1===this.at(t)&&(this._board[t[0]][t[1]]=s,this._count++,!0)}reset(){this._count=0,this._board=[];for(let t=0;t<this._size[0];t++)this._board[t]=Array(this._size[1]).fill(1)}choices(t){const s=[];if(this.finish)return s;for(let t=0;t<this._size[0];t++)for(let i=0;i<this._size[1];i++)1===this._board[t][i]&&s.push([t,i]);return s}row(t,s,i=!1){const e=[],r=(t,s)=>0<=t&&t<this._size[0]&&0<=s&&s<this._size[1],h=[[1,1],[1,0],[1,-1],[0,1]];for(let o=0;o<this._size[0];o++)for(let a=0;a<this._size[1];a++)if(this._board[o][a]===t)for(const[n,_]of h){if(r(o-n,a-_)&&this._board[o-n][a-_]===t)continue;if(!r(o+n*(s-1),a+_*(s-1)))continue;const h=[[o,a]];let l=o+n,u=a+_,c=!1;const d=[];for(let f=1;f<s&&r(l,u);f++,l+=n,u+=_)if(!i||c||1!==this._board[l][u]){if(this._board[l][u]!==t)break;if(h.push([l,u]),f===s-1){if(l+=n,u+=_,r(l,u)&&this._board[l][u]===t)break;c||(r(l,u)&&1===this._board[l][u]&&d.push([l,u]),r(o-n,a-_)&&1===this._board[o-n][a-_]&&d.push([o-n,a-_])),e.push({path:h,s:d})}}else c=!0,f--,d.push([l,u])}return e}}class ManualPlayer{constructor(t){this._turn=null,this._env=t,this._obj=null}set turn(t){this._turn=t}action(t,s){const i=this._env.platform.width,e=this._env.platform.height,r=this;this._obj=this._env.svg.append("g");t.choices(this._turn);this._obj.append("rect").attr("x",0).attr("y",0).attr("width",i).attr("height",e).attr("opacity",0).on("click",(function(){const h=d3.mouse(this),o=[Math.floor(h[1]/i*t.size[0]),Math.floor(h[0]/e*t.size[1])];s(o),r._obj.remove(),r._obj=null}))}close(){this._obj&&this._obj.remove()}}