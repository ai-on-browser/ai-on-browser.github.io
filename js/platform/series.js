import LineRenderer from"../renderer/line.js";import{BasePlatform,LossPlotter}from"./base.js";import{specialCategory,getCategoryColor,DataPoint}from"../utils.js";class TpPlotter{constructor(t,e){this._platform=t,0===e.select("g.tp-render").size()&&e.append("g").classed("tp-render",!0),this._r=e.select("g.tp-render"),this._r.append("path").attr("stroke","black").attr("fill-opacity",0).style("pointer-events","none"),this._pred=[],this._points=[]}set trainResult(t){this._pred=t}remove(){this._r.remove()}reset(){this._points.forEach((t=>t.remove())),this._points=[],this._r.select("path").attr("opacity",0)}plot(t){const e=d3.line().x((t=>t[0])).y((t=>t[1]));this._points.forEach((t=>t.remove())),this._points=[];const s=this._platform.datas;this._platform._renderer.predictValues=this._pred;const r=[];s.length>0&&r.push(t([s.length-1,s.x[s.length-1]||[s.y[s.length-1]]]));for(let e=0;e<this._pred.length;e++){const i=t([e+s.length,this._pred[e]]),h=new DataPoint(this._r,i,specialCategory.dummy);r.push(i),this._points.push(h)}0===r.length?this._r.select("path").attr("opacity",0):this._r.select("path").attr("d",e(r)).attr("opacity",.5)}}class SmoothPlotter{constructor(t,e){this._platform=t,0===e.select("g.smooth-render").size()&&e.append("g").classed("smooth-render",!0),this._r=e.select("g.smooth-render"),this._r.append("path").attr("stroke","red").attr("fill-opacity",0).style("pointer-events","none"),this._pred=[]}set trainResult(t){this._pred=t}remove(){this._r.remove()}plot(t){const e=d3.line().x((t=>t[0])).y((t=>t[1])),s=[];for(let e=0;e<this._pred.length;e++){const r=t([e,this._pred[e]]);s.push(r)}0===s.length?this._r.select("path").attr("opacity",0):this._r.select("path").attr("d",e(s)).attr("opacity",1)}}class CpdPlotter{constructor(t,e){this._platform=t,0===e.select("g.cpd-render").size()&&e.insert("g",":first-child").classed("cpd-render",!0),this._r=e.select("g.cpd-render"),this._pred=[]}set trainResult(t){"number"==typeof t[0]?(this._pred=t.map((t=>t>0)),this._pred_value=t.concat()):(this._pred=t.concat(),this._pred_value=null)}set threshold(t){this._pred_value&&(this._pred=this._pred_value.map((e=>e>t)),this._platform.render())}remove(){this._r.remove()}plot(t){if(this._r.selectAll("*").remove(),this._pred_value){let e=Math.max(...this._pred_value);const s=Math.min(...this._pred_value);e===s&&(e+=1);const r=document.createElement("canvas");r.width=this._platform.width,r.height=this._platform.height;const i=r.getContext("2d");let h=0;for(let r=0;r<this._pred_value.length;r++){const a=t([r+.5,[0]])[0],o=(this._pred_value[r]-s)/(e-s);i.fillStyle=getCategoryColor(specialCategory.errorRate(o)),i.fillRect(h,0,a-h+1,this._platform.height),h=a}this._r.append("image").attr("x",0).attr("y",0).attr("width",r.width).attr("height",r.height).attr("xlink:href",r.toDataURL()).attr("opacity",.3)}for(let e=0;e<this._pred.length;e++){if(!this._pred[e])continue;const s=t([e,[0]])[0];this._r.append("line").attr("x1",s).attr("x2",s).attr("y1",0).attr("y2",this._platform.height).attr("stroke","red")}}}export default class SeriesPlatform extends BasePlatform{constructor(t,e){super(t,e),this._renderer.terminate(),this._renderer=new LineRenderer(e)}get trainInput(){const t=this.datas.dimension>0?this.datas.x:this.datas.y.map((t=>[t]));return t.rolling||Object.defineProperty(t,"rolling",{value:e=>{const s=[];for(let r=0;r<t.length-e+1;r++)s.push([].concat(...t.slice(r,r+e)));return s}}),t}get trainOutput(){return this.datas.y}set trainResult(t){this._plotter.trainResult=t,this.render()}init(){0===this.svg.select("g.ts-render").size()&&("SM"===this._task?this.svg.append("g").classed("ts-render",!0):this.svg.insert("g",":first-child").classed("ts-render",!0)),this._r=this.svg.select("g.ts-render"),this._r.selectAll("*").remove(),"TP"===this._task?this._plotter=new TpPlotter(this,this._r):"SM"===this._task?this._plotter=new SmoothPlotter(this,this._r):"CP"===this._task&&(this._plotter=new CpdPlotter(this,this._r)),this._loss&&(this._loss.terminate(),this._loss=null),this._renderer._make_selector(),this.datas&&(this.datas.clip=!1,this._renderer._pred_count=0,this.render())}render(){this.datas&&(this._renderer.render(),this._plotter.plot(this._renderer.toPoint.bind(this._renderer)))}plotLoss(t){this._loss||(this._loss=new LossPlotter(this,this.setting.footer)),this._loss.add(t)}terminate(){this.datas&&(this.datas.clip=!0),this._loss&&this._loss.terminate(),this._r.remove(),super.terminate()}}