import{BasePlatform}from"./base.js";import ImageData from"../data/image.js";export default class ImagePlatform extends BasePlatform{constructor(t,e){super(t,e),this._reduce_algorithm="mean",this._color_space="rgb",this._normalize=!1,this._org_width=null,this._org_height=null,this._binary_threshold=180;const a=this.setting.task.configElement;a.append("span").text("Color space");const r=a.append("select").attr("name","space").on("change",(()=>{this._color_space=r.property("value"),s.style("display","binary"===this._color_space?null:"none"),this.render()}));r.selectAll("option").data(Object.keys(ImageData.colorSpaces).map((t=>ImageData.colorSpaces[t]))).enter().append("option").property("value",(t=>t)).text((t=>t));const s=a.append("input").attr("name","threshold").attr("type","number").attr("min",0).attr("max",255).attr("value",this._binary_threshold).style("display","none").on("change",(()=>{this._binary_threshold=s.property("value"),this.render()}));a.append("span").text(" overwrap "),this._opacity=a.append("input").attr("name","opacity").attr("type","range").attr("min",0).attr("max",1).attr("step",.1).property("value",.5).on("input",(()=>{let t=this._r.select("g.predict-img");t.size()>0&&t.attr("opacity",this._opacity.property("value"))}))}set colorSpace(t){this._color_space=t,this.setting.task.configElement.select("[name=space]").property("value",t),this.setting.task.configElement.select("[name=threshold]").style("display","binary"===this._color_space?null:"none"),this.render()}init(){0===this.svg.select("g.im-render").size()&&this.svg.append("g").classed("im-render",!0).style("transform","scale(1, -1) translate(0, -100%)"),this._r=this.svg.select("g.im-render"),this._r.selectAll("*").remove(),this.render()}render(){let t=this._r.select("g.target-image");if(0===t.size()&&(t=this._r.insert("g",":first-child").classed("target-image",!0)),!(this.datas&&this.datas.x&&Array.isArray(this.datas.x[0])&&Array.isArray(this.datas.x[0][0])))return;const e=this.datas.x[0],a=this.datas._applySpace(e,this._color_space,this._normalize,this._binary_threshold),r=a[0][0].length,s=document.createElement("canvas");s.width=e[0].length,s.height=e.length;const i=s.getContext("2d"),h=i.createImageData(s.width,s.height);for(let t=0,e=0;t<s.height;t++)for(let i=0;i<s.width;i++,e+=4)h.data[e]=a[t][i][0],1===r?(h.data[e+1]=a[t][i][0],h.data[e+2]=a[t][i][0],h.data[e+3]=255):3===r?(h.data[e+1]=a[t][i][1],h.data[e+2]=a[t][i][2],h.data[e+3]=255):(h.data[e+1]=a[t][i][1],h.data[e+2]=a[t][i][2],h.data[e+3]=a[t][i][3]);i.putImageData(h,0,0),t.selectAll("*").remove(),t.append("image").attr("x",0).attr("y",0).attr("width",s.width).attr("height",s.height).attr("xlink:href",s.toDataURL()),this._org_width||(this._org_width=this._manager.platform.width,this._org_height=this._manager.platform.height),this._manager.platform.width=s.width,this._manager.platform.height=s.height}fit(t,e=8){const a=this.datas.x[0],r=this.datas._applySpace(this.datas._reduce(a,e,this._reduce_algorithm),this._color_space,this._normalize,this._binary_threshold);t(r,null,(t=>{this._pred=t,this._displayResult(r,t,e)}))}predict(t,e=8){const a=this.datas.x[0],r=this.datas._reduce(a,e,this._reduce_algorithm);if("DN"===this.task)for(let t=0;t<r.length;t++)for(let e=0;e<r[t].length;e++)for(let a=0;a<r[t][e].length;a++)r[t][e][a]=Math.max(0,Math.min(255,r[t][e][a]+Math.floor(510*Math.random()-255)));const s=this.datas._applySpace(r,this._color_space,this._normalize,this._binary_threshold);t(s,(t=>{if(!Array.isArray(t[0])){const e=[];for(let a=0;a<t.length;a+=s[0][0].length){const r=[];for(let e=0;e<s[0][0].length;e++)r.push(t[a+e]);e.push(r)}t=e}this._pred=t,this._displayResult(r,t,e)}))}_displayResult(t,e,a){let r=this._r.select("g.predict-img");0===r.size()&&(r=this._r.append("g").attr("opacity",this._opacity.property("value")).classed("predict-img",!0)),r.selectAll("*").remove();const s=document.createElement("canvas");s.width=this.width,s.height=this.height;const i=s.getContext("2d"),h=i.createImageData(s.width,s.height);for(let r=0,i=0;r<t.length;r++)for(let o=0;o<t[r].length;o++,i++){const t=[0,0,0,0];if(Array.isArray(e[i]))t[0]=e[i][0],t[3]=255,1===e[i].length?(t[1]=e[i][0],t[2]=e[i][0]):(t[1]=e[i][1],t[2]=e[i][2]);else if(!0===e[i]||!1===e[i])if(e[i]){const e=getCategoryColor(specialCategory.error);t[0]=e.r,t[1]=e.g,t[2]=e.b,t[3]=255*e.opacity}else t[0]=255,t[1]=255,t[2]=255,t[3]=255;else{const a=getCategoryColor(e[i]);t[0]=a.r,t[1]=a.g,t[2]=a.b,t[3]=255*a.opacity}for(let e=0;e<a;e++)for(let i=0;i<a;i++){const l=4*((r*a+e)*s.width+o*a+i);h.data[l]=t[0],h.data[l+1]=t[1],h.data[l+2]=t[2],h.data[l+3]=t[3]}}i.putImageData(h,0,0),r.append("image").attr("x",0).attr("y",0).attr("width",s.width).attr("height",s.height).attr("xlink:href",s.toDataURL())}terminate(){this._r.remove(),this.setting.task.configElement.selectAll("*").remove(),this._org_width&&(this._manager.platform.width=this._org_width,this._manager.platform.height=this._org_height),super.terminate()}}