var m=Object.defineProperty;var d=(l,t)=>m(l,"name",{value:t,configurable:!0});import{BasePlatform as u}from"./base.js";import p from"../data/image.js";import f from"../renderer/image.js";export default class g extends u{static{d(this,"ImagePlatform")}constructor(t){super(t),this._reduce_algorithm="mean",this._color_space="rgb",this._normalize=!1,this._step=10,this._binary_threshold=180,this._renderer.forEach(n=>n.terminate()),this._renderer=[new f(t)];const s=this.setting.task.configElement;s.append("Color space");const e=document.createElement("select");e.name="space",e.onchange=()=>{this._color_space=e.value,r.style.display=this._color_space==="binary"?null:"none",this.render()};for(const n of Object.keys(p.colorSpaces).map(i=>p.colorSpaces[i])){const i=document.createElement("option");i.value=n,i.innerText=n,e.appendChild(i)}s.appendChild(e);const r=document.createElement("input");r.type="number",r.name="threshold",r.min=0,r.max=255,r.value=this._binary_threshold,r.style.display="none",r.onchange=()=>{this._binary_threshold=r.value,this.render()},s.appendChild(r)}set colorSpace(t){this._color_space=t,this.setting.task.configElement.querySelector("[name=space]").value=t,this.setting.task.configElement.querySelector("[name=threshold]").style.display=this._color_space==="binary"?null:"none",this.render()}get trainInput(){const t=this.datas.x[0];return this.datas._applySpace(this.datas._reduce(t,this._step,this._reduce_algorithm),this._color_space,this._normalize,this._binary_threshold)}set trainResult(t){t=this._to2d(t,this.trainInput,this._step),this._renderer.forEach(s=>s.trainResult=t)}testInput(t=8){const s=this.datas.x[0],e=this.datas._reduce(s,t,this._reduce_algorithm);if(this.task==="DN")for(let n=0;n<e.length;n++)for(let i=0;i<e[n].length;i++)for(let a=0;a<e[n][i].length;a++)e[n][i][a]=Math.max(0,Math.min(255,e[n][i][a]+Math.floor(Math.random()*50-25)));const r=this.datas._applySpace(e,this._color_space,this._normalize,this._binary_threshold);return this.__pred=r,this.__pred_x=e,this.__pred_step=t,r}testResult(t){if(!Array.isArray(t[0])){const s=[];for(let e=0;e<t.length;e+=this.__pred[0][0].length)s.push(t.slice(e,e+this.__pred[0][0].length));t=s}t=this._to2d(t,this.__pred_x,this.__pred_step),this._renderer.forEach(s=>s.testResult(t))}_to2d(t,s,e){const r=Array.from({length:s.length*e},()=>[]);for(let n=0,i=0,a=0;n<s.length;n++,i+=e)for(let c=0,_=0;c<s[n].length;c++,a++,_+=e)for(let o=0;o<e;o++)for(let h=0;h<e;h++)r[i+o][_+h]=t[a];return r}init(){this._renderer.forEach(t=>t.init()),this.render()}terminate(){this.setting.task.configElement.replaceChildren(),super.terminate()}}
