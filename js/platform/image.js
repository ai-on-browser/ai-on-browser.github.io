import{BasePlatform}from"./base.js";import ImageData from"../data/image.js";export default class ImagePlatform extends BasePlatform{constructor(t,e){super(t,e),this._reduce_algorithm="mean",this._color_space="rgb",this._normalize=!1,this._step=10,this._org_width=null,this._org_height=null,this._binary_threshold=180;const a=this.setting.task.configElement;a.appendChild(document.createTextNode("Color space"));const i=document.createElement("select");i.name="space",i.onchange=()=>{this._color_space=i.value,s.style.display="binary"===this._color_space?null:"none",this.render()};for(const t of Object.keys(ImageData.colorSpaces).map((t=>ImageData.colorSpaces[t]))){const e=document.createElement("option");e.value=t,e.innerText=t,i.appendChild(e)}a.appendChild(i);const s=document.createElement("input");s.type="number",s.name="threshold",s.min=0,s.max=255,s.value=this._binary_threshold,s.style.display="none",s.onchange=()=>{this._binary_threshold=s.value,this.render()},a.appendChild(s),a.appendChild(document.createTextNode(" overwrap ")),this._opacity=document.createElement("input"),this._opacity.name="opacity",this._opacity.type="range",this._opacity.min=0,this._opacity.max=1,this._opacity.step=.1,this._opacity.value=.5,this._opacity.oninput=()=>{let t=this._r.select("g.predict-img");t.size()>0&&t.attr("opacity",this._opacity.value)},a.appendChild(this._opacity)}set colorSpace(t){this._color_space=t,this.setting.task.configElement.querySelector("[name=space]").value=t,this.setting.task.configElement.querySelector("[name=threshold]").style.display="binary"===this._color_space?null:"none",this.render()}get trainInput(){const t=this.datas.x[0];return this.datas._applySpace(this.datas._reduce(t,this._step,this._reduce_algorithm),this._color_space,this._normalize,this._binary_threshold)}set trainResult(t){this._pred=t,this._displayResult(this.trainInput,t,this._step)}testInput(t=8){const e=this.datas.x[0],a=this.datas._reduce(e,t,this._reduce_algorithm);if("DN"===this.task)for(let t=0;t<a.length;t++)for(let e=0;e<a[t].length;e++)for(let i=0;i<a[t][e].length;i++)a[t][e][i]=Math.max(0,Math.min(255,a[t][e][i]+Math.floor(510*Math.random()-255)));const i=this.datas._applySpace(a,this._color_space,this._normalize,this._binary_threshold);return this.__pred=i,this.__pred_x=a,this.__pred_step=t,i}testResult(t){if(!Array.isArray(t[0])){const e=[];for(let a=0;a<t.length;a+=this.__pred[0][0].length){const i=[];for(let e=0;e<this.__pred[0][0].length;e++)i.push(t[a+e]);e.push(i)}t=e}this._pred=t,this._displayResult(this.__pred_x,t,this.__pred_step)}init(){0===this.svg.select("g.im-render").size()&&this.svg.append("g").classed("im-render",!0).style("transform","scale(1, -1) translate(0, -100%)"),this._r=this.svg.select("g.im-render"),this._r.selectAll("*").remove(),this.render()}render(){let t=this._r.select("g.target-image");if(0===t.size()&&(t=this._r.insert("g",":first-child").classed("target-image",!0)),!(this.datas&&this.datas.x&&Array.isArray(this.datas.x[0])&&Array.isArray(this.datas.x[0][0])))return;const e=this.datas.x[0],a=this.datas._applySpace(e,this._color_space,this._normalize,this._binary_threshold),i=a[0][0].length,s=document.createElement("canvas");s.width=e[0].length,s.height=e.length;const r=s.getContext("2d"),h=r.createImageData(s.width,s.height);for(let t=0,e=0;t<s.height;t++)for(let r=0;r<s.width;r++,e+=4)h.data[e]=a[t][r][0],1===i?(h.data[e+1]=a[t][r][0],h.data[e+2]=a[t][r][0],h.data[e+3]=255):3===i?(h.data[e+1]=a[t][r][1],h.data[e+2]=a[t][r][2],h.data[e+3]=255):(h.data[e+1]=a[t][r][1],h.data[e+2]=a[t][r][2],h.data[e+3]=a[t][r][3]);r.putImageData(h,0,0),t.selectAll("*").remove(),t.append("image").attr("x",0).attr("y",0).attr("width",s.width).attr("height",s.height).attr("xlink:href",s.toDataURL()),this._org_width||(this._org_width=this._manager.platform.width,this._org_height=this._manager.platform.height),this._manager.platform.width=s.width,this._manager.platform.height=s.height}_displayResult(t,e,a){let i=this._r.select("g.predict-img");0===i.size()&&(i=this._r.append("g").attr("opacity",this._opacity.value).classed("predict-img",!0)),i.selectAll("*").remove();const s=document.createElement("canvas");s.width=this.width,s.height=this.height;const r=s.getContext("2d"),h=r.createImageData(s.width,s.height);for(let i=0,r=0;i<t.length;i++)for(let o=0;o<t[i].length;o++,r++){const t=[0,0,0,0];if(Array.isArray(e[r]))t[0]=e[r][0],t[3]=255,1===e[r].length?(t[1]=e[r][0],t[2]=e[r][0]):(t[1]=e[r][1],t[2]=e[r][2]);else if(!0===e[r]||!1===e[r])if(e[r]){const e=getCategoryColor(specialCategory.error);t[0]=e.r,t[1]=e.g,t[2]=e.b,t[3]=255*e.opacity}else t[0]=255,t[1]=255,t[2]=255,t[3]=255;else{const a=getCategoryColor(e[r]);t[0]=a.r,t[1]=a.g,t[2]=a.b,t[3]=255*a.opacity}for(let e=0;e<a;e++)for(let r=0;r<a;r++){const n=4*((i*a+e)*s.width+o*a+r);h.data[n]=t[0],h.data[n+1]=t[1],h.data[n+2]=t[2],h.data[n+3]=t[3]}}r.putImageData(h,0,0),i.append("image").attr("x",0).attr("y",0).attr("width",s.width).attr("height",s.height).attr("xlink:href",s.toDataURL())}terminate(){this._r.remove(),this.setting.task.configElement.replaceChildren(),this._org_width&&(this._manager.platform.width=this._org_width,this._manager.platform.height=this._org_height),super.terminate()}}