import{BasePlatform}from"./base.js";import ImageData from"../data/image.js";import ImageRenderer from"../renderer/image.js";export default class ImagePlatform extends BasePlatform{constructor(e,t){super(e,t),this._reduce_algorithm="mean",this._color_space="rgb",this._normalize=!1,this._step=10,this._binary_threshold=180,this._renderer.forEach((e=>e.terminate())),this._renderer=[new ImageRenderer(t)];const r=this.setting.task.configElement;r.append("Color space");const s=document.createElement("select");s.name="space",s.onchange=()=>{this._color_space=s.value,a.style.display="binary"===this._color_space?null:"none",this.render()};for(const e of Object.keys(ImageData.colorSpaces).map((e=>ImageData.colorSpaces[e]))){const t=document.createElement("option");t.value=e,t.innerText=e,s.appendChild(t)}r.appendChild(s);const a=document.createElement("input");a.type="number",a.name="threshold",a.min=0,a.max=255,a.value=this._binary_threshold,a.style.display="none",a.onchange=()=>{this._binary_threshold=a.value,this.render()},r.appendChild(a)}set colorSpace(e){this._color_space=e,this.setting.task.configElement.querySelector("[name=space]").value=e,this.setting.task.configElement.querySelector("[name=threshold]").style.display="binary"===this._color_space?null:"none",this.render()}get trainInput(){const e=this.datas.x[0];return this.datas._applySpace(this.datas._reduce(e,this._step,this._reduce_algorithm),this._color_space,this._normalize,this._binary_threshold)}set trainResult(e){e=this._to2d(e,this.trainInput,this._step),this._renderer.forEach((t=>t.trainResult=e))}testInput(e=8){const t=this.datas.x[0],r=this.datas._reduce(t,e,this._reduce_algorithm);if("DN"===this.task)for(let e=0;e<r.length;e++)for(let t=0;t<r[e].length;t++)for(let s=0;s<r[e][t].length;s++)r[e][t][s]=Math.max(0,Math.min(255,r[e][t][s]+Math.floor(50*Math.random()-25)));const s=this.datas._applySpace(r,this._color_space,this._normalize,this._binary_threshold);return this.__pred=s,this.__pred_x=r,this.__pred_step=e,s}testResult(e){if(!Array.isArray(e[0])){const t=[];for(let r=0;r<e.length;r+=this.__pred[0][0].length)t.push(e.slice(r,r+this.__pred[0][0].length));e=t}e=this._to2d(e,this.__pred_x,this.__pred_step),this._renderer.forEach((t=>t.testResult(e)))}_to2d(e,t,r){const s=Array.from({length:t.length*r},(()=>[]));for(let a=0,n=0,i=0;a<t.length;a++,n+=r)for(let o=0,h=0;o<t[a].length;o++,i++,h+=r)for(let t=0;t<r;t++)for(let a=0;a<r;a++)s[n+t][h+a]=e[i];return s}init(){this._renderer.forEach((e=>e.init())),this.render()}terminate(){this.setting.task.configElement.replaceChildren(),super.terminate()}}