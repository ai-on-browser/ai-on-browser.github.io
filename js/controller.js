export default class Controller{constructor(e,t){this._platform=e,this._e=t??e.setting.ml.configElement.node(),this._terminators=[],e.setting.terminate=this.terminate.bind(this),this.input=this.input.bind(this),this.input.text=e=>this.input({type:"text",...e}),this.input.number=e=>this.input({type:"number",...e}),this.input.range=e=>this.input({type:"range",...e}),this.input.button=e=>("string"==typeof e&&(e={value:e}),this.input({type:"button",...e}))}get element(){return this._e}terminate(){this._terminators.forEach((e=>e()))}span(){const e=document.createElement("span");return this._e.appendChild(e),new Controller(this._platform,e)}text(e={}){"string"==typeof e&&(e={value:e});const t=this._e;e.label&&t.appendChild(document.createTextNode(e.label));const n=document.createElement("span");return t.appendChild(n),n.innerText=e.value??"",{element:n,get value(){return n.innerText},set value(e){n.innerText=e}}}select(e={}){Array.isArray(e)&&(e={values:e});const t=this._e,{label:n,values:i,value:l,...a}=e;n&&t.appendChild(document.createTextNode(n));const s=document.createElement("select");t.appendChild(s);for(const e of i){const t=document.createElement("option");t.value=t.innerText=e,s.appendChild(t)}l&&(s.value=l);for(const e of Object.keys(a))null!=a[e]&&s.setAttribute(e,a[e]);return{element:s,get value(){return s.value},set value(e){s.value=e},set values(e){s.replaceChild();for(const t of e){const e=document.createElement("option");e.value=t,e.innerText=t,s.appendChild(e)}},on(e,t){return s.addEventListener(e,t),this}}}input({label:e,type:t,...n}){const i=this._e;e&&i.appendChild(document.createTextNode(e));const l=document.createElement("input");i.appendChild(l),l.type=t;for(const e of Object.keys(n))null!=n[e]&&l.setAttribute(e,n[e]);return{element:l,get value(){return"number"===t||"range"===t?+l.value:"checkbox"===t?l.checked:l.value},set value(e){l.value=e},on(e,t){return l.addEventListener(e,t),this}}}array({label:e,type:t,...n}){const i=this._e;e&&i.appendChild(document.createTextNode(e));const l=document.createElement("span");i.appendChild(l);const a=n.values??[],s=[],u=()=>{l.replaceChildren();for(let e=0;e<a.length;e++){const i=document.createElement("input");i.type=t;for(const e of Object.keys(n))null!=n[e]&&i.setAttribute(e,n[e]);i.value=a[e],i.onchange=()=>{a[e]=i.value},l.appendChild(i),s.push(i)}if(a.length>0){const e=document.createElement("input");e.type="button",e.value="-",e.onclick=()=>{a.pop(),u()},l.appendChild(e)}},r=document.createElement("input");return r.type="button",r.value="+",r.onclick=()=>{a.push(n.default),u()},i.appendChild(r),u(),{element:l,get value(){return"number"===t||"range"===t?a.map((e=>+e)):a},set value(e){a.length=0,a.push(...e),u()},on(e,t){return s.forEach((n=>n.addEventListener(e,t))),this}}}stepLoopButtons(){let e=0;const t=this._e;let n=!1,i=null,l=null,a=null,s=null,u=()=>e+1,r=!1,o=null;const d={initialize:null,stop:()=>n=!1,set enable(e){i&&(i.disabled=!e),l&&(l.disabled=!e),a&&(a.disabled=!e)},init(n){this.initialize=n;const i=document.createElement("input");return i.type="button",i.value="Initialize",i.onclick=()=>{n.length>0?(i.disabled=!0,this.enable=!1,n((()=>{i.disabled=!1,this.enable=!0,s&&(s.innerText=e=0)}))):(n(),this.enable=!0,s&&(s.innerText=e=0))},t.appendChild(i),r=!0,this},step(d){return i=document.createElement("input"),i.type="button",i.value="Step",i.disabled=r,i.onclick=()=>{d.length>0?(this.enable=!1,d((()=>{this.enable=!0,s&&(s.innerText=e=u())}))):(d(),s&&(s.innerText=e=u()))},t.appendChild(i),l=document.createElement("input"),l.type="button",l.value="Run",l.disabled=r,l.onclick=()=>{if(n=!n,l.value=n?"Stop":"Run",n){const t=()=>{n&&(d.length>0?d((()=>{s&&(s.innerText=e=u()),setTimeout(t,0)})):(d(),s&&(s.innerText=e=u()),setTimeout(t,0))),i.disabled=n,a&&(a.disabled=n),l.disabled=!1};t()}else l.disabled=!0},t.appendChild(l),o=d,this},skip(d){return d||=o,a=document.createElement("input"),a.type="button",a.value="Skip",a.disabled=r,a.onclick=()=>{if(n=!n,a.value=n?"Stop":"Skip",n){let t=(new Date).getTime();const r=()=>{for(i&&(i.disabled=n),l&&(l.disabled=n),a.disabled=!1;n;){if(d.length>0)return void d((()=>{s&&(s.innerText=e=u()),setTimeout(r,0)}));{d(),s&&(s.innerText=e=u());const n=(new Date).getTime();if(n-t>200)return t=n,void setTimeout(r,0)}}};r()}else a.disabled=!0},t.appendChild(a),this},epoch(e){return t.appendChild(document.createTextNode(" Epoch: ")),s=document.createElement("span"),t.appendChild(s),s.setAttribute("name","epoch"),s.innerText=0,e&&(u=e),this},elm(e){return e(t),this}};return this._terminators.push(d.stop),d}}