export default class Controller{constructor(t){this._e=t.setting.ml.configElement,this._terminators=[],t.setting.terminate=this.terminate.bind(this),this.input.text=t=>this.input({type:"text",...t}),this.input.number=t=>this.input({type:"number",...t}),this.input.range=t=>this.input({type:"range",...t}),this.input.button=t=>("string"==typeof t&&(t={value:t}),this.input({type:"button",...t}))}terminate(){this._terminators.forEach((t=>t()))}text(t={}){"string"==typeof t&&(t={value:t});const e=this._e;t.label&&e.append("span").text(t.label);const n=e.append("span").text(t.value);return{element:n,get value(){return n.text()},set value(t){n.text(t)}}}select(t={}){Array.isArray(t)&&(t={values:t});const e=this._e;t.label&&e.append("span").text(t.label);const n=e.append("select");return n.selectAll("option").data(t.values).enter().append("option").property("value",(t=>t)).text((t=>t)),null!=t.value&&n.property("value",t.value),{element:n,get value(){return n.property("value")},set value(t){n.property("value",t)},set values(t){n.selectAll("*").remove(),n.selectAll("option").data(t).enter().append("option").attr("value",(t=>t)).text((t=>t))},on(t,e){return n.on(t,e),this}}}input({label:t,type:e,...n}){const p=this._e;t&&p.append("span").text(t);const r=p.append("input").attr("type",e);for(const t of Object.keys(n))null!=n[t]&&r.attr(t,n[t]);return{element:r,get value(){return"number"===e||"range"===e?+r.property("value"):r.property("value")},set value(t){r.property("value",t)},on(t,e){return r.on(t,e),this}}}stepLoopButtons(){let t=0;const e=this._e;let n=!1,p=null,r=null,a=null,l=null,i=()=>t+1,s=!1,o=null;const u={initialize:null,stop:()=>n=!1,set enable(t){p?.property("disabled",!t),r?.property("disabled",!t),a?.property("disabled",!t)},init(n){this.initialize=n;const p=e.append("input").attr("type","button").attr("value","Initialize").on("click",(()=>{n.length>0?(p.property("disabled",!0),this.enable=!1,n((()=>{p.property("disabled",!1),this.enable=!0,l?.text(t=0)}))):(n(),this.enable=!0,l?.text(t=0))}));return s=!0,this},step(u){return p=e.append("input").attr("type","button").attr("value","Step").property("disabled",s).on("click",(()=>{u.length>0?(this.enable=!1,u((()=>{this.enable=!0,l?.text(t=i())}))):(u(),l?.text(t=i()))})),r=e.append("input").attr("type","button").attr("value","Run").property("disabled",s).on("click",(()=>{if(n=!n,r.attr("value",n?"Stop":"Run"),n){const e=()=>{n&&(u.length>0?u((()=>{l?.text(t=i()),setTimeout(e,0)})):(u(),l?.text(t=i()),setTimeout(e,0))),p.property("disabled",n),a?.property("disabled",n),r.property("disabled",!1)};e()}else r.property("disabled",!0)})),o=u,this},skip(u){return u||=o,a=e.append("input").attr("type","button").attr("value","Skip").property("disabled",s).on("click",(()=>{if(n=!n,a.attr("value",n?"Stop":"Skip"),n){let e=(new Date).getTime();const s=()=>{for(p?.property("disabled",n),r?.property("disabled",n),a.property("disabled",!1);n;){if(u.length>0)return void u((()=>{l?.text(t=i()),setTimeout(s,0)}));{u(),l?.text(t=i());const n=(new Date).getTime();if(n-e>200)return e=n,void setTimeout(s,0)}}};s()}else a.property("disabled",!0)})),this},epoch(t){return e.append("span").text(" Epoch: "),l=e.append("span").attr("name","epoch").text("0"),t&&(i=t),this},elm(t){return t(e),this}};return this._terminators.push(u.stop),u}}