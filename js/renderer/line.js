import BaseRenderer from"./base.js";import{DataPoint,specialCategory,getCategoryColor}from"../utils.js";const scale=function(t,e,s,i,a){return isFinite(e)&&isFinite(s)&&e!==s?(t-e)/(s-e)*(a-i)+i:(a+i)/2};export default class LineRenderer extends BaseRenderer{constructor(t){super(t),this._size=[960,500],this._pred_values=[];const e=this.setting.render.addItem("line"),s=document.createElement("div");s.id="plot-area",e.appendChild(s),this._menu=document.createElement("div"),s.appendChild(this._menu);const i=d3.select(s).append("svg").style("border","1px solid #000000").attr("width",`${this._size[0]}px`).attr("height",`${this._size[1]}px`);if(this._svg=i.append("g").style("transform","scale(1, -1) translate(0, -100%)"),this._r=this._svg.select("g.points g.datas"),0===this._r.size()){const t=this._svg.append("g").classed("points",!0);this._r=t.append("g").classed("datas",!0)}this._pathg=this._svg.select("g.ts-render-path"),0===this._pathg.size()&&(this._pathg=this._svg.insert("g",":first-child").classed("ts-render-path",!0)),this._pathg.selectAll("g.ts-render-path *").remove(),this._path=this._pathg.append("path").attr("stroke","black").attr("fill-opacity",0).style("pointer-events","none"),this._p=[],this._pad=10,this._clip_pad=-1/0,this._cp_threshold=0,this._observe_target=null,this._observer=new MutationObserver((t=>{this._observe_target&&this._p.forEach(((t,e)=>t.title=this.datas.labels[e]))})),this._observer.observe(this._svg.node(),{childList:!0}),this._will_render=!1}get svg(){return this._svg}get width(){return this._size[0]}get height(){return this._size[1]}get padding(){return Array.isArray(this._pad)?this._pad:[this._pad,this._pad]}set padding(t){this._pad=t,this.render()}set clipPadding(t){this._clip_pad=t,this.render()}get points(){return this._p}init(){this._pred_values=[],this._r_tile?.remove(),this._make_selector()}_make_selector(){let t=this.datas?.columnNames||[],e=this._menu.querySelector("div.column-selector");if(!e&&t.length>0?(e=document.createElement("div"),e.classList.add("column-selector"),this._menu.appendChild(e)):e?.replaceChildren(),t.length<1)this._select=null;else if(t.length<=4){const s=document.createElement("table");s.style.borderCollapse="collapse",e.appendChild(s);let i=document.createElement("tr");i.style.textAlign="center",i.appendChild(document.createElement("td"));const a=document.createElement("td");a.innerHTML="&uarr;",i.appendChild(a),s.appendChild(i);const h=[];for(let e=0;e<t.length;e++){i=document.createElement("tr");const a=document.createElement("td");a.innerText=t[e],a.style.textAlign="right",i.appendChild(a);const n=document.createElement("td"),r=document.createElement("input");r.type="radio",r.name="data-d1",r.onchange=()=>this._manager.platform.render(),n.appendChild(r),i.appendChild(n),h.push(r),s.appendChild(i)}h[0].checked=!0,this._select=()=>{const e=[];for(let s=0;s<t.length;s++)h[s].checked&&(e[0]=s);return e}}else{t=t.map((t=>""+t));const s=document.createElement("span");s.innerHTML="&uarr;",e.appendChild(s);const i=document.createElement("select");i.onchange=()=>this._manager.platform.render();for(const e of t){const t=document.createElement("option");t.value=e,t.innerText=e,i.appendChild(t)}i.value=t[0],e.appendChild(i),this._select=()=>[t.indexOf(i.value)]}}_clip(t){if(this._clip_pad===-1/0)return t;const e=[this.width,this.height];for(let s=0;s<t.length;s++)t[s]<this._clip_pad?t[s]=this._clip_pad:e[s]-this._clip_pad<t[s]&&(t[s]=e[s]-this._clip_pad);return t}_range(){let t=[],e=0;0===this.datas.dimension?t=this.datas.range.concat():(e=this._select?.()??[Math.min(1,this.datas.dimension-1)],t=this.datas.domain[e[0]].concat());for(let s=0;s<this._pred_values.length;s++)this._pred_values[s][e]<t[0]?t[0]=this._pred_values[s][e]:this._pred_values[s][e]>t[1]&&(t[1]=this._pred_values[s][e]);return t}toPoint(t){if(0===this.datas.length)return[0,0];const e=[this.width,this.height],s=[],i=this._range();if(0===this.datas.dimension)s.push(scale(t[0],0,this.datas.length+this._pred_values.length,0,e[0]-2*this.padding[0])+this.padding[0],scale(t[1][0],i[0],i[1],0,e[1]-2*this.padding[1])+this.padding[1]);else{const a=this._select?.()??(0===this.datas.dimension?null:[Math.min(1,this.datas.dimension-1)]),h=Math.min(a[0],t[1].length-1);s.push(scale(t[0],0,this.datas.length+this._pred_values.length,0,e[0]-2*this.padding[0])+this.padding[0],scale(t[1][h],i[0],i[1],0,e[1]-2*this.padding[1])+this.padding[1])}return s.map((t=>isNaN(t)?0:t))}toValue(t){return t&&this.datas?[scale(t[0]-this.padding[0],0,this.width-2*this.padding[0],0,this.datas.length)]:[]}_render(){if(!this.datas||0===this.datas.length)return this._p.map((t=>t.remove())),this._p.length=0,void this._path.attr("opacity",0);const t=this._select?.()??(0===this.datas.dimension?null:[Math.min(1,this.datas.dimension-1)]),e=this.datas.length,s=this.datas.x,i=this.datas.y,a=this._size,h=this._range(),n=[];for(let r=0;r<e;r++)0===this.datas.dimension?n.push([scale(r,0,e+this._pred_values.length,0,a[0]-2*this.padding[0])+this.padding[0],scale(i[r],h[0],h[1],0,a[1]-2*this.padding[1])+this.padding[1]]):n.push([scale(r,0,e+this._pred_values.length,0,a[0]-2*this.padding[0])+this.padding[0],scale(s[r][t[0]],h[0],h[1],0,a[1]-2*this.padding[1])+this.padding[1]]);const r=Math.max(1,Math.min(5,Math.floor(2e3/e)));for(let t=0;t<e;t++){const e=this._clip(n[t]),s=this.datas.dimension<=1?0:this.datas.y[t];if(this._p[t]){const i=this._p[t].at;i[0]===e[0]&&i[1]===e[1]||(this._p[t].at=e),this._p[t].category!==s&&(this._p[t].category=s)}else this._p[t]=new DataPoint(this._r,e,s);this._p[t].title=this.datas.labels[t],this._p[t].radius=r}for(let t=e;t<this._p.length;t++)this._p[t].remove();this._p.length=e;const l=d3.line().x((t=>t[0])).y((t=>t[1]));this._path.attr("d",l(this.points.map((t=>t.at)))).attr("opacity",.5)}testResult(t){const e=this._manager.platform.task;0===this._svg.select("g.tile-render").size()&&("CP"===e?this._svg.insert("g",":first-child").classed("tile-render",!0):this._svg.append("g").classed("tile-render",!0)),this._r_tile=this._svg.select("g.tile-render"),this._r_tile.selectAll("*").remove();const s=d3.line().x((t=>t[0])).y((t=>t[1]));if(this._pred_values=[],this._cp_pred_value=null,"TP"===e){this._pred_values=t;const e=this._r_tile.append("path").attr("stroke","red").attr("fill-opacity",0).style("pointer-events","none");this._pred_points?.forEach((t=>t.remove())),this._pred_points=[];const i=this.datas,a=[];i.length>0&&a.push(this.toPoint([i.length-1,i.x[i.length-1]||[i.y[i.length-1]]]));for(let e=0;e<t.length;e++){const s=this.toPoint([e+i.length,t[e]]),h=new DataPoint(this._r_tile,s,specialCategory.dummy);a.push(s),this._pred_points.push(h)}0===a.length?e.attr("opacity",0):e.attr("d",s(a)).attr("opacity",.5)}else if("SM"===e){const e=this._r_tile.append("path").attr("stroke","red").attr("fill-opacity",0).style("pointer-events","none"),i=[];for(let e=0;e<t.length;e++){const s=this.toPoint([e,t[e]]);i.push(s)}0===i.length?e.attr("opacity",0):e.attr("d",s(i)).attr("opacity",1)}else if("CP"===e){if("number"==typeof t[0]?(this._cp_pred_value=t.concat(),t=t.map((t=>t>this._cp_threshold))):t=t.concat(),this._cp_pred_value){let t=Math.max(...this._cp_pred_value);const e=Math.min(...this._cp_pred_value);t===e&&(t+=1);const s=document.createElement("canvas");s.width=this.width,s.height=this.height;const i=s.getContext("2d");let a=0;for(let s=0;s<this._cp_pred_value.length;s++){const h=this.toPoint([s+.5,[0]])[0],n=(this._cp_pred_value[s]-e)/(t-e);i.fillStyle=getCategoryColor(specialCategory.errorRate(n)),i.fillRect(a,0,h-a+1,this.height),a=h}this._r_tile.append("image").attr("x",0).attr("y",0).attr("width",s.width).attr("height",s.height).attr("xlink:href",s.toDataURL()).attr("opacity",.3)}for(let e=0;e<t.length;e++){if(!t[e])continue;const s=this.toPoint([e,[0]])[0];this._r_tile.append("line").attr("x1",s).attr("x2",s).attr("y1",0).attr("y2",this.height).attr("stroke","red")}}}resetPredicts(){this._pred_values=[],this._r_tile?.selectAll("*").remove(),this.render()}updateThreshold(t){this._cp_pred_value&&(this._cp_threshold=t,this.testResult(this._cp_pred_value))}terminate(){this._observer.disconnect(),this.setting.render.removeItem("line"),super.terminate()}}