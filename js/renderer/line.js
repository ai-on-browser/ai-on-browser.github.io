import BaseRenderer from"./base.js";import{DataPoint}from"../utils.js";const scale=function(t,e,s,i,a){return isFinite(e)&&isFinite(s)&&e!==s?(t-e)/(s-e)*(a-i)+i:(a+i)/2};export default class LineRenderer extends BaseRenderer{constructor(t){super(t),this._size=[960,500];const e=this.setting.render.addItem("line"),s=document.createElement("div");s.id="plot-area",e.appendChild(s),this._menu=document.createElement("div"),s.appendChild(this._menu);const i=d3.select(s).append("svg").style("border","1px solid #000000").attr("width",`${this._size[0]}px`).attr("height",`${this._size[1]}px`);if(this._svg=i.append("g").style("transform","scale(1, -1) translate(0, -100%)"),this._r=this._svg.select("g.points g.datas"),0===this._r.size()){const t=this._svg.append("g").classed("points",!0);this._r=t.append("g").classed("datas",!0)}this._pathg=this._svg.select("g.ts-render-path"),0===this._pathg.size()&&(this._pathg=this._svg.insert("g",":first-child").classed("ts-render-path",!0)),this._pathg.selectAll("g.ts-render-path *").remove(),this._path=this._pathg.append("path").attr("stroke","black").attr("fill-opacity",0).style("pointer-events","none"),this._p=[],this._pad=10,this._clip_pad=-1/0,this._pred_count=0,this._observe_target=null,this._observer=new MutationObserver((t=>{this._observe_target&&this._p.forEach(((t,e)=>t.title=this.datas.labels[e]))})),this._observer.observe(this._svg.node(),{childList:!0}),this._will_render=!1}get svg(){return this._svg}get width(){return this._size[0]}get height(){return this._size[1]}get padding(){return Array.isArray(this._pad)?this._pad:[this._pad,this._pad]}set padding(t){this._pad=t,this.render()}set clipPadding(t){this._clip_pad=t,this.render()}get points(){return this._p}init(){this._make_selector()}_make_selector(){let t=this.datas?.columnNames||[],e=this._menu.querySelector("div.column-selector");if(!e&&t.length>0?(e=document.createElement("div"),e.classList.add("column-selector"),this._menu.appendChild(e)):e?.replaceChildren(),t.length<1)this._select=null;else if(t.length<=4){const s=document.createElement("table");s.style.borderCollapse="collapse",e.appendChild(s);let i=document.createElement("tr");i.style.textAlign="center",i.appendChild(document.createElement("td"));const a=document.createElement("td");a.innerHTML="&uarr;",i.appendChild(a),s.appendChild(i);const n=[];for(let e=0;e<t.length;e++){i=document.createElement("tr");const a=document.createElement("td");a.innerText=t[e],a.style.textAlign="right",i.appendChild(a);const h=document.createElement("td"),d=document.createElement("input");d.type="radio",d.name="data-d1",d.onchange=()=>this._manager.platform.render(),h.appendChild(d),i.appendChild(h),n.push(d),s.appendChild(i)}n[0].checked=!0,this._select=()=>{const e=[];for(let s=0;s<t.length;s++)n[s].checked&&(e[0]=s);return e}}else{t=t.map((t=>""+t));const s=document.createElement("span");s.innerHTML="&uarr;",e.appendChild(s);const i=document.createElement("select");i.onchange=()=>this._manager.platform.render();for(const e of t){const t=document.createElement("option");t.value=e,t.innerText=e,i.appendChild(t)}i.value=t[0],e.appendChild(i),this._select=()=>[t.indexOf(i.value)]}}_clip(t){if(this._clip_pad===-1/0)return t;const e=[this.width,this.height];for(let s=0;s<t.length;s++)t[s]<this._clip_pad?t[s]=this._clip_pad:e[s]-this._clip_pad<t[s]&&(t[s]=e[s]-this._clip_pad);return t}toPoint(t){if(0===this.datas.length)return[0,0];const e=[this.width,this.height],s=[];if(0===this.datas.dimension){const i=this.datas.range;s.push(scale(t[0],0,this.datas.length+this._pred_count,0,e[0]-2*this.padding[0])+this.padding[0],scale(t[1][0],i[0],i[1],0,e[1]-2*this.padding[1])+this.padding[1])}else{const i=this._select?.()??(0===this.datas.dimension?null:[Math.min(1,this.datas.dimension-1)]),a=this.datas.domain,n=Math.min(i[0],t[1].length-1);s.push(scale(t[0],0,this.datas.length+this._pred_count,0,e[0]-2*this.padding[0])+this.padding[0],scale(t[1][n],a[i[0]][0],a[i[0]][1],0,e[1]-2*this.padding[1])+this.padding[1])}return s.map((t=>isNaN(t)?0:t))}toValue(t){return t&&this.datas?[scale(t[0]-this.padding[0],0,this.width-2*this.padding[0],0,this.datas.length)]:[]}_render(){if(!this.datas||0===this.datas.length)return this._p.map((t=>t.remove())),this._p.length=0,void this._path.attr("opacity",0);const t=this._select?.()??(0===this.datas.dimension?null:[Math.min(1,this.datas.dimension-1)]),e=this.datas.length,s=this.datas.x,i=this.datas.domain,a=this.datas.y,n=this._size,[h,d]=this.datas.range,r=[];for(let l=0;l<e;l++)0===this.datas.dimension?r.push([scale(l,0,e+this._pred_count,0,n[0]-2*this.padding[0])+this.padding[0],scale(a[l],h,d,0,n[1]-2*this.padding[1])+this.padding[1]]):r.push([scale(l,0,e+this._pred_count,0,n[0]-2*this.padding[0])+this.padding[0],scale(s[l][t[0]],i[t[0]][0],i[t[0]][1],0,n[1]-2*this.padding[1])+this.padding[1]]);const l=Math.max(1,Math.min(5,Math.floor(2e3/e)));for(let t=0;t<e;t++){const e=this._clip(r[t]),s=this.datas.dimension<=1?0:this.datas.y[t];if(this._p[t]){const i=this._p[t].at;i[0]===e[0]&&i[1]===e[1]||(this._p[t].at=e),this._p[t].category!==s&&(this._p[t].category=s)}else this._p[t]=new DataPoint(this._r,e,s);this._p[t].title=this.datas.labels[t],this._p[t].radius=l}for(let t=e;t<this._p.length;t++)this._p[t].remove();this._p.length=e;const p=d3.line().x((t=>t[0])).y((t=>t[1]));this._path.attr("d",p(this.points.map((t=>t.at)))).attr("opacity",.5)}terminate(){this._observer.disconnect(),this.setting.render.removeItem("line"),super.terminate()}}