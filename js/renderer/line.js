var b=Object.defineProperty;var g=(_,e)=>b(_,"name",{value:e,configurable:!0});import{getCategoryColor as y,specialCategory as f}from"../utils.js";import A from"./base.js";import{DataPoint as v}from"./util/figure.js";const p=g((_,e,n,t,s)=>!isFinite(e)||!isFinite(n)||e===n?(s+t)/2:(_-e)/(n-e)*(s-t)+t,"scale"),w=g(_=>{let e="";for(let n=0;n<_.length;n++)e+=`${n===0?"M":"L"}${_[n][0]},${_[n][1]}`;return e},"line");export default class C extends A{static{g(this,"LineRenderer")}constructor(e){super(e),this._size=[960,500],this._pred_values=[];const n=this.setting.render.addItem("line"),t=document.createElement("div");t.id="plot-area",n.appendChild(t),this._menu=document.createElement("div"),t.appendChild(this._menu);const s=document.createElementNS("http://www.w3.org/2000/svg","svg");t.appendChild(s),s.style.border="1px solid #000000",s.setAttribute("width",`${this._size[0]}px`),s.setAttribute("height",`${this._size[1]}px`),this._svg=document.createElementNS("http://www.w3.org/2000/svg","g"),this._svg.style.transform="scale(1, -1) translate(0, -100%)",s.appendChild(this._svg),this._grid=document.createElementNS("http://www.w3.org/2000/svg","g"),this._grid.setAttribute("opacity",.3),this._svg.appendChild(this._grid);const i=document.createElementNS("http://www.w3.org/2000/svg","g");i.classList.add("points"),this._svg.appendChild(i),this._r=document.createElementNS("http://www.w3.org/2000/svg","g"),this._r.classList.add("datas"),i.appendChild(this._r),this._path=document.createElementNS("http://www.w3.org/2000/svg","g"),this._path.classList.add("ts-render-path"),this._svg.insertBefore(this._path,this._svg.firstChild),this._p=[],this._pad=10,this._clip_pad=-1/0,this._cp_threshold=0,this._hide_points_number=1e4,this._use_canvas_number=1e5,this._observe_target=null,this._observer=new MutationObserver(r=>{this._observe_target&&this._p.forEach((h,a)=>h.title=this.datas.labels[a])}),this._observer.observe(this._svg,{childList:!0}),this._will_render=!1}get svg(){return this._svg}get padding(){return Array.isArray(this._pad)?this._pad:[this._pad,this._pad]}set padding(e){this._pad=e,this.render()}set clipPadding(e){this._clip_pad=e,this.render()}get points(){return this._p}init(){this._pred_values=[],this._lastpred=[],this._r_tile?.remove(),this._grid.replaceChildren(),this._make_selector()}_make_selector(){let e=this.datas?.columnNames||[],n=this._menu.querySelector("div.column-selector");if(!n&&e.length>0?(n=document.createElement("div"),n.classList.add("column-selector"),this._menu.appendChild(n)):n?.replaceChildren(),e.length<1)this._select=null;else if(e.length<=4){const t=document.createElement("table");t.style.borderCollapse="collapse",n.appendChild(t);let s=t.insertRow();s.style.textAlign="center",s.insertCell(),s.insertCell().innerHTML="&uarr;";const i=[];for(let r=0;r<e.length;r++){s=t.insertRow();const h=s.insertCell();h.innerText=e[r],h.style.textAlign="right";const a=s.insertCell(),o=document.createElement("input");o.type="radio",o.name="data-d1",o.onchange=()=>this._manager.platform.render(),a.appendChild(o),i.push(o)}i[0].checked=!0,this._select=()=>{const r=[];for(let h=0;h<e.length;h++)i[h].checked&&(r[0]=h);return r}}else{e=e.map(i=>`${i}`);const t=document.createElement("span");t.innerHTML="&uarr;",n.appendChild(t);const s=document.createElement("select");s.onchange=()=>this._manager.platform.render();for(const i of e){const r=document.createElement("option");r.value=i,r.innerText=i,s.appendChild(r)}s.value=e[0],n.appendChild(s),this._select=()=>[e.indexOf(s.value)]}}_clip(e){if(this._clip_pad===-1/0)return e;const n=this._size;for(let t=0;t<e.length;t++)e[t]<this._clip_pad?e[t]=this._clip_pad:n[t]-this._clip_pad<e[t]&&(e[t]=n[t]-this._clip_pad);return e}_range(){let e=[],n=0;this.datas.dimension===0?e=this.datas.range.concat():(n=this._select?.()??[Math.min(1,this.datas.dimension-1)],e=this.datas.domain[n[0]].concat());for(let t=0;t<this._pred_values.length;t++)this._pred_values[t][n]<e[0]?e[0]=this._pred_values[t][n]:this._pred_values[t][n]>e[1]&&(e[1]=this._pred_values[t][n]);return e}toPoint(e){if(this.datas.length===0)return[0,0];const n=this._size,t=[],s=this._range();if(this.datas.dimension===0)t.push(p(e[0],0,this.datas.length+this._pred_values.length,0,n[0]-this.padding[0]*2)+this.padding[0],p(e[1][0],s[0],s[1],0,n[1]-this.padding[1]*2)+this.padding[1]);else{const i=this._select?.()??(this.datas.dimension===0?null:[Math.min(1,this.datas.dimension-1)]),r=Math.min(i[0],e[1].length-1);t.push(p(e[0],0,this.datas.length+this._pred_values.length,0,n[0]-this.padding[0]*2)+this.padding[0],p(e[1][r],s[0],s[1],0,n[1]-this.padding[1]*2)+this.padding[1])}return t.map(i=>Number.isNaN(i)?0:i)}toValue(e){return e&&this.datas?[p(e[0]-this.padding[0],0,this._size[0]-this.padding[0]*2,0,this.datas.length)]:[]}_render(){if(this._path.replaceChildren(),!this.datas||this.datas.length===0){this._p.map(d=>d.remove()),this._p.length=0;return}const e=this._select?.()??(this.datas.dimension===0?null:[Math.min(1,this.datas.dimension-1)]),n=this.datas.length,t=this.datas.x,s=this.datas.y,i=this._size,r=this._range(),h=[];for(let d=0;d<n;d++)this.datas.dimension===0?h.push([p(d,0,n+this._pred_values.length,0,i[0]-this.padding[0]*2)+this.padding[0],p(s[d],r[0],r[1],0,i[1]-this.padding[1]*2)+this.padding[1]]):h.push([p(d,0,n+this._pred_values.length,0,i[0]-this.padding[0]*2)+this.padding[0],p(t[d][e[0]],r[0],r[1],0,i[1]-this.padding[1]*2)+this.padding[1]]);if(n<this._hide_points_number){const d=Math.max(1,Math.min(5,Math.floor(2e3/n)));for(let l=0;l<n;l++){const c=this._clip(h[l]),u=this.datas.dimension<=1?0:this.datas.y[l];if(this._p[l]){const m=this._p[l].at;(m[0]!==c[0]||m[1]!==c[1])&&(this._p[l].at=c),this._p[l].category!==u&&(this._p[l].category=u)}else this._p[l]=new v(this._r,c,u);this._p[l].title=this.datas.labels[l],this._p[l].radius=d}for(let l=n;l<this._p.length;l++)this._p[l].remove();this._p.length=n}else this._p.forEach(d=>d.remove()),this._p.length=0;const a=h.map(d=>this._clip(d)),o=this._renderPath(a);o.setAttribute("opacity",.5),this._path.appendChild(o),this._lastpred&&this.testResult(this._lastpred),this._renderGrid()}_renderPath(e,n="black"){if(e.length<this._use_canvas_number){const t=document.createElementNS("http://www.w3.org/2000/svg","path");return t.setAttribute("stroke",n),t.setAttribute("fill-opacity",0),t.setAttribute("d",w(e)),t.style.pointerEvents="none",t}else{const t=document.createElement("canvas");t.width=this._size[0],t.height=this._size[1];const s=t.getContext("2d");s.strokeStyle=n,s.beginPath(),s.moveTo(...e[0]);for(let r=1;r<e.length;r++)s.lineTo(...e[r]),r%1e5===0&&(s.stroke(),s.beginPath(),s.moveTo(...e[r]));s.stroke();const i=document.createElementNS("http://www.w3.org/2000/svg","image");return i.setAttribute("x",0),i.setAttribute("y",0),i.setAttribute("width",t.width),i.setAttribute("height",t.height),i.setAttributeNS("http://www.w3.org/1999/xlink","xlink:href",t.toDataURL()),i}}_renderGrid(){this._grid.replaceChildren();const e=this._size,[n,t]=this._range(),s=this._getScales(n,t);for(const i of s){const r=p(+i,n,t,0,e[1]-this.padding[1]*2)+this.padding[1],h=document.createElementNS("http://www.w3.org/2000/svg","line");h.setAttribute("x1",0),h.setAttribute("x2",e[0]),h.setAttribute("y1",r),h.setAttribute("y2",r),h.setAttribute("stroke","gray");const a=document.createElementNS("http://www.w3.org/2000/svg","text");a.setAttribute("x",0),a.setAttribute("y",e[1]-r),a.setAttribute("fill","gray"),a.style.transform="scale(1, -1) translate(0, -100%)",a.innerHTML=i,this._grid.append(h,a)}}_getScales(e,n){const t=n-e;if(t===0)return[];let s=Math.floor(Math.log10(t)),i=10**s;t/i<2?(i/=2,s--):t/i>5&&(i*=2);const r=n-n%i,h=[];for(let a=r;a>=e;a-=i)h.push(s<0?a.toFixed(-s):a);return h}testResult(e){const n=this._manager.platform.task;if(this._lastpred=e,this._svg.querySelectorAll("g.tile-render").length===0){const t=document.createElementNS("http://www.w3.org/2000/svg","g");t.classList.add("tile-render"),n==="CP"?this._svg.insertBefore(t,this._svg.firstChild):this._svg.appendChild(t)}if(this._r_tile=this._svg.querySelector("g.tile-render"),this._r_tile.replaceChildren(),this._pred_values=[],this._cp_pred_value=null,n==="TP"){this._pred_values=this._manager.platform.invertScale(e);const t=document.createElementNS("http://www.w3.org/2000/svg","path");t.setAttribute("stroke","red"),t.setAttribute("fill-opacity",0),t.style.pointerEvents="none",this._r_tile.appendChild(t),this._pred_points?.forEach(r=>r.remove()),this._pred_points=[];const s=this.datas,i=[];s.length>0&&i.push(this.toPoint([s.length-1,s.dimension>0?s.x[s.length-1]:[s.y[s.length-1]]]));for(let r=0;r<e.length;r++){const h=this.toPoint([r+s.length,this._pred_values[r]]),a=new v(this._r_tile,h,f.dummy);i.push(h),this._pred_points.push(a)}i.length===0?t.setAttribute("opacity",0):(t.setAttribute("d",w(i)),t.setAttribute("opacity",.5))}else if(n==="SM"){const t=[];for(let s=0;s<e.length;s++){const i=this.toPoint([s,this._manager.platform.invertScale(e[s])]);t.push(i)}if(t.length>0){const s=this._renderPath(t,"red");this._r_tile.appendChild(s)}}else if(n==="CP"){if(typeof e[0]=="number"?(this._cp_pred_value=e.concat(),e=e.map(t=>t>this._cp_threshold)):e=e.concat(),this._cp_pred_value){let t=Math.max(...this._cp_pred_value);const s=Math.min(...this._cp_pred_value);t===s&&(t+=1);const i=document.createElement("canvas");i.width=this._size[0],i.height=this._size[1];const r=i.getContext("2d");let h=0;for(let o=0;o<this._cp_pred_value.length;o++){const d=this.toPoint([o+.5,[0]])[0],l=(this._cp_pred_value[o]-s)/(t-s);r.fillStyle=y(f.errorRate(l)),r.fillRect(h,0,d-h+1,this._size[1]),h=d}const a=document.createElementNS("http://www.w3.org/2000/svg","image");a.setAttribute("x",0),a.setAttribute("y",0),a.setAttribute("width",i.width),a.setAttribute("height",i.height),a.setAttributeNS("http://www.w3.org/1999/xlink","xlink:href",i.toDataURL()),a.setAttribute("opacity",.3),this._r_tile.appendChild(a)}for(let t=0;t<e.length;t++){if(!e[t])continue;const s=this.toPoint([t,[0]])[0],i=document.createElementNS("http://www.w3.org/2000/svg","line");i.setAttribute("x1",s),i.setAttribute("x2",s),i.setAttribute("y1",0),i.setAttribute("y2",this._size[1]),i.setAttribute("stroke","red"),this._r_tile.appendChild(i)}}}resetPredicts(){this._pred_values=[],this._lastpred=[],this._r_tile?.replaceChildren(),this.render()}updateThreshold(e){this._cp_pred_value&&(this._cp_threshold=e,this.testResult(this._cp_pred_value))}terminate(){this._observer.disconnect(),this.setting.render.removeItem("line"),super.terminate()}}
