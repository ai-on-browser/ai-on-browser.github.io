import BaseRenderer from"./base.js";import{specialCategory,getCategoryColor}from"../utils.js";import{DataPoint}from"./util/figure.js";const scale=function(t,e,s,i,h){return isFinite(e)&&isFinite(s)&&e!==s?(t-e)/(s-e)*(h-i)+i:(h+i)/2},line=t=>{let e="";for(let s=0;s<t.length;s++)e+=`${0===s?"M":"L"}${t[s][0]},${t[s][1]}`;return e};export default class LineRenderer extends BaseRenderer{constructor(t){super(t),this._size=[960,500],this._pred_values=[];const e=this.setting.render.addItem("line"),s=document.createElement("div");s.id="plot-area",e.appendChild(s),this._menu=document.createElement("div"),s.appendChild(this._menu);const i=document.createElementNS("http://www.w3.org/2000/svg","svg");s.appendChild(i),i.style.border="1px solid #000000",i.setAttribute("width",`${this._size[0]}px`),i.setAttribute("height",`${this._size[1]}px`),this._svg=document.createElementNS("http://www.w3.org/2000/svg","g"),this._svg.style.transform="scale(1, -1) translate(0, -100%)",i.appendChild(this._svg),this._grid=document.createElementNS("http://www.w3.org/2000/svg","g"),this._grid.setAttribute("opacity",.3),this._svg.appendChild(this._grid);const h=document.createElementNS("http://www.w3.org/2000/svg","g");h.classList.add("points"),this._svg.appendChild(h),this._r=document.createElementNS("http://www.w3.org/2000/svg","g"),this._r.classList.add("datas"),h.appendChild(this._r);const r=document.createElementNS("http://www.w3.org/2000/svg","g");r.classList.add("ts-render-path"),this._svg.insertBefore(r,this._svg.firstChild),this._path=document.createElementNS("http://www.w3.org/2000/svg","path"),this._path.setAttribute("stroke","black"),this._path.setAttribute("fill-opacity",0),this._path.style.pointerEvents="none",r.appendChild(this._path),this._p=[],this._pad=10,this._clip_pad=-1/0,this._cp_threshold=0,this._observe_target=null,this._observer=new MutationObserver((t=>{this._observe_target&&this._p.forEach(((t,e)=>t.title=this.datas.labels[e]))})),this._observer.observe(this._svg,{childList:!0}),this._will_render=!1}get svg(){return this._svg}get width(){return this._size[0]}get height(){return this._size[1]}get padding(){return Array.isArray(this._pad)?this._pad:[this._pad,this._pad]}set padding(t){this._pad=t,this.render()}set clipPadding(t){this._clip_pad=t,this.render()}get points(){return this._p}init(){this._pred_values=[],this._lastpred=[],this._r_tile?.remove(),this._grid.replaceChildren(),this._make_selector()}_make_selector(){let t=this.datas?.columnNames||[],e=this._menu.querySelector("div.column-selector");if(!e&&t.length>0?(e=document.createElement("div"),e.classList.add("column-selector"),this._menu.appendChild(e)):e?.replaceChildren(),t.length<1)this._select=null;else if(t.length<=4){const s=document.createElement("table");s.style.borderCollapse="collapse",e.appendChild(s);let i=s.insertRow();i.style.textAlign="center",i.insertCell(),i.insertCell().innerHTML="&uarr;";const h=[];for(let e=0;e<t.length;e++){i=s.insertRow();const r=i.insertCell();r.innerText=t[e],r.style.textAlign="right";const n=i.insertCell(),a=document.createElement("input");a.type="radio",a.name="data-d1",a.onchange=()=>this._manager.platform.render(),n.appendChild(a),h.push(a)}h[0].checked=!0,this._select=()=>{const e=[];for(let s=0;s<t.length;s++)h[s].checked&&(e[0]=s);return e}}else{t=t.map((t=>""+t));const s=document.createElement("span");s.innerHTML="&uarr;",e.appendChild(s);const i=document.createElement("select");i.onchange=()=>this._manager.platform.render();for(const e of t){const t=document.createElement("option");t.value=e,t.innerText=e,i.appendChild(t)}i.value=t[0],e.appendChild(i),this._select=()=>[t.indexOf(i.value)]}}_clip(t){if(this._clip_pad===-1/0)return t;const e=[this.width,this.height];for(let s=0;s<t.length;s++)t[s]<this._clip_pad?t[s]=this._clip_pad:e[s]-this._clip_pad<t[s]&&(t[s]=e[s]-this._clip_pad);return t}_range(){let t=[],e=0;0===this.datas.dimension?t=this.datas.range.concat():(e=this._select?.()??[Math.min(1,this.datas.dimension-1)],t=this.datas.domain[e[0]].concat());for(let s=0;s<this._pred_values.length;s++)this._pred_values[s][e]<t[0]?t[0]=this._pred_values[s][e]:this._pred_values[s][e]>t[1]&&(t[1]=this._pred_values[s][e]);return t}toPoint(t){if(0===this.datas.length)return[0,0];const e=[this.width,this.height],s=[],i=this._range();if(0===this.datas.dimension)s.push(scale(t[0],0,this.datas.length+this._pred_values.length,0,e[0]-2*this.padding[0])+this.padding[0],scale(t[1][0],i[0],i[1],0,e[1]-2*this.padding[1])+this.padding[1]);else{const h=this._select?.()??(0===this.datas.dimension?null:[Math.min(1,this.datas.dimension-1)]),r=Math.min(h[0],t[1].length-1);s.push(scale(t[0],0,this.datas.length+this._pred_values.length,0,e[0]-2*this.padding[0])+this.padding[0],scale(t[1][r],i[0],i[1],0,e[1]-2*this.padding[1])+this.padding[1])}return s.map((t=>isNaN(t)?0:t))}toValue(t){return t&&this.datas?[scale(t[0]-this.padding[0],0,this.width-2*this.padding[0],0,this.datas.length)]:[]}_render(){if(!this.datas||0===this.datas.length)return this._p.map((t=>t.remove())),this._p.length=0,void this._path.setAttribute("opacity",0);const t=this._select?.()??(0===this.datas.dimension?null:[Math.min(1,this.datas.dimension-1)]),e=this.datas.length,s=this.datas.x,i=this.datas.y,h=this._size,r=this._range(),n=[];for(let a=0;a<e;a++)0===this.datas.dimension?n.push([scale(a,0,e+this._pred_values.length,0,h[0]-2*this.padding[0])+this.padding[0],scale(i[a],r[0],r[1],0,h[1]-2*this.padding[1])+this.padding[1]]):n.push([scale(a,0,e+this._pred_values.length,0,h[0]-2*this.padding[0])+this.padding[0],scale(s[a][t[0]],r[0],r[1],0,h[1]-2*this.padding[1])+this.padding[1]]);const a=Math.max(1,Math.min(5,Math.floor(2e3/e)));for(let t=0;t<e;t++){const e=this._clip(n[t]),s=this.datas.dimension<=1?0:this.datas.y[t];if(this._p[t]){const i=this._p[t].at;i[0]===e[0]&&i[1]===e[1]||(this._p[t].at=e),this._p[t].category!==s&&(this._p[t].category=s)}else this._p[t]=new DataPoint(this._r,e,s);this._p[t].title=this.datas.labels[t],this._p[t].radius=a}for(let t=e;t<this._p.length;t++)this._p[t].remove();this._p.length=e,this._path.setAttribute("d",line(this.points.map((t=>t.at)))),this._path.setAttribute("opacity",.5),this._lastpred&&this.testResult(this._lastpred),this._renderGrid()}_renderGrid(){this._grid.replaceChildren();const t=this._size,[e,s]=this._range(),i=this._getScales(e,s);for(const h of i){const i=scale(+h,e,s,0,t[1]-2*this.padding[1])+this.padding[1],r=document.createElementNS("http://www.w3.org/2000/svg","line");r.setAttribute("x1",0),r.setAttribute("x2",t[0]),r.setAttribute("y1",i),r.setAttribute("y2",i),r.setAttribute("stroke","gray");const n=document.createElementNS("http://www.w3.org/2000/svg","text");n.setAttribute("x",0),n.setAttribute("y",t[1]-i),n.setAttribute("fill","gray"),n.style.transform="scale(1, -1) translate(0, -100%)",n.innerHTML=h,this._grid.append(r,n)}}_getScales(t,e){const s=e-t;if(0===s)return[];let i=Math.floor(Math.log10(s)),h=10**i;s/h<2?(h/=2,i--):s/h>5&&(h*=2);const r=[];for(let s=e-e%h;s>=t;s-=h)r.push(i<0?s.toFixed(-i):s);return r}testResult(t){const e=this._manager.platform.task;if(this._lastpred=t,0===this._svg.querySelectorAll("g.tile-render").length){const t=document.createElementNS("http://www.w3.org/2000/svg","g");t.classList.add("tile-render"),"CP"===e?this._svg.insertBefore(t,this._svg.firstChild):this._svg.appendChild(t)}if(this._r_tile=this._svg.querySelector("g.tile-render"),this._r_tile.replaceChildren(),this._pred_values=[],this._cp_pred_value=null,"TP"===e){this._pred_values=t;const e=document.createElementNS("http://www.w3.org/2000/svg","path");e.setAttribute("stroke","red"),e.setAttribute("fill-opacity",0),e.style.pointerEvents="none",this._r_tile.appendChild(e),this._pred_points?.forEach((t=>t.remove())),this._pred_points=[];const s=this.datas,i=[];s.length>0&&i.push(this.toPoint([s.length-1,s.x[s.length-1]||[s.y[s.length-1]]]));for(let e=0;e<t.length;e++){const h=this.toPoint([e+s.length,t[e]]),r=new DataPoint(this._r_tile,h,specialCategory.dummy);i.push(h),this._pred_points.push(r)}0===i.length?e.setAttribute("opacity",0):(e.setAttribute("d",line(i)),e.setAttribute("opacity",.5))}else if("SM"===e){const e=document.createElementNS("http://www.w3.org/2000/svg","path");e.setAttribute("stroke","red"),e.setAttribute("fill-opacity",0),e.style.pointerEvents="none",this._r_tile.appendChild(e);const s=[];for(let e=0;e<t.length;e++){const i=this.toPoint([e,t[e]]);s.push(i)}0===s.length?e.setAttribute("opacity",0):(e.setAttribute("d",line(s)),e.setAttribute("opacity",1))}else if("CP"===e){if("number"==typeof t[0]?(this._cp_pred_value=t.concat(),t=t.map((t=>t>this._cp_threshold))):t=t.concat(),this._cp_pred_value){let t=Math.max(...this._cp_pred_value);const e=Math.min(...this._cp_pred_value);t===e&&(t+=1);const s=document.createElement("canvas");s.width=this.width,s.height=this.height;const i=s.getContext("2d");let h=0;for(let s=0;s<this._cp_pred_value.length;s++){const r=this.toPoint([s+.5,[0]])[0],n=(this._cp_pred_value[s]-e)/(t-e);i.fillStyle=getCategoryColor(specialCategory.errorRate(n)),i.fillRect(h,0,r-h+1,this.height),h=r}const r=document.createElementNS("http://www.w3.org/2000/svg","image");r.setAttribute("x",0),r.setAttribute("y",0),r.setAttribute("width",s.width),r.setAttribute("height",s.height),r.setAttributeNS("http://www.w3.org/1999/xlink","xlink:href",s.toDataURL()),r.setAttribute("opacity",.3),this._r_tile.appendChild(r)}for(let e=0;e<t.length;e++){if(!t[e])continue;const s=this.toPoint([e,[0]])[0],i=document.createElementNS("http://www.w3.org/2000/svg","line");i.setAttribute("x1",s),i.setAttribute("x2",s),i.setAttribute("y1",0),i.setAttribute("y2",this.height),i.setAttribute("stroke","red"),this._r_tile.appendChild(i)}}}resetPredicts(){this._pred_values=[],this._lastpred=[],this._r_tile?.replaceChildren(),this.render()}updateThreshold(t){this._cp_pred_value&&(this._cp_threshold=t,this.testResult(this._cp_pred_value))}terminate(){this._observer.disconnect(),this.setting.render.removeItem("line"),super.terminate()}}