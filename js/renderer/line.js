var w=Object.defineProperty;var _=(o,t)=>w(o,"name",{value:t,configurable:!0});import v from"./base.js";import{specialCategory as m,getCategoryColor as b}from"../utils.js";import{DataPoint as f}from"./util/figure.js";const d=_(function(o,t,i,e,n){return!isFinite(t)||!isFinite(i)||t===i?(n+e)/2:(o-t)/(i-t)*(n-e)+e},"scale"),g=_(o=>{let t="";for(let i=0;i<o.length;i++)t+=`${i===0?"M":"L"}${o[i][0]},${o[i][1]}`;return t},"line");export default class y extends v{static{_(this,"LineRenderer")}constructor(t){super(t),this._size=[960,500],this._pred_values=[];const i=this.setting.render.addItem("line"),e=document.createElement("div");e.id="plot-area",i.appendChild(e),this._menu=document.createElement("div"),e.appendChild(this._menu);const n=document.createElementNS("http://www.w3.org/2000/svg","svg");e.appendChild(n),n.style.border="1px solid #000000",n.setAttribute("width",`${this._size[0]}px`),n.setAttribute("height",`${this._size[1]}px`),this._svg=document.createElementNS("http://www.w3.org/2000/svg","g"),this._svg.style.transform="scale(1, -1) translate(0, -100%)",n.appendChild(this._svg),this._grid=document.createElementNS("http://www.w3.org/2000/svg","g"),this._grid.setAttribute("opacity",.3),this._svg.appendChild(this._grid);const s=document.createElementNS("http://www.w3.org/2000/svg","g");s.classList.add("points"),this._svg.appendChild(s),this._r=document.createElementNS("http://www.w3.org/2000/svg","g"),this._r.classList.add("datas"),s.appendChild(this._r);const r=document.createElementNS("http://www.w3.org/2000/svg","g");r.classList.add("ts-render-path"),this._svg.insertBefore(r,this._svg.firstChild),this._path=document.createElementNS("http://www.w3.org/2000/svg","path"),this._path.setAttribute("stroke","black"),this._path.setAttribute("fill-opacity",0),this._path.style.pointerEvents="none",r.appendChild(this._path),this._p=[],this._pad=10,this._clip_pad=-1/0,this._cp_threshold=0,this._observe_target=null,this._observer=new MutationObserver(a=>{this._observe_target&&this._p.forEach((l,h)=>l.title=this.datas.labels[h])}),this._observer.observe(this._svg,{childList:!0}),this._will_render=!1}get svg(){return this._svg}get width(){return this._size[0]}get height(){return this._size[1]}get padding(){return Array.isArray(this._pad)?this._pad:[this._pad,this._pad]}set padding(t){this._pad=t,this.render()}set clipPadding(t){this._clip_pad=t,this.render()}get points(){return this._p}init(){this._pred_values=[],this._lastpred=[],this._r_tile?.remove(),this._grid.replaceChildren(),this._make_selector()}_make_selector(){let t=this.datas?.columnNames||[],i=this._menu.querySelector("div.column-selector");if(!i&&t.length>0?(i=document.createElement("div"),i.classList.add("column-selector"),this._menu.appendChild(i)):i?.replaceChildren(),t.length<1)this._select=null;else if(t.length<=4){const e=document.createElement("table");e.style.borderCollapse="collapse",i.appendChild(e);let n=e.insertRow();n.style.textAlign="center",n.insertCell(),n.insertCell().innerHTML="&uarr;";const s=[];for(let r=0;r<t.length;r++){n=e.insertRow();const a=n.insertCell();a.innerText=t[r],a.style.textAlign="right";const l=n.insertCell(),h=document.createElement("input");h.type="radio",h.name="data-d1",h.onchange=()=>this._manager.platform.render(),l.appendChild(h),s.push(h)}s[0].checked=!0,this._select=()=>{const r=[];for(let a=0;a<t.length;a++)s[a].checked&&(r[0]=a);return r}}else{t=t.map(s=>""+s);const e=document.createElement("span");e.innerHTML="&uarr;",i.appendChild(e);const n=document.createElement("select");n.onchange=()=>this._manager.platform.render();for(const s of t){const r=document.createElement("option");r.value=s,r.innerText=s,n.appendChild(r)}n.value=t[0],i.appendChild(n),this._select=()=>[t.indexOf(n.value)]}}_clip(t){if(this._clip_pad===-1/0)return t;const i=[this.width,this.height];for(let e=0;e<t.length;e++)t[e]<this._clip_pad?t[e]=this._clip_pad:i[e]-this._clip_pad<t[e]&&(t[e]=i[e]-this._clip_pad);return t}_range(){let t=[],i=0;this.datas.dimension===0?t=this.datas.range.concat():(i=this._select?.()??[Math.min(1,this.datas.dimension-1)],t=this.datas.domain[i[0]].concat());for(let e=0;e<this._pred_values.length;e++)this._pred_values[e][i]<t[0]?t[0]=this._pred_values[e][i]:this._pred_values[e][i]>t[1]&&(t[1]=this._pred_values[e][i]);return t}toPoint(t){if(this.datas.length===0)return[0,0];const i=[this.width,this.height],e=[],n=this._range();if(this.datas.dimension===0)e.push(d(t[0],0,this.datas.length+this._pred_values.length,0,i[0]-this.padding[0]*2)+this.padding[0],d(t[1][0],n[0],n[1],0,i[1]-this.padding[1]*2)+this.padding[1]);else{const s=this._select?.()??(this.datas.dimension===0?null:[Math.min(1,this.datas.dimension-1)]),r=Math.min(s[0],t[1].length-1);e.push(d(t[0],0,this.datas.length+this._pred_values.length,0,i[0]-this.padding[0]*2)+this.padding[0],d(t[1][r],n[0],n[1],0,i[1]-this.padding[1]*2)+this.padding[1])}return e.map(s=>isNaN(s)?0:s)}toValue(t){return t&&this.datas?[d(t[0]-this.padding[0],0,this.width-this.padding[0]*2,0,this.datas.length)]:[]}_render(){if(!this.datas||this.datas.length===0){this._p.map(h=>h.remove()),this._p.length=0,this._path.setAttribute("opacity",0);return}const t=this._select?.()??(this.datas.dimension===0?null:[Math.min(1,this.datas.dimension-1)]),i=this.datas.length,e=this.datas.x,n=this.datas.y,s=this._size,r=this._range(),a=[];for(let h=0;h<i;h++)this.datas.dimension===0?a.push([d(h,0,i+this._pred_values.length,0,s[0]-this.padding[0]*2)+this.padding[0],d(n[h],r[0],r[1],0,s[1]-this.padding[1]*2)+this.padding[1]]):a.push([d(h,0,i+this._pred_values.length,0,s[0]-this.padding[0]*2)+this.padding[0],d(e[h][t[0]],r[0],r[1],0,s[1]-this.padding[1]*2)+this.padding[1]]);const l=Math.max(1,Math.min(5,Math.floor(2e3/i)));for(let h=0;h<i;h++){const p=this._clip(a[h]),c=this.datas.dimension<=1?0:this.datas.y[h];if(this._p[h]){const u=this._p[h].at;(u[0]!==p[0]||u[1]!==p[1])&&(this._p[h].at=p),this._p[h].category!==c&&(this._p[h].category=c)}else this._p[h]=new f(this._r,p,c);this._p[h].title=this.datas.labels[h],this._p[h].radius=l}for(let h=i;h<this._p.length;h++)this._p[h].remove();this._p.length=i,this._path.setAttribute("d",g(this.points.map(h=>h.at))),this._path.setAttribute("opacity",.5),this._lastpred&&this.testResult(this._lastpred),this._renderGrid()}_renderGrid(){this._grid.replaceChildren();const t=this._size,[i,e]=this._range(),n=this._getScales(i,e);for(const s of n){const r=d(+s,i,e,0,t[1]-this.padding[1]*2)+this.padding[1],a=document.createElementNS("http://www.w3.org/2000/svg","line");a.setAttribute("x1",0),a.setAttribute("x2",t[0]),a.setAttribute("y1",r),a.setAttribute("y2",r),a.setAttribute("stroke","gray");const l=document.createElementNS("http://www.w3.org/2000/svg","text");l.setAttribute("x",0),l.setAttribute("y",t[1]-r),l.setAttribute("fill","gray"),l.style.transform="scale(1, -1) translate(0, -100%)",l.innerHTML=s,this._grid.append(a,l)}}_getScales(t,i){const e=i-t;if(e===0)return[];let n=Math.floor(Math.log10(e)),s=10**n;e/s<2?(s/=2,n--):e/s>5&&(s*=2);const r=i-i%s,a=[];for(let l=r;l>=t;l-=s)a.push(n<0?l.toFixed(-n):l);return a}testResult(t){const i=this._manager.platform.task;if(this._lastpred=t,this._svg.querySelectorAll("g.tile-render").length===0){const e=document.createElementNS("http://www.w3.org/2000/svg","g");e.classList.add("tile-render"),i==="CP"?this._svg.insertBefore(e,this._svg.firstChild):this._svg.appendChild(e)}if(this._r_tile=this._svg.querySelector("g.tile-render"),this._r_tile.replaceChildren(),this._pred_values=[],this._cp_pred_value=null,i==="TP"){this._pred_values=t;const e=document.createElementNS("http://www.w3.org/2000/svg","path");e.setAttribute("stroke","red"),e.setAttribute("fill-opacity",0),e.style.pointerEvents="none",this._r_tile.appendChild(e),this._pred_points?.forEach(r=>r.remove()),this._pred_points=[];const n=this.datas,s=[];n.length>0&&s.push(this.toPoint([n.length-1,n.x[n.length-1]||[n.y[n.length-1]]]));for(let r=0;r<t.length;r++){const a=this.toPoint([r+n.length,t[r]]),l=new f(this._r_tile,a,m.dummy);s.push(a),this._pred_points.push(l)}s.length===0?e.setAttribute("opacity",0):(e.setAttribute("d",g(s)),e.setAttribute("opacity",.5))}else if(i==="SM"){const e=document.createElementNS("http://www.w3.org/2000/svg","path");e.setAttribute("stroke","red"),e.setAttribute("fill-opacity",0),e.style.pointerEvents="none",this._r_tile.appendChild(e);const n=[];for(let s=0;s<t.length;s++){const r=this.toPoint([s,t[s]]);n.push(r)}n.length===0?e.setAttribute("opacity",0):(e.setAttribute("d",g(n)),e.setAttribute("opacity",1))}else if(i==="CP"){if(typeof t[0]=="number"?(this._cp_pred_value=t.concat(),t=t.map(e=>e>this._cp_threshold)):t=t.concat(),this._cp_pred_value){let e=Math.max(...this._cp_pred_value);const n=Math.min(...this._cp_pred_value);e===n&&(e+=1);const s=document.createElement("canvas");s.width=this.width,s.height=this.height;const r=s.getContext("2d");let a=0;for(let h=0;h<this._cp_pred_value.length;h++){const p=this.toPoint([h+.5,[0]])[0],c=(this._cp_pred_value[h]-n)/(e-n);r.fillStyle=b(m.errorRate(c)),r.fillRect(a,0,p-a+1,this.height),a=p}const l=document.createElementNS("http://www.w3.org/2000/svg","image");l.setAttribute("x",0),l.setAttribute("y",0),l.setAttribute("width",s.width),l.setAttribute("height",s.height),l.setAttributeNS("http://www.w3.org/1999/xlink","xlink:href",s.toDataURL()),l.setAttribute("opacity",.3),this._r_tile.appendChild(l)}for(let e=0;e<t.length;e++){if(!t[e])continue;const n=this.toPoint([e,[0]])[0],s=document.createElementNS("http://www.w3.org/2000/svg","line");s.setAttribute("x1",n),s.setAttribute("x2",n),s.setAttribute("y1",0),s.setAttribute("y2",this.height),s.setAttribute("stroke","red"),this._r_tile.appendChild(s)}}}resetPredicts(){this._pred_values=[],this._lastpred=[],this._r_tile?.replaceChildren(),this.render()}updateThreshold(t){this._cp_pred_value&&(this._cp_threshold=t,this.testResult(this._cp_pred_value))}terminate(){this._observer.disconnect(),this.setting.render.removeItem("line"),super.terminate()}}
