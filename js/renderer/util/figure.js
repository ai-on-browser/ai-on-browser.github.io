var P=Object.defineProperty;var d=(p,t)=>P(p,"name",{value:t,configurable:!0});import{getCategoryColor as M,specialCategory as S}from"../../utils.js";class z{static{d(this,"DataPointCirclePlotter")}constructor(t,e){this._svg=t,this.item=e,e||(this.item=document.createElementNS("http://www.w3.org/2000/svg","circle"),this._svg.append(this.item))}attr(t,e){return e!==void 0?(this.item.setAttribute(t,e),this):this.item.getAttribute(t)}cx(t){return this.attr("cx",t)}cy(t){return this.attr("cy",t)}color(t){return this.attr("fill",t)}radius(t){return this.attr("r",t)}title(t){if(this.item.replaceChildren(),t&&t!==""){const e=document.createElementNS("http://www.w3.org/2000/svg","title");this.item.append(e),e.replaceChildren(t)}return this}remove(){return this.item.remove()}}export class DataPointStarPlotter{static{d(this,"DataPointStarPlotter")}constructor(t,e,i){this._svg=t,this._c=[0,0],this._r=5,e?(this.g=e,this.polygon=i):(this.g=document.createElementNS("http://www.w3.org/2000/svg","g"),this._svg.append(this.g),this.polygon=document.createElementNS("http://www.w3.org/2000/svg","polygon"),this.g.append(this.polygon),this.polygon.setAttribute("points",this._path()),this.polygon.setAttribute("stroke","black"))}_path(){return[[-Math.sin(Math.PI*2/5),-Math.cos(Math.PI*2/5)],[-Math.sin(Math.PI/5)/2,-Math.cos(Math.PI/5)/2],[0,-1],[Math.sin(Math.PI/5)/2,-Math.cos(Math.PI/5)/2],[Math.sin(Math.PI*2/5),-Math.cos(Math.PI*2/5)],[Math.sin(Math.PI*3/5)/2,-Math.cos(Math.PI*3/5)/2],[Math.sin(Math.PI*4/5),-Math.cos(Math.PI*4/5)],[0,1/2],[-Math.sin(Math.PI*4/5),-Math.cos(Math.PI*4/5)],[-Math.sin(Math.PI*3/5)/2,-Math.cos(Math.PI*3/5)/2]].reduce((t,e)=>t+e[0]*this._r+","+e[1]*this._r+" ","")}cx(t){return this._c[0]=t||this._c[0],t!==void 0?(this.g.setAttribute("transform","translate("+this._c[0]+", "+this._c[1]+")"),this):this._c[0]}cy(t){return this._c[1]=t||this._c[1],t!==void 0?(this.g.setAttribute("transform","translate("+this._c[0]+", "+this._c[1]+")"),this):this._c[1]}color(t){return t!==void 0?(this.polygon.setAttribute("fill",t),this):this.polygon.getAttribute("fill")}radius(t){return this._r=t||this._r,t!==void 0?(this.polygon.setAttribute("points",this._path()),this):this._r}title(t){if(this.polygon.replaceChildren(),t&&t!==""){const e=document.createElementNS("http://www.w3.org/2000/svg","title");this.polygon.append(e),e.replaceChildren(t)}return this}duration(t){return this.g.style.transitionDuration=t+"ms",this.g.style.transitionTimingFunction="linear",this.polygon.style.transitionDuration=t+"ms",this.polygon.style.transitionTimingFunction="linear",this}remove(){return this.g.remove()}}class y{static{d(this,"DataVector")}constructor(t){this.value=t instanceof y?t.value:t}get length(){return Math.sqrt(this.value.reduce((t,e)=>t+e*e,0))}map(t){return new y(this.value.map(t))}reduce(t,e){return this.value.reduce(t,e)}add(t){return this.map((e,i)=>e+t.value[i])}sub(t){return this.map((e,i)=>e-t.value[i])}mult(t){return this.map(e=>e*t)}div(t){return this.map(e=>e/t)}dot(t){return this.value.reduce((e,i,s)=>e+i*t.value[s],0)}distance(t){return Math.sqrt(this.value.reduce((e,i,s)=>e+(i-t.value[s])**2,0))}angleCos(t){return this.dot(t)/(this.length*t.length)}equals(t){return this.value.every((e,i)=>e===t.value[i])}}export class DataPoint{static{d(this,"DataPoint")}constructor(t,e=[0,0],i=0){this.svg=t,this.vector=new y(e),this._color=M(i),this._category=i,this._radius=5,this._plotter=new z(this.svg),this._binds=[],this.display()}display(){this._plotter.cx(""+this.vector.value[0]).cy(""+this.vector.value[1]).radius(this._radius).color(this._color),this._binds.forEach(t=>t.display())}get item(){return this._plotter.item}get at(){return this.vector.value}set at(t){this.vector=new y(t),this.display()}get color(){return this._color}get category(){return this._category}set category(t){this._category=t,this._color=M(t),this.display()}get radius(){return this._radius}set radius(t){this._radius=t,this.display()}set title(t){this._plotter.title(t)}plotter(t){this._plotter.remove(),this._plotter=new t(this.svg),this.display()}remove(){this._plotter.remove(),this._binds.forEach(t=>t.remove())}move(t,e=1e3){this.vector=new y(t),this._plotter.duration(e).cx(this.vector.value[0]).cy(this.vector.value[1]),this._binds.forEach(i=>i.move(e))}distance(t){return this.vector.distance(t.vector)}bind(t){this._binds.push(t)}removeBind(t){this._binds=this._binds.filter(e=>e!==t)}static sum(t){return t.length===0?[]:t.slice(1).reduce((e,i)=>e.add(i.vector),t[0].vector)}static mean(t){return t.length===0?[]:DataPoint.sum(t).div(t.length)}}export class DataCircle{static{d(this,"DataCircle")}constructor(t,e){this._svg=t,this.item=document.createElementNS("http://www.w3.org/2000/svg","circle"),this._svg.append(this.item),this.item.setAttribute("fill-opacity",0),this._at=e,this._color=null,this._width=4,e.bind(this),this.display()}get color(){return this._color||this._at.color}set color(t){this._color=t,this.display()}set title(t){if(this.item.replaceChildren(),t&&t.length>0){const e=document.createElementNS("http://www.w3.org/2000/svg","title");this.item.append(e),e.replaceChildren(t)}}display(){this.item.setAttribute("cx",this._at.at[0]),this.item.setAttribute("cy",this._at.at[1]),this.item.setAttribute("stroke",this.color),this.item.setAttribute("stroke-width",this._width),this.item.setAttribute("r",this._at._radius)}remove(){this.item.remove(),this._at.removeBind(this)}}export class DataLine{static{d(this,"DataLine")}constructor(t,e,i){this._svg=t,this.item=document.createElementNS("http://www.w3.org/2000/svg","line"),this._svg.append(this.item),this._from=e,this._to=i,this._remove_listener=null,e&&e.bind(this),i&&i.bind(this),this.display()}set from(t){this._from&&this._from.removeBind(this),this._from=t,this._from.bind(this)}set to(t){this._to&&this._to.removeBind(this),this._to=t,this._to.bind(this)}display(){!this._from||!this._to||(this.item.setAttribute("x1",this._from.at[0]),this.item.setAttribute("y1",this._from.at[1]),this.item.setAttribute("x2",this._to.at[0]),this.item.setAttribute("y2",this._to.at[1]),this.item.setAttribute("stroke",this._from.color))}move(t=1e3){if(!this._from||!this._to)return;if(t===0){this.display();return}const e=+this.item.getAttribute("x1"),i=+this.item.getAttribute("y1"),s=+this.item.getAttribute("x2"),o=+this.item.getAttribute("y2"),c=this._from.at[0]-e,_=this._from.at[1]-i,u=this._to.at[0]-s,m=this._to.at[1]-o;let g=0,n=0;const l=d(w=>{g||(g=w);const f=Math.min(1,(w-g)/t);if(Math.abs(w-n)>15){if(c!==0&&this.item.setAttribute("x1",e+c*f),_!==0&&this.item.setAttribute("y1",i+_*f),u!==0&&this.item.setAttribute("x2",s+u*f),m!==0&&this.item.setAttribute("y2",o+m*f),f>=1)return;n=w}requestAnimationFrame(l)},"step");requestAnimationFrame(l)}remove(){this.item.remove(),this._from&&this._from.removeBind(this),this._from=null,this._to&&this._to.removeBind(this),this._to=null,this._remove_listener&&this._remove_listener(this)}setRemoveListener(t){this._remove_listener=t}}export class DataConvexHull{static{d(this,"DataConvexHull")}constructor(t,e){this._svg=t,this.item=document.createElementNS("http://www.w3.org/2000/svg","polygon"),this._svg.append(this.item),this._points=e,this._color=null,this.display()}get color(){return this._color||this._points[0].color}set color(t){this._color=t,this.display()}_argmin(t,e){return t.length===0?-1:(t=e?t.map(e):t,t.indexOf(Math.min(...t)))}_convexPoints(){if(this._points.length<=3)return this._points;let t=[].concat(this._points),e=this._argmin(t,o=>o.at[1]);const i=t.splice(e,1)[0];t.sort((o,c)=>{let _=o.vector.sub(i.vector),u=c.vector.sub(i.vector);return _.value[0]/_.length-u.value[0]/u.length});let s=[i];for(let o=0;o<t.length;o++){for(;s.length>=3;){let c=s.length;const _=s[c-1].vector.sub(s[c-2].vector).value,u=t[o].vector.sub(s[c-2].vector).value,m=i.vector.sub(s[c-2].vector).value;if((_[0]*m[1]-_[1]*m[0])*(_[0]*u[1]-_[1]*u[0])>0)break;s.pop()}s.push(t[o])}return s}display(){let t=this._convexPoints().reduce((e,i)=>e+i.at[0]+","+i.at[1]+" ","");this.item.setAttribute("points",t),this.item.setAttribute("stroke",this.color),this.item.setAttribute("fill",this.color),this.item.setAttribute("opacity",.5)}remove(){this.item.remove()}}class x{static{d(this,"DataMap")}constructor(){this._data=[],this._size=[0,0]}get rows(){return this._size[0]}get cols(){return this._size[1]}at(t,e){return t<0||!this._data[t]||e<0?void 0:this._data[t][e]}set(t,e,i){this._data[t]||(this._data[t]=[]),this._data[t][e]=i,this._size[0]=Math.max(this._size[0],t+1),this._size[1]=Math.max(this._size[1],e+1)}}export class DataHulls{static{d(this,"DataHulls")}constructor(t,e,i,s=!1,o=null){this._svg=t,this._categories=e,this._tileSize=i,Array.isArray(this._tileSize)||(this._tileSize=[this._tileSize,this._tileSize]),this._use_canvas=s,this._mousemove=o,this.display()}display(){if(this._use_canvas){const i=document.querySelector("#plot-area svg"),s=document.createElement("canvas");s.width=i.getBoundingClientRect().width,s.height=i.getBoundingClientRect().height;let o=s.getContext("2d");for(let u=0;u<this._categories.length;u++)for(let m=0;m<this._categories[u].length;m++)o.fillStyle=M(this._categories[u][m]),o.fillRect(Math.round(m*this._tileSize[0]),Math.round(u*this._tileSize[1]),Math.ceil(this._tileSize[0]),Math.ceil(this._tileSize[1]));let c=this;const _=document.createElementNS("http://www.w3.org/2000/svg","image");this._svg.append(_),_.setAttribute("x",0),_.setAttribute("y",0),_.setAttribute("width",s.width),_.setAttribute("height",s.height),_.setAttributeNS("http://www.w3.org/1999/xlink","xlink:href",s.toDataURL()),_.onmousemove=u=>{const m=d3.pointer(u);this._mousemove&&this._mousemove(c._categories[Math.round(m[1]/c._tileSize)][Math.round(m[0]/c._tileSize)])};return}let t=new x;for(let i=0;i<this._categories.length;i++)for(let s=0;s<this._categories[i].length;s++)this._categories[i][s]===null?t.set(i,s,null):t.set(i,s,Math.round(this._categories[i][s]));const e=[];for(let i=0;i<t.rows;i++)for(let s=0;s<t.cols;s++){if(t.at(i,s)<=S.never)continue;let o=t.at(i,s),c=new x,_=new x,u=[[i,s]],m=!1;for(;u.length>0;){let[h,r]=u.pop();t.at(h,r)===o?(c.set(h,r,1),t.set(h,r,S.never),u.push([h-1,r]),u.push([h+1,r]),u.push([h,r-1]),u.push([h,r+1]),_.set(h,r,c.at(h-1,r)!==1&&t.at(h-1,r)!==o||c.at(h+1,r)!==1&&t.at(h+1,r)!==o||c.at(h,r-1)!==1&&t.at(h,r-1)!==o||c.at(h,r+1)!==1&&t.at(h,r+1)!==o)):t.at(h,r)===void 0&&o===null&&(m=!0)}if(m)continue;let g=[[i,s]],n=i,l=s+1;const w=t.rows*t.cols;let f=0,a="r";for(;n!=i||l!=s;){let h=c.at(n-1,l-1),r=c.at(n-1,l),v=c.at(n,l-1),b=c.at(n,l);if(r&&h&&v&&b){e.push([n,l]);break}else if(r&&h&&v)g.push([n,l]),a="b";else if(h&&v&&b)g.push([n,l]),a="r";else if(v&&b&&r)g.push([n,l]),a="t";else if(b&&r&&h)g.push([n,l]),a="l";else if(r&&h)a="l";else if(h&&v)a="b";else if(v&&b)a="r";else if(b&&r)a="t";else if(r&&v)g.push([n,l]),a==="l"?a="t":a==="r"?a="b":e.push([n,l]);else if(h&&b)g.push([n,l]),a==="t"?a="r":a==="b"?a="l":e.push([n,l]);else if(r)g.push([n,l]),a="t";else if(h)g.push([n,l]),a="l";else if(v)g.push([n,l]),a="b";else if(b)g.push([n,l]),a="r";else{e.push([n,l]);break}if(a==="r"?l+=1:a==="l"?l-=1:a==="b"?n+=1:a==="t"&&(n-=1),f+=1,f>=w){e.push([n,l]);break}}const A=document.createElementNS("http://www.w3.org/2000/svg","polygon");this._svg.append(A),A.setAttribute("points",g.reduce((h,r)=>h+r[1]*this._tileSize[0]+","+r[0]*this._tileSize[1]+" ","")),A.setAttribute("fill",o===null?"white":M(o))}if(e.length>0){let i="";e.length>100?(i="[",i+=e.slice(0,50).map(JSON.stringify).join(","),i+=",...,",i+=e.slice(-50).map(JSON.stringify).join(","),i+="]"):i=JSON.stringify(e),console.log("invalid loop condition at "+i)}}}
