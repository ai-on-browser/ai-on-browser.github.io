import DraughtsRLEnvironment from"../../../lib/rl/draughts.js";import{Game}from"../../platform/game/base.js";export default class DraughtsRenderer{constructor(t){this.renderer=t,this._game=new Draughts(t.platform),this._org_width=t.width,this._org_height=t.height}init(t){this.renderer.width=500,this.renderer.height=500,this._envrenderer=new Renderer(this.renderer.env,{width:this.renderer.width,height:this.renderer.height,g:t.node()}),this._envrenderer.init()}render(){this._envrenderer.render()}game(...t){return t[0]||(t[0]=new ManualPlayer(this._envrenderer)),t[1]||(t[1]=new ManualPlayer(this._envrenderer)),t[0].turn=DraughtsRLEnvironment.RED,t[1].turn=DraughtsRLEnvironment.WHITE,this._game.players=t,this._game}close(){this.renderer.width=this._org_width,this.renderer.height=this._org_height}}class Renderer{constructor(t,e={}){this.env=t,this._size=[e.width||200,e.height||200],this.svg=document.createElementNS("http://www.w3.org/2000/svg","svg"),this.svg.setAttribute("width",this._size[0]),this.svg.setAttribute("height",this._size[1]),this.svg.setAttribute("viewbox","0 0 200 200"),e.g&&e.g.replaceChildren(this.svg)}init(){const t=this._size[0],e=this._size[1],s=t/this.env._size[1],i=e/this.env._size[0];this._cells=[];for(let t=0;t<this.env._size[0];t++){this._cells[t]=[];for(let e=0;e<this.env._size[1];e++){this._cells[t][e]=document.createElementNS("http://www.w3.org/2000/svg","g"),this.svg.appendChild(this._cells[t][e]);const r=document.createElementNS("http://www.w3.org/2000/svg","rect");r.setAttribute("x",e*s),r.setAttribute("y",t*i),r.setAttribute("width",s),r.setAttribute("height",i),r.setAttribute("fill",(t+e)%2==0?"#aa9977":"#eeddcc"),r.setAttribute("stroke","#333333"),r.setAttribute("stroke-width","1"),this._cells[t][e].appendChild(r)}}}render(){const t=this._size[0],e=this._size[1],s=t/this.env._size[1],i=e/this.env._size[0];for(let t=0;t<this._cells.length;t++)for(let e=0;e<this._cells[t].length;e++){if(this._cells[t][e].querySelector("circle")?.remove(),this._cells[t][e].querySelector("text")?.remove(),this.env._board.at([t,e])===DraughtsRLEnvironment.EMPTY)continue;const r=document.createElementNS("http://www.w3.org/2000/svg","circle");if(r.setAttribute("cx",s*(e+.5)),r.setAttribute("cy",i*(t+.5)),r.setAttribute("r",.4*Math.min(s,i)),r.setAttribute("stroke","black"),r.setAttribute("stroke-width","1"),this.env._board.at([t,e])&DraughtsRLEnvironment.WHITE?r.setAttribute("fill","white"):this.env._board.at([t,e])&DraughtsRLEnvironment.RED&&r.setAttribute("fill","red"),this._cells[t][e].appendChild(r),this.env._board.at([t,e])&DraughtsRLEnvironment.KING){const r=document.createElementNS("http://www.w3.org/2000/svg","text");r.setAttribute("x",s*(e+.5)),r.setAttribute("y",i*(t+.5)),r.style.transform="translate(-0.4em, 0.3em)",r.append("K"),this._cells[t][e].appendChild(r)}}}}class Draughts extends Game{constructor(t){super(t),this._board=t.env._board,this.turns=[DraughtsRLEnvironment.RED,DraughtsRLEnvironment.WHITE]}_showResult(t){t.append("tspan").attr("x","0em").attr("y","0em").text(this._board.winner===DraughtsRLEnvironment.RED?"RED WIN":"WHITE WIN")}}class ManualPlayer{constructor(t){this._turn=null,this._renderer=t,this._obj=null}set turn(t){this._turn=t}action(t,e){const s=this._renderer._size[0],i=this._renderer._size[1],r=s/t.size[1],h=i/t.size[0],n=t.choices(this._turn);this._obj=document.createElementNS("http://www.w3.org/2000/svg","g"),this._renderer.svg.appendChild(this._obj),this._check=[];for(let s=0;s<t.size[0];s++){this._check[s]=[];for(let i=0;i<t.size[1];i++)if(!((s+i)%2>0)){this._check[s][i]=document.createElementNS("http://www.w3.org/2000/svg","rect"),this._check[s][i].setAttribute("x",r*i),this._check[s][i].setAttribute("y",h*s),this._check[s][i].setAttribute("width",r),this._check[s][i].setAttribute("height",h),this._check[s][i].setAttribute("fill","rgba(255, 255, 0, 0.5)"),this._check[s][i].setAttribute("opacity",0),this._obj.appendChild(this._check[s][i]);for(let r=0;r<n.length;r++)n[r].from[0]===s&&n[r].from[1]===i&&(this._check[s][i].setAttribute("opacity",1),this._check[s][i].onclick=((s,i)=>()=>{this.nextPath(t,n.filter((t=>t.from[0]===s&&t.from[1]===i)),e)})(s,i))}}}nextPath(t,e,s,i=0){for(let t=0;t<this._check.length;t++)for(let e=0;e<this._check[t].length;e++)this._check[t][e]&&(this._check[t][e].setAttribute("opacity",0),this._check[t][e].onclick=null);for(let r=0;r<e.length;r++)this._check[e[r].path[i][0]][e[r].path[i][1]].setAttribute("opacity",1),this._check[e[r].path[i][0]][e[r].path[i][1]].onclick=(r=>()=>{e[r].path.length===i+1?(s(e[r]),this._obj.remove(),this._obj=null):this.nextPath(t,e.filter((t=>t.path[i][0]===e[r].path[i][0]&&t.path[i][1]===e[r].path[i][1])),s,i+1)})(r)}close(){this._obj?.remove()}}