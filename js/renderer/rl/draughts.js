var a=Object.defineProperty;var _=(l,t)=>a(l,"name",{value:t,configurable:!0});import o from"../../../lib/rl/draughts.js";import{Game as g}from"../../platform/game/base.js";export default class m{static{_(this,"DraughtsRenderer")}constructor(t){this.renderer=t,this._game=new v(t.platform)}init(t){this._envrenderer=new b(this.renderer.env,{width:500,height:500,g:t}),this._envrenderer.init()}render(){this._envrenderer.render()}game(...t){return t[0]||(t[0]=new w(this._envrenderer)),t[1]||(t[1]=new w(this._envrenderer)),t[0].turn=o.RED,t[1].turn=o.WHITE,this._game.players=t,this._game}}class b{static{_(this,"Renderer")}constructor(t,r={}){this.env=t,this._size=[r.width||200,r.height||200],this.svg=document.createElementNS("http://www.w3.org/2000/svg","svg"),this.svg.setAttribute("width",this._size[0]),this.svg.setAttribute("height",this._size[1]),this.svg.setAttribute("viewbox","0 0 200 200"),r.g&&r.g.replaceChildren(this.svg)}init(){const t=this._size[0],r=this._size[1],n=t/this.env._size[1],c=r/this.env._size[0];this._cells=[];for(let s=0;s<this.env._size[0];s++){this._cells[s]=[];for(let i=0;i<this.env._size[1];i++){this._cells[s][i]=document.createElementNS("http://www.w3.org/2000/svg","g"),this.svg.appendChild(this._cells[s][i]);const e=document.createElementNS("http://www.w3.org/2000/svg","rect");e.setAttribute("x",i*n),e.setAttribute("y",s*c),e.setAttribute("width",n),e.setAttribute("height",c),e.setAttribute("fill",(s+i)%2===0?"#aa9977":"#eeddcc"),e.setAttribute("stroke","#333333"),e.setAttribute("stroke-width","1"),this._cells[s][i].appendChild(e)}}}render(){const t=this._size[0],r=this._size[1],n=t/this.env._size[1],c=r/this.env._size[0];for(let s=0;s<this._cells.length;s++)for(let i=0;i<this._cells[s].length;i++){if(this._cells[s][i].querySelector("circle")?.remove(),this._cells[s][i].querySelector("text")?.remove(),this.env._board.at([s,i])===o.EMPTY)continue;const e=document.createElementNS("http://www.w3.org/2000/svg","circle");if(e.setAttribute("cx",n*(i+.5)),e.setAttribute("cy",c*(s+.5)),e.setAttribute("r",Math.min(n,c)*.4),e.setAttribute("stroke","black"),e.setAttribute("stroke-width","1"),this.env._board.at([s,i])&o.WHITE?e.setAttribute("fill","white"):this.env._board.at([s,i])&o.RED&&e.setAttribute("fill","red"),this._cells[s][i].appendChild(e),this.env._board.at([s,i])&o.KING){const h=document.createElementNS("http://www.w3.org/2000/svg","text");h.setAttribute("x",n*(i+.5)),h.setAttribute("y",c*(s+.5)),h.style.transform="translate(-0.4em, 0.3em)",h.append("K"),this._cells[s][i].appendChild(h)}}}}class v extends g{static{_(this,"Draughts")}constructor(t){super(t),this._board=t.env._board,this.turns=[o.RED,o.WHITE]}_showResult(t){t.innerHTML=this._board.winner===o.RED?"RED WIN":"WHITE WIN"}}class w{static{_(this,"ManualPlayer")}constructor(t){this._turn=null,this._renderer=t,this._obj=null}set turn(t){this._turn=t}action(t){const r=this._renderer._size[0],n=this._renderer._size[1],c=r/t.size[1],s=n/t.size[0],i=t.choices(this._turn);this._obj=document.createElementNS("http://www.w3.org/2000/svg","g"),this._renderer.svg.appendChild(this._obj),this._check=[];for(let e=0;e<t.size[0];e++){this._check[e]=[];for(let h=0;h<t.size[1];h++)(e+h)%2!==0&&(this._check[e][h]=document.createElementNS("http://www.w3.org/2000/svg","rect"),this._check[e][h].setAttribute("x",c*h),this._check[e][h].setAttribute("y",s*e),this._check[e][h].setAttribute("width",c),this._check[e][h].setAttribute("height",s),this._check[e][h].setAttribute("fill","rgba(255, 255, 0, 0.5)"),this._check[e][h].setAttribute("opacity",0),this._obj.appendChild(this._check[e][h]))}return new Promise(e=>{this._obj.oncontextmenu=h=>{h.preventDefault(),this.nextPath(t,i).then(e)},this.nextPath(t,i).then(e)})}async nextPath(t,r,n=0){for(let s=0;s<this._check.length;s++)for(let i=0;i<this._check[s].length;i++)this._check[s][i]&&(this._check[s][i].setAttribute("opacity",0),this._check[s][i].onclick=null);const c=[];for(let s=0;s<r.length;s++){const[i,e]=n===0?r[s].from:r[s].path[n-1];this._check[i][e].setAttribute("opacity",1),c.push(new Promise(h=>{this._check[i][e].onclick=(d=>()=>{r[d].path.length===n?(this._obj.remove(),this._obj=null,h(r[d])):this.nextPath(t,r.filter(u=>n===0?u.from[0]===i&&u.from[1]===e:u.path[n-1][0]===i&&u.path[n-1][1]===e),n+1).then(h)})(s)}))}return Promise.race(c)}close(){this._obj?.remove()}}
