export default class BreakerRenderer{constructor(t){this.renderer=t,this._org_width=this._width=t.width,this._org_height=this._height=t.height,this._render_blocks=[]}init(t){const e=this.renderer.width=this.renderer.env._size[0],i=this.renderer.height=this.renderer.env._size[1];this._envrenderer=new Renderer(this.renderer.env,{g:t}),this._envrenderer.init();this._manualButton=document.createElementNS("http://www.w3.org/2000/svg","g"),this._manualButton.style.transform=`translate(${e/2-50}px, ${i-100}px)`,this._manualButton.style.cursor="pointer",this._manualButton.onclick=async()=>{this._game=new BreakerGame(this.renderer.platform),await this._game.start(),this._game=null,this._manualButton.attr("opacity",1)},t.appendChild(this._manualButton);const s=document.createElementNS("http://www.w3.org/2000/svg","rect");s.setAttribute("x",0),s.setAttribute("y",0),s.setAttribute("width",100),s.setAttribute("height",20),s.setAttribute("fill-opacity",0),s.setAttribute("stroke","gray"),this._manualButton.appendChild(s);const r=document.createElementNS("http://www.w3.org/2000/svg","text");r.setAttribute("x",50),r.setAttribute("text-anchor","middle"),r.setAttribute("dominant-baseline","hanging"),r.setAttribute("pointer-events","none"),r.setAttribute("user-select","none"),r.innerHTML="Start",this._manualButton.appendChild(r)}render(){this._manualButton.setAttribute("opacity",this._game||this.renderer.platform._manager._modelname?0:1),this._envrenderer.render()}close(){this.renderer.width=this._org_width,this.renderer.height=this._org_height}}class Renderer{constructor(t,e={}){this.env=t,this._render_blocks=[],this.svg=document.createElementNS("http://www.w3.org/2000/svg","svg"),this.svg.setAttribute("width",this.env._size[0]),this.svg.setAttribute("height",this.env._size[1]),e.g&&e.g.replaceChildren(this.svg)}init(){const t=this.env._size[1];this._render_blocks=[];for(let e=0;e<this.env._block_positions.length;e++)this._render_blocks[e]=document.createElementNS("http://www.w3.org/2000/svg","rect"),this._render_blocks[e].setAttribute("x",this.env._block_positions[e][0]-this.env._block_size[0]/2),this._render_blocks[e].setAttribute("y",t-this.env._block_positions[e][1]-this.env._block_size[1]/2),this._render_blocks[e].setAttribute("width",this.env._block_size[0]),this._render_blocks[e].setAttribute("height",this.env._block_size[1]),this._render_blocks[e].setAttribute("fill",`rgb(${Math.floor(128*Math.random())}, ${Math.floor(128*Math.random())}, ${Math.floor(128*Math.random())})`),this.svg.appendChild(this._render_blocks[e]);this._render_ball=document.createElementNS("http://www.w3.org/2000/svg","circle"),this._render_ball.setAttribute("cx",this.env._ball_position[0]),this._render_ball.setAttribute("cy",t-this.env._ball_position[1]),this._render_ball.setAttribute("r",this.env._ball_radius),this._render_ball.setAttribute("fill","black"),this.svg.appendChild(this._render_ball),this._render_paddle=document.createElementNS("http://www.w3.org/2000/svg","rect"),this._render_paddle.setAttribute("x",this.env._paddle_position-this.env._paddle_size[0]/2),this._render_paddle.setAttribute("y",t-this.env._paddle_baseline-this.env._paddle_size[1]/2),this._render_paddle.setAttribute("width",this.env._paddle_size[0]),this._render_paddle.setAttribute("height",this.env._paddle_size[1]),this._render_paddle.setAttribute("fill","black"),this.svg.appendChild(this._render_paddle)}render(){const t=this.env._size[1];for(let t=0;t<this.env._block_positions.length;t++)this.env._block_existances[t]?this._render_blocks[t].style.display=null:this._render_blocks[t].style.display="none";this._render_ball.setAttribute("cx",this.env._ball_position[0]),this._render_ball.setAttribute("cy",t-this.env._ball_position[1]),this._render_paddle.setAttribute("x",this.env._paddle_position-this.env._paddle_size[0]/2)}}class BreakerGame{constructor(t){this._platform=t,this._env=t.env,this._act=0,this._keyDown=this.keyDown.bind(this),this._keyUp=this.keyUp.bind(this)}async start(){for(this._env.reset(),document.addEventListener("keydown",this._keyDown),document.addEventListener("keyup",this._keyUp);;){const{done:t}=this._env.step([this._act]);if(this._platform.render(),t)break;await new Promise((t=>setTimeout(t,10)))}document.removeEventListener("keydown",this._keyDown),document.removeEventListener("keyup",this._keyUp)}keyDown(t){"ArrowLeft"===t.code?this._act=-1:"ArrowRight"===t.code&&(this._act=1)}keyUp(t){("ArrowLeft"===t.code||"ArrowRight"===t.code)&&(this._act=0)}}