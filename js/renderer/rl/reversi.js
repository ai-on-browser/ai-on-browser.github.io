import ReversiRLEnvironment from"../../../lib/rl/reversi.js";import{Game}from"../../platform/game/base.js";export default class ReversiRenderer{constructor(t){this.renderer=t,this._game=new Reversi(t.platform),this._org_width=t.width,this._org_height=t.height}init(t){this.renderer.width=500,this.renderer.height=500,this._envrenderer=new Renderer(this.renderer.env,{width:this.renderer.width,height:this.renderer.height,g:t.node()}),this._envrenderer.init()}render(){this._envrenderer.render()}game(...t){return t[0]||(t[0]=new ManualPlayer(this.renderer.platform)),t[1]||(t[1]=new ManualPlayer(this.renderer.platform)),t[0].turn=ReversiRLEnvironment.BLACK,t[1].turn=ReversiRLEnvironment.WHITE,this._game.players=t,this._game}close(){this.renderer.width=this._org_width,this.renderer.height=this._org_height}}class Renderer{constructor(t,e={}){this.env=t,this._size=[e.width||200,e.height||200],this.svg=document.createElementNS("http://www.w3.org/2000/svg","svg"),this.svg.setAttribute("width",this._size[0]),this.svg.setAttribute("height",this._size[1]),this.svg.setAttribute("viewbox","0 0 200 200"),e.g&&e.g.replaceChildren(this.svg)}init(){const t=this._size[0],e=this._size[1],i=t/this.env._size[1],r=e/this.env._size[0];this._cells=[];for(let t=0;t<this.env._size[0];t++){this._cells[t]=[];for(let e=0;e<this.env._size[1];e++){this._cells[t][e]=document.createElementNS("http://www.w3.org/2000/svg","g"),this.svg.appendChild(this._cells[t][e]);const s=document.createElementNS("http://www.w3.org/2000/svg","rect");s.setAttribute("x",e*i),s.setAttribute("y",t*r),s.setAttribute("width",i),s.setAttribute("height",r),s.setAttribute("fill","#339933"),s.setAttribute("stroke","#333333"),s.setAttribute("stroke-width","1"),this._cells[t][e].appendChild(s)}}}render(){const t=this._size[0],e=this._size[1],i=t/this.env._size[1],r=e/this.env._size[0];for(let t=0;t<this._cells.length;t++)for(let e=0;e<this._cells[t].length;e++){if(this._cells[t][e].querySelector("circle")?.remove(),this.env._board.at([t,e])===ReversiRLEnvironment.EMPTY)continue;const s=document.createElementNS("http://www.w3.org/2000/svg","circle");s.setAttribute("cx",i*(e+.5)),s.setAttribute("cy",r*(t+.5)),s.setAttribute("r",.4*Math.min(i,r)),s.setAttribute("stroke","black"),s.setAttribute("stroke-width","1"),this.env._board.at([t,e])===ReversiRLEnvironment.WHITE?s.setAttribute("fill","white"):this.env._board.at([t,e])===ReversiRLEnvironment.BLACK&&s.setAttribute("fill","black"),this._cells[t][e].appendChild(s)}}}class Reversi extends Game{constructor(t){super(t),this._board=t.env._board,this.turns=[ReversiRLEnvironment.BLACK,ReversiRLEnvironment.WHITE]}_showResult(t){const e=this._board.count;t.append("tspan").attr("x","0em").attr("y","-1em").text(`BLACK: ${e.black}`),t.append("tspan").attr("x","0em").attr("y","1em").text(`WHITE: ${e.white}`)}}class ManualPlayer{constructor(t){this._turn=null,this._platform=t,this._obj=null}set turn(t){this._turn=t}action(t,e){const i=this._platform.width,r=this._platform.height,s=this;this._obj=this._platform.svg.append("g");t.choices(this._turn);this._obj.append("rect").attr("x",0).attr("y",0).attr("width",i).attr("height",r).attr("opacity",0).on("click",(h=>{const n=d3.pointer(h),o=[Math.floor(n[1]/i*t.size[0]),Math.floor(n[0]/r*t.size[1])];e(o),s._obj.remove(),s._obj=null}))}close(){this._obj&&this._obj.remove()}}