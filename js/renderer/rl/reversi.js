import ReversiRLEnvironment from"../../../lib/rl/reversi.js";import{Game}from"../../platform/game/base.js";export default class ReversiRenderer{constructor(e){this.renderer=e,this._game=new Reversi(e.platform),this._org_width=e.width,this._org_height=e.height}init(e){this.renderer.width=500,this.renderer.height=500,this._envrenderer=new Renderer(this.renderer.env,{width:this.renderer.width,height:this.renderer.height,g:e}),this._envrenderer.init()}render(){this._envrenderer.render()}game(...e){return e[0]||(e[0]=new ManualPlayer(this._envrenderer)),e[1]||(e[1]=new ManualPlayer(this._envrenderer)),e[0].turn=ReversiRLEnvironment.BLACK,e[1].turn=ReversiRLEnvironment.WHITE,this._game.players=e,this._game}close(){this.renderer.width=this._org_width,this.renderer.height=this._org_height}}class Renderer{constructor(e,t={}){this.env=e,this._size=[t.width||200,t.height||200],this.svg=document.createElementNS("http://www.w3.org/2000/svg","svg"),this.svg.setAttribute("width",this._size[0]),this.svg.setAttribute("height",this._size[1]),this.svg.setAttribute("viewbox","0 0 200 200"),t.g&&t.g.replaceChildren(this.svg)}init(){const e=this._size[0],t=this._size[1],r=e/this.env._size[1],i=t/this.env._size[0];this._cells=[];for(let e=0;e<this.env._size[0];e++){this._cells[e]=[];for(let t=0;t<this.env._size[1];t++){this._cells[e][t]=document.createElementNS("http://www.w3.org/2000/svg","g"),this.svg.appendChild(this._cells[e][t]);const s=document.createElementNS("http://www.w3.org/2000/svg","rect");s.setAttribute("x",t*r),s.setAttribute("y",e*i),s.setAttribute("width",r),s.setAttribute("height",i),s.setAttribute("fill","#339933"),s.setAttribute("stroke","#333333"),s.setAttribute("stroke-width","1"),this._cells[e][t].appendChild(s)}}}render(){const e=this._size[0],t=this._size[1],r=e/this.env._size[1],i=t/this.env._size[0];for(let e=0;e<this._cells.length;e++)for(let t=0;t<this._cells[e].length;t++){if(this._cells[e][t].querySelector("circle")?.remove(),this.env._board.at([e,t])===ReversiRLEnvironment.EMPTY)continue;const s=document.createElementNS("http://www.w3.org/2000/svg","circle");s.setAttribute("cx",r*(t+.5)),s.setAttribute("cy",i*(e+.5)),s.setAttribute("r",.4*Math.min(r,i)),s.setAttribute("stroke","black"),s.setAttribute("stroke-width","1"),this.env._board.at([e,t])===ReversiRLEnvironment.WHITE?s.setAttribute("fill","white"):this.env._board.at([e,t])===ReversiRLEnvironment.BLACK&&s.setAttribute("fill","black"),this._cells[e][t].appendChild(s)}}}class Reversi extends Game{constructor(e){super(e),this._board=e.env._board,this.turns=[ReversiRLEnvironment.BLACK,ReversiRLEnvironment.WHITE]}_showResult(e){const t=this._board.count,r=document.createElementNS("http://www.w3.org/2000/svg","tspan");r.setAttribute("x","0em"),r.setAttribute("y","-1em"),r.innerHTML=`BLACK: ${t.black}`,e.appendChild(r);const i=document.createElementNS("http://www.w3.org/2000/svg","tspan");i.setAttribute("x","0em"),i.setAttribute("y","1em"),i.innerHTML=`WHITE: ${t.white}`,e.appendChild(i)}}class ManualPlayer{constructor(e){this._turn=null,this._renderer=e,this._obj=null}set turn(e){this._turn=e}action(e){const t=this._renderer._size[0],r=this._renderer._size[1];this._obj=document.createElementNS("http://www.w3.org/2000/svg","g"),this._renderer.svg.appendChild(this._obj);const i=document.createElementNS("http://www.w3.org/2000/svg","rect");return i.setAttribute("x",0),i.setAttribute("y",0),i.setAttribute("width",t),i.setAttribute("height",r),i.setAttribute("opacity",0),this._obj.appendChild(i),new Promise((s=>{i.onclick=i=>{const n=d3.pointer(i),h=[Math.floor(n[1]/t*e.size[0]),Math.floor(n[0]/r*e.size[1])];this._obj.remove(),this._obj=null,s(h)}}))}close(){this._obj?.remove()}}