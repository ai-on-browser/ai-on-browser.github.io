var _=Object.defineProperty;var h=(d,t)=>_(d,"name",{value:t,configurable:!0});import u from"../../../lib/rl/gem_puzzle.js";export default class m{static{h(this,"GemPuzzleRenderer")}constructor(t){this.renderer=t,this._init_menu()}_init_menu(){const t=this.renderer.setting.rl.configElement;t.replaceChildren(),t.appendChild(document.createTextNode("Size "));const e=document.createElement("input");e.type="number",e.min=2,e.max=10,e.value=this.renderer.env._size[0],e.onchange=()=>{this.renderer.env._size=[+e.value,+e.value],this.renderer.env._board._size=[+e.value,+e.value],this.renderer.platform.init(),this.renderer.env.reset(),this.renderer.setting.ml.refresh()},t.appendChild(e)}init(t){const i=t.appendChild(document.createElement("div"));i.style.position="relative",this._envrenderer=new p(this.renderer.env,{width:500,height:500,g:i}),this._envrenderer.init(),this._resetButton=document.createElement("button"),this._resetButton.innerText="Reset",this._resetButton.onclick=async()=>{this.renderer.env.reset(),this._envrenderer.render()},t.appendChild(this._resetButton),this._manualButton=document.createElement("button"),this._manualButton.innerText="Manual",this._manualButton.onclick=async()=>{this._game=new c(this.renderer.platform),this._autoButton.disabled=!0,this._manualButton.disabled=!0,this._resetButton.disabled=!0,this._cancelButton.style.display="inline",await this._game.start(),this._autoButton.disabled=!1,this._manualButton.disabled=!1,this._resetButton.disabled=!1,this._cancelButton.style.display="none",this._game=null},t.appendChild(this._manualButton),this._autoButton=document.createElement("button"),this._autoButton.innerText="Auto",this._autoButton.onclick=async()=>{this._game=new c(this.renderer.platform),this._autoButton.disabled=!0,this._manualButton.disabled=!0,this._resetButton.disabled=!0,this._cancelButton.style.display="inline",await this._game.start(!0),this._autoButton.disabled=!1,this._manualButton.disabled=!1,this._resetButton.disabled=!1,this._cancelButton.style.display="none",this._game=null},t.appendChild(this._autoButton),this._cancelButton=document.createElement("button"),this._cancelButton.innerText="Cancel",this._cancelButton.onclick=async()=>{this._game.cancel(),this._cancelButton.style.display="none"},this._cancelButton.style.display="none",t.appendChild(this._cancelButton)}render(){const t=this.renderer.platform._manager._modelname?"none":null;this._resetButton.style.display=t,this._manualButton.style.display=t,this._autoButton.style.display=t,this._envrenderer.render()}}class p{static{h(this,"Renderer")}constructor(t,e={}){this.env=t,this._size=[e.width||200,e.height||200],this._points=[],this._q=null,this._render_blocks=[],this.svg=document.createElementNS("http://www.w3.org/2000/svg","svg"),this.svg.setAttribute("width",this._size[0]),this.svg.setAttribute("height",this._size[1]),this.svg.setAttribute("viewbox","0 0 200 200"),e.g&&e.g.replaceChildren(this.svg)}init(){const t=this._size[0],e=this._size[1],n=t/this.env._size[0],i=e/this.env._size[1];this._render_blocks=[];for(let l=0;l<this.env._size[0];l++){this._render_blocks[l]=[];for(let s=0;s<this.env._size[1];s++){const a=this._render_blocks[l][s]=document.createElementNS("http://www.w3.org/2000/svg","g");a.classList.add("grid"),a.setAttribute("stroke-width",1),a.setAttribute("stroke","black"),a.setAttribute("stroke-opacity",.2),this.svg.appendChild(a);const r=document.createElementNS("http://www.w3.org/2000/svg","rect");r.setAttribute("x",i*s),r.setAttribute("y",i*l),r.setAttribute("width",i),r.setAttribute("height",n),r.setAttribute("fill","white"),a.appendChild(r);const o=document.createElementNS("http://www.w3.org/2000/svg","text");o.classList.add("value"),o.setAttribute("x",i*(s+.5)),o.setAttribute("y",n*(l+.5)),o.setAttribute("font-size",14),o.setAttribute("user-select","none"),o.setAttribute("dominant-baseline","middle"),o.setAttribute("text-anchor","middle"),a.appendChild(o)}}this.render()}render(){const t=this.env._board;for(let e=0;e<this.env._size[0];e++)for(let n=0;n<this.env._size[1];n++)this._render_blocks[e][n].querySelector("text.value").replaceChildren(t.at([e,n])??""),t.at([e,n])===null?this._render_blocks[e][n].querySelector("rect").setAttribute("fill","rgba(0, 0, 0, 0.5)"):this._render_blocks[e][n].querySelector("rect").setAttribute("fill","white")}}class c{static{h(this,"GemPuzzleGame")}constructor(t){this._platform=t,this._env=t.env,this._cancel=!1}async start(t=!1){if(this._platform.render(),t){const i=this._env._board.solve();for(const l of i)if(await new Promise(s=>setTimeout(s,50)),this._env.step([l]),this._platform.render(),this._cancel)break;return}const{promise:e,resolve:n}=Promise.withResolvers();for(this._cancelResolver=n;;){const i=await Promise.race([e,new Promise(s=>{const a=h(r=>{r.code==="ArrowUp"?s(u.UP):r.code==="ArrowDown"?s(u.DOWN):r.code==="ArrowLeft"?s(u.LEFT):r.code==="ArrowRight"&&s(u.RIGHT),document.removeEventListener("keydown",a)},"keyDown");document.addEventListener("keydown",a)})]);if(i===null)break;const{done:l}=this._env.step([i]);if(this._platform.render(),l)break;await new Promise(s=>setTimeout(s,10))}}cancel(){this._cancelResolver?.(null),this._cancel=!0}}
