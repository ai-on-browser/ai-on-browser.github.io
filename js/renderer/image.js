import BaseRenderer from"./base.js";import{specialCategory,getCategoryColor}from"../utils.js";export default class ImageRenderer extends BaseRenderer{constructor(t){super(t),this._size=[0,0];const e=this.setting.render.addItem("image");this._root=document.createElement("div"),e.appendChild(this._root),this._root.style.position="relative",this._root.style.border="1px solid black",this._opacity=.5}get width(){return this._size[0]}set width(t){this._size[0]=t,this._root.style.width=`${t}px`}get height(){return this._size[1]}set height(t){this._size[1]=t,this._root.style.height=`${t}px`}set resultOpacity(t){this._opacity=t,this._overlay&&(this._overlay.style.opacity=t)}init(){this._overlay?.remove(),this._root.replaceChildren()}render(){if(this._root.querySelector("canvas.base-img")?.remove(),!(this.datas&&this.datas.x&&Array.isArray(this.datas.x[0])&&Array.isArray(this.datas.x[0][0])))return;const t=this.datas.x[0],e=this.datas._applySpace(t,this._manager.platform._color_space,this._manager.platform._normalize,this._manager.platform._binary_threshold),a=e[0][0].length,i=document.createElement("canvas");i.classList.add("base-img"),i.style.position="absolute",i.width=t[0].length,i.height=t.length;const s=i.getContext("2d"),r=s.createImageData(i.width,i.height);for(let t=0,s=0;t<i.height;t++)for(let o=0;o<i.width;o++,s+=4)r.data[s]=e[t][o][0],1===a?(r.data[s+1]=e[t][o][0],r.data[s+2]=e[t][o][0],r.data[s+3]=255):3===a?(r.data[s+1]=e[t][o][1],r.data[s+2]=e[t][o][2],r.data[s+3]=255):(r.data[s+1]=e[t][o][1],r.data[s+2]=e[t][o][2],r.data[s+3]=e[t][o][3]);s.putImageData(r,0,0),this._root.firstChild?this._root.insertBefore(i,this._root.firstChild):this._root.appendChild(i),this.width=i.width,this.height=i.height}_displayResult(t,e,a){this._overlay?.remove();const i=document.createElement("canvas");i.classList.add("overlay"),i.style.position="absolute",i.style.opacity=this._opacity,i.width=this.width,i.height=this.height;const s=i.getContext("2d"),r=s.createImageData(i.width,i.height);for(let s=0,o=0;s<t.length;s++)for(let h=0;h<t[s].length;h++,o++){const t=[0,0,0,0];if(Array.isArray(e[o]))t[0]=e[o][0],t[3]=255,1===e[o].length?(t[1]=e[o][0],t[2]=e[o][0]):(t[1]=e[o][1],t[2]=e[o][2]);else if(!0===e[o]||!1===e[o])if(e[o]){const e=getCategoryColor(specialCategory.error);t[0]=e.r,t[1]=e.g,t[2]=e.b,t[3]=255*e.opacity}else t[0]=255,t[1]=255,t[2]=255,t[3]=255;else{const a=getCategoryColor(e[o]);t[0]=a.r,t[1]=a.g,t[2]=a.b,t[3]=255*a.opacity}for(let e=0;e<a;e++)for(let o=0;o<a;o++){const d=4*((s*a+e)*i.width+h*a+o);r.data[d]=t[0],r.data[d+1]=t[1],r.data[d+2]=t[2],r.data[d+3]=t[3]}}s.putImageData(r,0,0),this._root.appendChild(i),this._overlay=i}terminate(){this.setting.render.removeItem("image"),super.terminate()}}