var L=Object.defineProperty;var S=(C,t)=>L(C,"name",{value:t,configurable:!0});import z from"./base.js";import{getCategoryColor as v,specialCategory as x}from"../utils.js";import{DataPoint as N,DataCircle as M,DataHulls as k}from"./util/figure.js";import R from"../../lib/util/matrix.js";const u=S(function(C,t,n,r,e){return!isFinite(t)||!isFinite(n)||t===n?(e+r)/2:(C-t)/(n-t)*(e-r)+r},"scale");export default class D extends z{static{S(this,"ScatterRenderer")}constructor(t){super(t),this._size=[960,500];const n=this.setting.render.addItem("scatter"),r=document.createElement("div");r.id="plot-area",n.appendChild(r),this._menu=document.createElement("div"),r.appendChild(this._menu),this._root=document.createElementNS("http://www.w3.org/2000/svg","svg"),r.appendChild(this._root),this._root.style.border="1px solid #000000",this._root.setAttribute("width",`${this._size[0]}px`),this._root.setAttribute("height",`${this._size[1]}px`),this._svg=document.createElementNS("http://www.w3.org/2000/svg","g"),this._svg.style.transform="scale(1, -1) translate(0, -100%)",this._root.appendChild(this._svg),this._grid=document.createElementNS("http://www.w3.org/2000/svg","g"),this._grid.setAttribute("opacity",.3),this._svg.appendChild(this._grid);const e=document.createElementNS("http://www.w3.org/2000/svg","g");e.classList.add("points"),this._svg.appendChild(e),this._r=document.createElementNS("http://www.w3.org/2000/svg","g"),this._r.classList.add("datas"),e.appendChild(this._r),this._p=[],this._pad=10,this._clip_pad=-1/0,this._pred_count=0,this._select=[0,1],this._use_canvas_number=1e4,this._observe_target=null,this._observer=new MutationObserver(s=>{this._observe_target&&this._p.forEach((l,a)=>l.title=this.datas.labels[a])}),this._observer.observe(this._svg,{childList:!0})}get svg(){return this._svg}get padding(){return Array.isArray(this._pad)?this._pad:[this._pad,this._pad]}set padding(t){this._pad=t??0,this.render()}set clipPadding(t){this._clip_pad=t,this.render()}get points(){return this._p.length===0?this._dp:this._p}set trainResult(t){const n=this._manager.platform.task;if(n==="AD"||n==="SC"){if(this._svg.querySelectorAll(".tile").length===0){const s=document.createElementNS("http://www.w3.org/2000/svg","g");s.classList.add("tile"),this._svg.insertBefore(s,this._svg.firstChild)}const r=this._svg.querySelector(".tile");r.replaceChildren();let e=[];n==="AD"?e=t.map(s=>s?v(x.error):null):e=t.map(s=>v(s)),this._r.querySelector("image")?(this._roundcolor=e,this._render()):e.forEach((s,l)=>{if(!s)return;const a=new M(r,this._p[l]);a.color=s})}else if(n==="DR"||n==="FS"||n==="TF"){if(this._svg.querySelectorAll(".tile").length===0){const h=document.createElementNS("http://www.w3.org/2000/svg","g");h.classList.add("tile"),h.setAttribute("opacity",.5),this._svg.insertBefore(h,this._svg.firstChild)}const r=this._svg.querySelector(".tile");r.replaceChildren();const e=t[0].length;let s=t;e===1&&(s=s.map(h=>[h,0]));let l=[],a=[];for(let h=0;h<s[0].length;h++){const m=s.map(w=>w[h]);l.push(Math.max(...m)),a.push(Math.min(...m))}const d=this.datas.dimension<=1?[this._size[1],this._size[1]]:this._size,_=d.map((h,m)=>(h-10)/(l[m]-a[m]));let c=Math.min(..._);const o=[5,5];for(let h=0;h<_.length;h++)(!isFinite(c)||_[h]>c)&&(isFinite(_[h])?o[h]+=(_[h]-c)*(l[h]-a[h])/2:o[h]=d[h]/2-a[h]);isFinite(c)||(c=0);let i=1/0,p=null;const g=R.fromArray(this._dp.map(h=>h.at));for(let h=0;h<(this.datas.dimension<=1?1:2**e);h++){const m=h.toString(2).padStart(e,"0").split("").map(f=>!!+f),w=s.map(f=>f.map((E,A)=>((m[A]?l[A]-E+a[A]:E)-a[A])*c+o[A])),b=R.fromArray(w);b.sub(g);const y=b.norm();y<i&&(i=y,p=w)}p.forEach((h,m)=>{const w=this.datas.dimension<=1?[this._dp[m].at[0],h[0]]:h,b=v(this._dp[m].color),y=document.createElementNS("http://www.w3.org/2000/svg","circle");y.setAttribute("cx",w[0]),y.setAttribute("cy",w[1]),y.setAttribute("r",2),y.setAttribute("fill",b),r.appendChild(y);const f=document.createElementNS("http://www.w3.org/2000/svg","line");f.setAttribute("x1",this._dp[m].at[0]),f.setAttribute("x2",w[0]),f.setAttribute("y1",this._dp[m].at[1]),f.setAttribute("y2",w[1]),f.setAttribute("stroke",b),r.appendChild(f)})}else if(n==="GR"){if(this._svg.querySelectorAll(".tile").length===0){const s=document.createElementNS("http://www.w3.org/2000/svg","g");s.classList.add("tile","generated"),s.setAttribute("opacity",.5),this._svg.insertBefore(s,this._svg.firstChild)}const r=this._svg.querySelector(".tile.generated");r.replaceChildren();let e=null;Array.isArray(t)&&t.length===2&&Array.isArray(t[0])&&Array.isArray(t[0][0])&&([t,e]=t),t.forEach((s,l)=>{let a=new N(r,this.toPoint(s),e?e[l][0]:0);a.radius=2})}}get scale(){const t=this.datas.domain,n=this._size,[r,e]=this.datas.range,s=this._select.map((l,a)=>n[a]/(t[l][1]-t[l][0]));return this._select.length===1&&(s[1]=n[1]/(e-r)),s}init(){this._lastpred=null,this._roundcolor=null,this._r_tile?.remove(),this._svg.querySelectorAll(".tile").forEach(t=>t.remove()),this._grid.replaceChildren(),this._make_selector()}_make_selector(){let t=this.datas?.columnNames||[],n=this._menu.querySelector("div.column-selector");if(!n&&t.length>0?(n=document.createElement("div"),n.classList.add("column-selector"),this._menu.appendChild(n)):n?.replaceChildren(),t.length<1)this._select=this.datas?.dimension===1?[0]:[0,1];else if(t.length===1){const r=document.createElement("table");r.style.borderCollapse="collapse",n.appendChild(r);let e=r.insertRow();e.style.textAlign="center",e.insertCell(),e.insertCell().innerHTML="&rarr;",e=r.insertRow();const s=e.insertCell();s.innerText=t[0],s.style.textAlign="right";const l=e.insertCell(),a=document.createElement("input");a.type="radio",a.name="data-d1",a.checked=!0,l.appendChild(a),this._select=this.datas.dimension===1?[0]:[0,1]}else if(t.length<=4){const r=document.createElement("table");r.style.borderCollapse="collapse",n.appendChild(r);let e=r.insertRow();e.style.textAlign="center",e.insertCell(),e.insertCell().innerHTML="&rarr;",e.insertCell().innerHTML="&uarr;";const s=[],l=[];for(let a=0;a<t.length;a++){e=r.insertRow();const d=e.insertCell();d.innerText=t[a],d.style.textAlign="right";const _=e.insertCell(),c=document.createElement("input");c.type="radio",c.name="data-d1",c.onchange=()=>{this._select[1]===a&&(l[this._select[1]].checked=!1,l[this._select[0]].checked=!0,this._select[1]=this._select[0]),this._select[0]=a,this.render()},_.appendChild(c),s.push(c);const o=e.insertCell(),i=document.createElement("input");i.type="radio",i.name="data-d2",i.onchange=()=>{this._select[0]===a&&(s[this._select[0]].checked=!1,s[this._select[1]].checked=!0,this._select[0]=this._select[1]),this._select[1]=a,this.render()},o.appendChild(i),l.push(i)}s[0].checked=!0,l[1].checked=!0,this._select=[0,1]}else{t=t.map(a=>""+a);const r=document.createElement("span");r.innerHTML="&rarr;",n.appendChild(r);const e=document.createElement("select");e.onchange=()=>{const a=t.indexOf(e.value);this._select[1]===a&&(l.value=t[this._select[0]],this._select[1]=this._select[0]),this._select[0]=a,this.render()};for(const a of t){const d=document.createElement("option");d.value=a,d.innerText=a,e.appendChild(d)}e.value=t[0],n.appendChild(e);const s=document.createElement("span");s.innerHTML="&uarr;",s.style.display="inline-block",n.appendChild(s);const l=document.createElement("select");l.onchange=()=>{const a=t.indexOf(l.value);this._select[0]===a&&(e.value=t[this._select[1]],this._select[0]=this._select[1]),this._select[1]=a,this.render()};for(const a of t){const d=document.createElement("option");d.value=a,d.innerText=a,l.appendChild(d)}l.value=t[1],n.appendChild(l),this._select=[0,1]}}_clip(t){if(this._clip_pad===-1/0)return t;const n=this._size;for(let r=0;r<t.length;r++)t[r]<this._clip_pad?t[r]=this._clip_pad:n[r]-this._clip_pad<t[r]&&(t[r]=n[r]-this._clip_pad);return t}toPoint(t){const n=this.datas.domain,r=this._size,[e,s]=this.datas.range,l=this._select.map((a,d)=>u(t[a],n[a][0],n[a][1],0,r[d]-this.padding[d]*2)+this.padding[d]);return l.length===1&&t.length>1&&(l[1]=u(t[1],e,s,0,r[1]-this.padding[1]*2)+this.padding[1]),l.map(a=>isNaN(a)?0:a)}_render(){if(this._r.querySelector("image")?.remove(),!this.datas||this.datas.length===0){this._p.map(i=>i.remove()),this._p.length=0,this._dp=[];return}const t=this.datas.length,n=this.datas.x,r=this.datas.domain,e=this.datas.y,s=this._size,l=this.datas.index,a=this.datas.indexRange,[d,_]=this.datas.range,c=[];for(let i=0;i<t;i++)if(this.datas.dimension===0){const p=isNaN(l[i])?u(i,0,t,0,s[0]-this.padding[0]*2):u(l[i],a[0],a[1],0,s[0]-this.padding[0]*2);c.push([p+this.padding[0],u(e[i],d,_,0,s[1]-this.padding[1]*2)+this.padding[1]])}else this.datas.dimension===1?c.push([u(n[i][0],r[0][0],r[0][1],0,s[0]-this.padding[0]*2)+this.padding[0],u(e[i],d,_,0,s[1]-this.padding[1]*2)+this.padding[1]]):c.push(this._select.map((p,g)=>u(n[i][p],r[p][0],r[p][1],0,s[g]-this.padding[g]*2)+this.padding[g]));const o=Math.max(1,Math.min(5,Math.floor(2e3/t)));if(this._dp=c.map((i,p)=>({at:this._clip(i),radius:o,color:this.datas.dimension<=1?0:this.datas.y[p]})),t<this._use_canvas_number){for(let i=0;i<t;i++){const p=this._dp[i].at,g=this._dp[i].color;if(this._p[i]){const h=this._p[i].at;(h[0]!==p[0]||h[1]!==p[1])&&(this._p[i].at=p),this._p[i].category!==g&&(this._p[i].category=g)}else this._p[i]=new N(this._r,p,g);this._p[i].title=this.datas.labels[i],this._p[i].radius=o}for(let i=t;i<this._p.length;i++)this._p[i].remove();this._p.length=t}else{this._p.forEach(h=>h.remove()),this._p.length=0;const i=document.createElement("canvas");i.width=this._size[0],i.height=this._size[1];const p=i.getContext("2d");for(let h=0;h<t;h++){const m=this._dp[h].at;p.fillStyle=v(this._dp[h].color),p.beginPath(),p.arc(m[0],m[1],o,0,Math.PI*2),p.fill(),this._roundcolor?.[h]&&(p.strokeStyle=this._roundcolor[h],p.fillStyle=null,p.beginPath(),p.arc(m[0],m[1],o,0,Math.PI*2),p.stroke(),p.strokeStyle=null)}const g=document.createElementNS("http://www.w3.org/2000/svg","image");g.setAttribute("x",0),g.setAttribute("y",0),g.setAttribute("width",i.width),g.setAttribute("height",i.height),g.setAttributeNS("http://www.w3.org/1999/xlink","xlink:href",i.toDataURL()),this._r.appendChild(g)}this._lastpred&&this.testResult(this._lastpred),this._renderGrid()}_renderGrid(){this._grid.replaceChildren();const t=this.datas.domain,n=this._size,[r,e]=this.datas.range;let s=[],l=[],a=[],d=[];this.datas.dimension===0?(a=this._getScales(r,e),d=[r,e]):this.datas.dimension===1?(s=this._getScales(t[0][0],t[0][1]),l=t[0],a=this._getScales(r,e),d=[r,e]):(s=this._getScales(t[this._select[0]][0],t[this._select[0]][1]),l=t[this._select[0]],a=this._getScales(t[this._select[1]][0],t[this._select[1]][1]),d=t[this._select[1]]);for(const _ of s){const c=u(_,l[0],l[1],0,n[0]-this.padding[0]*2)+this.padding[0],o=document.createElementNS("http://www.w3.org/2000/svg","line");o.setAttribute("x1",c),o.setAttribute("x2",c),o.setAttribute("y1",0),o.setAttribute("y2",n[1]),o.setAttribute("stroke","gray");const i=document.createElementNS("http://www.w3.org/2000/svg","text");i.setAttribute("x",Math.max(c,10)),i.setAttribute("y",n[1]-5),i.setAttribute("fill","gray"),i.style.transform="scale(1, -1) translate(0, -100%)",i.innerHTML=_,this._grid.append(o,i)}for(const _ of a){const c=u(+_,d[0],d[1],0,n[1]-this.padding[1]*2)+this.padding[1],o=document.createElementNS("http://www.w3.org/2000/svg","line");o.setAttribute("x1",0),o.setAttribute("x2",n[0]),o.setAttribute("y1",c),o.setAttribute("y2",c),o.setAttribute("stroke","gray");const i=document.createElementNS("http://www.w3.org/2000/svg","text");i.setAttribute("x",5),i.setAttribute("y",Math.min(n[1]-c,n[1]-10)),i.setAttribute("fill","gray"),i.style.transform="scale(1, -1) translate(0, -100%)",i.innerHTML=_,this._grid.append(o,i)}}_getScales(t,n){const r=n-t;if(r===0)return[];let e=Math.floor(Math.log10(r)),s=10**e;r/s<2?(s/=2,e--):r/s>5&&(s*=2);const l=n-n%s,a=[];for(let d=l;d>=t;d-=s)a.push(e<0?d.toFixed(-e):d);return a}testData(t){this._lastpred=null,Array.isArray(t)||(t=[t,t]),this._laststep=t;const n=[];if(this.datas.dimension===0){const s=this.datas.indexRange;n[0]=[isNaN(s[0])?0:s[0],isNaN(s[1])?this.datas.length:s[1]]}else n.push(...this.datas.domain);this._lastdomain=n;const r=this._size,e=[];if(this.datas.dimension<=2)for(let s=0;s<r[0]+t[0];s+=t[0]){const l=u(s-this.padding[0],0,r[0]-this.padding[0]*2,n[0][0],n[0][1]);if(this.datas.dimension<=1)e.push([l]);else for(let a=0;a<r[1]-t[1]/100;a+=t[1]){const d=u(a-this.padding[1],0,r[1]-this.padding[1]*2,n[1][0],n[1][1]);e.push([l,d])}}else for(let s=0;s<this.datas.x.length;s++)e.push(this.datas.x[s].concat());return this._lasttiles=e,e}testResult(t){const n=this._laststep,r=this._lastdomain,e=this._size,s=this._lasttiles,l=this._manager.platform.task;if(this._lastpred=t,l==="AD")t=t.map(_=>_?x.error:x.errorRate(0));else if(l==="DE"){let _=1/0,c=-1/0;for(const o of t)_=Math.min(_,o),c=Math.max(c,o);t=t.map(o=>x.density((o-_)/(c-_)))}this._r_tile?.remove(),this.datas.dimension===1&&(l==="RG"||l==="IN")?(this._r_tile=document.createElementNS("http://www.w3.org/2000/svg","g"),this._r_tile.classList.add("tile-render"),this._r_tile.setAttribute("opacity",1),this._svg.appendChild(this._r_tile)):(this._r_tile=document.createElementNS("http://www.w3.org/2000/svg","g"),this._r_tile.classList.add("tile-render"),this._r_tile.setAttribute("opacity",.5),this._svg.insertBefore(this._r_tile,this._svg.firstChild)),this._r_tile.replaceChildren();let d=t.some(_=>!Number.isInteger(_));if(this.datas.dimension<=1){const _=[];if(l==="RG"||l==="IN"||d&&l!=="DE"){const[c,o]=this.datas.range;for(let g=0;g<t.length;g++)_.push([u(s[g],r[0][0],r[0][1],0,e[0]-this.padding[0]*2)+this.padding[0],u(t[g],c,o,0,e[1]-this.padding[1]*2)+this.padding[1]]);const i=S(g=>{let h="";for(let m=0;m<g.length;m++)h+=`${m===0?"M":"L"}${g[m][0]},${g[m][1]}`;return h},"line"),p=document.createElementNS("http://www.w3.org/2000/svg","path");p.setAttribute("stroke","red"),p.setAttribute("fill-opacity",0),p.setAttribute("d",i(_)),this._r_tile.appendChild(p)}else{_.push([],[]);for(let o=0,i=0;i<e[0]+n[0];o++,i+=n[0])_[0][o]=t[o],_[1][o]=t[o];const c=document.createElementNS("http://www.w3.org/2000/svg","g");this._r_tile.appendChild(c),new k(c,_,[n[0],1e3],d)}}else if(this.datas.dimension===2){let _=0;const c=[];for(let p=0,g=0;g<e[0]+n[0];p++,g+=n[0]){this._select[1]===0&&(c[p]=[]);for(let h=0,m=0;m<e[1]-n[1]/100;h++,m+=n[1])this._select[1]===0?c[p][h]=t[_++]:(c[h]||(c[h]=[]),c[h][p]=t[_++])}!d&&t.length>100&&(d||=new Set(t).size>100);const o=document.createElementNS("http://www.w3.org/2000/svg","g");this._r_tile.appendChild(o);const i=this._select[1]===0?[n[1]/e[1]*e[0],n[0]/e[0]*e[1]]:n;new k(o,c,i,d||l==="DE")}else{const _=document.createElementNS("http://www.w3.org/2000/svg","g");if(this._r_tile.appendChild(_),this._r.querySelector("image"))this._roundcolor=t.map(c=>v(c)),this._lastpred=null,this._render(),this._lastpred=t;else{const c=t.every(Number.isInteger);for(let o=0;o<t.length;o++){const i=new M(_,this._p[o]);i.color=v(t[o]),c&&this.datas.outputCategoryNames?this._p[o].title=`true: ${this.datas.originalY[o]}
pred: ${this.datas.outputCategoryNames[t[o]-1]}`:this._p[o].title=`true: ${this.datas.y[o]}
pred: ${t[o]}`}}this._observe_target=this._r_tile}}terminate(){this._observer.disconnect(),this.setting.render.removeItem("scatter"),super.terminate()}}
