var k=Object.defineProperty;var v=(y,t)=>k(y,"name",{value:t,configurable:!0});import T from"./base.js";import{getCategoryColor as b,specialCategory as S}from"../utils.js";import{DataPoint as E,DataCircle as x,DataLine as z,DataHulls as M}from"./util/figure.js";import R from"../../lib/util/matrix.js";const u=v(function(y,t,i,s,e){return!isFinite(t)||!isFinite(i)||t===i?(e+s)/2:(y-t)/(i-t)*(e-s)+s},"scale");export default class D extends T{static{v(this,"ScatterRenderer")}constructor(t){super(t),this._size=[960,500];const i=this.setting.render.addItem("scatter"),s=document.createElement("div");s.id="plot-area",i.appendChild(s),this._menu=document.createElement("div"),s.appendChild(this._menu),this._root=document.createElementNS("http://www.w3.org/2000/svg","svg"),s.appendChild(this._root),this._root.style.border="1px solid #000000",this._root.setAttribute("width",`${this._size[0]}px`),this._root.setAttribute("height",`${this._size[1]}px`),this._svg=document.createElementNS("http://www.w3.org/2000/svg","g"),this._svg.style.transform="scale(1, -1) translate(0, -100%)",this._root.appendChild(this._svg),this._grid=document.createElementNS("http://www.w3.org/2000/svg","g"),this._grid.setAttribute("opacity",.3),this._svg.appendChild(this._grid);const e=document.createElementNS("http://www.w3.org/2000/svg","g");e.classList.add("points"),this._svg.appendChild(e),this._r=document.createElementNS("http://www.w3.org/2000/svg","g"),this._r.classList.add("datas"),e.appendChild(this._r),this._p=[],this._pad=10,this._clip_pad=-1/0,this._pred_count=0,this._select=[0,1],this._observe_target=null,this._observer=new MutationObserver(n=>{this._observe_target&&this._p.forEach((h,r)=>h.title=this.datas.labels[r])}),this._observer.observe(this._svg,{childList:!0})}get svg(){return this._svg}get width(){return this._size[0]}set width(t){this._size[0]=t,this._root.setAttribute("width",`${t}px`)}get height(){return this._size[1]}set height(t){this._size[1]=t,this._root.setAttribute("height",`${t}px`)}get padding(){return Array.isArray(this._pad)?this._pad:[this._pad,this._pad]}set padding(t){this._pad=t??0,this.render()}set clipPadding(t){this._clip_pad=t,this.render()}get points(){return this._p}set trainResult(t){const i=this._manager.platform.task;if(i==="AD"){if(this._svg.querySelectorAll(".tile").length===0){const e=document.createElementNS("http://www.w3.org/2000/svg","g");e.classList.add("tile","anormal_point"),this._svg.insertBefore(e,this._svg.firstChild)}const s=this._svg.querySelector(".tile");s.replaceChildren(),t.forEach((e,n)=>{if(e){const h=new x(s,this.points[n]);h.color=b(S.error)}})}else if(i==="SC"){if(this._svg.querySelectorAll(".tile").length===0){const e=document.createElementNS("http://www.w3.org/2000/svg","g");e.classList.add("tile"),this._svg.insertBefore(e,this._svg.firstChild)}const s=this._svg.querySelector(".tile");s.replaceChildren(),t.forEach((e,n)=>{const h=new x(s,this.points[n]);h.color=b(e)})}else if(i==="DR"||i==="FS"||i==="TF"){if(this._svg.querySelectorAll(".tile").length===0){const l=document.createElementNS("http://www.w3.org/2000/svg","g");l.classList.add("tile"),l.setAttribute("opacity",.5),this._svg.insertBefore(l,this._svg.firstChild)}const s=this._svg.querySelector(".tile");s.replaceChildren();const e=t[0].length;let n=t;e===1&&(n=n.map(l=>[l,0]));let h=[],r=[];for(let l=0;l<n[0].length;l++){const m=n.map(f=>f[l]);h.push(Math.max(...m)),r.push(Math.min(...m))}const d=this.datas.dimension<=1?[this.height,this.height]:[this.width,this.height],p=d.map((l,m)=>(l-10)/(h[m]-r[m]));let c=Math.min(...p);const o=[5,5];for(let l=0;l<p.length;l++)(!isFinite(c)||p[l]>c)&&(isFinite(p[l])?o[l]+=(p[l]-c)*(h[l]-r[l])/2:o[l]=d[l]/2-r[l]);isFinite(c)||(c=0);let a=1/0,g=null;const _=R.fromArray(this.points.map(l=>l.at));for(let l=0;l<(this.datas.dimension<=1?1:2**e);l++){const m=l.toString(2).padStart(e,"0").split("").map(A=>!!+A),f=n.map(A=>A.map((L,w)=>((m[w]?h[w]-L+r[w]:L)-r[w])*c+o[w])),C=R.fromArray(f);C.sub(_);const N=C.norm();N<a&&(a=N,g=f)}g.forEach((l,m)=>{const f=new E(s,this.datas.dimension<=1?[this.points[m].at[0],l[0]]:l,this.points[m].category);f.radius=2,new z(s,this.points[m],f).setRemoveListener(()=>f.remove())})}else if(i==="GR"){if(this._svg.querySelectorAll(".tile").length===0){const n=document.createElementNS("http://www.w3.org/2000/svg","g");n.classList.add("tile","generated"),n.setAttribute("opacity",.5),this._svg.insertBefore(n,this._svg.firstChild)}const s=this._svg.querySelector(".tile.generated");s.replaceChildren();let e=null;Array.isArray(t)&&t.length===2&&Array.isArray(t[0])&&Array.isArray(t[0][0])&&([t,e]=t),t.forEach((n,h)=>{let r=new E(s,this.toPoint(n),e?e[h][0]:0);r.radius=2})}}get scale(){const t=this.datas.domain,i=[this.width,this.height],[s,e]=this.datas.range,n=this._select.map((h,r)=>i[r]/(t[h][1]-t[h][0]));return this._select.length===1&&(n[1]=i[1]/(e-s)),n}init(){this._lastpred=null,this._r_tile?.remove(),this._svg.querySelectorAll(".tile").forEach(t=>t.remove()),this._grid.replaceChildren(),this._make_selector()}_make_selector(){let t=this.datas?.columnNames||[],i=this._menu.querySelector("div.column-selector");if(!i&&t.length>0?(i=document.createElement("div"),i.classList.add("column-selector"),this._menu.appendChild(i)):i?.replaceChildren(),t.length<1)this._select=this.datas?.dimension===1?[0]:[0,1];else if(t.length===1){const s=document.createElement("table");s.style.borderCollapse="collapse",i.appendChild(s);let e=s.insertRow();e.style.textAlign="center",e.insertCell(),e.insertCell().innerHTML="&rarr;",e=s.insertRow();const n=e.insertCell();n.innerText=t[0],n.style.textAlign="right";const h=e.insertCell(),r=document.createElement("input");r.type="radio",r.name="data-d1",r.checked=!0,h.appendChild(r),this._select=this.datas.dimension===1?[0]:[0,1]}else if(t.length<=4){const s=document.createElement("table");s.style.borderCollapse="collapse",i.appendChild(s);let e=s.insertRow();e.style.textAlign="center",e.insertCell(),e.insertCell().innerHTML="&rarr;",e.insertCell().innerHTML="&uarr;";const n=[],h=[];for(let r=0;r<t.length;r++){e=s.insertRow();const d=e.insertCell();d.innerText=t[r],d.style.textAlign="right";const p=e.insertCell(),c=document.createElement("input");c.type="radio",c.name="data-d1",c.onchange=()=>{this._select[1]===r&&(h[this._select[1]].checked=!1,h[this._select[0]].checked=!0,this._select[1]=this._select[0]),this._select[0]=r,this.render()},p.appendChild(c),n.push(c);const o=e.insertCell(),a=document.createElement("input");a.type="radio",a.name="data-d2",a.onchange=()=>{this._select[0]===r&&(n[this._select[0]].checked=!1,n[this._select[1]].checked=!0,this._select[0]=this._select[1]),this._select[1]=r,this.render()},o.appendChild(a),h.push(a)}n[0].checked=!0,h[1].checked=!0,this._select=[0,1]}else{t=t.map(r=>""+r);const s=document.createElement("span");s.innerHTML="&rarr;",i.appendChild(s);const e=document.createElement("select");e.onchange=()=>{const r=t.indexOf(e.value);this._select[1]===r&&(h.value=t[this._select[0]],this._select[1]=this._select[0]),this._select[0]=r,this.render()};for(const r of t){const d=document.createElement("option");d.value=r,d.innerText=r,e.appendChild(d)}e.value=t[0],i.appendChild(e);const n=document.createElement("span");n.innerHTML="&uarr;",n.style.display="inline-block",i.appendChild(n);const h=document.createElement("select");h.onchange=()=>{const r=t.indexOf(h.value);this._select[0]===r&&(e.value=t[this._select[1]],this._select[0]=this._select[1]),this._select[1]=r,this.render()};for(const r of t){const d=document.createElement("option");d.value=r,d.innerText=r,h.appendChild(d)}h.value=t[1],i.appendChild(h),this._select=[0,1]}}_clip(t){if(this._clip_pad===-1/0)return t;const i=[this.width,this.height];for(let s=0;s<t.length;s++)t[s]<this._clip_pad?t[s]=this._clip_pad:i[s]-this._clip_pad<t[s]&&(t[s]=i[s]-this._clip_pad);return t}toPoint(t){const i=this.datas.domain,s=[this.width,this.height],[e,n]=this.datas.range,h=this._select.map((r,d)=>u(t[r],i[r][0],i[r][1],0,s[d]-this.padding[d]*2)+this.padding[d]);return h.length===1&&t.length>1&&(h[1]=u(t[1],e,n,0,s[1]-this.padding[1]*2)+this.padding[1]),h.map(r=>isNaN(r)?0:r)}_render(){if(!this.datas||this.datas.length===0){this._p.map(a=>a.remove()),this._p.length=0;return}const t=this.datas.length,i=this.datas.x,s=this.datas.domain,e=this.datas.y,n=this._size,h=this.datas.index,r=this.datas.indexRange,[d,p]=this.datas.range,c=[];for(let a=0;a<t;a++)if(this.datas.dimension===0){const g=isNaN(h[a])?u(a,0,t,0,n[0]-this.padding[0]*2):u(h[a],r[0],r[1],0,n[0]-this.padding[0]*2);c.push([g+this.padding[0],u(e[a],d,p,0,n[1]-this.padding[1]*2)+this.padding[1]])}else this.datas.dimension===1?c.push([u(i[a][0],s[0][0],s[0][1],0,n[0]-this.padding[0]*2)+this.padding[0],u(e[a],d,p,0,n[1]-this.padding[1]*2)+this.padding[1]]):c.push(this._select.map((g,_)=>u(i[a][g],s[g][0],s[g][1],0,n[_]-this.padding[_]*2)+this.padding[_]));const o=Math.max(1,Math.min(5,Math.floor(2e3/t)));for(let a=0;a<t;a++){const g=this._clip(c[a]),_=this.datas.dimension<=1?0:this.datas.y[a];if(this._p[a]){const l=this._p[a].at;(l[0]!==g[0]||l[1]!==g[1])&&(this._p[a].at=g),this._p[a].category!==_&&(this._p[a].category=_)}else this._p[a]=new E(this._r,g,_);this._p[a].title=this.datas.labels[a],this._p[a].radius=o}for(let a=t;a<this._p.length;a++)this._p[a].remove();this._p.length=t,this._lastpred&&this.testResult(this._lastpred),this._renderGrid()}_renderGrid(){this._grid.replaceChildren();const t=this.datas.domain,i=this._size,[s,e]=this.datas.range;let n=[],h=[],r=[],d=[];this.datas.dimension===0?(r=this._getScales(s,e),d=[s,e]):this.datas.dimension===1?(n=this._getScales(t[0][0],t[0][1]),h=t[0],r=this._getScales(s,e),d=[s,e]):(n=this._getScales(t[this._select[0]][0],t[this._select[0]][1]),h=t[this._select[0]],r=this._getScales(t[this._select[1]][0],t[this._select[1]][1]),d=t[this._select[1]]);for(const p of n){const c=u(p,h[0],h[1],0,i[0]-this.padding[0]*2)+this.padding[0],o=document.createElementNS("http://www.w3.org/2000/svg","line");o.setAttribute("x1",c),o.setAttribute("x2",c),o.setAttribute("y1",0),o.setAttribute("y2",i[1]),o.setAttribute("stroke","gray");const a=document.createElementNS("http://www.w3.org/2000/svg","text");a.setAttribute("x",Math.max(c,10)),a.setAttribute("y",i[1]-5),a.setAttribute("fill","gray"),a.style.transform="scale(1, -1) translate(0, -100%)",a.innerHTML=p,this._grid.append(o,a)}for(const p of r){const c=u(+p,d[0],d[1],0,i[1]-this.padding[1]*2)+this.padding[1],o=document.createElementNS("http://www.w3.org/2000/svg","line");o.setAttribute("x1",0),o.setAttribute("x2",i[0]),o.setAttribute("y1",c),o.setAttribute("y2",c),o.setAttribute("stroke","gray");const a=document.createElementNS("http://www.w3.org/2000/svg","text");a.setAttribute("x",5),a.setAttribute("y",Math.min(i[1]-c,i[1]-10)),a.setAttribute("fill","gray"),a.style.transform="scale(1, -1) translate(0, -100%)",a.innerHTML=p,this._grid.append(o,a)}}_getScales(t,i){const s=i-t;if(s===0)return[];let e=Math.floor(Math.log10(s)),n=10**e;s/n<2?(n/=2,e--):s/n>5&&(n*=2);const h=i-i%n,r=[];for(let d=h;d>=t;d-=n)r.push(e<0?d.toFixed(-e):d);return r}testData(t){this._lastpred=null,Array.isArray(t)||(t=[t,t]),this._laststep=t;const i=[];if(this.datas.dimension===0){const n=this.datas.indexRange;i[0]=[isNaN(n[0])?0:n[0],isNaN(n[1])?this.datas.length:n[1]]}else i.push(...this.datas.domain);this._lastdomain=i;const s=[this.width,this.height],e=[];if(this.datas.dimension<=2)for(let n=0;n<s[0]+t[0];n+=t[0]){const h=u(n-this.padding[0],0,s[0]-this.padding[0]*2,i[0][0],i[0][1]);if(this.datas.dimension<=1)e.push([h]);else for(let r=0;r<s[1]-t[1]/100;r+=t[1]){const d=u(r-this.padding[1],0,s[1]-this.padding[1]*2,i[1][0],i[1][1]);e.push([h,d])}}else for(let n=0;n<this.datas.x.length;n++)e.push(this.datas.x[n].concat());return this._lasttiles=e,e}testResult(t){const i=this._laststep,s=this._lastdomain,e=[this.width,this.height],n=this._lasttiles,h=this._manager.platform.task;this._lastpred=t,h==="AD"&&(t=t.map(p=>p?S.error:S.errorRate(0))),this._r_tile?.remove(),this.datas.dimension===1&&(h==="RG"||h==="IN")?(this._r_tile=document.createElementNS("http://www.w3.org/2000/svg","g"),this._r_tile.classList.add("tile-render"),this._r_tile.setAttribute("opacity",1),this._svg.appendChild(this._r_tile)):(this._r_tile=document.createElementNS("http://www.w3.org/2000/svg","g"),this._r_tile.classList.add("tile-render"),this._r_tile.setAttribute("opacity",.5),this._svg.insertBefore(this._r_tile,this._svg.firstChild)),this._r_tile.replaceChildren();let d=t.some(p=>!Number.isInteger(p));if(this.datas.dimension<=1){const p=[];if(h==="IN"||d&&h!=="DE"){const[c,o]=this.datas.range;for(let _=0;_<t.length;_++)p.push([u(n[_],s[0][0],s[0][1],0,e[0]-this.padding[0]*2)+this.padding[0],u(t[_],c,o,0,e[1]-this.padding[1]*2)+this.padding[1]]);const a=v(_=>{let l="";for(let m=0;m<_.length;m++)l+=`${m===0?"M":"L"}${_[m][0]},${_[m][1]}`;return l},"line"),g=document.createElementNS("http://www.w3.org/2000/svg","path");g.setAttribute("stroke","red"),g.setAttribute("fill-opacity",0),g.setAttribute("d",a(p)),this._r_tile.appendChild(g)}else{p.push([],[]);for(let o=0,a=0;a<e[0]+i[0];o++,a+=i[0])p[0][o]=t[o],p[1][o]=t[o];const c=document.createElementNS("http://www.w3.org/2000/svg","g");this._r_tile.appendChild(c),new M(c,p,[i[0],1e3],d)}}else if(this.datas.dimension===2){let p=0;const c=[];for(let g=0,_=0;_<e[0]+i[0];g++,_+=i[0]){this._select[1]===0&&(c[g]=[]);for(let l=0,m=0;m<e[1]-i[1]/100;l++,m+=i[1])this._select[1]===0?c[g][l]=t[p++]:(c[l]||(c[l]=[]),c[l][g]=t[p++])}!d&&t.length>100&&(d||=new Set(t).size>100);const o=document.createElementNS("http://www.w3.org/2000/svg","g");this._r_tile.appendChild(o);const a=this._select[1]===0?[i[1]/e[1]*e[0],i[0]/e[0]*e[1]]:i;new M(o,c,a,d||h==="DE")}else{const p=document.createElementNS("http://www.w3.org/2000/svg","g");this._r_tile.appendChild(p);const c=t.every(Number.isInteger);for(let o=0;o<t.length;o++){const a=new x(p,this._p[o]);a.color=b(t[o]),c&&this.datas.outputCategoryNames?this._p[o].title=`true: ${this.datas.originalY[o]}
pred: ${this.datas.outputCategoryNames[t[o]-1]}`:this._p[o].title=`true: ${this.datas.y[o]}
pred: ${t[o]}`}this._observe_target=this._r_tile}}terminate(){this._observer.disconnect(),this.setting.render.removeItem("scatter"),super.terminate()}}
