import BaseRenderer from"./base.js";import{getCategoryColor,DataPoint,DataCircle,DataHulls}from"../utils.js";const scale=function(e,t,s,i,n){return isFinite(t)&&isFinite(s)&&t!==s?(e-t)/(s-t)*(n-i)+i:(n+i)/2};export default class ScatterRenderer extends BaseRenderer{constructor(e){if(super(e),this._r=this.setting.svg.select("g.points g.datas"),0===this._r.size()){const e=this.setting.svg.append("g").classed("points",!0);this._r=e.append("g").classed("datas",!0)}this._p=[],this._pad=10,this._clip_pad=-1/0,this._pred_count=0,this._observe_target=null,this._observer=new MutationObserver((e=>{this._observe_target&&this._p.forEach(((e,t)=>e.title=this.datas.labels[t]))})),this._observer.observe(this.setting.svg.node(),{childList:!0}),this._will_render=!1}get padding(){return Array.isArray(this._pad)?this._pad:[this._pad,this._pad]}set padding(e){this._pad=e,this.render()}set clipPadding(e){this._clip_pad=e,this.render()}get points(){return this._p}init(){this._make_selector()}_make_selector(){let e=this.datas?.columnNames||[],t=this.setting.render.configElement.querySelector("div.column-selector");if(!t&&e.length>0?(t=document.createElement("div"),t.classList.add("column-selector"),this.setting.render.configElement.appendChild(t)):t?.replaceChildren(),e.length<1)this._select=null;else if(1===e.length){const s=document.createElement("table");s.style.borderCollapse="collapse",t.appendChild(s);let i=document.createElement("tr");i.style.textAlign="center",i.appendChild(document.createElement("td"));const n=document.createElement("td");n.innerHTML="&rarr;",i.appendChild(n),s.appendChild(i),i=document.createElement("tr");const a=document.createElement("td");a.innerText=e[0],a.style.textAlign="right",i.appendChild(a);const d=document.createElement("td"),l=document.createElement("input");l.type="radio",l.name="data-d1",l.checked=!0,d.appendChild(l),i.appendChild(d),s.appendChild(i),this._select=null}else if(e.length<=4){const s=document.createElement("table");s.style.borderCollapse="collapse",t.appendChild(s);let i=document.createElement("tr");i.style.textAlign="center",i.appendChild(document.createElement("td"));const n=document.createElement("td");n.innerHTML="&rarr;",i.appendChild(n);const a=document.createElement("td");a.innerHTML="&uarr;",i.appendChild(a),s.appendChild(i);const d=[],l=[];for(let t=0;t<e.length;t++){i=document.createElement("tr");const n=document.createElement("td");n.innerText=e[t],n.style.textAlign="right",i.appendChild(n);const a=document.createElement("td"),h=document.createElement("input");h.type="radio",h.name="data-d1",h.onchange=()=>this.render(),a.appendChild(h),i.appendChild(a),d.push(h);const r=document.createElement("td"),o=document.createElement("input");o.type="radio",o.name="data-d2",o.onchange=()=>this.render(),r.appendChild(o),i.appendChild(r),l.push(o),s.appendChild(i)}d[0].checked=!0,l[1].checked=!0,this._select=()=>{const t=[];for(let s=0;s<e.length;s++)d[s].checked&&(t[0]=s),l[s].checked&&(t[1]=s);return t}}else{e=e.map((e=>""+e));const s=document.createElement("span");s.innerHTML="&rarr;",t.appendChild(s);const i=document.createElement("select");i.onchange=()=>this.render();for(const t of e){const e=document.createElement("option");e.value=t,e.innerText=t,i.appendChild(e)}i.value=e[0],t.appendChild(i);const n=document.createElement("span");n.innerHTML="&uarr;",n.style.display="inline-block",t.appendChild(n);const a=document.createElement("select");a.onchange=()=>this.render();for(const t of e){const e=document.createElement("option");e.value=t,e.innerText=t,a.appendChild(e)}a.value=e[1],t.appendChild(a),this._select=()=>[e.indexOf(i.value),e.indexOf(a.value)]}}_clip(e){if(this._clip_pad===-1/0)return e;const t=[this.width,this.height];for(let s=0;s<e.length;s++)e[s]<this._clip_pad?e[s]=this._clip_pad:t[s]-this._clip_pad<e[s]&&(e[s]=t[s]-this._clip_pad);return e}toPoint(e){const t=this._select?.()??(1===this.datas.dimension?[0]:[0,1]),s=this.datas.domain,i=[this.width,this.height],[n,a]=this.datas.range,d=t.map(((t,n)=>scale(e[t],s[t][0],s[t][1],0,i[n]-2*this.padding[n])+this.padding[n]));return 1===d.length&&e.length>1&&(d[1]=scale(e[1],n,a,0,i[1]-2*this.padding[1])+this.padding[1]),d.map((e=>isNaN(e)?0:e))}_render(){if(!this.datas||0===this.datas.length)return this._p.map((e=>e.remove())),void(this._p.length=0);const e=this._select?.()??(this.datas.dimension<=1?null:[0,1]),t=this.datas.length,s=this.datas.x,i=this.datas.domain,n=this.datas.y,a=[this.width,this.height],d=this.datas.index,l=this.datas.indexRange,[h,r]=this.datas.range,o=[];for(let p=0;p<t;p++)0===this.datas.dimension?o.push([scale(d[p],l[0],l[1],0,a[0]-2*this.padding[0])+this.padding[0],scale(n[p],h,r,0,a[1]-2*this.padding[1])+this.padding[1]]):1===this.datas.dimension?o.push([scale(s[p][0],i[0][0],i[0][1],0,a[0]-2*this.padding[0])+this.padding[0],scale(n[p],h,r,0,a[1]-2*this.padding[1])+this.padding[1]]):o.push(e.map(((e,t)=>scale(s[p][e],i[e][0],i[e][1],0,a[t]-2*this.padding[t])+this.padding[t])));const p=Math.max(1,Math.min(5,Math.floor(2e3/t)));for(let e=0;e<t;e++){const t=this._clip(o[e]),s=this.datas.dimension<=1?0:this.datas.y[e];if(this._p[e]){const i=this._p[e].at;i[0]===t[0]&&i[1]===t[1]||(this._p[e].at=t),this._p[e].category!==s&&(this._p[e].category=s)}else this._p[e]=new DataPoint(this._r,t,s);this._p[e].title=this.datas.labels[e],this._p[e].radius=p}for(let e=t;e<this._p.length;e++)this._p[e].remove();this._p.length=t}predict(e){Array.isArray(e)||(e=[e,e]);const t=0===this.datas.dimension?[this.datas.indexRange]:this.datas.domain,s=[this.width,this.height],i=[];if(this.datas.dimension<=2)for(let n=0;n<s[0]+e[0];n+=e[0]){const a=scale(n-this.padding[0],0,s[0]-2*this.padding[0],t[0][0],t[0][1]);if(this.datas.dimension<=1)i.push([a]);else for(let n=0;n<s[1]-e[1]/100;n+=e[1]){const e=scale(n-this.padding[1],0,s[1]-2*this.padding[1],t[1][0],t[1][1]);i.push([a,e])}}else for(let e=0;e<this.datas.x.length;e++)i.push(this.datas.x[e].concat());const n=this.setting.vue.mlTask;return[i,(a,d)=>{d.selectAll("*").remove();let l=a.some((e=>!Number.isInteger(e)));if(this.datas.dimension<=1){const h=[];if("IN"===n||l&&"DE"!==n){const[e,n]=this.datas.range;for(let d=0;d<a.length;d++)h.push([scale(i[d],t[0][0],t[0][1],0,s[0]-2*this.padding[0])+this.padding[0],scale(a[d],e,n,0,s[1]-2*this.padding[1])+this.padding[1]]);const l=d3.line().x((e=>e[0])).y((e=>e[1]));d.append("path").attr("stroke","red").attr("fill-opacity",0).attr("d",l(h))}else{h.push([],[]);for(let t=0,i=0;i<s[0]+e[0];t++,i+=e[0])h[0][t]=a[t],h[1][t]=a[t];const t=d.append("g");new DataHulls(t,h,[e[0],1e3],l)}}else if(2===this.datas.dimension){let t=0;const i=[];for(let n=0,d=0;d<s[0]+e[0];n++,d+=e[0])for(let d=0,l=0;l<s[1]-e[1]/100;d++,l+=e[1])i[d]||(i[d]=[]),i[d][n]=a[t++];!l&&a.length>100&&(l|=new Set(a).size>100);const h=d.append("g");new DataHulls(h,i,e,l||"DE"===n)}else{const e=d.append("g"),t=a.every(Number.isInteger);for(let s=0;s<a.length;s++){new DataCircle(e,this._p[s]).color=getCategoryColor(a[s]),t&&this.datas.outputCategoryNames?this._p[s].title=`true: ${this.datas.originalY[s]}\npred: ${this.datas.outputCategoryNames[a[s]-1]}`:this._p[s].title=`true: ${this.datas.y[s]}\npred: ${a[s]}`}this._observe_target=d}}]}terminate(){this._p.forEach((e=>e.remove())),this._observer.disconnect(),this.setting.render.configElement.replaceChildren(),super.terminate()}}