import BaseRenderer from"./base.js";import{getCategoryColor,DataPoint,DataCircle,DataHulls}from"../utils.js";const scale=function(t,e,s,i,n){return isFinite(e)&&isFinite(s)&&e!==s?(t-e)/(s-e)*(n-i)+i:(n+i)/2};export default class ScatterRenderer extends BaseRenderer{constructor(t){super(t),this._size=[960,500];const e=this.setting.render.addItem("scatter"),s=document.createElement("div");if(s.id="plot-area",e.appendChild(s),this._menu=document.createElement("div"),s.appendChild(this._menu),this._root=d3.select(s).append("svg").style("border","1px solid #000000").attr("width",`${this._size[0]}px`).attr("height",`${this._size[1]}px`),this._svg=this._root.append("g").style("transform","scale(1, -1) translate(0, -100%)"),this._r=this._svg.select("g.points g.datas"),0===this._r.size()){const t=this._svg.append("g").classed("points",!0);this._r=t.append("g").classed("datas",!0)}this._p=[],this._pad=10,this._clip_pad=-1/0,this._pred_count=0,this._select=[0,1],this._observe_target=null,this._observer=new MutationObserver((t=>{this._observe_target&&this._p.forEach(((t,e)=>t.title=this.datas.labels[e]))})),this._observer.observe(this._svg.node(),{childList:!0})}get svg(){return this._svg}get width(){return this._size[0]}set width(t){this._size[0]=t,this._root.attr("width",`${t}px`)}get height(){return this._size[1]}set height(t){this._size[1]=t,this._root.attr("height",`${t}px`)}get padding(){return Array.isArray(this._pad)?this._pad:[this._pad,this._pad]}set padding(t){this._pad=t,this.render()}set clipPadding(t){this._clip_pad=t,this.render()}get points(){return this._p}init(){this._make_selector()}_make_selector(){let t=this.datas?.columnNames||[],e=this._menu.querySelector("div.column-selector");if(!e&&t.length>0?(e=document.createElement("div"),e.classList.add("column-selector"),this._menu.appendChild(e)):e?.replaceChildren(),t.length<1)this._select=1===this.datas?.dimension?[0]:[0,1];else if(1===t.length){const s=document.createElement("table");s.style.borderCollapse="collapse",e.appendChild(s);let i=document.createElement("tr");i.style.textAlign="center",i.appendChild(document.createElement("td"));const n=document.createElement("td");n.innerHTML="&rarr;",i.appendChild(n),s.appendChild(i),i=document.createElement("tr");const a=document.createElement("td");a.innerText=t[0],a.style.textAlign="right",i.appendChild(a);const d=document.createElement("td"),h=document.createElement("input");h.type="radio",h.name="data-d1",h.checked=!0,d.appendChild(h),i.appendChild(d),s.appendChild(i),this._select=1===this.datas.dimension?[0]:[0,1]}else if(t.length<=4){const s=document.createElement("table");s.style.borderCollapse="collapse",e.appendChild(s);let i=document.createElement("tr");i.style.textAlign="center",i.appendChild(document.createElement("td"));const n=document.createElement("td");n.innerHTML="&rarr;",i.appendChild(n);const a=document.createElement("td");a.innerHTML="&uarr;",i.appendChild(a),s.appendChild(i);const d=[],h=[];for(let e=0;e<t.length;e++){i=document.createElement("tr");const n=document.createElement("td");n.innerText=t[e],n.style.textAlign="right",i.appendChild(n);const a=document.createElement("td"),l=document.createElement("input");l.type="radio",l.name="data-d1",l.onchange=()=>{this._select[1]===e&&(h[this._select[1]].checked=!1,h[this._select[0]].checked=!0,this._select[1]=this._select[0]),this._select[0]=e,this.render()},a.appendChild(l),i.appendChild(a),d.push(l);const r=document.createElement("td"),c=document.createElement("input");c.type="radio",c.name="data-d2",c.onchange=()=>{this._select[0]===e&&(d[this._select[0]].checked=!1,d[this._select[1]].checked=!0,this._select[0]=this._select[1]),this._select[1]=e,this.render()},r.appendChild(c),i.appendChild(r),h.push(c),s.appendChild(i)}d[0].checked=!0,h[1].checked=!0,this._select=[0,1]}else{t=t.map((t=>""+t));const s=document.createElement("span");s.innerHTML="&rarr;",e.appendChild(s);const i=document.createElement("select");i.onchange=()=>{const e=t.indexOf(i.value);this._select[1]===e&&(a.value=t[this._select[0]],this._select[1]=this._select[0]),this._select[0]=e,this.render()};for(const e of t){const t=document.createElement("option");t.value=e,t.innerText=e,i.appendChild(t)}i.value=t[0],e.appendChild(i);const n=document.createElement("span");n.innerHTML="&uarr;",n.style.display="inline-block",e.appendChild(n);const a=document.createElement("select");a.onchange=()=>{const e=t.indexOf(a.value);this._select[0]===e&&(i.value=t[this._select[1]],this._select[0]=this._select[1]),this._select[1]=e,this.render()};for(const e of t){const t=document.createElement("option");t.value=e,t.innerText=e,a.appendChild(t)}a.value=t[1],e.appendChild(a),this._select=[0,1]}}_clip(t){if(this._clip_pad===-1/0)return t;const e=[this.width,this.height];for(let s=0;s<t.length;s++)t[s]<this._clip_pad?t[s]=this._clip_pad:e[s]-this._clip_pad<t[s]&&(t[s]=e[s]-this._clip_pad);return t}toPoint(t){const e=this.datas.domain,s=[this.width,this.height],[i,n]=this.datas.range,a=this._select.map(((i,n)=>scale(t[i],e[i][0],e[i][1],0,s[n]-2*this.padding[n])+this.padding[n]));return 1===a.length&&t.length>1&&(a[1]=scale(t[1],i,n,0,s[1]-2*this.padding[1])+this.padding[1]),a.map((t=>isNaN(t)?0:t))}_render(){if(!this.datas||0===this.datas.length)return this._p.map((t=>t.remove())),void(this._p.length=0);const t=this.datas.length,e=this.datas.x,s=this.datas.domain,i=this.datas.y,n=this._size,a=this.datas.index,d=this.datas.indexRange,[h,l]=this.datas.range,r=[];for(let c=0;c<t;c++)if(0===this.datas.dimension){const e=isNaN(a[c])?scale(c,0,t,0,n[0]-2*this.padding[0]):scale(a[c],d[0],d[1],0,n[0]-2*this.padding[0]);r.push([e+this.padding[0],scale(i[c],h,l,0,n[1]-2*this.padding[1])+this.padding[1]])}else 1===this.datas.dimension?r.push([scale(e[c][0],s[0][0],s[0][1],0,n[0]-2*this.padding[0])+this.padding[0],scale(i[c],h,l,0,n[1]-2*this.padding[1])+this.padding[1]]):r.push(this._select.map(((t,i)=>scale(e[c][t],s[t][0],s[t][1],0,n[i]-2*this.padding[i])+this.padding[i])));const c=Math.max(1,Math.min(5,Math.floor(2e3/t)));for(let e=0;e<t;e++){const t=this._clip(r[e]),s=this.datas.dimension<=1?0:this.datas.y[e];if(this._p[e]){const i=this._p[e].at;i[0]===t[0]&&i[1]===t[1]||(this._p[e].at=t),this._p[e].category!==s&&(this._p[e].category=s)}else this._p[e]=new DataPoint(this._r,t,s);this._p[e].title=this.datas.labels[e],this._p[e].radius=c}for(let e=t;e<this._p.length;e++)this._p[e].remove();this._p.length=t}predict(t){Array.isArray(t)||(t=[t,t]);const e=[];if(0===this.datas.dimension){const t=this.datas.indexRange;e[0]=[isNaN(t[0])?0:t[0],isNaN(t[1])?this.datas.length:t[1]]}else e.push(...this.datas.domain);const s=[this.width,this.height],i=[];if(this.datas.dimension<=2)for(let n=0;n<s[0]+t[0];n+=t[0]){const a=scale(n-this.padding[0],0,s[0]-2*this.padding[0],e[0][0],e[0][1]);if(this.datas.dimension<=1)i.push([a]);else for(let n=0;n<s[1]-t[1]/100;n+=t[1]){const t=scale(n-this.padding[1],0,s[1]-2*this.padding[1],e[1][0],e[1][1]);i.push([a,t])}}else for(let t=0;t<this.datas.x.length;t++)i.push(this.datas.x[t].concat());const n=this.setting.vue.mlTask;return[i,(a,d)=>{d.selectAll("*").remove();let h=a.some((t=>!Number.isInteger(t)));if(this.datas.dimension<=1){const l=[];if("IN"===n||h&&"DE"!==n){const[t,n]=this.datas.range;for(let d=0;d<a.length;d++)l.push([scale(i[d],e[0][0],e[0][1],0,s[0]-2*this.padding[0])+this.padding[0],scale(a[d],t,n,0,s[1]-2*this.padding[1])+this.padding[1]]);const h=d3.line().x((t=>t[0])).y((t=>t[1]));d.append("path").attr("stroke","red").attr("fill-opacity",0).attr("d",h(l))}else{l.push([],[]);for(let e=0,i=0;i<s[0]+t[0];e++,i+=t[0])l[0][e]=a[e],l[1][e]=a[e];const e=d.append("g");new DataHulls(e,l,[t[0],1e3],h)}}else if(2===this.datas.dimension){let e=0;const i=[];for(let n=0,d=0;d<s[0]+t[0];n++,d+=t[0])for(let d=0,h=0;h<s[1]-t[1]/100;d++,h+=t[1])i[d]||(i[d]=[]),i[d][n]=a[e++];!h&&a.length>100&&(h|=new Set(a).size>100);const l=d.append("g");new DataHulls(l,i,t,h||"DE"===n)}else{const t=d.append("g"),e=a.every(Number.isInteger);for(let s=0;s<a.length;s++){new DataCircle(t,this._p[s]).color=getCategoryColor(a[s]),e&&this.datas.outputCategoryNames?this._p[s].title=`true: ${this.datas.originalY[s]}\npred: ${this.datas.outputCategoryNames[a[s]-1]}`:this._p[s].title=`true: ${this.datas.y[s]}\npred: ${a[s]}`}this._observe_target=d}}]}terminate(){this._observer.disconnect(),this.setting.render.removeItem("scatter"),super.terminate()}}