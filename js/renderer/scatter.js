import BaseRenderer from"./base.js";const scale=function(t,e,s,i,a){return isFinite(e)&&isFinite(s)&&e!==s?(t-e)/(s-e)*(a-i)+i:(a+i)/2};export default class ScatterRenderer extends BaseRenderer{constructor(t){if(super(t),this._r=this.setting.svg.select("g.points g.datas"),0===this._r.size()){const t=this.setting.svg.append("g").classed("points",!0);this._r=t.append("g").classed("datas",!0)}this._p=[],this._pad=10,this._clip_pad=-1/0,this._pred_count=0,this._observe_target=null,this._observer=new MutationObserver((t=>{this._observe_target&&this._p.forEach(((t,e)=>t.title=this.datas._categorical_output?this.datas._output_category_names[this.datas.y[e]-1]:this.datas.y[e]))})),this._observer.observe(this.setting.svg.node(),{childList:!0}),this._will_render=!1}get padding(){return Array.isArray(this._pad)?this._pad:[this._pad,this._pad]}set padding(t){this._pad=t,this.render()}set clipPadding(t){this._clip_pad=t,this.render()}get points(){return this._p}init(){this._make_selector()}_make_selector(){let t=this.datas?.columnNames||[],e=this.setting.render.configElement.select("div.column-selector");if(0===e.size()&&t.length>0?e=this.setting.render.configElement.append("div").classed("column-selector",!0):e.selectAll("*").remove(),t.length<=2)this._select=null;else if(t.length<=4){const s=e.append("table").style("border-collapse","collapse");let i=s.append("tr").style("text-align","center");i.append("td"),i.append("td").text(">"),i.append("td").text("V").style("transform","rotate(180deg");const a=[],n=[];for(let e=0;e<this.datas.dimension;e++){i=s.append("tr"),s.append("td").text(t[e]).style("text-align","right");const d=s.append("td").append("input").attr("type","radio").attr("name","data-d1").on("change",(()=>this.render()));a.push(d);const r=s.append("td").append("input").attr("type","radio").attr("name","data-d2").on("change",(()=>this.render()));n.push(r)}a[0].property("checked",!0),n[1].property("checked",!0),this._select=()=>{const t=[];for(let e=0;e<this.datas.dimension;e++)a[e].property("checked")&&(t[0]=e),n[e].property("checked")&&(t[1]=e);return t}}else{t=t.map((t=>""+t)),e.append("span").text(">");const s=e.append("select").on("change",(()=>this.render()));s.selectAll("option").data(t).enter().append("option").attr("value",(t=>t)).text((t=>t)),s.property("value",t[0]),e.append("span").text("V").style("transform","rotate(180deg").style("display","inline-block");const i=e.append("select").on("change",(()=>this.render()));i.selectAll("option").data(t).enter().append("option").attr("value",(t=>t)).text((t=>t)),i.property("value",t[1]),this._select=()=>[t.indexOf(s.property("value")),t.indexOf(i.property("value"))]}}_clip(t){if(this._clip_pad===-1/0)return t;const e=[this.width,this.height];for(let s=0;s<t.length;s++)t[s]<this._clip_pad?t[s]=this._clip_pad:e[s]-this._clip_pad<t[s]&&(t[s]=e[s]-this._clip_pad);return t}toPoint(t){const e=this._select?.()??(1===this.datas.dimension?[0]:[0,1]),s=this.datas.domain,i=[this.width,this.height],[a,n]=this.datas.range,d=e.map(((e,a)=>scale(t[e],s[e][0],s[e][1],0,i[a]-2*this.padding[a])+this.padding[a]));return 1===d.length&&t.length>1&&(d[1]=scale(t[1],a,n,0,i[1]-2*this.padding[1])+this.padding[1]),d.map((t=>isNaN(t)?0:t))}_render(){if(!this.datas||0===this.datas.dimension)return this._p.map((t=>t.remove())),void(this._p.length=0);const t=this._select?.()??(1===this.datas.dimension?[0]:[0,1]),e=this.datas.length,s=this.datas.x,i=this.datas.domain,a=[this.width,this.height],[n,d]=this.datas.range,r=Math.max(1,Math.min(5,Math.floor(2e3/e)));for(let h=0;h<e;h++){const e=t.map(((t,e)=>scale(s[h][t],i[t][0],i[t][1],0,a[e]-2*this.padding[e])+this.padding[e]));1===e.length&&(e[1]=scale(this.datas.y[h],n,d,0,a[1]-2*this.padding[1])+this.padding[1]);const p=this._clip(e),o=1===this.datas.dimension?0:this.datas.y[h];if(this._p[h]){const t=this._p[h].at;t[0]===p[0]&&t[1]===p[1]||(this._p[h].at=p),this._p[h].category!==o&&(this._p[h].category=o)}else this._p[h]=new DataPoint(this._r,p,o);this._p[h].title=this.datas._categorical_output?this.datas._output_category_names[this.datas.y[h]-1]:this.datas.y[h],this._p[h].radius=r}for(let t=e;t<this._p.length;t++)this._p[t].remove();this._p.length=e}predict(t){Array.isArray(t)||(t=[t,t]);const e=this.datas.domain,s=[this.width,this.height],i=[];if(this.datas.dimension<=2)for(let a=0;a<s[0]+t[0];a+=t[0]){const n=scale(a-this.padding[0],0,s[0]-2*this.padding[0],e[0][0],e[0][1]);if(1===this.datas.dimension)i.push([n]);else for(let a=0;a<s[1]-t[1]/100;a+=t[1]){const t=scale(a-this.padding[1],0,s[1]-2*this.padding[1],e[1][0],e[1][1]);i.push([n,t])}}else for(let t=0;t<this.datas.x.length;t++)i.push(this.datas.x[t].concat());const a=this.setting.vue.mlTask;return[i,(n,d)=>{d.selectAll("*").remove();let r=n.some((t=>!Number.isInteger(t)));if(1===this.datas.dimension){const h=[];if("IN"===a||r&&"DE"!==a){const[t,a]=this.datas.range;for(let d=0;d<n.length;d++)h.push([scale(i[d],e[0][0],e[0][1],0,s[0]-2*this.padding[0])+this.padding[0],scale(n[d],t,a,0,s[1]-2*this.padding[1])+this.padding[1]]);const r=d3.line().x((t=>t[0])).y((t=>t[1]));d.append("path").attr("stroke","red").attr("fill-opacity",0).attr("d",r(h))}else{h.push([],[]);for(let e=0,i=0;i<s[0]+t[0];e++,i+=t[0])h[0][e]=n[e],h[1][e]=n[e];const e=d.append("g");new DataHulls(e,h,[t[0],1e3],r)}}else if(2===this.datas.dimension){let e=0;const i=[];for(let a=0,d=0;d<s[0]+t[0];a++,d+=t[0])for(let d=0,r=0;r<s[1]-t[1]/100;d++,r+=t[1])i[d]||(i[d]=[]),i[d][a]=n[e++];!r&&n.length>100&&(r|=new Set(n).size>100);const h=d.append("g");new DataHulls(h,i,t,r||"DE"===a)}else{const t=d.append("g"),e=n.every(Number.isInteger);for(let s=0;s<n.length;s++){new DataCircle(t,this._p[s]).color=getCategoryColor(n[s]),e&&this.datas._categorical_output?this._p[s].title=`true: ${this.datas._output_category_names[this.datas.y[s]-1]}\npred: ${this.datas._output_category_names[n[s]-1]}`:this._p[s].title=`true: ${this.datas.y[s]}\npred: ${n[s]}`}this._observe_target=d}}]}terminate(){this._p.forEach((t=>t.remove())),this._observer.disconnect(),this.setting.render.configElement.selectAll("*").remove(),super.terminate()}}