import BaseRenderer from"./base.js";const scale=function(t,e,s,i,a){return isFinite(e)&&isFinite(s)&&e!==s?(t-e)/(s-e)*(a-i)+i:(a+i)/2};export default class LineRenderer extends BaseRenderer{constructor(t){if(super(t),this._r=this.svg.select("g.points g.datas"),0===this._r.size()){const t=this.svg.append("g").classed("points",!0);this._r=t.append("g").classed("datas",!0)}this._pathg=this.svg.select("g.ts-render-path"),0===this._pathg.size()&&(this._pathg=this.svg.insert("g",":first-child").classed("ts-render-path",!0)),this._pathg.selectAll("g.ts-render-path *").remove(),this._path=this._pathg.append("path").attr("stroke","black").attr("fill-opacity",0).style("pointer-events","none"),this._p=[],this._pad=10,this._clip_pad=-1/0,this._pred_count=0,this._observe_target=null,this._observer=new MutationObserver((t=>{this._observe_target&&this._p.forEach(((t,e)=>t.title=this.datas._categorical_output?this.datas._output_category_names[this.datas.y[e]-1]:this.datas.y[e]))})),this._observer.observe(this.setting.svg.node(),{childList:!0}),this._will_render=!1}get padding(){return Array.isArray(this._pad)?this._pad:[this._pad,this._pad]}set padding(t){this._pad=t,this.render()}set clipPadding(t){this._clip_pad=t,this.render()}get points(){return this._p}init(){this._make_selector()}_make_selector(){let t=this.datas?.columnNames||[],e=this.setting.render.configElement.select("div.column-selector");if(0===e.size()&&t.length>0?e=this.setting.render.configElement.append("div").classed("column-selector",!0):e.selectAll("*").remove(),t.length<=1)this._select=null;else if(t.length<=4){const s=e.append("table").style("border-collapse","collapse");let i=s.append("tr").style("text-align","center");i.append("td"),i.append("td").text(">");const a=[];for(let e=0;e<this.datas.dimension;e++){i=s.append("tr"),s.append("td").text(t[e]).style("text-align","right");const h=s.append("td").append("input").attr("type","radio").attr("name","data-d1").on("change",(()=>this._manager.platform.render()));a.push(h)}a[0].property("checked",!0),this._select=()=>{const t=[];for(let e=0;e<this.datas.dimension;e++)a[e].property("checked")&&(t[0]=e);return t}}else{t=t.map((t=>""+t)),e.append("span").text(">");const s=e.append("select").on("change",(()=>this._manager.platform.render()));s.selectAll("option").data(t).enter().append("option").attr("value",(t=>t)).text((t=>t)),s.property("value",t[0]),this._select=()=>[t.indexOf(s.property("value"))]}}_clip(t){if(this._clip_pad===-1/0)return t;const e=[this.width,this.height];for(let s=0;s<t.length;s++)t[s]<this._clip_pad?t[s]=this._clip_pad:e[s]-this._clip_pad<t[s]&&(t[s]=e[s]-this._clip_pad);return t}toPoint(t){if(0===this.datas.length)return[0,0];const e=this._select?.()??[Math.min(1,this.datas.dimension-1)],s=this.datas.series.domain,i=[this.width,this.height],a=Math.min(e[0],t[1].length-1);return[scale(t[0],0,this.datas.length+this._pred_count,0,i[0]-2*this.padding[0])+this.padding[0],scale(t[1][a],s[e[0]][0],s[e[0]][1],0,i[1]-2*this.padding[1])+this.padding[1]].map((t=>isNaN(t)?0:t))}toValue(t){return t&&this.datas?[scale(t[0]-this.padding[0],0,this.width-2*this.padding[0],0,this.datas.length)]:[]}_render(){if(!this.datas||0===this.datas.dimension)return this._p.map((t=>t.remove())),this._p.length=0,void this._path.attr("opacity",0);const t=this._select?.()??[Math.min(1,this.datas.dimension-1)],e=this.datas.length,s=this.datas.series.values,i=this.datas.series.domain,a=[this.width,this.height],h=Math.max(1,Math.min(5,Math.floor(2e3/e)));for(let n=0;n<e;n++){const r=[scale(n,0,e+this._pred_count,0,a[0]-2*this.padding[0])+this.padding[0],scale(s[n][t[0]],i[t[0]][0],i[t[0]][1],0,a[1]-2*this.padding[1])+this.padding[1]],d=this._clip(r),p=1===this.datas.dimension?0:this.datas.y[n];if(this._p[n]){const t=this._p[n].at;t[0]===d[0]&&t[1]===d[1]||(this._p[n].at=d),this._p[n].category!==p&&(this._p[n].category=p)}else this._p[n]=new DataPoint(this._r,d,p);this._p[n].title=this.datas._categorical_output?this.datas._output_category_names[this.datas.y[n]-1]:this.datas.y[n],this._p[n].radius=h}for(let t=e;t<this._p.length;t++)this._p[t].remove();this._p.length=e;const n=d3.line().x((t=>t[0])).y((t=>t[1]));this._path.attr("d",n(this.points.map((t=>t.at)))).attr("opacity",.5)}terminate(){this._p.forEach((t=>t.remove())),this._observer.disconnect(),this.setting.render.configElement.selectAll("*").remove(),this._pathg.remove(),super.terminate()}}