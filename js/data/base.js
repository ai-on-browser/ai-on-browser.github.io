const scale=function(t,e,s,i,a){return isFinite(e)&&isFinite(s)&&e!==s?(t-e)/(s-e)*(a-i)+i:(a+i)/2};class DataRenderer{constructor(t){if(this._data=t,this._manager=t._manager,this._r=this.setting.svg.select("g.points g.datas"),0===this._r.size()){const t=this.setting.svg.append("g").classed("points",!0);this._r=t.append("g").classed("datas",!0)}this._p=[],this._pad=10,this._clip_pad=-1/0,this._pred_count=0,this._observe_target=null,this._observer=new MutationObserver((t=>{this._observe_target&&this._p.forEach(((t,e)=>t.title=this._data._categorical_output?this._data._output_category_names[this._data.y[e]-1]:this._data.y[e]))})),this._observer.observe(this.setting.svg.node(),{childList:!0}),this._k=()=>this._series?[Math.min(1,this._data.dimension-1)]:1===this._data.dimension?[0]:[0,1],this._will_render=!1}get padding(){return Array.isArray(this._pad)?this._pad:[this._pad,this._pad]}set padding(t){this._pad=t,this.render()}set clipPadding(t){this._clip_pad=t,this.render()}get _series(){return this._data.isSeries}get setting(){return this._manager.setting}get width(){return this._manager.platform.width}get height(){return this._manager.platform.height}get points(){return this._p}_make_selector(t){let e=this.setting.data.configElement.select("div.column-selector");if(0===e.size()?e=this.setting.data.configElement.append("div").classed("column-selector",!0):e.selectAll("*").remove(),this._data.dimension<=2)this._k=()=>this._series?[Math.min(1,this._data.dimension-1)]:1===this._data.dimension?[0]:[0,1];else if(this._data.dimension<=4){const s=e.append("table").style("border-collapse","collapse");let i=s.append("tr").style("text-align","center");i.append("td"),i.append("td").text(">"),i.append("td").text("V").style("transform","rotate(180deg");const a=[],n=[];for(let e=0;e<this._data.dimension;e++){i=s.append("tr"),s.append("td").text(t[e]).style("text-align","right");const r=s.append("td").append("input").attr("type","radio").attr("name","data-d1").on("change",(()=>this.render()));a.push(r);const h=s.append("td").append("input").attr("type","radio").attr("name","data-d2").on("change",(()=>this.render()));n.push(h)}a[0].property("checked",!0),n[1].property("checked",!0),this._k=()=>{const t=[];for(let e=0;e<this._data.dimension;e++)a[e].property("checked")&&(t[0]=e),n[e].property("checked")&&(t[1]=e);return t}}else{t=t.map((t=>""+t)),e.append("span").text(">");const s=e.append("select").on("change",(()=>this.render()));s.selectAll("option").data(t).enter().append("option").attr("value",(t=>t)).text((t=>t)),s.property("value",t[0]),e.append("span").text("V").style("transform","rotate(180deg").style("display","inline-block");const i=e.append("select").on("change",(()=>this.render()));i.selectAll("option").data(t).enter().append("option").attr("value",(t=>t)).text((t=>t)),i.property("value",t[1]),this._k=()=>[t.indexOf(s.property("value")),t.indexOf(i.property("value"))]}this.render()}_clip(t){if(this._clip_pad===-1/0)return t;const e=[this.width,this.height];for(let s=0;s<t.length;s++)t[s]<this._clip_pad?t[s]=this._clip_pad:e[s]-this._clip_pad<t[s]&&(t[s]=e[s]-this._clip_pad);return t}render(){this._will_render||(this._will_render=!0,Promise.resolve().then((()=>{this._will_render=!1,this._render()})))}toPoint(t){const e=this._k(),s=this._series?this._data.series.domain:this._data.domain,i=[this.width,this.height],[a,n]=this._data.range,r=e.map(((e,a)=>scale(t[e],s[e][0],s[e][1],0,i[a]-2*this.padding[a])+this.padding[a]));if(this._series)if(Array.isArray(t[0])){const e=this._data.domain[0];r[1]=scale(t[1],a,n,0,i[1]-2*this.padding[1])+this.padding[1],r[0]=scale(t[0][0],e[0],e[1],0,i[0]-2*this.padding[0])+this.padding[0]}else{const a=Math.min(e[0],t[1].length-1);r[1]=scale(t[1][a],s[e[0]][0],s[e[0]][1],0,i[1]-2*this.padding[1])+this.padding[1],r[0]=scale(t[0],0,this._data.length+this._pred_count,0,i[0]-2*this.padding[0])+this.padding[0]}return 1===r.length&&t.length>1&&(r[1]=scale(t[1],a,n,0,i[1]-2*this.padding[1])+this.padding[1]),r}toValue(t){return t&&this._series?[scale(t[0]-this.padding[0],0,this.width-2*this.padding[0],0,this._data.length)]:[]}_render(){if(!this._manager._platform)return;if(0===this._data.dimension)return;const t=this._k(),e=this._data.length,s=this._series?this._data.series.values:this._data.x,i=this._series?this._data.series.domain:this._data.domain,a=[this.width,this.height],[n,r]=this._data.range,h=Math.max(1,Math.min(5,Math.floor(2e3/e)));for(let d=0;d<e;d++){const o=t.map(((t,e)=>scale(s[d][t],i[t][0],i[t][1],0,a[e]-2*this.padding[e])+this.padding[e]));this._series&&(o[1]=scale(s[d][t[0]],i[t[0]][0],i[t[0]][1],0,a[1]-2*this.padding[1])+this.padding[1],o[0]=scale(d,0,e+this._pred_count,0,a[0]-2*this.padding[0])+this.padding[0]),1===o.length&&(o[1]=scale(this._data.y[d],n,r,0,a[1]-2*this.padding[1])+this.padding[1]);const l=this._clip(o),p=1===this._data.dimension?0:this._data.y[d];if(this._p[d]){const t=this._p[d].at;t[0]===l[0]&&t[1]===l[1]||(this._p[d].at=l),this._p[d].category!==p&&(this._p[d].category=p)}else this._p[d]=new DataPoint(this._r,l,p);this._p[d].title=this._data._categorical_output?this._data._output_category_names[this._data.y[d]-1]:this._data.y[d],this._p[d].radius=h}for(let t=e;t<this._p.length;t++)this._p[t].remove();this._p.length=e}predict(t){Array.isArray(t)||(t=[t,t]);const e=this._data.domain,s=[this.width,this.height],i=[];if(this._data.dimension<=2)for(let a=0;a<s[0]+t[0];a+=t[0]){const n=scale(a-this.padding[0],0,s[0]-2*this.padding[0],e[0][0],e[0][1]);if(1===this._data.dimension)i.push([n]);else for(let a=0;a<s[1]-t[1]/100;a+=t[1]){const t=scale(a-this.padding[1],0,s[1]-2*this.padding[1],e[1][0],e[1][1]);i.push([n,t])}}else for(let t=0;t<this._data.x.length;t++)i.push(this._data.x[t].concat());const a=this.setting.vue.mlTask;return[i,(n,r)=>{r.selectAll("*").remove();let h=n.some((t=>!Number.isInteger(t)));if(1===this._data.dimension){const d=[];if("IN"===a||h&&"DE"!==a){const[t,a]=this._data.range;for(let r=0;r<n.length;r++)d.push([scale(i[r],e[0][0],e[0][1],0,s[0]-2*this.padding[0])+this.padding[0],scale(n[r],t,a,0,s[1]-2*this.padding[1])+this.padding[1]]);const h=d3.line().x((t=>t[0])).y((t=>t[1]));r.append("path").attr("stroke","red").attr("fill-opacity",0).attr("d",h(d))}else{d.push([],[]);for(let e=0,i=0;i<s[0]+t[0];e++,i+=t[0])d[0][e]=n[e],d[1][e]=n[e];const e=r.append("g");new DataHulls(e,d,[t[0],1e3],h)}}else if(2===this._data.dimension){let e=0;const i=[];for(let a=0,r=0;r<s[0]+t[0];a++,r+=t[0])for(let r=0,h=0;h<s[1]-t[1]/100;r++,h+=t[1])i[r]||(i[r]=[]),i[r][a]=n[e++];!h&&n.length>100&&(h|=new Set(n).size>100);const d=r.append("g");new DataHulls(d,i,t,h||"DE"===a)}else{const t=r.append("g"),e=n.every(Number.isInteger);for(let s=0;s<n.length;s++){new DataCircle(t,this._p[s]).color=getCategoryColor(n[s]),e&&this._data._categorical_output?this._p[s].title=`true: ${this._data._output_category_names[this._data.y[s]-1]}\npred: ${this._data._output_category_names[n[s]-1]}`:this._p[s].title=`true: ${this._data.y[s]}\npred: ${n[s]}`}this._observe_target=r}}]}terminate(){this._p.forEach((t=>t.remove())),this.setting.data.configElement.select("div.column-selector").remove(),this._observer.disconnect()}}export class BaseData{constructor(t){this._x=[],this._y=[],this._manager=t,this._renderer=new DataRenderer(this)}get setting(){return this._manager.setting}get svg(){return this._manager.setting.svg}get availTask(){return[]}get dimension(){return this.domain.length}get domain(){if(0===this.length)return[];const t=[];for(let e=0;e<this.x[0].length;e++)t.push([1/0,-1/0]);for(const e of this.x)if(!Array.isArray(e[0]))for(let s=0;s<e.length;s++)t[s][0]=Math.min(t[s][0],e[s]),t[s][1]=Math.max(t[s][1],e[s]);return t}get range(){const t=[1/0,-1/0];for(const e of this.y)t[0]=Math.min(t[0],e),t[1]=Math.max(t[1],e);return t}get categories(){return[...new Set(this.y)]}get length(){return this.x.length}get x(){return this._x}get series(){return{values:this.x,get domain(){if(0===this.values.length)return[];const t=[];for(let e=0;e<this.values[0].length;e++)t.push([1/0,-1/0]);for(const e of this.values)for(let s=0;s<e.length;s++)t[s][0]=Math.min(t[s][0],e[s]),t[s][1]=Math.max(t[s][1],e[s]);return t}}}get y(){return this._y}get points(){return this._renderer.points}get scale(){return 1}set scale(t){}get isSeries(){const t=this.setting.vue.mlTask;return["TP","SM","CP"].indexOf(t)>=0}get params(){return{}}set params(t){}*[Symbol.iterator](){const t=this.length;for(let e=0;e<t;e++)yield this.at(e)}splice(t,e,...s){return[]}set(t,e,s){this.splice(t,1,e,s)}push(...t){this.splice(this.length,0,...t)}pop(){return this.splice(this.length-1,1)[0]}unshift(...t){this.splice(0,0,...t)}shift(){return this.splice(0,1)[0]}slice(t,e){const s=[];for(let i=t;i<e;i++)s.push(this.at(i));return s}forEach(t){const e=this.length;for(let s=0;s<e;s++)t(this.at(s),s,this)}map(t){const e=this.length,s=[];for(let i=0;i<e;i++)s.push(t(this.at(i),i,this));return s}swap(t,e){[this._x[t],this._x[e]]=[this._x[e],this._x[t]],[this._y[t],this._y[e]]=[this._y[e],this._y[t]]}sort(t){const e=this.length,s=[];for(let i=0;i<e;i++){s[i]=this.at(i);for(let e=i;e>0;e--)t(s[e-1],s[e])>0&&this.swap(e-1,e)}}remove(){this.splice(0,this.length)}terminate(){this._renderer.terminate(),this.setting.data.configElement.selectAll("*").remove(),this.remove()}}export class MultiDimensionalData extends BaseData{constructor(t){super(t),this._categorical_output=!1,this._output_category_names=null}terminate(){super.terminate()}}export class FixData extends MultiDimensionalData{constructor(t){super(t),this._domain=null}get domain(){return this._domain?this._domain:this._domain=super.domain}at(t){return Object.defineProperties({},{x:{get:()=>this._x[t]},y:{get:()=>this._y[t]},point:{get:()=>this.points[t]}})}}