import{FixData}from"./base.js";class CSV{constructor(t,e){this._data=t,this._decoder=new TextDecoder("utf-8"),this._config=e,this._delimiter=this._config?.delimiter||","}get data(){return this._data}async load(t){if(t instanceof File)await new Promise((e=>{const s=new FileReader;s.onload=()=>{this.loadFromString(s.result),e()},s.readAsText(t)}));else{this._data=[];for await(let e of this._fetch(t)){if(0===e.length)continue;const t=e.split(this._delimiter).map((t=>isNaN(t)?t:+t));this._data.push(t)}}}loadFromString(t){this._data=[];for(let e of t.split(/\r\n?|\n/)){if(0===e.length)continue;const t=e.split(this._delimiter).map((t=>isNaN(t)?t:+t));this._data.push(t)}}async*_fetch(t){const e=(await fetch(t)).body.getReader();let{value:s,done:a}=await e.read();if(s&&t.endsWith(".gz")){let t=s;for(;!a;)if(({value:s,done:a}=await e.read()),s){const e=new Uint8Array(t.length+s.length);e.set(t),e.set(s,t.length),t=e}s=pako.ungzip(t)}s=s?this._decoder.decode(s):"";const i=/\n|\r|\r\n/gm;let n=0;for(;;){const t=i.exec(s);if(t)yield s.substring(n,t.index),n=i.lastIndex;else{if(a)break;const t=s.substr(n);({value:s,done:a}=await e.read()),s=t+(s?this._decoder.decode(s):""),n=i.lastIndex=0}}n<s.length&&(yield s.substr(n))}}export default class CSVData extends FixData{constructor(t,e,s){super(t),this._input_category_names=[],this._output_category_names=null,e&&s&&this.setCSV(e,s)}readCSV(t,e,s){s="function"==typeof e?e:s;const a=new CSV(null,"function"==typeof e?null:e);a.load(t).then((()=>s(a.data)))}setCSV(t,e,s=!1){if(Array.isArray(t)){if(s){const s=t[0];t=t.slice(1),e||((e=s.map(((e,s)=>({name:e,type:t.some((t=>isNaN(t[s])))?"category":"numeric"}))))[e.length-1].out=!0)}this._x=[];for(let e=0;e<t.length;e++)this._x[e]=[];for(let s=0,a=0;s<e.length;s++)if(e[s].out)this._categorical_output="category"===e[s].type,this._y=t.map((t=>t[s])),this._categorical_output&&(this._output_category_names=[...new Set(this._y)],this._y=this._y.map((t=>this._output_category_names.indexOf(t)+1)),e[s].labels&&(this._output_category_names[a]=this._output_category_names[a].map((t=>e[s].labels[t]??t))));else if(!e[s].ignore){if("category"===e[s].type){this._input_category_names[a]=[...new Set(t.map((t=>t[s])))];for(let e=0;e<t.length;e++)this._x[e].push(this._input_category_names[a].indexOf(t[e][s]));e[s].labels&&(this._input_category_names[a]=this._input_category_names[a].map((t=>e[s].labels[t]??t)))}else for(let e=0;e<t.length;e++)this._x[e].push(t[e][s]);a++}if(!this._y)throw new Error("There is no 'out' column.");this._feature_names=e.filter((t=>!t.out&&!t.ignore)).map((t=>t.name)),this._domain=null,this._manager.platform._renderer._make_selector(this._feature_names)}else this.readCSV(t,(t=>{this.setCSV(t,e,s)}))}}