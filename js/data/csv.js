import{FixData}from"./base.js";class CSV{constructor(t){this._data=t}get data(){return this._data}static async load(t,e){let a;a=t instanceof File?await new Promise((e=>{const a=new FileReader;a.onload=()=>{e(a.result)},a.readAsText(t)})):await CSV._fetch(t,e);const s=await this.loadFromString(a,e);return new CSV(s)}static async loadFromString(t,e){const a=e?.delimiter||",",s=[];let n=[],i=!1,r="";for(let e=0;e<t.length;e++)i?'"'===t[e]&&'"'===t[e+1]?(r+='"',e++):'"'===t[e]?i=!1:r+=t[e]:'"'===t[e]?i=!0:t.startsWith(a,e)?(n.push(r),r=""):"\n"===t[e]||"\r"===t[e]?((r.length>0||n.length>0)&&(n.push(r),s.push(n),r="",n=[]),"\r"===t[e]&&"\n"===t[e+1]&&e++):r+=t[e];return(r.length>0||n.length>0)&&(n.push(r),s.push(n)),s}static async _fetch(t,e){const a=(await fetch(t)).body.getReader();let{value:s,done:n}=await a.read();if(s&&t.endsWith(".gz")){let t=s;for(;!n;)if(({value:s,done:n}=await a.read()),s){const e=new Uint8Array(t.length+s.length);e.set(t),e.set(s,t.length),t=e}s=pako.ungzip(t)}const i=new TextDecoder(e?.encoding||"utf-8");for(s=s?i.decode(s):"";!n;){const t=s;({value:s,done:n}=await a.read()),s=t+(s?i.decode(s):"")}return s}}export default class CSVData extends FixData{constructor(t,e,a){super(t),this._input_category_names=[],this._output_category_names=null,e&&a&&this.setCSV(e,a)}get columnNames(){return this._feature_names||[]}async readCSV(t,e){return(await CSV.load(t,e)).data}setCSV(t,e,a=!1){if(Array.isArray(t)){if(a){const a=t[0];t=t.slice(1),e||((e=a.map(((e,a)=>({name:e,type:t.some((t=>isNaN(t[a])))?"category":"numeric"}))))[e.length-1].out=!0)}this._x=[];for(let e=0;e<t.length;e++)this._x[e]=[];for(let a=0,s=0;a<e.length;a++)if(!e[a].ignore)if(e[a].type||(e[a].type=t.every((t=>!isNaN(t[a])))?"numeric":"category"),e[a].out)this._categorical_output="category"===e[a].type,this._y=t.map((t=>isNaN(t[a])?t[a]:+t[a])),this._categorical_output&&(this._output_category_names=[...new Set(this._y)],this._y=this._y.map((t=>this._output_category_names.indexOf(t)+1)),e[a].labels&&(this._output_category_names[s]=this._output_category_names[s].map((t=>e[a].labels.hasOwnProperty(t)?e[a].labels[t]:t))));else{if("category"===e[a].type){this._input_category_names[s]=[...new Set(t.map((t=>t[a])))];for(let e=0;e<t.length;e++)this._x[e].push(this._input_category_names[s].indexOf(t[e][a]));e[a].labels&&(this._input_category_names[s]=this._input_category_names[s].map((t=>e[a].labels.hasOwnProperty(t)?e[a].labels[t]:t)))}else for(let e=0;e<t.length;e++)this._x[e].push(isNaN(t[e][a])?t[e][a]:+t[e][a]);s++}this._feature_names=e.filter((t=>!t.out&&!t.ignore)).map((t=>t.name)),this._domain=null,this._manager.onReady((()=>{this._manager.platform.init()}))}else this.readCSV(t).then((t=>{this.setCSV(t,e,a)}))}}