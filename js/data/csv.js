import{FixData}from"./base.js";class CSV{constructor(t,e){this._data=t,this._decoder=new TextDecoder("utf-8"),this._config=e,this._delimiter=this._config?.delimiter||","}get data(){return this._data}async load(t){t instanceof File?await new Promise((e=>{const a=new FileReader;a.onload=()=>{this.loadFromString(a.result),e()},a.readAsText(t)})):this.loadFromString(await this._fetch(t))}loadFromString(t){const e=[];let a=[],s=!1,i="";for(let n=0;n<t.length;n++)s?'"'===t[n]&&'"'===t[n+1]?(i+='"',n++):'"'===t[n]?s=!1:i+=t[n]:'"'===t[n]?s=!0:t.startsWith(this._delimiter,n)?(a.push(isNaN(i)?i:+i),i=""):"\n"===t[n]||"\r"===t[n]?((i.length>0||a.length>0)&&(a.push(isNaN(i)?i:+i),e.push(a),i="",a=[]),"\r"===t[n]&&"\n"===t[n+1]&&n++):i+=t[n];(i.length>0||a.length>0)&&(a.push(isNaN(i)?i:+i),e.push(a)),this._data=e}async _fetch(t){const e=(await fetch(t)).body.getReader();let{value:a,done:s}=await e.read();if(a&&t.endsWith(".gz")){let t=a;for(;!s;)if(({value:a,done:s}=await e.read()),a){const e=new Uint8Array(t.length+a.length);e.set(t),e.set(a,t.length),t=e}a=pako.ungzip(t)}for(a=a?this._decoder.decode(a):"";!s;){const t=a;({value:a,done:s}=await e.read()),a=t+(a?this._decoder.decode(a):"")}return a}}export default class CSVData extends FixData{constructor(t,e,a){super(t),this._input_category_names=[],this._output_category_names=null,e&&a&&this.setCSV(e,a)}readCSV(t,e,a){a="function"==typeof e?e:a;const s=new CSV(null,"function"==typeof e?null:e);s.load(t).then((()=>a(s.data)))}setCSV(t,e,a=!1){if(Array.isArray(t)){if(a){const a=t[0];t=t.slice(1),e||((e=a.map(((e,a)=>({name:e,type:t.some((t=>isNaN(t[a])))?"category":"numeric"}))))[e.length-1].out=!0)}this._x=[];for(let e=0;e<t.length;e++)this._x[e]=[];for(let a=0,s=0;a<e.length;a++)if(e[a].out)this._categorical_output="category"===e[a].type,this._y=t.map((t=>t[a])),this._categorical_output&&(this._output_category_names=[...new Set(this._y)],this._y=this._y.map((t=>this._output_category_names.indexOf(t)+1)),e[a].labels&&(this._output_category_names[s]=this._output_category_names[s].map((t=>e[a].labels.hasOwnProperty(t)?e[a].labels[t]:t))));else if(!e[a].ignore){if("category"===e[a].type){this._input_category_names[s]=[...new Set(t.map((t=>t[a])))];for(let e=0;e<t.length;e++)this._x[e].push(this._input_category_names[s].indexOf(t[e][a]));e[a].labels&&(this._input_category_names[s]=this._input_category_names[s].map((t=>e[a].labels.hasOwnProperty(t)?e[a].labels[t]:t)))}else for(let e=0;e<t.length;e++)this._x[e].push(t[e][a]);s++}if(!this._y)throw new Error("There is no 'out' column.");this._feature_names=e.filter((t=>!t.out&&!t.ignore)).map((t=>t.name)),this._domain=null,this._manager.platform._renderer._make_selector(this._feature_names)}else this.readCSV(t,(t=>{this.setCSV(t,e,a)}))}}