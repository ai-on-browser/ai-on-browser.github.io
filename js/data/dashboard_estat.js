import JSONData from"./json.js";const BASE_URL="https://dashboard.e-stat.go.jp/api/1.0",ExpiredTime=2592e6,lang=(()=>{switch(window.navigator.languages&&window.navigator.languages[0]||window.navigator.language){case"ja-JP":case"ja":return"JP";default:return"EN"}})(),resources={link:"JP"===lang?"https://dashboard.e-stat.go.jp/":"https://dashboard.e-stat.go.jp/en/",text:"JP"===lang?"統計ダッシュボード":"Statistics Dashboard",credit:"JP"===lang?"このサービスは、統計ダッシュボードのAPI機能を使用していますが、サービスの内容は国によって保証されたものではありません。":"This service uses the API feature of Statistics Dashboard, but the contents of this service are not guaranteed by the Statistics Bureau of Japan."},datasetInfos={"Nikkei Indexes":{indicatorCode:["0702020501000010010"],columnKeys:["indicator"],indexKeys:["time"],availTask:["SM","TP","CP"]},"Number of entries/departures":{indicatorCode:["0204030001000010010","0204040001000010010"],columnKeys:["indicator"],indexKeys:["time"],filter:{cycle:["Month","月"]},availTask:["RG","SM","TP","CP"]},"Employed persons":{indicatorCode:["0301010000010010010","0301010000020010010","0301010000030010010"],columnKeys:["indicator"],indexKeys:["time"],filter:{cycle:["Month","月"]},availTask:["RG","SM","TP","CP"]}},lockKeys={};export default class EStatData extends JSONData{constructor(e){super(e),this._name="Nikkei Indexes",this._columns=[],this._availTask=[];const t=this.setting.data.configElement,a=document.createElement("div");a.style.display="flex",a.style.justifyContent="space-between",t.appendChild(a);const n=document.createElement("span");a.appendChild(n),n.appendChild(document.createTextNode("Name"));const s=document.createElement("select");s.name="name",s.onchange=()=>{this._name=s.value,this._readyData(),this.setting.vue.pushHistory()};for(const e of Object.keys(datasetInfos)){const t=document.createElement("option");t.value=e,t.innerText=datasetInfos[e].caption||e,s.appendChild(t)}n.appendChild(s);const o=document.createElement("span");a.appendChild(o);const r=document.createElement("a");o.appendChild(r),r.href=resources.link,r.setAttribute("ref","noreferrer noopener"),r.target="_blank",r.innerText=resources.text;const i=document.createElement("span");i.innerText=resources.credit,i.style.fontSize="80%",t.appendChild(i),this._outSelector=document.createElement("div"),t.appendChild(this._outSelector),this._readyData()}get availTask(){return this._availTask}get columnNames(){if(this._target>=0){const e=this._columns.concat();return e.splice(this._target,1),e}return this._columns}get x(){return this._target>=0?this._x.map((e=>{const t=e.concat();return t.splice(this._target,1),t})):this._x}get y(){return this._target>=0?this._x.map((e=>e[this._target])):Array(this._x.length).fill(0)}get params(){return{dataname:this._name}}set params(e){if(e.dataname&&Object.keys(datasetInfos).indexOf(e.dataname)>=0){const t=this.setting.data.configElement;this._name=e.dataname,t.querySelector("[name=name]").value=e.dataname,this._readyData()}}async _getData(e){const t={Lang:"JP"===lang?"JP":"EN",IndicatorCode:e,IsSeasonalAdjustment:1,MetaGetFlg:"Y"},a=new EStatDB,n=await a.get("data",e);if(!n||+n.GET_STATS.RESULT.status>=100||new Date-n.fetchDate>2592e6){const n=e.join(",");if(lockKeys[n])return new Promise((e=>lockKeys[n].push(e)));const s=`${BASE_URL}/Json/getData?${new URLSearchParams(t)}`;console.debug(`Fetch to ${s}`),lockKeys[n]=[];const o=await fetch(s),r=await o.json();+r.GET_STATS.RESULT.status>=100&&console.error(r.GET_STATS.RESULT),r.fetchDate=new Date,await a.save("data",r);for(const e of lockKeys[n])e(r);return lockKeys[n]=void 0,r}return n}async _readyData(){const e=datasetInfos[this._name];this._availTask=e.availTask,this._outSelector.replaceChildren();const t=await this._getData(e.indicatorCode),a=t.GET_STATS.STATISTICAL_DATA.DATA_INF.DATA_OBJ,n=t.GET_STATS.STATISTICAL_DATA.CLASS_INF.CLASS_OBJ,s={};for(const e of n)s[e["@id"]]=e;const o=(e,t)=>{for(const a of e.CLASS)if(a["@code"]===t)return a.$||a["@name"]},r=e.columnKeys.map((e=>s[e])),i=e.indexKeys.map((e=>s[e])),c={},d=[];for(let t=0;t<a.length;t++){const n=a[t].VALUE;if(e.filter){let t=!0;for(const a of Object.keys(e.filter)){const r=s[a],i=n[`@${r["@id"]}`],c=o(r,i),d=e.filter[a];if("string"==typeof d)t&&=c===d;else{if(!Array.isArray(d))throw new Error("Invalid condition");t&&=d.indexOf(c)>=0}}if(!t)continue}const l=i.map((e=>n[`@${e["@id"]}`])).join("_"),h=r.map((e=>o(e,n[`@${e["@id"]}`]))).join("_");c[l]||(c[l]={}),c[l][h]=n.$,d.indexOf(h)<0&&d.push(h)}this._columns=d,this._target=1===d.length?-1:this._columns.length-1;const l=Object.keys(c);if(l.sort(),this._index=l,this.setJSON(l.map((e=>c[e])),d.map((e=>({name:e,nan:0})))),d.length>1){this._outSelector.appendChild(document.createTextNode("Output"));const e=document.createElement("select");e.onchange=()=>{this._target=this._columns.indexOf(e.value),this._domain=null,this._manager.onReady((()=>{this._manager.platform.init()}))},this._outSelector.appendChild(e),e.appendChild(document.createElement("option"));for(const t of this._columns){const a=document.createElement("option");a.value=t,a.innerText=t,e.appendChild(a)}e.value=this._columns[this._target]}this.setting.ml.refresh(),this.setting.vue.$forceUpdate()}}const DB_NAME="dashboard.e-stat.go.jp";class EStatDB{constructor(){this.db=null}async _ready(){if(this.db)return;const e=indexedDB.open(DB_NAME,1);return new Promise(((t,a)=>{e.onerror=a,e.onsuccess=()=>{this.db=e.result,t()},e.onupgradeneeded=e=>{e.target.result.createObjectStore("data",{keyPath:"GET_STATS.PARAMETER.indicatorCode"})}}))}async save(e,t){return await this._ready(),new Promise(((a,n)=>{const s=this.db.transaction([e],"readwrite"),o=s.objectStore(e);Array.isArray(t)||(t=[t]);for(const e of t)o.put(e);s.oncomplete=a,s.onerror=n}))}async get(e,t){return await this._ready(),new Promise(((a,n)=>{const s=this.db.transaction(e).objectStore(e).get(t);s.onsuccess=e=>{a(e.target.result)},s.onerror=n}))}async list(e){return await this._ready(),new Promise(((t,a)=>{const n=this.db.transaction(e).objectStore(e).getAll();n.onsuccess=e=>{t(e.target.result)},n.onerror=a}))}async deleteDatabase(){return new Promise(((e,t)=>{const a=indexedDB.deleteDatabase(DB_NAME);a.onerror=t,a.onsuccess=()=>{this.db=null,e()}}))}}