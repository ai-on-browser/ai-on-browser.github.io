var O=Object.defineProperty;var D=(k,e)=>O(k,"name",{value:e,configurable:!0});import P from"./db/base.js";import J from"./json.js";const L="https://dashboard.e-stat.go.jp/api/1.0",N=1e3*60*60*24*30,I=(()=>{switch(window.navigator.languages&&window.navigator.languages[0]||window.navigator.language){case"ja-JP":case"ja":return"JP";default:return"EN"}})(),M={link:I==="JP"?"https://dashboard.e-stat.go.jp/":"https://dashboard.e-stat.go.jp/en/",text:I==="JP"?"\u7D71\u8A08\u30C0\u30C3\u30B7\u30E5\u30DC\u30FC\u30C9":"Statistics Dashboard",credit:I==="JP"?"\u3053\u306E\u30B5\u30FC\u30D3\u30B9\u306F\u3001\u7D71\u8A08\u30C0\u30C3\u30B7\u30E5\u30DC\u30FC\u30C9\u306EAPI\u6A5F\u80FD\u3092\u4F7F\u7528\u3057\u3066\u3044\u307E\u3059\u304C\u3001\u30B5\u30FC\u30D3\u30B9\u306E\u5185\u5BB9\u306F\u56FD\u306B\u3088\u3063\u3066\u4FDD\u8A3C\u3055\u308C\u305F\u3082\u306E\u3067\u306F\u3042\u308A\u307E\u305B\u3093\u3002\u307E\u305F\u3001\u30C7\u30FC\u30BF\u306E\u52A0\u5DE5\u3092\u884C\u3063\u3066\u304A\u308A\u307E\u3059\u3002":"This service uses the API feature of Statistics Dashboard, but the contents of this service are not guaranteed by the Statistics Bureau of Japan. In addition, the data is processed."},E={Manual:{indicatorCode:[],columnKeys:["indicator"],indexKeys:["time"],query:{},dropna:!0},"Nikkei Indexes":{indicatorCode:["0702020501000010010"],columnKeys:["indicator"],indexKeys:["time"]},"Number of entries/departures":{indicatorCode:["0204030001000010010","0204040001000010010"],columnKeys:["indicator"],indexKeys:["time"],filter:{cycle:["Month","\u6708"]}},"Employed persons":{indicatorCode:["0301010000010010010","0301010000020010010","0301010000030010010"],columnKeys:["indicator"],indexKeys:["time"],filter:{cycle:["Month","\u6708"]}},"Number of schools":{indicatorCode:["1201010100000010000","1201010300000010000","1201010400000010000","1201010500000010000","1201010800000010000"],columnKeys:["indicator"],indexKeys:["time"],query:{RegionLevel:2}},Garbage:{indicatorCode:["1405050100000010010","1405050300000010010","1405050800000020010","1405050900000010010"],columnKeys:["indicator"],indexKeys:["time"],query:{RegionLevel:2}}},T={};export default class q extends J{static{D(this,"EStatData")}constructor(e){super(e),this._name="Nikkei Indexes",this._columns=[],this._shift=[],this._scale=[],this._object=[],this._target=-1,this._scaled=!0,this._lastRequested=0;const t=this.setting.data.configElement,a=document.createElement("div");a.style.display="flex",a.style.justifyContent="space-between",t.appendChild(a);const o=document.createElement("span");a.appendChild(o);const n=document.createElement("select");n.name="name",n.onchange=()=>{this._name=n.value,this._indicatorSelector.style.display=this._name==="Manual"?"flex":"none",this._readyData(),this.setting.pushHistory()};for(const r of Object.keys(E)){const g=document.createElement("option");g.value=r,g.innerText=E[r].caption||r,n.appendChild(g)}n.value=this._name,o.append("Name",n);const i=document.createElement("a");a.appendChild(i),i.href=M.link,i.setAttribute("ref","noreferrer noopener"),i.target="_blank",i.innerText=M.text,this._indicatorSelector=document.createElement("div"),t.appendChild(this._indicatorSelector),this._initManualIndicatorSelector();const d=document.createElement("span");d.innerText=M.credit,d.style.fontSize="80%",t.appendChild(d),this._selector=document.createElement("div"),t.appendChild(this._selector);const p=document.createElement("div"),m=document.createElement("input");m.type="checkbox",m.checked=!0,m.onchange=()=>{this._scaled=m.checked,this._readyData()},p.append("Scale",m),t.appendChild(p),this._readyData()}get availTask(){return["RG","AD","SM","TP","CP"]}get _requireDateInput(){return this._object.length===0&&this._datetime&&["","RG","AD"].includes(this._manager.task)}get columnNames(){return this._requireDateInput?["date"]:this._object.map(e=>this._columns[e])}get originalX(){return this._requireDateInput?this._datetime.map(e=>[e]):this._x.map(e=>this._object.map(t=>e[t]))}get x(){return this._scaled?this._requireDateInput?this._datetime.map(e=>[e]):(this._readyScaledData(),this._x.map(e=>{const t=e.map((a,o)=>(a-this._shift[o])/this._scale[o]);return this._object.map(a=>t[a])})):this.originalX}get originalY(){return this._target>=0?this._x.map(e=>e[this._target]):Array(this._x.length).fill(0)}get y(){return this._scaled?(this._readyScaledData(),this._target>=0?this._x.map(e=>(e[this._target]-this._shift[this._target])/this._scale[this._target]):Array(this._x.length).fill(0)):this.originalY}get params(){return{dataname:this._name}}set params(e){if(e.dataname&&Object.keys(E).includes(e.dataname)){const t=this.setting.data.configElement;this._name=e.dataname,t.querySelector("[name=name]").value=e.dataname,e.dataname!=="Manual"&&this._readyData()}}_initManualIndicatorSelector(){this._indicatorSelector.style.display="none",this._indicatorSelector.style.alignItems="flex-start",this._indicatorSelector.classList.add("sub-menu");let e=null;const t={},a=document.createElement("select");a.multiple=!0,a.size=5,a.style.overflowY="hidden",a.style.minWidth="100px";const o=document.createElement("span");o.style.margin="auto 0";const n=document.createElement("button");n.innerHTML="&larr;",n.onclick=()=>{let h=!1;const l=E.Manual.indicatorCode;for(const f of g.selectedOptions){if(l.length>=5||l.includes(f.value))break;a.appendChild(f.cloneNode(!0)),l.push(f.value),h=!0}h&&(u(),this._readyData())};const i=document.createElement("button");i.innerHTML="&rarr;",i.onclick=()=>{let h=!1;for(let l=a.options.length-1;l>=0;l--){const f=a.options.item(l);f.selected&&(f.remove(),h=!0)}E.Manual.indicatorCode=[];for(const l of a.options)E.Manual.indicatorCode.push(l.value);h&&(u(),this._readyData())},o.append(n,document.createElement("br"),i);const d=document.createElement("span"),p=document.createElement("select");p.onchange=()=>u();const m=document.createElement("select");m.onchange=()=>{E.Manual.query.Cycle=m.value,u(),this._readyData()};const r=document.createElement("select");r.onchange=()=>{E.Manual.query.RegionCode=r.value,u(),this._readyData()};const g=document.createElement("select");g.multiple=!0;const u=D(()=>{g.replaceChildren();const h=E.Manual.indicatorCode;for(const l of e){if(!l["@code"].startsWith(p.value)||l.CLASS.every(y=>y.cycle["@code"]!==m.value||y.RegionalRank["@code"]!==t[r.value]))continue;const f=g.appendChild(document.createElement("option"));f.value=l["@code"],f.innerText=l["@name"],f.disabled=h.includes(l["@code"])}},"filterIndicatorCodes");d.append("Filter",p,m,r,document.createElement("br"),g),this._indicatorSelector.append("Indicator ",a,o,d);const C=D((h,l)=>{const f=Object.keys(h);f.sort((y,s)=>y-s);for(const y of f){const s=l.appendChild(document.createElement("option"));s.value=y,s.innerText=h[y]}},"dictToOptions");Promise.all(["Indicator","Term","Region"].map(h=>this._getMeta(h))).then(([h,l,f])=>{e=h.GET_META_INDICATOR_INF.METADATA_INF.CLASS_INF.CLASS_OBJ;const y={};for(const c of e)for(const x of c.CLASS)y[x.cycle["@code"]]||(y[x.cycle["@code"]]=x.cycle["@name"]);C(y,m),m.value=3,E.Manual.query.Cycle=3;const s={},_=l.GET_META_TERM_INFO.METADATA_INF.CLASS_INF.CLASS_OBJ.CLASS;for(const c of _)s[c["@code"].slice(0,4)]||(s[c["@code"].slice(0,4)]=c["@category"]);C(s,p);const S={},b=f.GET_META_REGION_INF.METADATA_INF.CLASS_INF.CLASS_OBJ,A=b.find(c=>c["@parentRegionCode"].length===0);let v=null;for(const c of A.CLASS)c["@level"]==="2"&&(S[c["@regionCode"]]=c["@name"],v=c["@regionCode"],t[c["@regionCode"]]=c["@level"]);const j=b.find(c=>c["@parentRegionCode"]===v);for(const c of j.CLASS)c["@level"]==="3"&&(S[c["@regionCode"]]=c["@name"],t[c["@regionCode"]]=c["@level"]);C(S,r),r.value=v,E.Manual.query.RegionCode=v,u(),this.setting.data.configElement.querySelector("[name=name]").value==="Manual"&&(this._indicatorSelector.style.display="flex",this._readyData())})}_readyScaledData(){if(!(this._scale.length>0)&&(this._shift=[],this._scale=[],this._x.length>0)){const e=Array(this._x[0].length).fill(1/0),t=Array(this._x[0].length).fill(-1/0);for(let n=0;n<this._x.length;n++)for(let i=0;i<this._x[n].length;i++)e[i]=Math.min(e[i],this._x[n][i]),t[i]=Math.max(t[i],this._x[n][i]);const a=10,o=0;for(let n=0;n<e.length;n++)e[n]===t[n]&&(t[n]=e[n]+1),this._scale[n]=(t[n]-e[n])/(a-o),this._shift[n]=e[n]-o*this._scale[n]}}async _getMeta(e){const t=e.toUpperCase()==="INDICATOR"||e.toUpperCase()==="REGION"?"INF":"INFO",a=`GET_META_${e.toUpperCase()}_${t}`,o={Lang:I==="JP"?"JP":"EN"},n=new R,i=await n.get("meta",e);if(!i||+i[a].RESULT.status>=100||new Date-i.fetchDate>N){const d=e;if(T[d])return new Promise(u=>{T[d]?T[d].push(u):u(n.get("meta",e))});const p=`${L}/Json/get${e}Info?${new URLSearchParams(o)}`;console.debug(`Fetch to ${p}`),T[d]=[];const r=await(await fetch(p)).json();+r[a].RESULT.status>=100&&console.error(r[a].RESULT),r.function=e,r.fetchDate=new Date,await n.save("meta",r);for(const u of T[d])u(r);return T[d]=void 0,r}return i}async _getData(e,t){const a={Lang:I==="JP"?"JP":"EN",IndicatorCode:e,IsSeasonalAdjustment:1,MetaGetFlg:"Y",...t},o=new URLSearchParams(a).toString(),n=new R,i=await n.get("data",o);if(!i||+i.GET_STATS.RESULT.status>=100||new Date-i.fetchDate>N){const d=e.join(",");if(T[d])return new Promise(u=>{T[d]?T[d].push(u):u(n.get("data",e))});for(;new Date-this._lastRequested<2e3;)await new Promise(u=>setTimeout(u,500));this._lastRequested=new Date;const p=`${L}/Json/getData?${o}`;console.debug(`Fetch to ${p}`),T[d]=[];const r=await(await fetch(p)).json();+r.GET_STATS.RESULT.status>=100&&console.error(r.GET_STATS.RESULT),r.fetchDate=new Date,r.params=o,await n.save("data",r);for(const u of T[d])u(r);return T[d]=void 0,r}return i}async _readyData(){this._x=[],this._shift=[],this._scale=[],this._columns=[],this._object=[],this._index=null,this._datetime=null,this._manager.platform?.init();const e=E[this._name],t=e.indicatorCode.concat();if(t.length===0){this._readySelector(),this.setting.ml.refresh();return}const a=document.createElement("div");a.classList.add("loader"),this._selector.replaceChildren(a);const o=this._name,n=JSON.stringify(e.query),i=await this._getData(t,e.query);if(this._name!==o||t.length!=e.indicatorCode.length||t.some((s,_)=>s!==e.indicatorCode[_])||n!=JSON.stringify(e.query))return;if(i.GET_STATS.RESULT.status==="1"){this._readySelector();return}const d=i.GET_STATS.STATISTICAL_DATA.DATA_INF.DATA_OBJ,p=i.GET_STATS.STATISTICAL_DATA.CLASS_INF.CLASS_OBJ,m={};for(const s of p)m[s["@id"]]=s;const r=D((s,_)=>{for(const S of s.CLASS)if(S["@code"]===_)return S.$||S["@name"]},"getNameFromCobj"),g=e.columnKeys.map(s=>m[s]),u=e.indexKeys.map(s=>m[s]),C={},h=[];for(let s=0;s<d.length;s++){const _=d[s].VALUE;if(e.filter){let A=!0;for(const v of Object.keys(e.filter)){const j=m[v],w=_[`@${j["@id"]}`],c=r(j,w),x=e.filter[v];if(typeof x=="string")A&&=c===x;else if(Array.isArray(x))A&&=x.includes(c);else throw new Error("Invalid condition")}if(!A)continue}const S=u.map(A=>_[`@${A["@id"]}`]).join("_"),b=g.map(A=>r(A,_[`@${A["@id"]}`])).join("_");C[S]||(C[S]={}),C[S][b]=_.$,h.includes(b)||h.push(b)}if(e.dropna)for(const s of Object.keys(C))Object.keys(C[s]).length!==h.length&&delete C[s];this._columns=h;for(let s=0;s<h.length-1;s++)this._object.push(s);this._target=this._columns.length-1;const l=Object.keys(C);l.sort(),this._index=l;const f=l.map(s=>{const _=s.match(/([0-9]{4})([0-9CFQY]{2})00/),S=+_[1],b=_[2]==="CY"?1:_[2]==="FY"?4:_[2][1]==="Q"?(+_[2][0]-1)*3+1:+_[2];return{year:S,month:b}}),y=f.reduce((s,_)=>Math.min(s,_.year),1/0);this._datetime=f.map(s=>(s.year-y)*12+s.month-1),this.setJSON(l.map(s=>C[s]),h.map(s=>({name:s,nan:0}))),this._readySelector(),this.setting.ml.refresh(),this.setting.$forceUpdate()}_readySelector(){if(this._selector.replaceChildren(),this._columns.length>1){const e=document.createElement("select");e.multiple=!0,e.onchange=()=>{this._object=[];let a="",o=!1;for(const n of e.options)n.selected?(this._object.push(this._columns.indexOf(n.value)),n.value===t.value&&(o=!0)):a||(a=n.value);o&&(this._target=this._columns.indexOf(a),t.value=a),this._domain=null,this._manager.onReady(()=>{this._manager.platform.init()})},this._selector.append("Input",e);const t=document.createElement("select");t.onchange=()=>{let a=!1;for(const o of e.selectedOptions)if(o.value===t.value){o.selected=!1,this._object=this._object.filter(n=>this._columns[n]!==o.value),a=!0;break}if(a||t.value===""&&this._target>=0)for(const o of e.options)o.value===this._columns[this._target]&&(o.selected=!0,this._object.push(this._target));this._target=this._columns.indexOf(t.value),this._domain=null,this._manager.onReady(()=>{this._manager.platform.init()})},this._selector.append("Output",t),t.appendChild(document.createElement("option"));for(const a of this._columns){const o=document.createElement("option");o.value=o.innerText=a,e.appendChild(o),t.appendChild(o.cloneNode(!0))}e.size=Math.min(4,e.options.length);for(let a=0;a<this._columns.length-1;a++)e.options[a].selected=this._object.includes(a);t.value=this._columns[this._target]}}}const F="dashboard.e-stat.go.jp";class R extends P{static{D(this,"EStatDB")}constructor(){super(F,3)}onupgradeneeded(e){const t=e.target.result;e.oldVersion<1&&(t.createObjectStore("meta",{keyPath:"function"}),t.createObjectStore("data",{keyPath:"GET_STATS.PARAMETER.indicatorCode"})),e.oldVersion<3&&(t.deleteObjectStore("data"),t.createObjectStore("data",{keyPath:"params"}))}}
