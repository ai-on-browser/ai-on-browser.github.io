var R=Object.defineProperty;var E=(b,e)=>R(b,"name",{value:e,configurable:!0});import N from"./db/base.js";import{FixData as O}from"./base.js";import M from"./loader/json.js";import P from"./util/ioselector.js";const w="https://dashboard.e-stat.go.jp/api/1.0",j=1e3*60*60*24*30,A=(()=>{switch(window.navigator.languages&&window.navigator.languages[0]||window.navigator.language){case"ja-JP":case"ja":return"JP";default:return"EN"}})(),v={link:A==="JP"?"https://dashboard.e-stat.go.jp/":"https://dashboard.e-stat.go.jp/en/",text:A==="JP"?"\u7D71\u8A08\u30C0\u30C3\u30B7\u30E5\u30DC\u30FC\u30C9":"Statistics Dashboard",credit:A==="JP"?"\u3053\u306E\u30B5\u30FC\u30D3\u30B9\u306F\u3001\u7D71\u8A08\u30C0\u30C3\u30B7\u30E5\u30DC\u30FC\u30C9\u306EAPI\u6A5F\u80FD\u3092\u4F7F\u7528\u3057\u3066\u3044\u307E\u3059\u304C\u3001\u30B5\u30FC\u30D3\u30B9\u306E\u5185\u5BB9\u306F\u56FD\u306B\u3088\u3063\u3066\u4FDD\u8A3C\u3055\u308C\u305F\u3082\u306E\u3067\u306F\u3042\u308A\u307E\u305B\u3093\u3002\u307E\u305F\u3001\u30C7\u30FC\u30BF\u306E\u52A0\u5DE5\u3092\u884C\u3063\u3066\u304A\u308A\u307E\u3059\u3002":"This service uses the API feature of Statistics Dashboard, but the contents of this service are not guaranteed by the Statistics Bureau of Japan. In addition, the data is processed."},D={Manual:null,"Nikkei Indexes":{indicatorCode:["0702020501000010010"],region:"00000",cycle:"1"},"Number of entries/departures":{indicatorCode:["0204030001000010010","0204040001000010010"],region:"00000",cycle:"1"},"Employed persons":{indicatorCode:["0301010000010010010","0301010000020010010","0301010000030010010"],region:"00000",cycle:"1"},"Number of schools":{indicatorCode:["1201010100000010000","1201010300000010000","1201010400000010000","1201010500000010000","1201010800000010000"],region:"00000",cycle:"3"},Garbage:{indicatorCode:["1405050100000010010","1405050300000010010","1405050800000020010","1405050900000010010"],region:"00000",cycle:"4"}},p={};export default class F extends O{static{E(this,"EStatData")}constructor(e){super(e),this._name="Nikkei Indexes",this._shift=[],this._scale=[],this._scaled=!0,this._lastRequested=0;const t=this.setting.data.configElement,c=document.createElement("div");c.style.display="flex",c.style.justifyContent="space-between",t.appendChild(c);const l=document.createElement("span");c.appendChild(l);const n=document.createElement("select");n.name="name",n.onchange=()=>{this._name=n.value;const i=D[this._name];i&&this._setIndicators(i.indicatorCode,i.cycle,i.region),this._readyData(),this.setting.pushHistory()};for(const i of Object.keys(D)){const h=n.appendChild(document.createElement("option"));h.value=h.innerText=i}n.value=this._name,l.append("Name",n);const o=document.createElement("a");c.appendChild(o),o.href=v.link,o.setAttribute("ref","noreferrer noopener"),o.target="_blank",o.innerText=v.text,this._indicatorSelector=document.createElement("div"),t.appendChild(this._indicatorSelector);const s=document.createElement("span");s.innerText=v.credit,s.style.fontSize="80%",t.appendChild(s),this._selector=new P(t),this._selector.onchange=()=>{this._domain=null,this._manager.onReady(()=>{this._manager.platform.init()})},this._loader=document.createElement("div"),t.appendChild(this._loader);const m=document.createElement("div"),_=document.createElement("input");_.type="checkbox",_.checked=!0,_.onchange=()=>{this._scaled=_.checked,this._readyData()},m.append("Scale",_),t.appendChild(m),this._initIndicatorSelector().then(()=>{const i=D[this._name];i&&this._setIndicators(i.indicatorCode,i.cycle,i.region),this._readyData()})}get availTask(){return["RG","AD","SM","TP","CP"]}get _requireDateInput(){return this._selector.object.length===0&&this._datetime&&["","RG","AD"].includes(this._manager.task)}get columnNames(){return this._requireDateInput?["date"]:this._selector.objectNames}get originalX(){return this._requireDateInput?this._datetime.map(e=>[e]):this._x.map(e=>this._selector.object.map(t=>e[t]))}get x(){return this._scaled?this._requireDateInput?this._datetime.map(e=>[e]):(this._readyScaledData(),this._x.map(e=>{const t=e.map((c,l)=>(c-this._shift[l])/this._scale[l]);return this._selector.object.map(c=>t[c])})):this.originalX}get originalY(){const e=this._selector.target;return e>=0?this._x.map(t=>t[e]):Array(this._x.length).fill(0)}get y(){if(!this._scaled)return this.originalY;this._readyScaledData();const e=this._selector.target;return e>=0?this._x.map(t=>(t[e]-this._shift[e])/this._scale[e]):Array(this._x.length).fill(0)}get params(){return{dataname:this._name}}set params(e){if(e.dataname&&Object.keys(D).includes(e.dataname)){const t=this.setting.data.configElement;this._name=e.dataname,t.querySelector("[name=name]").value=e.dataname,this._indicatorMetaInfos&&this._readyData()}}get indicatorCodes(){const e=this._indicatorSelector.querySelector("select[name=useCodes]"),t=[];for(const c of e.options)t.push(c.value);return t}get cycle(){return this._indicatorSelector.querySelector("select[name=cycle]").value}get region(){return this._indicatorSelector.querySelector("select[name=region]").value}_initIndicatorSelector(){this._indicatorSelector.style.display="flex",this._indicatorSelector.style.alignItems="flex-start",this._regionCodeToRank={};const e=document.createElement("select");e.name="useCodes",e.multiple=!0,e.size=5,e.style.overflowY="hidden",e.style.minWidth="100px";const t=document.createElement("span");t.style.margin="auto 0";const c=document.createElement("button");c.innerHTML="&larr;",c.onclick=()=>{let h=!1;const r=this.indicatorCodes;for(const f of _.selectedOptions){if(r.length>=5||r.includes(f.value))break;e.appendChild(f.cloneNode(!0)),h=!0}h&&(this._filterIndicatorCodes(),this._readyData())};const l=document.createElement("button");l.innerHTML="&rarr;",l.onclick=()=>{let h=!1;for(let r=e.options.length-1;r>=0;r--){const f=e.options.item(r);f.selected&&(f.remove(),h=!0)}h&&(this._filterIndicatorCodes(),this._readyData())},t.append(c,document.createElement("br"),l);const n=document.createElement("span"),o=document.createElement("select");o.name="category",o.onchange=()=>this._filterIndicatorCodes();const s=document.createElement("select");s.name="cycle",s.onchange=()=>{this._filterIndicatorCodes(),this._readyData()};const m=document.createElement("select");m.name="region",m.onchange=()=>{this._filterIndicatorCodes(),this._readyData()};const _=document.createElement("select");_.name="unuseCodes",_.multiple=!0,n.append("Filter",o,s,m,document.createElement("br"),_),this._indicatorSelector.append("Indicator ",e,t,n);const i=E((h,r)=>{const f=Object.keys(h);f.sort((g,y)=>g-y);for(const g of f){const y=r.appendChild(document.createElement("option"));y.value=g,y.innerText=h[g]}},"dictToOptions");return Promise.all(["Indicator","Term","Region"].map(h=>this._getMeta(h))).then(([h,r,f])=>{this._indicatorMetaInfos=h.GET_META_INDICATOR_INF.METADATA_INF.CLASS_INF.CLASS_OBJ;const g={};for(const d of this._indicatorMetaInfos)for(const k of d.CLASS)g[k.cycle["@code"]]||(g[k.cycle["@code"]]=k.cycle["@name"]);i(g,s),s.value=3;const y={},x=r.GET_META_TERM_INFO.METADATA_INF.CLASS_INF.CLASS_OBJ.CLASS;for(const d of x)y[d["@code"].slice(0,4)]||(y[d["@code"].slice(0,4)]=d["@category"]);i(y,o);const C={},I=f.GET_META_REGION_INF.METADATA_INF.CLASS_INF.CLASS_OBJ,a=I.find(d=>d["@parentRegionCode"].length===0);let u=null;for(const d of a.CLASS)d["@level"]==="2"&&(C[d["@regionCode"]]=d["@name"],u=d["@regionCode"],this._regionCodeToRank[d["@regionCode"]]=d["@level"]);const S=I.find(d=>d["@parentRegionCode"]===u);for(const d of S.CLASS)d["@level"]==="3"&&(C[d["@regionCode"]]=d["@name"],this._regionCodeToRank[d["@regionCode"]]=d["@level"]);i(C,m),m.value=u,this._filterIndicatorCodes(),this.setting.data.configElement.querySelector("[name=name]").value==="Manual"&&(this._indicatorSelector.style.display="flex",this._readyData())})}_setIndicators(e,t,c){const l=this._indicatorSelector.querySelector("select[name=useCodes]");l.replaceChildren();for(const s of this._indicatorMetaInfos)if(e.includes(s["@code"])){const m=l.appendChild(document.createElement("option"));m.value=s["@code"],m.innerText=s["@name"]}const n=this._indicatorSelector.querySelector("select[name=cycle]");n.value=t;const o=this._indicatorSelector.querySelector("select[name=region]");o.value=c,this._filterIndicatorCodes(e[0].slice(0,4))}_filterIndicatorCodes(e){const t=this._indicatorSelector.querySelector("select[name=category]");e&&(t.value=e),e=t.value;const c=this.cycle,l=this._regionCodeToRank[this.region],n=this._indicatorSelector.querySelector("select[name=unuseCodes]");n.replaceChildren();const o=this.indicatorCodes;for(const s of this._indicatorMetaInfos){if(!s["@code"].startsWith(e)||s.CLASS.every(_=>_.cycle["@code"]!==c||_.RegionalRank["@code"]!==l))continue;const m=n.appendChild(document.createElement("option"));m.value=s["@code"],m.innerText=s["@name"],m.disabled=o.includes(s["@code"])}}_readyScaledData(){if(!(this._scale.length>0)&&(this._shift=[],this._scale=[],this._x.length>0)){const e=Array(this._x[0].length).fill(1/0),t=Array(this._x[0].length).fill(-1/0);for(let n=0;n<this._x.length;n++)for(let o=0;o<this._x[n].length;o++)e[o]=Math.min(e[o],this._x[n][o]),t[o]=Math.max(t[o],this._x[n][o]);const c=10,l=0;for(let n=0;n<e.length;n++)e[n]===t[n]&&(t[n]=e[n]+1),this._scale[n]=(t[n]-e[n])/(c-l),this._shift[n]=e[n]-l*this._scale[n]}}async _getMeta(e){const t=e.toUpperCase()==="INDICATOR"||e.toUpperCase()==="REGION"?"INF":"INFO",c=`GET_META_${e.toUpperCase()}_${t}`,l={Lang:A==="JP"?"JP":"EN"},n=new L,o=await n.get("meta",e);if(!o||+o[c].RESULT.status>=100||new Date-o.fetchDate>j){const s=e;if(p[s])return new Promise(r=>{p[s]?p[s].push(r):r(n.get("meta",e))});const m=`${w}/Json/get${e}Info?${new URLSearchParams(l)}`;console.debug(`Fetch to ${m}`),p[s]=[];const i=await(await fetch(m)).json();+i[c].RESULT.status>=100&&console.error(i[c].RESULT),i.function=e,i.fetchDate=new Date,await n.save("meta",i);for(const r of p[s])r(i);return p[s]=void 0,i}return o}async _getData(e,t){const c={Lang:A==="JP"?"JP":"EN",IndicatorCode:e,IsSeasonalAdjustment:1,MetaGetFlg:"Y",...t},l=new URLSearchParams(c).toString(),n=new L,o=await n.get("data",l);if(!o||+o.GET_STATS.RESULT.status>=100||new Date-o.fetchDate>j){const s=e.join(",");if(p[s])return new Promise(r=>{p[s]?p[s].push(r):r(n.get("data",e))});for(;new Date-this._lastRequested<2e3;)await new Promise(r=>setTimeout(r,500));this._lastRequested=new Date;const m=`${w}/Json/getData?${l}`;console.debug(`Fetch to ${m}`),p[s]=[];const i=await(await fetch(m)).json();+i.GET_STATS.RESULT.status>=100&&console.error(i.GET_STATS.RESULT),i.fetchDate=new Date,i.params=l,await n.save("data",i);for(const r of p[s])r(i);return p[s]=void 0,i}return o}async _readyData(){this._x=[],this._shift=[],this._scale=[],this._index=null,this._datetime=null,this._manager.platform?.init();const e=this.indicatorCodes;if(this._selector.columns=[],e.length===0){this.setting.ml.refresh();return}this._loader.classList.add("loader");const t={Cycle:this.cycle,RegionCode:this.region},c=JSON.stringify(t),l=await this._getData(e,t);if(this._loader.classList.remove("loader"),e.length!=this.indicatorCodes.length||e.some((a,u)=>a!==this.indicatorCodes[u])||c!=JSON.stringify({Cycle:this.cycle,RegionCode:this.region})||l.GET_STATS.RESULT.status==="1")return;const n=l.GET_STATS.STATISTICAL_DATA.DATA_INF.DATA_OBJ,o=l.GET_STATS.STATISTICAL_DATA.CLASS_INF.CLASS_OBJ,s={};for(const a of o)s[a["@id"]]=a;const m=E((a,u)=>{for(const S of a.CLASS)if(S["@code"]===u)return S.$||S["@name"]},"getNameFromCobj"),_=["indicator"].map(a=>s[a]),i=["time"].map(a=>s[a]),h={},r=[];for(let a=0;a<n.length;a++){const u=n[a].VALUE,S=i.map(d=>u[`@${d["@id"]}`]).join("_"),T=_.map(d=>m(d,u[`@${d["@id"]}`])).join("_");h[S]||(h[S]={}),h[S][T]=u.$,r.includes(T)||r.push(T)}for(const a of Object.keys(h))Object.keys(h[a]).length!==r.length&&delete h[a];this._selector.columns=r;const f=[];for(let a=0;a<r.length-1;a++)f.push(a);this._selector.object=f,this._selector.target=r.length-1;const g=Object.keys(h);g.sort(),this._index=g;const y=g.map(a=>{const u=a.match(/([0-9]{4})([0-9CFQY]{2})00/),S=+u[1],T=u[2]==="CY"?1:u[2]==="FY"?4:u[2][1]==="Q"?(+u[2][0]-1)*3+1:+u[2];return{year:S,month:T}}),x=y.reduce((a,u)=>Math.min(a,u.year),1/0);this._datetime=y.map(a=>(a.year-x)*12+a.month-1);const C=r.map(a=>({name:a,nan:0})),I=new M(g.map(a=>h[a]),{columnInfos:C});this.setArray(I.data,C),this.setting.ml.refresh(),this.setting.$forceUpdate()}}const J="dashboard.e-stat.go.jp";class L extends N{static{E(this,"EStatDB")}constructor(){super(J,3)}onupgradeneeded(e){const t=e.target.result;e.oldVersion<1&&(t.createObjectStore("meta",{keyPath:"function"}),t.createObjectStore("data",{keyPath:"GET_STATS.PARAMETER.indicatorCode"})),e.oldVersion<3&&(t.deleteObjectStore("data"),t.createObjectStore("data",{keyPath:"params"}))}}
