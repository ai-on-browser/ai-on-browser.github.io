import JSONData from"./json.js";const BASE_URL="https://dashboard.e-stat.go.jp/api/1.0",ExpiredTime=2592e6,lang=(()=>{switch(window.navigator.languages&&window.navigator.languages[0]||window.navigator.language){case"ja-JP":case"ja":return"JP";default:return"EN"}})(),resources={link:"JP"===lang?"https://dashboard.e-stat.go.jp/":"https://dashboard.e-stat.go.jp/en/",text:"JP"===lang?"統計ダッシュボード":"Statistics Dashboard",credit:"JP"===lang?"このサービスは、統計ダッシュボードのAPI機能を使用していますが、サービスの内容は国によって保証されたものではありません。また、データの加工を行っております。":"This service uses the API feature of Statistics Dashboard, but the contents of this service are not guaranteed by the Statistics Bureau of Japan. In addition, the data is processed."},datasetInfos={"Nikkei Indexes":{indicatorCode:["0702020501000010010"],columnKeys:["indicator"],indexKeys:["time"],availTask:["SM","TP","CP"]},"Number of entries/departures":{indicatorCode:["0204030001000010010","0204040001000010010"],columnKeys:["indicator"],indexKeys:["time"],filter:{cycle:["Month","月"]},availTask:["RG","AD","SM","TP","CP"]},"Employed persons":{indicatorCode:["0301010000010010010","0301010000020010010","0301010000030010010"],columnKeys:["indicator"],indexKeys:["time"],filter:{cycle:["Month","月"]},availTask:["RG","AD","SM","TP","CP"]},"Number of schools":{indicatorCode:["1201010100000010000","1201010300000010000","1201010400000010000","1201010500000010000","1201010800000010000"],columnKeys:["indicator"],indexKeys:["time"],query:{RegionLevel:2},availTask:["RG","AD","SM","TP","CP"]},Garbage:{indicatorCode:["1405050100000010010","1405050300000010010","1405050800000020010","1405050900000010010"],columnKeys:["indicator"],indexKeys:["time"],query:{RegionLevel:2},availTask:["RG","AD","SM","TP","CP"]}},lockKeys={};export default class EStatData extends JSONData{constructor(t){super(t),this._name="Nikkei Indexes",this._columns=[],this._availTask=[],this._shift=[],this._scale=[],this._object=[],this._target=-1;const e=this.setting.data.configElement,s=document.createElement("div");s.style.display="flex",s.style.justifyContent="space-between",e.appendChild(s);const a=document.createElement("span");s.appendChild(a);const n=document.createElement("select");n.name="name",n.onchange=()=>{this._name=n.value,this._readyData(),this.setting.vue.pushHistory()};for(const t of Object.keys(datasetInfos)){const e=document.createElement("option");e.value=t,e.innerText=datasetInfos[t].caption||t,n.appendChild(e)}a.append("Name",n);const i=document.createElement("a");s.appendChild(i),i.href=resources.link,i.setAttribute("ref","noreferrer noopener"),i.target="_blank",i.innerText=resources.text;const o=document.createElement("span");o.innerText=resources.credit,o.style.fontSize="80%",e.appendChild(o),this._selector=document.createElement("div"),e.appendChild(this._selector),this._readyData()}get availTask(){return this._availTask}get columnNames(){return this._object.map((t=>this._columns[t]))}get originalX(){return this._x.map((t=>this._object.map((e=>t[e]))))}get x(){return this._readyScaledData(),this._x.map((t=>{const e=t.map(((t,e)=>(t-this._shift[e])/this._scale[e]));return this._object.map((t=>e[t]))}))}get originalY(){return this._target>=0?this._x.map((t=>t[this._target])):Array(this._x.length).fill(0)}get y(){return this._readyScaledData(),this._target>=0?this._x.map((t=>(t[this._target]-this._shift[this._target])/this._scale[this._target])):Array(this._x.length).fill(0)}get params(){return{dataname:this._name}}set params(t){if(t.dataname&&Object.keys(datasetInfos).indexOf(t.dataname)>=0){const e=this.setting.data.configElement;this._name=t.dataname,e.querySelector("[name=name]").value=t.dataname,this._readyData()}}_readyScaledData(){if(!(this._scale.length>0)&&(this._shift=[],this._scale=[],this._x.length>0)){const t=Array(this._x[0].length).fill(1/0),e=Array(this._x[0].length).fill(-1/0);for(let s=0;s<this._x.length;s++)for(let a=0;a<this._x[s].length;a++)t[a]=Math.min(t[a],this._x[s][a]),e[a]=Math.max(e[a],this._x[s][a]);const s=10,a=1;for(let n=0;n<t.length;n++)t[n]===e[n]&&(e[n]=t[n]+1),this._scale[n]=(e[n]-t[n])/(s-a),this._shift[n]=t[n]-a*this._scale[n]}}async _getMeta(){const t="Indicator",e=`GET_META_${t.toUpperCase()}_INF`,s={Lang:"JP"===lang?"JP":"EN"},a=new EStatDB,n=await a.get("meta",t);if(!n||+n[e].RESULT.status>=100||new Date-n.fetchDate>2592e6){const n=t;if(lockKeys[n])return new Promise((e=>{lockKeys[n]?lockKeys[n].push(e):e(a.get("meta",t))}));const i=`${BASE_URL}/Json/get${t}Info?${new URLSearchParams(s)}`;console.debug(`Fetch to ${i}`),lockKeys[n]=[];const o=await fetch(i),r=await o.json();+r[e].RESULT.status>=100&&console.error(r[e].RESULT),r.function=t,r.fetchDate=new Date,await a.save("meta",r);for(const t of lockKeys[n])t(r);return lockKeys[n]=void 0,r}return n}async _getData(t,e){const s={Lang:"JP"===lang?"JP":"EN",IndicatorCode:t,IsSeasonalAdjustment:1,MetaGetFlg:"Y",...e},a=new EStatDB,n=await a.get("data",t);if(!n||+n.GET_STATS.RESULT.status>=100||new Date-n.fetchDate>2592e6){const e=t.join(",");if(lockKeys[e])return new Promise((s=>{lockKeys[e]?lockKeys[e].push(s):s(a.get("data",t))}));const n=`${BASE_URL}/Json/getData?${new URLSearchParams(s)}`;console.debug(`Fetch to ${n}`),lockKeys[e]=[];const i=await fetch(n),o=await i.json();+o.GET_STATS.RESULT.status>=100&&console.error(o.GET_STATS.RESULT),o.fetchDate=new Date,await a.save("data",o);for(const t of lockKeys[e])t(o);return lockKeys[e]=void 0,o}return n}async _readyData(){this._x=[],this._shift=[],this._scale=[],this._index=null,this._manager.platform?.init();const t=datasetInfos[this._name];this._availTask=t.availTask;const e=document.createElement("div");e.classList.add("loader"),this._selector.replaceChildren(e);const s=this._name,a=await this._getData(t.indicatorCode,t.query);if(this._name!==s)return;const n=a.GET_STATS.STATISTICAL_DATA.DATA_INF.DATA_OBJ,i=a.GET_STATS.STATISTICAL_DATA.CLASS_INF.CLASS_OBJ,o={};for(const t of i)o[t["@id"]]=t;const r=(t,e)=>{for(const s of t.CLASS)if(s["@code"]===e)return s.$||s["@name"]},c=t.columnKeys.map((t=>o[t])),l=t.indexKeys.map((t=>o[t])),h={},d=[];for(let e=0;e<n.length;e++){const s=n[e].VALUE;if(t.filter){let e=!0;for(const a of Object.keys(t.filter)){const n=o[a],i=s[`@${n["@id"]}`],c=r(n,i),l=t.filter[a];if("string"==typeof l)e&&=c===l;else{if(!Array.isArray(l))throw new Error("Invalid condition");e&&=l.indexOf(c)>=0}}if(!e)continue}const a=l.map((t=>s[`@${t["@id"]}`])).join("_"),i=c.map((t=>r(t,s[`@${t["@id"]}`]))).join("_");h[a]||(h[a]={}),h[a][i]=s.$,d.indexOf(i)<0&&d.push(i)}this._columns=d,this._object=[];for(let t=0;t<Math.max(1,d.length-1);t++)this._object.push(t);this._target=1===d.length?-1:this._columns.length-1;const u=Object.keys(h);u.sort(),this._index=u,this.setJSON(u.map((t=>h[t])),d.map((t=>({name:t,nan:0})))),this._readySelector(),this.setting.ml.refresh(),this.setting.vue.$forceUpdate()}_readySelector(){if(this._selector.replaceChildren(),this._columns.length>1){const t=document.createElement("select");t.multiple=!0,t.onchange=()=>{this._object=[];let s="",a=!1;for(const n of t.options)n.selected?(this._object.push(this._columns.indexOf(n.value)),n.value===e.value&&(a=!0)):s||(s=n.value);a&&(this._target=this._columns.indexOf(s),e.value=s),this._domain=null,this._manager.onReady((()=>{this._manager.platform.init()}))},this._selector.append("Input",t);const e=document.createElement("select");e.onchange=()=>{let s=!1;for(const a of t.selectedOptions)if(a.value===e.value){a.selected=!1,this._object=this._object.filter((t=>this._columns[t]!==a.value)),s=!0;break}if(s||""===e.value&&this._target>=0)for(const e of t.options)e.value===this._columns[this._target]&&(e.selected=!0,this._object.push(this._target));this._target=this._columns.indexOf(e.value),this._domain=null,this._manager.onReady((()=>{this._manager.platform.init()}))},this._selector.append("Output",e),e.appendChild(document.createElement("option"));for(const s of this._columns){const a=document.createElement("option");a.value=s,a.innerText=s,t.appendChild(a),e.appendChild(a.cloneNode(!0))}t.size=Math.min(4,t.options.length);for(let e=0;e<this._columns.length-1;e++)t.options[e].selected=this._object.indexOf(e)>=0;e.value=this._columns[this._target]}}}const DB_NAME="dashboard.e-stat.go.jp";class EStatDB{constructor(){this.db=null}async _ready(){if(this.db)return;const t=indexedDB.open(DB_NAME,2);return new Promise(((e,s)=>{t.onerror=s,t.onsuccess=()=>{this.db=t.result,e()},t.onupgradeneeded=t=>{const e=t.target.result;e.createObjectStore("meta",{keyPath:"function"}),t.oldVersion<1&&e.createObjectStore("data",{keyPath:"GET_STATS.PARAMETER.indicatorCode"})}}))}async save(t,e){return await this._ready(),new Promise(((s,a)=>{const n=this.db.transaction([t],"readwrite"),i=n.objectStore(t);Array.isArray(e)||(e=[e]);for(const t of e)i.put(t);n.oncomplete=s,n.onerror=a}))}async get(t,e){return await this._ready(),new Promise(((s,a)=>{const n=this.db.transaction(t).objectStore(t).get(e);n.onsuccess=t=>{s(t.target.result)},n.onerror=a}))}async list(t){return await this._ready(),new Promise(((e,s)=>{const a=this.db.transaction(t).objectStore(t).getAll();a.onsuccess=t=>{e(t.target.result)},a.onerror=s}))}async deleteDatabase(){return new Promise(((t,e)=>{this.db.close();const s=indexedDB.deleteDatabase(DB_NAME);s.onerror=e,s.onsuccess=()=>{this.db=null,t()}}))}}