var O=Object.defineProperty;var A=(j,e)=>O(j,"name",{value:e,configurable:!0});import P from"./db/base.js";import J from"./json.js";const w="https://dashboard.e-stat.go.jp/api/1.0",L=1e3*60*60*24*30,D=(()=>{switch(window.navigator.languages&&window.navigator.languages[0]||window.navigator.language){case"ja-JP":case"ja":return"JP";default:return"EN"}})(),R={link:D==="JP"?"https://dashboard.e-stat.go.jp/":"https://dashboard.e-stat.go.jp/en/",text:D==="JP"?"\u7D71\u8A08\u30C0\u30C3\u30B7\u30E5\u30DC\u30FC\u30C9":"Statistics Dashboard",credit:D==="JP"?"\u3053\u306E\u30B5\u30FC\u30D3\u30B9\u306F\u3001\u7D71\u8A08\u30C0\u30C3\u30B7\u30E5\u30DC\u30FC\u30C9\u306EAPI\u6A5F\u80FD\u3092\u4F7F\u7528\u3057\u3066\u3044\u307E\u3059\u304C\u3001\u30B5\u30FC\u30D3\u30B9\u306E\u5185\u5BB9\u306F\u56FD\u306B\u3088\u3063\u3066\u4FDD\u8A3C\u3055\u308C\u305F\u3082\u306E\u3067\u306F\u3042\u308A\u307E\u305B\u3093\u3002\u307E\u305F\u3001\u30C7\u30FC\u30BF\u306E\u52A0\u5DE5\u3092\u884C\u3063\u3066\u304A\u308A\u307E\u3059\u3002":"This service uses the API feature of Statistics Dashboard, but the contents of this service are not guaranteed by the Statistics Bureau of Japan. In addition, the data is processed."},y={Manual:{indicatorCode:[],columnKeys:["indicator"],indexKeys:["time"],query:{},dropna:!0,availTask:["RG","AD","SM","TP","CP"]},"Nikkei Indexes":{indicatorCode:["0702020501000010010"],columnKeys:["indicator"],indexKeys:["time"],availTask:["SM","TP","CP"]},"Number of entries/departures":{indicatorCode:["0204030001000010010","0204040001000010010"],columnKeys:["indicator"],indexKeys:["time"],filter:{cycle:["Month","\u6708"]},availTask:["RG","AD","SM","TP","CP"]},"Employed persons":{indicatorCode:["0301010000010010010","0301010000020010010","0301010000030010010"],columnKeys:["indicator"],indexKeys:["time"],filter:{cycle:["Month","\u6708"]},availTask:["RG","AD","SM","TP","CP"]},"Number of schools":{indicatorCode:["1201010100000010000","1201010300000010000","1201010400000010000","1201010500000010000","1201010800000010000"],columnKeys:["indicator"],indexKeys:["time"],query:{RegionLevel:2},availTask:["RG","AD","SM","TP","CP"]},Garbage:{indicatorCode:["1405050100000010010","1405050300000010010","1405050800000020010","1405050900000010010"],columnKeys:["indicator"],indexKeys:["time"],query:{RegionLevel:2},availTask:["RG","AD","SM","TP","CP"]}},C={};export default class G extends J{static{A(this,"EStatData")}constructor(e){super(e),this._name="Nikkei Indexes",this._columns=[],this._shift=[],this._scale=[],this._object=[],this._target=-1,this._scaled=!0,this._lastRequested=0;const t=this.setting.data.configElement,a=document.createElement("div");a.style.display="flex",a.style.justifyContent="space-between",t.appendChild(a);const o=document.createElement("span");a.appendChild(o);const n=document.createElement("select");n.name="name",n.onchange=()=>{this._name=n.value,this._indicatorSelector.style.display=this._name==="Manual"?"flex":"none",this._readyData(),this.setting.pushHistory()};for(const c of Object.keys(y)){const g=document.createElement("option");g.value=c,g.innerText=y[c].caption||c,n.appendChild(g)}n.value=this._name,o.append("Name",n);const i=document.createElement("a");a.appendChild(i),i.href=R.link,i.setAttribute("ref","noreferrer noopener"),i.target="_blank",i.innerText=R.text,this._indicatorSelector=document.createElement("div"),t.appendChild(this._indicatorSelector),this._initManualIndicatorSelector();const r=document.createElement("span");r.innerText=R.credit,r.style.fontSize="80%",t.appendChild(r),this._selector=document.createElement("div"),t.appendChild(this._selector);const p=document.createElement("div"),f=document.createElement("input");f.type="checkbox",f.checked=!0,f.onchange=()=>{this._scaled=f.checked,this._readyData()},p.append("Scale",f),t.appendChild(p),this._readyData()}get availTask(){return y[this._name]?.availTask||[]}get columnNames(){return this._object.map(e=>this._columns[e])}get originalX(){return this._x.map(e=>this._object.map(t=>e[t]))}get x(){return this._scaled?(this._readyScaledData(),this._x.map(e=>{const t=e.map((a,o)=>(a-this._shift[o])/this._scale[o]);return this._object.map(a=>t[a])})):this.originalX}get originalY(){return this._target>=0?this._x.map(e=>e[this._target]):Array(this._x.length).fill(0)}get y(){return this._scaled?(this._readyScaledData(),this._target>=0?this._x.map(e=>(e[this._target]-this._shift[this._target])/this._scale[this._target]):Array(this._x.length).fill(0)):this.originalY}get params(){return{dataname:this._name}}set params(e){if(e.dataname&&Object.keys(y).includes(e.dataname)){const t=this.setting.data.configElement;this._name=e.dataname,t.querySelector("[name=name]").value=e.dataname,e.dataname!=="Manual"&&this._readyData()}}_initManualIndicatorSelector(){this._indicatorSelector.style.display="none",this._indicatorSelector.style.alignItems="flex-start",this._indicatorSelector.classList.add("sub-menu");let e=null;const t={},a=document.createElement("select");a.multiple=!0,a.size=5,a.style.overflowY="hidden",a.style.minWidth="100px";const o=document.createElement("span");o.style.margin="auto 0";const n=document.createElement("button");n.innerHTML="&larr;",n.onclick=()=>{let d=!1;const l=y.Manual.indicatorCode;for(const s of g.selectedOptions){if(l.length>=5||l.includes(s.value))break;a.appendChild(s.cloneNode(!0)),l.push(s.value),d=!0}d&&(u(),this._readyData())};const i=document.createElement("button");i.innerHTML="&rarr;",i.onclick=()=>{let d=!1;for(let l=a.options.length-1;l>=0;l--){const s=a.options.item(l);s.selected&&(s.remove(),d=!0)}y.Manual.indicatorCode=[];for(const l of a.options)y.Manual.indicatorCode.push(l.value);d&&(u(),this._readyData())},o.append(n,document.createElement("br"),i);const r=document.createElement("span"),p=document.createElement("select");p.onchange=()=>u();const f=document.createElement("select");f.onchange=()=>{y.Manual.query.Cycle=f.value,u(),this._readyData()};const c=document.createElement("select");c.onchange=()=>{y.Manual.query.RegionCode=c.value,u(),this._readyData()};const g=document.createElement("select");g.multiple=!0;const u=A(()=>{g.replaceChildren();const d=y.Manual.indicatorCode;for(const l of e){if(!l["@code"].startsWith(p.value)||l.CLASS.every(m=>m.cycle["@code"]!==f.value||m.RegionalRank["@code"]!==t[c.value]))continue;const s=g.appendChild(document.createElement("option"));s.value=l["@code"],s.innerText=l["@name"],s.disabled=d.includes(l["@code"])}},"filterIndicatorCodes");r.append("Filter",p,f,c,document.createElement("br"),g),this._indicatorSelector.append("Indicator ",a,o,r);const S=A((d,l)=>{const s=Object.keys(d);s.sort((m,_)=>m-_);for(const m of s){const _=l.appendChild(document.createElement("option"));_.value=m,_.innerText=d[m]}},"dictToOptions");Promise.all(["Indicator","Term","Region"].map(d=>this._getMeta(d))).then(([d,l,s])=>{e=d.GET_META_INDICATOR_INF.METADATA_INF.CLASS_INF.CLASS_OBJ;const m={};for(const h of e)for(const M of h.CLASS)m[M.cycle["@code"]]||(m[M.cycle["@code"]]=M.cycle["@name"]);S(m,f),f.value=3,y.Manual.query.Cycle=3;const _={},v=l.GET_META_TERM_INFO.METADATA_INF.CLASS_INF.CLASS_OBJ.CLASS;for(const h of v)_[h["@code"].slice(0,4)]||(_[h["@code"].slice(0,4)]=h["@category"]);S(_,p);const T={},b=s.GET_META_REGION_INF.METADATA_INF.CLASS_INF.CLASS_OBJ,k=b.find(h=>h["@parentRegionCode"].length===0);let E=null;for(const h of k.CLASS)h["@level"]==="2"&&(T[h["@regionCode"]]=h["@name"],E=h["@regionCode"],t[h["@regionCode"]]=h["@level"]);const I=b.find(h=>h["@parentRegionCode"]===E);for(const h of I.CLASS)h["@level"]==="3"&&(T[h["@regionCode"]]=h["@name"],t[h["@regionCode"]]=h["@level"]);S(T,c),c.value=E,y.Manual.query.RegionCode=E,u(),this.setting.data.configElement.querySelector("[name=name]").value==="Manual"&&(this._indicatorSelector.style.display="flex",this._readyData())})}_readyScaledData(){if(!(this._scale.length>0)&&(this._shift=[],this._scale=[],this._x.length>0)){const e=Array(this._x[0].length).fill(1/0),t=Array(this._x[0].length).fill(-1/0);for(let n=0;n<this._x.length;n++)for(let i=0;i<this._x[n].length;i++)e[i]=Math.min(e[i],this._x[n][i]),t[i]=Math.max(t[i],this._x[n][i]);const a=10,o=0;for(let n=0;n<e.length;n++)e[n]===t[n]&&(t[n]=e[n]+1),this._scale[n]=(t[n]-e[n])/(a-o),this._shift[n]=e[n]-o*this._scale[n]}}async _getMeta(e){const t=e.toUpperCase()==="INDICATOR"||e.toUpperCase()==="REGION"?"INF":"INFO",a=`GET_META_${e.toUpperCase()}_${t}`,o={Lang:D==="JP"?"JP":"EN"},n=new N,i=await n.get("meta",e);if(!i||+i[a].RESULT.status>=100||new Date-i.fetchDate>L){const r=e;if(C[r])return new Promise(u=>{C[r]?C[r].push(u):u(n.get("meta",e))});const p=`${w}/Json/get${e}Info?${new URLSearchParams(o)}`;console.debug(`Fetch to ${p}`),C[r]=[];const c=await(await fetch(p)).json();+c[a].RESULT.status>=100&&console.error(c[a].RESULT),c.function=e,c.fetchDate=new Date,await n.save("meta",c);for(const u of C[r])u(c);return C[r]=void 0,c}return i}async _getData(e,t){const a={Lang:D==="JP"?"JP":"EN",IndicatorCode:e,IsSeasonalAdjustment:1,MetaGetFlg:"Y",...t},o=new URLSearchParams(a).toString(),n=new N,i=await n.get("data",o);if(!i||+i.GET_STATS.RESULT.status>=100||new Date-i.fetchDate>L){const r=e.join(",");if(C[r])return new Promise(u=>{C[r]?C[r].push(u):u(n.get("data",e))});for(;new Date-this._lastRequested<2e3;)await new Promise(u=>setTimeout(u,500));this._lastRequested=new Date;const p=`${w}/Json/getData?${o}`;console.debug(`Fetch to ${p}`),C[r]=[];const c=await(await fetch(p)).json();+c.GET_STATS.RESULT.status>=100&&console.error(c.GET_STATS.RESULT),c.fetchDate=new Date,c.params=o,await n.save("data",c);for(const u of C[r])u(c);return C[r]=void 0,c}return i}async _readyData(){this._x=[],this._shift=[],this._scale=[],this._columns=[],this._object=[],this._index=null,this._manager.platform?.init();const e=y[this._name],t=e.indicatorCode.concat();if(t.length===0){this._readySelector(),this.setting.ml.refresh();return}const a=document.createElement("div");a.classList.add("loader"),this._selector.replaceChildren(a);const o=this._name,n=JSON.stringify(e.query),i=await this._getData(t,e.query);if(this._name!==o||t.length!=e.indicatorCode.length||t.some((s,m)=>s!==e.indicatorCode[m])||n!=JSON.stringify(e.query))return;if(i.GET_STATS.RESULT.status==="1"){this._readySelector();return}const r=i.GET_STATS.STATISTICAL_DATA.DATA_INF.DATA_OBJ,p=i.GET_STATS.STATISTICAL_DATA.CLASS_INF.CLASS_OBJ,f={};for(const s of p)f[s["@id"]]=s;const c=A((s,m)=>{for(const _ of s.CLASS)if(_["@code"]===m)return _.$||_["@name"]},"getNameFromCobj"),g=e.columnKeys.map(s=>f[s]),u=e.indexKeys.map(s=>f[s]),S={},d=[];for(let s=0;s<r.length;s++){const m=r[s].VALUE;if(e.filter){let T=!0;for(const b of Object.keys(e.filter)){const k=f[b],E=m[`@${k["@id"]}`],I=c(k,E),x=e.filter[b];if(typeof x=="string")T&&=I===x;else if(Array.isArray(x))T&&=x.includes(I);else throw new Error("Invalid condition")}if(!T)continue}const _=u.map(T=>m[`@${T["@id"]}`]).join("_"),v=g.map(T=>c(T,m[`@${T["@id"]}`])).join("_");S[_]||(S[_]={}),S[_][v]=m.$,d.includes(v)||d.push(v)}if(e.dropna)for(const s of Object.keys(S))Object.keys(S[s]).length!==d.length&&delete S[s];this._columns=d,this._object=[];for(let s=0;s<Math.max(1,d.length-1);s++)this._object.push(s);this._target=d.length===1?-1:this._columns.length-1;const l=Object.keys(S);l.sort(),this._index=l,this.setJSON(l.map(s=>S[s]),d.map(s=>({name:s,nan:0}))),this._readySelector(),this.setting.ml.refresh(),this.setting.$forceUpdate()}_readySelector(){if(this._selector.replaceChildren(),this._columns.length>1){const e=document.createElement("select");e.multiple=!0,e.onchange=()=>{this._object=[];let a="",o=!1;for(const n of e.options)n.selected?(this._object.push(this._columns.indexOf(n.value)),n.value===t.value&&(o=!0)):a||(a=n.value);o&&(this._target=this._columns.indexOf(a),t.value=a),this._domain=null,this._manager.onReady(()=>{this._manager.platform.init()})},this._selector.append("Input",e);const t=document.createElement("select");t.onchange=()=>{let a=!1;for(const o of e.selectedOptions)if(o.value===t.value){o.selected=!1,this._object=this._object.filter(n=>this._columns[n]!==o.value),a=!0;break}if(a||t.value===""&&this._target>=0)for(const o of e.options)o.value===this._columns[this._target]&&(o.selected=!0,this._object.push(this._target));this._target=this._columns.indexOf(t.value),this._domain=null,this._manager.onReady(()=>{this._manager.platform.init()})},this._selector.append("Output",t),t.appendChild(document.createElement("option"));for(const a of this._columns){const o=document.createElement("option");o.value=o.innerText=a,e.appendChild(o),t.appendChild(o.cloneNode(!0))}e.size=Math.min(4,e.options.length);for(let a=0;a<this._columns.length-1;a++)e.options[a].selected=this._object.includes(a);t.value=this._columns[this._target]}}}const K="dashboard.e-stat.go.jp";class N extends P{static{A(this,"EStatDB")}constructor(){super(K,3)}onupgradeneeded(e){const t=e.target.result;e.oldVersion<1&&(t.createObjectStore("meta",{keyPath:"function"}),t.createObjectStore("data",{keyPath:"GET_STATS.PARAMETER.indicatorCode"})),e.oldVersion<3&&(t.deleteObjectStore("data"),t.createObjectStore("data",{keyPath:"params"}))}}
