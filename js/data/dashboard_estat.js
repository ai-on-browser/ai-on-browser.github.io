var N=Object.defineProperty;var E=(D,e)=>N(D,"name",{value:e,configurable:!0});import x from"./db/base.js";import{FixData as O}from"./base.js";import M from"./loader/json.js";import P from"./util/ioselector.js";const L="https://dashboard.e-stat.go.jp/api/1.0",R=1e3*60*60*24*30,A=(()=>{switch(window.navigator.languages&&window.navigator.languages[0]||window.navigator.language){case"ja-JP":case"ja":return"JP";default:return"EN"}})(),w={link:A==="JP"?"https://dashboard.e-stat.go.jp/":"https://dashboard.e-stat.go.jp/en/",text:A==="JP"?"\u7D71\u8A08\u30C0\u30C3\u30B7\u30E5\u30DC\u30FC\u30C9":"Statistics Dashboard",credit:A==="JP"?"\u3053\u306E\u30B5\u30FC\u30D3\u30B9\u306F\u3001\u7D71\u8A08\u30C0\u30C3\u30B7\u30E5\u30DC\u30FC\u30C9\u306EAPI\u6A5F\u80FD\u3092\u4F7F\u7528\u3057\u3066\u3044\u307E\u3059\u304C\u3001\u30B5\u30FC\u30D3\u30B9\u306E\u5185\u5BB9\u306F\u56FD\u306B\u3088\u3063\u3066\u4FDD\u8A3C\u3055\u308C\u305F\u3082\u306E\u3067\u306F\u3042\u308A\u307E\u305B\u3093\u3002\u307E\u305F\u3001\u30C7\u30FC\u30BF\u306E\u52A0\u5DE5\u3092\u884C\u3063\u3066\u304A\u308A\u307E\u3059\u3002":"This service uses the API feature of Statistics Dashboard, but the contents of this service are not guaranteed by the Statistics Bureau of Japan. In addition, the data is processed."},b={Manual:null,"Nikkei Indexes":{indicatorCode:["0702020501000010010"],region:"00000",cycle:"1"},"Number of entries/departures":{indicatorCode:["0204030001000010010","0204040001000010010"],region:"00000",cycle:"1"},"Employed persons":{indicatorCode:["0301010000010010010","0301010000020010010","0301010000030010010"],region:"00000",cycle:"1"},"Number of schools":{indicatorCode:["1201010100000010000","1201010300000010000","1201010400000010000","1201010500000010000","1201010800000010000"],region:"00000",cycle:"3"},Garbage:{indicatorCode:["1405050100000010010","1405050300000010010","1405050800000020010","1405050900000010010"],region:"00000",cycle:"4"}},p={};export default class F extends O{static{E(this,"EStatData")}constructor(e){super(e),this._name="Nikkei Indexes",this._lastRequested=0;const n=this.setting.data.configElement,l=document.createElement("div");l.style.display="flex",l.style.justifyContent="space-between",n.appendChild(l);const m=document.createElement("span");l.appendChild(m);const c=document.createElement("select");c.name="name",c.onchange=()=>{this._name=c.value;const s=b[this._name];s&&this._setIndicators(s.indicatorCode,s.cycle,s.region),this._readyData(),this.setting.pushHistory()};for(const s of Object.keys(b)){const f=c.appendChild(document.createElement("option"));f.value=f.innerText=s}c.value=this._name,m.append("Name",c);const r=document.createElement("a");l.appendChild(r),r.href=w.link,r.setAttribute("ref","noreferrer noopener"),r.target="_blank",r.innerText=w.text,this._indicatorSelector=document.createElement("div"),n.appendChild(this._indicatorSelector);const t=document.createElement("span");t.innerText=w.credit,t.style.fontSize="80%",n.appendChild(t),this._selector=new P(n),this._selector.onchange=()=>{this._domain=null,this._manager.onReady(()=>{this._manager.platform.init()})},this._loader=document.createElement("div"),n.appendChild(this._loader),this._initIndicatorSelector().then(()=>{const s=b[this._name];s&&this._setIndicators(s.indicatorCode,s.cycle,s.region),this._readyData()})}get availTask(){return["RG","AD","SM","TP","CP"]}get _requireDateInput(){return this._selector.object.length===0&&this._datetime&&["","RG","AD"].includes(this._manager.task)}get columnNames(){return this._requireDateInput?["date"]:this._selector.objectNames}get originalX(){return this._requireDateInput?this._datetime.map(e=>[e]):this._x.map(e=>this._selector.object.map(n=>e[n]))}get x(){return this.originalX}get originalY(){const e=this._selector.target;return e>=0?this._x.map(n=>n[e]):Array(this._x.length).fill(0)}get y(){return this.originalY}get params(){return{dataname:this._name}}set params(e){if(e.dataname&&Object.keys(b).includes(e.dataname)){const n=this.setting.data.configElement;this._name=e.dataname,n.querySelector("[name=name]").value=e.dataname,this._indicatorMetaInfos&&this._readyData()}}get indicatorCodes(){const e=this._indicatorSelector.querySelector("select[name=useCodes]"),n=[];for(const l of e.options)n.push(l.value);return n}get cycle(){return this._indicatorSelector.querySelector("select[name=cycle]").value}get region(){return this._indicatorSelector.querySelector("select[name=region]").value}_initIndicatorSelector(){this._indicatorSelector.style.display="flex",this._indicatorSelector.style.alignItems="flex-start",this._regionCodeToRank={};const e=document.createElement("select");e.name="useCodes",e.multiple=!0,e.size=5,e.style.overflowY="hidden",e.style.minWidth="100px";const n=document.createElement("span");n.style.margin="auto 0";const l=document.createElement("button");l.innerHTML="&larr;",l.onclick=()=>{let d=!1;const a=this.indicatorCodes;for(const g of f.selectedOptions){if(a.length>=5||a.includes(g.value))break;e.appendChild(g.cloneNode(!0)),d=!0}d&&(this._filterIndicatorCodes(),this._readyData())};const m=document.createElement("button");m.innerHTML="&rarr;",m.onclick=()=>{let d=!1;for(let a=e.options.length-1;a>=0;a--){const g=e.options.item(a);g.selected&&(g.remove(),d=!0)}d&&(this._filterIndicatorCodes(),this._readyData())},n.append(l,document.createElement("br"),m);const c=document.createElement("span"),r=document.createElement("select");r.name="category",r.onchange=()=>this._filterIndicatorCodes();const t=document.createElement("select");t.name="cycle",t.onchange=()=>{this._filterIndicatorCodes(),this._readyData()};const s=document.createElement("select");s.name="region",s.onchange=()=>{this._filterIndicatorCodes(),this._readyData()};const f=document.createElement("select");f.name="unuseCodes",f.multiple=!0,c.append("Filter",r,t,s,document.createElement("br"),f),this._indicatorSelector.append("Indicator ",e,n,c);const h=E((d,a)=>{const g=Object.keys(d);g.sort((_,S)=>_-S);for(const _ of g){const S=a.appendChild(document.createElement("option"));S.value=_,S.innerText=d[_]}},"dictToOptions");return Promise.all(["Indicator","Term","Region"].map(d=>this._getMeta(d))).then(([d,a,g])=>{this._indicatorMetaInfos=d.GET_META_INDICATOR_INF.METADATA_INF.CLASS_INF.CLASS_OBJ;const _={};for(const i of this._indicatorMetaInfos)for(const v of i.CLASS)_[v.cycle["@code"]]||(_[v.cycle["@code"]]=v.cycle["@name"]);h(_,t),t.value=3;const S={},k=a.GET_META_TERM_INFO.METADATA_INF.CLASS_INF.CLASS_OBJ.CLASS;for(const i of k)S[i["@code"].slice(0,4)]||(S[i["@code"].slice(0,4)]=i["@category"]);h(S,r);const C={},I=g.GET_META_REGION_INF.METADATA_INF.CLASS_INF.CLASS_OBJ,o=I.find(i=>i["@parentRegionCode"].length===0);let u=null;for(const i of o.CLASS)i["@level"]==="2"&&(C[i["@regionCode"]]=i["@name"],u=i["@regionCode"],this._regionCodeToRank[i["@regionCode"]]=i["@level"]);const y=I.find(i=>i["@parentRegionCode"]===u);for(const i of y.CLASS)i["@level"]==="3"&&(C[i["@regionCode"]]=i["@name"],this._regionCodeToRank[i["@regionCode"]]=i["@level"]);h(C,s),s.value=u,this._filterIndicatorCodes(),this.setting.data.configElement.querySelector("[name=name]").value==="Manual"&&(this._indicatorSelector.style.display="flex",this._readyData())})}_setIndicators(e,n,l){const m=this._indicatorSelector.querySelector("select[name=useCodes]");m.replaceChildren();for(const t of this._indicatorMetaInfos)if(e.includes(t["@code"])){const s=m.appendChild(document.createElement("option"));s.value=t["@code"],s.innerText=t["@name"]}const c=this._indicatorSelector.querySelector("select[name=cycle]");c.value=n;const r=this._indicatorSelector.querySelector("select[name=region]");r.value=l,this._filterIndicatorCodes(e[0].slice(0,4))}_filterIndicatorCodes(e){const n=this._indicatorSelector.querySelector("select[name=category]");e&&(n.value=e),e=n.value;const l=this.cycle,m=this._regionCodeToRank[this.region],c=this._indicatorSelector.querySelector("select[name=unuseCodes]");c.replaceChildren();const r=this.indicatorCodes;for(const t of this._indicatorMetaInfos){if(!t["@code"].startsWith(e)||t.CLASS.every(f=>f.cycle["@code"]!==l||f.RegionalRank["@code"]!==m))continue;const s=c.appendChild(document.createElement("option"));s.value=t["@code"],s.innerText=t["@name"],s.disabled=r.includes(t["@code"])}}async _getMeta(e){const n=e.toUpperCase()==="INDICATOR"||e.toUpperCase()==="REGION"?"INF":"INFO",l=`GET_META_${e.toUpperCase()}_${n}`,m={Lang:A==="JP"?"JP":"EN"},c=new j,r=await c.get("meta",e);if(!r||+r[l].RESULT.status>=100||new Date-r.fetchDate>R){const t=e;if(p[t])return new Promise(a=>{p[t]?p[t].push(a):a(c.get("meta",e))});const s=`${L}/Json/get${e}Info?${new URLSearchParams(m)}`;console.debug(`Fetch to ${s}`),p[t]=[];const h=await(await fetch(s)).json();+h[l].RESULT.status>=100&&console.error(h[l].RESULT),h.function=e,h.fetchDate=new Date,await c.save("meta",h);for(const a of p[t])a(h);return p[t]=void 0,h}return r}async _getData(e,n){const l={Lang:A==="JP"?"JP":"EN",IndicatorCode:e,IsSeasonalAdjustment:1,MetaGetFlg:"Y",...n},m=new URLSearchParams(l).toString(),c=new j,r=await c.get("data",m);if(!r||+r.GET_STATS.RESULT.status>=100||new Date-r.fetchDate>R){const t=e.join(",");if(p[t])return new Promise(a=>{p[t]?p[t].push(a):a(c.get("data",e))});for(;new Date-this._lastRequested<2e3;)await new Promise(a=>setTimeout(a,500));this._lastRequested=new Date;const s=`${L}/Json/getData?${m}`;console.debug(`Fetch to ${s}`),p[t]=[];const h=await(await fetch(s)).json();+h.GET_STATS.RESULT.status>=100&&console.error(h.GET_STATS.RESULT),h.fetchDate=new Date,h.params=m,await c.save("data",h);for(const a of p[t])a(h);return p[t]=void 0,h}return r}async _readyData(){this._x=[],this._index=null,this._datetime=null,this._manager.platform?.init();const e=this.indicatorCodes;if(this._selector.columns=[],e.length===0){this.setting.ml.refresh();return}this._loader.classList.add("loader");const n={Cycle:this.cycle,RegionCode:this.region},l=JSON.stringify(n),m=await this._getData(e,n);if(this._loader.classList.remove("loader"),e.length!=this.indicatorCodes.length||e.some((o,u)=>o!==this.indicatorCodes[u])||l!=JSON.stringify({Cycle:this.cycle,RegionCode:this.region})||m.GET_STATS.RESULT.status==="1")return;const c=m.GET_STATS.STATISTICAL_DATA.DATA_INF.DATA_OBJ,r=m.GET_STATS.STATISTICAL_DATA.CLASS_INF.CLASS_OBJ,t={};for(const o of r)t[o["@id"]]=o;const s=E((o,u)=>{for(const y of o.CLASS)if(y["@code"]===u)return y.$||y["@name"]},"getNameFromCobj"),f=["indicator"].map(o=>t[o]),h=["time"].map(o=>t[o]),d={},a=[];for(let o=0;o<c.length;o++){const u=c[o].VALUE,y=h.map(i=>u[`@${i["@id"]}`]).join("_"),T=f.map(i=>s(i,u[`@${i["@id"]}`])).join("_");d[y]||(d[y]={}),d[y][T]=u.$,a.includes(T)||a.push(T)}for(const o of Object.keys(d))Object.keys(d[o]).length!==a.length&&delete d[o];this._selector.columns=a;const g=[];for(let o=0;o<a.length-1;o++)g.push(o);this._selector.object=g,this._selector.target=a.length-1;const _=Object.keys(d);_.sort(),this._index=_;const S=_.map(o=>{const u=o.match(/([0-9]{4})([0-9CFQY]{2})00/),y=+u[1],T=u[2]==="CY"?1:u[2]==="FY"?4:u[2][1]==="Q"?(+u[2][0]-1)*3+1:+u[2];return{year:y,month:T}}),k=S.reduce((o,u)=>Math.min(o,u.year),1/0);this._datetime=S.map(o=>(o.year-k)*12+o.month-1);const C=a.map(o=>({name:o,nan:0})),I=new M(_.map(o=>d[o]),{columnInfos:C});this.setArray(I.data,C),this.setting.ml.refresh(),this.setting.$forceUpdate()}}const J="dashboard.e-stat.go.jp";class j extends x{static{E(this,"EStatDB")}constructor(){super(J,3)}onupgradeneeded(e){const n=e.target.result;e.oldVersion<1&&(n.createObjectStore("meta",{keyPath:"function"}),n.createObjectStore("data",{keyPath:"GET_STATS.PARAMETER.indicatorCode"})),e.oldVersion<3&&(n.deleteObjectStore("data"),n.createObjectStore("data",{keyPath:"params"}))}}
