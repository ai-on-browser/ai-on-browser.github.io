var L=Object.defineProperty;var T=(v,e)=>L(v,"name",{value:e,configurable:!0});import N from"./db/base.js";import{FixData as O}from"./base.js";import M from"./loader/json.js";const k="https://dashboard.e-stat.go.jp/api/1.0",R=1e3*60*60*24*30,A=(()=>{switch(window.navigator.languages&&window.navigator.languages[0]||window.navigator.language){case"ja-JP":case"ja":return"JP";default:return"EN"}})(),j={link:A==="JP"?"https://dashboard.e-stat.go.jp/":"https://dashboard.e-stat.go.jp/en/",text:A==="JP"?"\u7D71\u8A08\u30C0\u30C3\u30B7\u30E5\u30DC\u30FC\u30C9":"Statistics Dashboard",credit:A==="JP"?"\u3053\u306E\u30B5\u30FC\u30D3\u30B9\u306F\u3001\u7D71\u8A08\u30C0\u30C3\u30B7\u30E5\u30DC\u30FC\u30C9\u306EAPI\u6A5F\u80FD\u3092\u4F7F\u7528\u3057\u3066\u3044\u307E\u3059\u304C\u3001\u30B5\u30FC\u30D3\u30B9\u306E\u5185\u5BB9\u306F\u56FD\u306B\u3088\u3063\u3066\u4FDD\u8A3C\u3055\u308C\u305F\u3082\u306E\u3067\u306F\u3042\u308A\u307E\u305B\u3093\u3002\u307E\u305F\u3001\u30C7\u30FC\u30BF\u306E\u52A0\u5DE5\u3092\u884C\u3063\u3066\u304A\u308A\u307E\u3059\u3002":"This service uses the API feature of Statistics Dashboard, but the contents of this service are not guaranteed by the Statistics Bureau of Japan. In addition, the data is processed."},b={Manual:null,"Nikkei Indexes":{indicatorCode:["0702020501000010010"],region:"00000",cycle:"1"},"Number of entries/departures":{indicatorCode:["0204030001000010010","0204040001000010010"],region:"00000",cycle:"1"},"Employed persons":{indicatorCode:["0301010000010010010","0301010000020010010","0301010000030010010"],region:"00000",cycle:"1"},"Number of schools":{indicatorCode:["1201010100000010000","1201010300000010000","1201010400000010000","1201010500000010000","1201010800000010000"],region:"00000",cycle:"3"},Garbage:{indicatorCode:["1405050100000010010","1405050300000010010","1405050800000020010","1405050900000010010"],region:"00000",cycle:"4"}},g={};export default class P extends O{static{T(this,"EStatData")}constructor(e){super(e),this._name="Nikkei Indexes",this._columns=[],this._shift=[],this._scale=[],this._object=[],this._target=-1,this._scaled=!0,this._lastRequested=0;const t=this.setting.data.configElement,s=document.createElement("div");s.style.display="flex",s.style.justifyContent="space-between",t.appendChild(s);const o=document.createElement("span");s.appendChild(o);const n=document.createElement("select");n.name="name",n.onchange=()=>{this._name=n.value;const r=b[this._name];r&&this._setIndicators(r.indicatorCode,r.cycle,r.region),this._readyData(),this.setting.pushHistory()};for(const r of Object.keys(b)){const u=n.appendChild(document.createElement("option"));u.value=u.innerText=r}n.value=this._name,o.append("Name",n);const i=document.createElement("a");s.appendChild(i),i.href=j.link,i.setAttribute("ref","noreferrer noopener"),i.target="_blank",i.innerText=j.text,this._indicatorSelector=document.createElement("div"),t.appendChild(this._indicatorSelector);const a=document.createElement("span");a.innerText=j.credit,a.style.fontSize="80%",t.appendChild(a),this._selector=document.createElement("div"),t.appendChild(this._selector);const h=document.createElement("div"),_=document.createElement("input");_.type="checkbox",_.checked=!0,_.onchange=()=>{this._scaled=_.checked,this._readyData()},h.append("Scale",_),t.appendChild(h),this._initIndicatorSelector().then(()=>{const r=b[this._name];r&&this._setIndicators(r.indicatorCode,r.cycle,r.region),this._readyData()})}get availTask(){return["RG","AD","SM","TP","CP"]}get _requireDateInput(){return this._object.length===0&&this._datetime&&["","RG","AD"].includes(this._manager.task)}get columnNames(){return this._requireDateInput?["date"]:this._object.map(e=>this._columns[e])}get originalX(){return this._requireDateInput?this._datetime.map(e=>[e]):this._x.map(e=>this._object.map(t=>e[t]))}get x(){return this._scaled?this._requireDateInput?this._datetime.map(e=>[e]):(this._readyScaledData(),this._x.map(e=>{const t=e.map((s,o)=>(s-this._shift[o])/this._scale[o]);return this._object.map(s=>t[s])})):this.originalX}get originalY(){return this._target>=0?this._x.map(e=>e[this._target]):Array(this._x.length).fill(0)}get y(){return this._scaled?(this._readyScaledData(),this._target>=0?this._x.map(e=>(e[this._target]-this._shift[this._target])/this._scale[this._target]):Array(this._x.length).fill(0)):this.originalY}get params(){return{dataname:this._name}}set params(e){if(e.dataname&&Object.keys(b).includes(e.dataname)){const t=this.setting.data.configElement;this._name=e.dataname,t.querySelector("[name=name]").value=e.dataname,this._indicatorMetaInfos&&this._readyData()}}get indicatorCodes(){const e=this._indicatorSelector.querySelector("select[name=useCodes]"),t=[];for(const s of e.options)t.push(s.value);return t}get cycle(){return this._indicatorSelector.querySelector("select[name=cycle]").value}get region(){return this._indicatorSelector.querySelector("select[name=region]").value}_initIndicatorSelector(){this._indicatorSelector.style.display="flex",this._indicatorSelector.style.alignItems="flex-start",this._regionCodeToRank={};const e=document.createElement("select");e.name="useCodes",e.multiple=!0,e.size=5,e.style.overflowY="hidden",e.style.minWidth="100px";const t=document.createElement("span");t.style.margin="auto 0";const s=document.createElement("button");s.innerHTML="&larr;",s.onclick=()=>{let u=!1;const l=this.indicatorCodes;for(const f of _.selectedOptions){if(l.length>=5||l.includes(f.value))break;e.appendChild(f.cloneNode(!0)),u=!0}u&&(this._filterIndicatorCodes(),this._readyData())};const o=document.createElement("button");o.innerHTML="&rarr;",o.onclick=()=>{let u=!1;for(let l=e.options.length-1;l>=0;l--){const f=e.options.item(l);f.selected&&(f.remove(),u=!0)}u&&(this._filterIndicatorCodes(),this._readyData())},t.append(s,document.createElement("br"),o);const n=document.createElement("span"),i=document.createElement("select");i.name="category",i.onchange=()=>this._filterIndicatorCodes();const a=document.createElement("select");a.name="cycle",a.onchange=()=>{this._filterIndicatorCodes(),this._readyData()};const h=document.createElement("select");h.name="region",h.onchange=()=>{this._filterIndicatorCodes(),this._readyData()};const _=document.createElement("select");_.name="unuseCodes",_.multiple=!0,n.append("Filter",i,a,h,document.createElement("br"),_),this._indicatorSelector.append("Indicator ",e,t,n);const r=T((u,l)=>{const f=Object.keys(u);f.sort((p,y)=>p-y);for(const p of f){const y=l.appendChild(document.createElement("option"));y.value=p,y.innerText=u[p]}},"dictToOptions");return Promise.all(["Indicator","Term","Region"].map(u=>this._getMeta(u))).then(([u,l,f])=>{this._indicatorMetaInfos=u.GET_META_INDICATOR_INF.METADATA_INF.CLASS_INF.CLASS_OBJ;const p={};for(const d of this._indicatorMetaInfos)for(const x of d.CLASS)p[x.cycle["@code"]]||(p[x.cycle["@code"]]=x.cycle["@name"]);r(p,a),a.value=3;const y={},D=l.GET_META_TERM_INFO.METADATA_INF.CLASS_INF.CLASS_OBJ.CLASS;for(const d of D)y[d["@code"].slice(0,4)]||(y[d["@code"].slice(0,4)]=d["@category"]);r(y,i);const C={},I=f.GET_META_REGION_INF.METADATA_INF.CLASS_INF.CLASS_OBJ,c=I.find(d=>d["@parentRegionCode"].length===0);let m=null;for(const d of c.CLASS)d["@level"]==="2"&&(C[d["@regionCode"]]=d["@name"],m=d["@regionCode"],this._regionCodeToRank[d["@regionCode"]]=d["@level"]);const S=I.find(d=>d["@parentRegionCode"]===m);for(const d of S.CLASS)d["@level"]==="3"&&(C[d["@regionCode"]]=d["@name"],this._regionCodeToRank[d["@regionCode"]]=d["@level"]);r(C,h),h.value=m,this._filterIndicatorCodes(),this.setting.data.configElement.querySelector("[name=name]").value==="Manual"&&(this._indicatorSelector.style.display="flex",this._readyData())})}_setIndicators(e,t,s){const o=this._indicatorSelector.querySelector("select[name=useCodes]");o.replaceChildren();for(const a of this._indicatorMetaInfos)if(e.includes(a["@code"])){const h=o.appendChild(document.createElement("option"));h.value=a["@code"],h.innerText=a["@name"]}const n=this._indicatorSelector.querySelector("select[name=cycle]");n.value=t;const i=this._indicatorSelector.querySelector("select[name=region]");i.value=s,this._filterIndicatorCodes(e[0].slice(0,4))}_filterIndicatorCodes(e){const t=this._indicatorSelector.querySelector("select[name=category]");e&&(t.value=e),e=t.value;const s=this.cycle,o=this._regionCodeToRank[this.region],n=this._indicatorSelector.querySelector("select[name=unuseCodes]");n.replaceChildren();const i=this.indicatorCodes;for(const a of this._indicatorMetaInfos){if(!a["@code"].startsWith(e)||a.CLASS.every(_=>_.cycle["@code"]!==s||_.RegionalRank["@code"]!==o))continue;const h=n.appendChild(document.createElement("option"));h.value=a["@code"],h.innerText=a["@name"],h.disabled=i.includes(a["@code"])}}_readyScaledData(){if(!(this._scale.length>0)&&(this._shift=[],this._scale=[],this._x.length>0)){const e=Array(this._x[0].length).fill(1/0),t=Array(this._x[0].length).fill(-1/0);for(let n=0;n<this._x.length;n++)for(let i=0;i<this._x[n].length;i++)e[i]=Math.min(e[i],this._x[n][i]),t[i]=Math.max(t[i],this._x[n][i]);const s=10,o=0;for(let n=0;n<e.length;n++)e[n]===t[n]&&(t[n]=e[n]+1),this._scale[n]=(t[n]-e[n])/(s-o),this._shift[n]=e[n]-o*this._scale[n]}}async _getMeta(e){const t=e.toUpperCase()==="INDICATOR"||e.toUpperCase()==="REGION"?"INF":"INFO",s=`GET_META_${e.toUpperCase()}_${t}`,o={Lang:A==="JP"?"JP":"EN"},n=new w,i=await n.get("meta",e);if(!i||+i[s].RESULT.status>=100||new Date-i.fetchDate>R){const a=e;if(g[a])return new Promise(l=>{g[a]?g[a].push(l):l(n.get("meta",e))});const h=`${k}/Json/get${e}Info?${new URLSearchParams(o)}`;console.debug(`Fetch to ${h}`),g[a]=[];const r=await(await fetch(h)).json();+r[s].RESULT.status>=100&&console.error(r[s].RESULT),r.function=e,r.fetchDate=new Date,await n.save("meta",r);for(const l of g[a])l(r);return g[a]=void 0,r}return i}async _getData(e,t){const s={Lang:A==="JP"?"JP":"EN",IndicatorCode:e,IsSeasonalAdjustment:1,MetaGetFlg:"Y",...t},o=new URLSearchParams(s).toString(),n=new w,i=await n.get("data",o);if(!i||+i.GET_STATS.RESULT.status>=100||new Date-i.fetchDate>R){const a=e.join(",");if(g[a])return new Promise(l=>{g[a]?g[a].push(l):l(n.get("data",e))});for(;new Date-this._lastRequested<2e3;)await new Promise(l=>setTimeout(l,500));this._lastRequested=new Date;const h=`${k}/Json/getData?${o}`;console.debug(`Fetch to ${h}`),g[a]=[];const r=await(await fetch(h)).json();+r.GET_STATS.RESULT.status>=100&&console.error(r.GET_STATS.RESULT),r.fetchDate=new Date,r.params=o,await n.save("data",r);for(const l of g[a])l(r);return g[a]=void 0,r}return i}async _readyData(){this._x=[],this._shift=[],this._scale=[],this._columns=[],this._object=[],this._index=null,this._datetime=null,this._manager.platform?.init();const e=this.indicatorCodes;if(e.length===0){this._readySelector(),this.setting.ml.refresh();return}const t=document.createElement("div");t.classList.add("loader"),this._selector.replaceChildren(t);const s={Cycle:this.cycle,RegionCode:this.region},o=JSON.stringify(s),n=await this._getData(e,s);if(e.length!=this.indicatorCodes.length||e.some((c,m)=>c!==this.indicatorCodes[m])||o!=JSON.stringify({Cycle:this.cycle,RegionCode:this.region}))return;if(n.GET_STATS.RESULT.status==="1"){this._readySelector();return}const i=n.GET_STATS.STATISTICAL_DATA.DATA_INF.DATA_OBJ,a=n.GET_STATS.STATISTICAL_DATA.CLASS_INF.CLASS_OBJ,h={};for(const c of a)h[c["@id"]]=c;const _=T((c,m)=>{for(const S of c.CLASS)if(S["@code"]===m)return S.$||S["@name"]},"getNameFromCobj"),r=["indicator"].map(c=>h[c]),u=["time"].map(c=>h[c]),l={},f=[];for(let c=0;c<i.length;c++){const m=i[c].VALUE,S=u.map(d=>m[`@${d["@id"]}`]).join("_"),E=r.map(d=>_(d,m[`@${d["@id"]}`])).join("_");l[S]||(l[S]={}),l[S][E]=m.$,f.includes(E)||f.push(E)}for(const c of Object.keys(l))Object.keys(l[c]).length!==f.length&&delete l[c];this._columns=f;for(let c=0;c<f.length-1;c++)this._object.push(c);this._target=this._columns.length-1;const p=Object.keys(l);p.sort(),this._index=p;const y=p.map(c=>{const m=c.match(/([0-9]{4})([0-9CFQY]{2})00/),S=+m[1],E=m[2]==="CY"?1:m[2]==="FY"?4:m[2][1]==="Q"?(+m[2][0]-1)*3+1:+m[2];return{year:S,month:E}}),D=y.reduce((c,m)=>Math.min(c,m.year),1/0);this._datetime=y.map(c=>(c.year-D)*12+c.month-1);const C=f.map(c=>({name:c,nan:0})),I=new M(p.map(c=>l[c]),{columnInfos:C});this.setArray(I.data,C),this._readySelector(),this.setting.ml.refresh(),this.setting.$forceUpdate()}_readySelector(){if(this._selector.replaceChildren(),this._columns.length>1){const e=document.createElement("select");e.multiple=!0,e.onchange=()=>{this._object=[];let s="",o=!1;for(const n of e.options)n.selected?(this._object.push(this._columns.indexOf(n.value)),n.value===t.value&&(o=!0)):s||(s=n.value);o&&(this._target=this._columns.indexOf(s),t.value=s),this._domain=null,this._manager.onReady(()=>{this._manager.platform.init()})},this._selector.append("Input",e);const t=document.createElement("select");t.onchange=()=>{let s=!1;for(const o of e.selectedOptions)if(o.value===t.value){o.selected=!1,this._object=this._object.filter(n=>this._columns[n]!==o.value),s=!0;break}if(s||t.value===""&&this._target>=0)for(const o of e.options)o.value===this._columns[this._target]&&(o.selected=!0,this._object.push(this._target));this._target=this._columns.indexOf(t.value),this._domain=null,this._manager.onReady(()=>{this._manager.platform.init()})},this._selector.append("Output",t),t.appendChild(document.createElement("option"));for(const s of this._columns){const o=document.createElement("option");o.value=o.innerText=s,e.appendChild(o),t.appendChild(o.cloneNode(!0))}e.size=Math.min(4,e.options.length);for(let s=0;s<this._columns.length-1;s++)e.options[s].selected=this._object.includes(s);t.value=this._columns[this._target]}}}const F="dashboard.e-stat.go.jp";class w extends N{static{T(this,"EStatDB")}constructor(){super(F,3)}onupgradeneeded(e){const t=e.target.result;e.oldVersion<1&&(t.createObjectStore("meta",{keyPath:"function"}),t.createObjectStore("data",{keyPath:"GET_STATS.PARAMETER.indicatorCode"})),e.oldVersion<3&&(t.deleteObjectStore("data"),t.createObjectStore("data",{keyPath:"params"}))}}
