import BaseDB from"./db/base.js";import JSONData from"./json.js";const BASE_URL="https://dashboard.e-stat.go.jp/api/1.0",ExpiredTime=2592e6,lang=(()=>{switch(window.navigator.languages&&window.navigator.languages[0]||window.navigator.language){case"ja-JP":case"ja":return"JP";default:return"EN"}})(),resources={link:"JP"===lang?"https://dashboard.e-stat.go.jp/":"https://dashboard.e-stat.go.jp/en/",text:"JP"===lang?"統計ダッシュボード":"Statistics Dashboard",credit:"JP"===lang?"このサービスは、統計ダッシュボードのAPI機能を使用していますが、サービスの内容は国によって保証されたものではありません。また、データの加工を行っております。":"This service uses the API feature of Statistics Dashboard, but the contents of this service are not guaranteed by the Statistics Bureau of Japan. In addition, the data is processed."},datasetInfos={"Nikkei Indexes":{indicatorCode:["0702020501000010010"],columnKeys:["indicator"],indexKeys:["time"],availTask:["SM","TP","CP"]},"Number of entries/departures":{indicatorCode:["0204030001000010010","0204040001000010010"],columnKeys:["indicator"],indexKeys:["time"],filter:{cycle:["Month","月"]},availTask:["RG","AD","SM","TP","CP"]},"Employed persons":{indicatorCode:["0301010000010010010","0301010000020010010","0301010000030010010"],columnKeys:["indicator"],indexKeys:["time"],filter:{cycle:["Month","月"]},availTask:["RG","AD","SM","TP","CP"]},"Number of schools":{indicatorCode:["1201010100000010000","1201010300000010000","1201010400000010000","1201010500000010000","1201010800000010000"],columnKeys:["indicator"],indexKeys:["time"],query:{RegionLevel:2},availTask:["RG","AD","SM","TP","CP"]},Garbage:{indicatorCode:["1405050100000010010","1405050300000010010","1405050800000020010","1405050900000010010"],columnKeys:["indicator"],indexKeys:["time"],query:{RegionLevel:2},availTask:["RG","AD","SM","TP","CP"]}},lockKeys={};export default class EStatData extends JSONData{constructor(t){super(t),this._name="Nikkei Indexes",this._columns=[],this._shift=[],this._scale=[],this._object=[],this._target=-1;const e=this.setting.data.configElement,a=document.createElement("div");a.style.display="flex",a.style.justifyContent="space-between",e.appendChild(a);const s=document.createElement("span");a.appendChild(s);const n=document.createElement("select");n.name="name",n.onchange=()=>{this._name=n.value,this._readyData(),this.setting.vue.pushHistory()};for(const t of Object.keys(datasetInfos)){const e=document.createElement("option");e.value=t,e.innerText=datasetInfos[t].caption||t,n.appendChild(e)}s.append("Name",n);const i=document.createElement("a");a.appendChild(i),i.href=resources.link,i.setAttribute("ref","noreferrer noopener"),i.target="_blank",i.innerText=resources.text;const o=document.createElement("span");o.innerText=resources.credit,o.style.fontSize="80%",e.appendChild(o),this._selector=document.createElement("div"),e.appendChild(this._selector),this._readyData()}get availTask(){return datasetInfos[this._name]?.availTask||[]}get columnNames(){return this._object.map((t=>this._columns[t]))}get originalX(){return this._x.map((t=>this._object.map((e=>t[e]))))}get x(){return this._readyScaledData(),this._x.map((t=>{const e=t.map(((t,e)=>(t-this._shift[e])/this._scale[e]));return this._object.map((t=>e[t]))}))}get originalY(){return this._target>=0?this._x.map((t=>t[this._target])):Array(this._x.length).fill(0)}get y(){return this._readyScaledData(),this._target>=0?this._x.map((t=>(t[this._target]-this._shift[this._target])/this._scale[this._target])):Array(this._x.length).fill(0)}get params(){return{dataname:this._name}}set params(t){if(t.dataname&&Object.keys(datasetInfos).indexOf(t.dataname)>=0){const e=this.setting.data.configElement;this._name=t.dataname,e.querySelector("[name=name]").value=t.dataname,this._readyData()}}_readyScaledData(){if(!(this._scale.length>0)&&(this._shift=[],this._scale=[],this._x.length>0)){const t=Array(this._x[0].length).fill(1/0),e=Array(this._x[0].length).fill(-1/0);for(let a=0;a<this._x.length;a++)for(let s=0;s<this._x[a].length;s++)t[s]=Math.min(t[s],this._x[a][s]),e[s]=Math.max(e[s],this._x[a][s]);const a=10,s=1;for(let n=0;n<t.length;n++)t[n]===e[n]&&(e[n]=t[n]+1),this._scale[n]=(e[n]-t[n])/(a-s),this._shift[n]=t[n]-s*this._scale[n]}}async _getMeta(){const t="Indicator",e=`GET_META_${t.toUpperCase()}_INF`,a={Lang:"JP"===lang?"JP":"EN"},s=new EStatDB,n=await s.get("meta",t);if(!n||+n[e].RESULT.status>=100||new Date-n.fetchDate>2592e6){const n=t;if(lockKeys[n])return new Promise((e=>{lockKeys[n]?lockKeys[n].push(e):e(s.get("meta",t))}));const i=`${BASE_URL}/Json/get${t}Info?${new URLSearchParams(a)}`;console.debug(`Fetch to ${i}`),lockKeys[n]=[];const o=await fetch(i),r=await o.json();+r[e].RESULT.status>=100&&console.error(r[e].RESULT),r.function=t,r.fetchDate=new Date,await s.save("meta",r);for(const t of lockKeys[n])t(r);return lockKeys[n]=void 0,r}return n}async _getData(t,e){const a={Lang:"JP"===lang?"JP":"EN",IndicatorCode:t,IsSeasonalAdjustment:1,MetaGetFlg:"Y",...e},s=new EStatDB,n=await s.get("data",t);if(!n||+n.GET_STATS.RESULT.status>=100||new Date-n.fetchDate>2592e6){const e=t.join(",");if(lockKeys[e])return new Promise((a=>{lockKeys[e]?lockKeys[e].push(a):a(s.get("data",t))}));const n=`${BASE_URL}/Json/getData?${new URLSearchParams(a)}`;console.debug(`Fetch to ${n}`),lockKeys[e]=[];const i=await fetch(n),o=await i.json();+o.GET_STATS.RESULT.status>=100&&console.error(o.GET_STATS.RESULT),o.fetchDate=new Date,await s.save("data",o);for(const t of lockKeys[e])t(o);return lockKeys[e]=void 0,o}return n}async _readyData(){this._x=[],this._shift=[],this._scale=[],this._index=null,this._manager.platform?.init();const t=datasetInfos[this._name],e=document.createElement("div");e.classList.add("loader"),this._selector.replaceChildren(e);const a=this._name,s=await this._getData(t.indicatorCode,t.query);if(this._name!==a)return;const n=s.GET_STATS.STATISTICAL_DATA.DATA_INF.DATA_OBJ,i=s.GET_STATS.STATISTICAL_DATA.CLASS_INF.CLASS_OBJ,o={};for(const t of i)o[t["@id"]]=t;const r=(t,e)=>{for(const a of t.CLASS)if(a["@code"]===e)return a.$||a["@name"]},c=t.columnKeys.map((t=>o[t])),l=t.indexKeys.map((t=>o[t])),h={},d=[];for(let e=0;e<n.length;e++){const a=n[e].VALUE;if(t.filter){let e=!0;for(const s of Object.keys(t.filter)){const n=o[s],i=a[`@${n["@id"]}`],c=r(n,i),l=t.filter[s];if("string"==typeof l)e&&=c===l;else{if(!Array.isArray(l))throw new Error("Invalid condition");e&&=l.indexOf(c)>=0}}if(!e)continue}const s=l.map((t=>a[`@${t["@id"]}`])).join("_"),i=c.map((t=>r(t,a[`@${t["@id"]}`]))).join("_");h[s]||(h[s]={}),h[s][i]=a.$,d.indexOf(i)<0&&d.push(i)}this._columns=d,this._object=[];for(let t=0;t<Math.max(1,d.length-1);t++)this._object.push(t);this._target=1===d.length?-1:this._columns.length-1;const _=Object.keys(h);_.sort(),this._index=_,this.setJSON(_.map((t=>h[t])),d.map((t=>({name:t,nan:0})))),this._readySelector(),this.setting.ml.refresh(),this.setting.vue.$forceUpdate()}_readySelector(){if(this._selector.replaceChildren(),this._columns.length>1){const t=document.createElement("select");t.multiple=!0,t.onchange=()=>{this._object=[];let a="",s=!1;for(const n of t.options)n.selected?(this._object.push(this._columns.indexOf(n.value)),n.value===e.value&&(s=!0)):a||(a=n.value);s&&(this._target=this._columns.indexOf(a),e.value=a),this._domain=null,this._manager.onReady((()=>{this._manager.platform.init()}))},this._selector.append("Input",t);const e=document.createElement("select");e.onchange=()=>{let a=!1;for(const s of t.selectedOptions)if(s.value===e.value){s.selected=!1,this._object=this._object.filter((t=>this._columns[t]!==s.value)),a=!0;break}if(a||""===e.value&&this._target>=0)for(const e of t.options)e.value===this._columns[this._target]&&(e.selected=!0,this._object.push(this._target));this._target=this._columns.indexOf(e.value),this._domain=null,this._manager.onReady((()=>{this._manager.platform.init()}))},this._selector.append("Output",e),e.appendChild(document.createElement("option"));for(const a of this._columns){const s=document.createElement("option");s.value=s.innerText=a,t.appendChild(s),e.appendChild(s.cloneNode(!0))}t.size=Math.min(4,t.options.length);for(let e=0;e<this._columns.length-1;e++)t.options[e].selected=this._object.indexOf(e)>=0;e.value=this._columns[this._target]}}}const DB_NAME="dashboard.e-stat.go.jp";class EStatDB extends BaseDB{constructor(){super(DB_NAME,2)}onupgradeneeded(t){const e=t.target.result;e.createObjectStore("meta",{keyPath:"function"}),t.oldVersion<1&&e.createObjectStore("data",{keyPath:"GET_STATS.PARAMETER.indicatorCode"})}}