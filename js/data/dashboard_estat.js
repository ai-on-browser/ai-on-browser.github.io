var I=Object.defineProperty;var T=(S,t)=>I(S,"name",{value:t,configurable:!0});import L from"./db/base.js";import R from"./json.js";const C="https://dashboard.e-stat.go.jp/api/1.0",w=1e3*60*60*24*30,p=(()=>{switch(window.navigator.languages&&window.navigator.languages[0]||window.navigator.language){case"ja-JP":case"ja":return"JP";default:return"EN"}})(),E={link:p==="JP"?"https://dashboard.e-stat.go.jp/":"https://dashboard.e-stat.go.jp/en/",text:p==="JP"?"\u7D71\u8A08\u30C0\u30C3\u30B7\u30E5\u30DC\u30FC\u30C9":"Statistics Dashboard",credit:p==="JP"?"\u3053\u306E\u30B5\u30FC\u30D3\u30B9\u306F\u3001\u7D71\u8A08\u30C0\u30C3\u30B7\u30E5\u30DC\u30FC\u30C9\u306EAPI\u6A5F\u80FD\u3092\u4F7F\u7528\u3057\u3066\u3044\u307E\u3059\u304C\u3001\u30B5\u30FC\u30D3\u30B9\u306E\u5185\u5BB9\u306F\u56FD\u306B\u3088\u3063\u3066\u4FDD\u8A3C\u3055\u308C\u305F\u3082\u306E\u3067\u306F\u3042\u308A\u307E\u305B\u3093\u3002\u307E\u305F\u3001\u30C7\u30FC\u30BF\u306E\u52A0\u5DE5\u3092\u884C\u3063\u3066\u304A\u308A\u307E\u3059\u3002":"This service uses the API feature of Statistics Dashboard, but the contents of this service are not guaranteed by the Statistics Bureau of Japan. In addition, the data is processed."},g={"Nikkei Indexes":{indicatorCode:["0702020501000010010"],columnKeys:["indicator"],indexKeys:["time"],availTask:["SM","TP","CP"]},"Number of entries/departures":{indicatorCode:["0204030001000010010","0204040001000010010"],columnKeys:["indicator"],indexKeys:["time"],filter:{cycle:["Month","\u6708"]},availTask:["RG","AD","SM","TP","CP"]},"Employed persons":{indicatorCode:["0301010000010010010","0301010000020010010","0301010000030010010"],columnKeys:["indicator"],indexKeys:["time"],filter:{cycle:["Month","\u6708"]},availTask:["RG","AD","SM","TP","CP"]},"Number of schools":{indicatorCode:["1201010100000010000","1201010300000010000","1201010400000010000","1201010500000010000","1201010800000010000"],columnKeys:["indicator"],indexKeys:["time"],query:{RegionLevel:2},availTask:["RG","AD","SM","TP","CP"]},Garbage:{indicatorCode:["1405050100000010010","1405050300000010010","1405050800000020010","1405050900000010010"],columnKeys:["indicator"],indexKeys:["time"],query:{RegionLevel:2},availTask:["RG","AD","SM","TP","CP"]}},h={};export default class N extends R{static{T(this,"EStatData")}constructor(t){super(t),this._name="Nikkei Indexes",this._columns=[],this._shift=[],this._scale=[],this._object=[],this._target=-1;const s=this.setting.data.configElement,n=document.createElement("div");n.style.display="flex",n.style.justifyContent="space-between",s.appendChild(n);const a=document.createElement("span");n.appendChild(a);const e=document.createElement("select");e.name="name",e.onchange=()=>{this._name=e.value,this._readyData(),this.setting.vue.pushHistory()};for(const d of Object.keys(g)){const o=document.createElement("option");o.value=d,o.innerText=g[d].caption||d,e.appendChild(o)}a.append("Name",e);const i=document.createElement("a");n.appendChild(i),i.href=E.link,i.setAttribute("ref","noreferrer noopener"),i.target="_blank",i.innerText=E.text;const l=document.createElement("span");l.innerText=E.credit,l.style.fontSize="80%",s.appendChild(l),this._selector=document.createElement("div"),s.appendChild(this._selector),this._readyData()}get availTask(){return g[this._name]?.availTask||[]}get columnNames(){return this._object.map(t=>this._columns[t])}get originalX(){return this._x.map(t=>this._object.map(s=>t[s]))}get x(){return this._readyScaledData(),this._x.map(t=>{const s=t.map((n,a)=>(n-this._shift[a])/this._scale[a]);return this._object.map(n=>s[n])})}get originalY(){return this._target>=0?this._x.map(t=>t[this._target]):Array(this._x.length).fill(0)}get y(){return this._readyScaledData(),this._target>=0?this._x.map(t=>(t[this._target]-this._shift[this._target])/this._scale[this._target]):Array(this._x.length).fill(0)}get params(){return{dataname:this._name}}set params(t){if(t.dataname&&Object.keys(g).includes(t.dataname)){const s=this.setting.data.configElement;this._name=t.dataname,s.querySelector("[name=name]").value=t.dataname,this._readyData()}}_readyScaledData(){if(!(this._scale.length>0)&&(this._shift=[],this._scale=[],this._x.length>0)){const t=Array(this._x[0].length).fill(1/0),s=Array(this._x[0].length).fill(-1/0);for(let e=0;e<this._x.length;e++)for(let i=0;i<this._x[e].length;i++)t[i]=Math.min(t[i],this._x[e][i]),s[i]=Math.max(s[i],this._x[e][i]);const n=10,a=1;for(let e=0;e<t.length;e++)t[e]===s[e]&&(s[e]=t[e]+1),this._scale[e]=(s[e]-t[e])/(n-a),this._shift[e]=t[e]-a*this._scale[e]}}async _getMeta(){const t="Indicator",s=`GET_META_${t.toUpperCase()}_INF`,n={Lang:p==="JP"?"JP":"EN"},a=new P,e=await a.get("meta",t);if(!e||+e[s].RESULT.status>=100||new Date-e.fetchDate>w){const i=t;if(h[i])return new Promise(c=>{h[i]?h[i].push(c):c(a.get("meta",t))});const l=`${C}/Json/get${t}Info?${new URLSearchParams(n)}`;console.debug(`Fetch to ${l}`),h[i]=[];const o=await(await fetch(l)).json();+o[s].RESULT.status>=100&&console.error(o[s].RESULT),o.function=t,o.fetchDate=new Date,await a.save("meta",o);for(const c of h[i])c(o);return h[i]=void 0,o}return e}async _getData(t,s){const n={Lang:p==="JP"?"JP":"EN",IndicatorCode:t,IsSeasonalAdjustment:1,MetaGetFlg:"Y",...s},a=new P,e=await a.get("data",t);if(!e||+e.GET_STATS.RESULT.status>=100||new Date-e.fetchDate>w){const i=t.join(",");if(h[i])return new Promise(c=>{h[i]?h[i].push(c):c(a.get("data",t))});const l=`${C}/Json/getData?${new URLSearchParams(n)}`;console.debug(`Fetch to ${l}`),h[i]=[];const o=await(await fetch(l)).json();+o.GET_STATS.RESULT.status>=100&&console.error(o.GET_STATS.RESULT),o.fetchDate=new Date,await a.save("data",o);for(const c of h[i])c(o);return h[i]=void 0,o}return e}async _readyData(){this._x=[],this._shift=[],this._scale=[],this._index=null,this._manager.platform?.init();const t=g[this._name],s=document.createElement("div");s.classList.add("loader"),this._selector.replaceChildren(s);const n=this._name,a=await this._getData(t.indicatorCode,t.query);if(this._name!==n)return;const e=a.GET_STATS.STATISTICAL_DATA.DATA_INF.DATA_OBJ,i=a.GET_STATS.STATISTICAL_DATA.CLASS_INF.CLASS_OBJ,l={};for(const r of i)l[r["@id"]]=r;const d=T((r,_)=>{for(const m of r.CLASS)if(m["@code"]===_)return m.$||m["@name"]},"getNameFromCobj"),o=t.columnKeys.map(r=>l[r]),x=t.indexKeys.map(r=>l[r]),c={},f=[];for(let r=0;r<e.length;r++){const _=e[r].VALUE;if(t.filter){let u=!0;for(const v of Object.keys(t.filter)){const j=l[v],k=_[`@${j["@id"]}`],D=d(j,k),y=t.filter[v];if(typeof y=="string")u&&=D===y;else if(Array.isArray(y))u&&=y.includes(D);else throw new Error("Invalid condition")}if(!u)continue}const m=x.map(u=>_[`@${u["@id"]}`]).join("_"),A=o.map(u=>d(u,_[`@${u["@id"]}`])).join("_");c[m]||(c[m]={}),c[m][A]=_.$,f.includes(A)||f.push(A)}this._columns=f,this._object=[];for(let r=0;r<Math.max(1,f.length-1);r++)this._object.push(r);this._target=f.length===1?-1:this._columns.length-1;const b=Object.keys(c);b.sort(),this._index=b,this.setJSON(b.map(r=>c[r]),f.map(r=>({name:r,nan:0}))),this._readySelector(),this.setting.ml.refresh(),this.setting.vue.$forceUpdate()}_readySelector(){if(this._selector.replaceChildren(),this._columns.length>1){const t=document.createElement("select");t.multiple=!0,t.onchange=()=>{this._object=[];let n="",a=!1;for(const e of t.options)e.selected?(this._object.push(this._columns.indexOf(e.value)),e.value===s.value&&(a=!0)):n||(n=e.value);a&&(this._target=this._columns.indexOf(n),s.value=n),this._domain=null,this._manager.onReady(()=>{this._manager.platform.init()})},this._selector.append("Input",t);const s=document.createElement("select");s.onchange=()=>{let n=!1;for(const a of t.selectedOptions)if(a.value===s.value){a.selected=!1,this._object=this._object.filter(e=>this._columns[e]!==a.value),n=!0;break}if(n||s.value===""&&this._target>=0)for(const a of t.options)a.value===this._columns[this._target]&&(a.selected=!0,this._object.push(this._target));this._target=this._columns.indexOf(s.value),this._domain=null,this._manager.onReady(()=>{this._manager.platform.init()})},this._selector.append("Output",s),s.appendChild(document.createElement("option"));for(const n of this._columns){const a=document.createElement("option");a.value=a.innerText=n,t.appendChild(a),s.appendChild(a.cloneNode(!0))}t.size=Math.min(4,t.options.length);for(let n=0;n<this._columns.length-1;n++)t.options[n].selected=this._object.includes(n);s.value=this._columns[this._target]}}}const K="dashboard.e-stat.go.jp";class P extends L{static{T(this,"EStatDB")}constructor(){super(K,2)}onupgradeneeded(t){const s=t.target.result;s.createObjectStore("meta",{keyPath:"function"}),t.oldVersion<1&&s.createObjectStore("data",{keyPath:"GET_STATS.PARAMETER.indicatorCode"})}}
