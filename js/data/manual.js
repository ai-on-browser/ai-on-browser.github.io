import{BaseData}from"./base.js";import Matrix from"../../lib/util/matrix.js";import{specialCategory,getCategoryColor,DataPoint}from"../utils.js";const normal_random=function(t=0,e=1){const a=Math.sqrt(e),n=Math.random(),r=Math.random();return[Math.sqrt(-2*Math.log(n))*Math.cos(2*Math.PI*r)*a+t,Math.sqrt(-2*Math.log(n))*Math.sin(2*Math.PI*r)*a+t]},dataCreateTools={point:(t,e)=>{let a=null;return{init:()=>{a=new DataPoint(e,[0,0],specialCategory.dummy)},move:(t,e)=>{a.at=t},click:(e,a)=>{t.push(e,a.category)},terminate:()=>{a?.remove()},menu:[{title:"category",type:"category",min:0,max:100,value:1,key:"category"}]}},circle:(t,e)=>{let a=null;return{init:()=>{a=e.append("circle").attr("r",0).attr("fill","red").attr("fill-opacity",.2).attr("stroke","red")},move:(t,e)=>{a.attr("cx",t[0]),a.attr("cy",t[1]),a.attr("r",e.radius)},click:(e,a)=>{for(let n=0;n<a.count;n++){const n=[2*Math.random()-1,2*Math.random()-1];for(;n[0]**2+n[1]**2>1;)n[0]=2*Math.random()-1,n[1]=2*Math.random()-1;t.push([e[0]+n[0]*a.radius,e[1]+n[1]*a.radius],a.category)}},terminate:()=>{a?.remove()},menu:[{title:"radius",type:"number",min:1,max:200,value:50,key:"radius"},{title:"category",type:"category",min:0,max:100,value:1,key:"category"},{title:"count",type:"number",min:1,max:100,value:10,key:"count"}]}},square:(t,e)=>{let a=null;return{init:()=>{a=e.append("rect").attr("fill","red").attr("fill-opacity",.2).attr("stroke","red")},move:(t,e)=>{a.attr("x",t[0]-e.size),a.attr("y",t[1]-e.size),a.attr("width",2*e.size),a.attr("height",2*e.size)},click:(e,a)=>{for(let n=0;n<a.count;n++){const n=[2*Math.random()-1,2*Math.random()-1];t.push([e[0]+n[0]*a.size,e[1]+n[1]*a.size],a.category)}},terminate:()=>{a?.remove()},menu:[{title:"size",type:"number",min:1,max:200,value:50,key:"size"},{title:"category",type:"category",min:0,max:100,value:1,key:"category"},{title:"count",type:"number",min:1,max:100,value:10,key:"count"}]}},gaussian:(t,e)=>{let a=null;const n=t=>{const e=[t.varx,t.cov,t.cov,t.vary],a=(e[0]+e[3]+Math.sqrt((e[0]-e[3])**2+4*e[1]**2))/2,n=(e[0]+e[3]-Math.sqrt((e[0]-e[3])**2+4*e[1]**2))/2;let r=360*Math.atan((a-e[0])/e[1])/(2*Math.PI);isNaN(r)&&(r=0),t.rot=r,t.rx=2.146*Math.sqrt(a),t.ry=2.146*Math.sqrt(n)},r=t=>{const e=(t.rx/2.146)**2,a=(t.ry/2.146)**2,n=Math.tan(2*t.rot*Math.PI/360),r=n**2,o=1+1/r,s=e+a+2*e/r,i=Math.sqrt(s**2-4*o*(e**2/r+e*a));if(isNaN(i))return t.varx=e,t.vary=a,void(t.cov=0);const l=(s-i)/(2*o),c=e+a-l,h=(e-l)/n;t.varx=l,t.vary=c,t.cov=h};return{init:()=>{a=e.append("ellipse").attr("rx",0).attr("ry",0).attr("fill","red").attr("fill-opacity",.2).attr("stroke","red")},move:(t,e)=>{const n=t,r=[e.varx,e.cov,e.cov,e.vary],o=(r[0]+r[3]+Math.sqrt((r[0]-r[3])**2+4*r[1]**2))/2,s=(r[0]+r[3]-Math.sqrt((r[0]-r[3])**2+4*r[1]**2))/2;let i=360*Math.atan((o-r[0])/r[1])/(2*Math.PI);isNaN(i)&&(i=0),a.attr("rx",2.146*Math.sqrt(o)).attr("ry",2.146*Math.sqrt(s)).attr("transform","translate("+n[0]+","+n[1]+") rotate("+i+")")},click:(e,a)=>{const n=[[a.varx,a.cov],[a.cov,a.vary]],r=Matrix.randn(a.count,2,e,n).toArray();for(let e=0;e<r.length;e++)t.push(r[e],a.category)},terminate:()=>{a?.remove()},menu:[{title:"var x",type:"number",min:1,max:1e4,value:1600,key:"varx",onchange:n},{title:"var y",type:"number",min:1,max:1e4,value:800,key:"vary",onchange:n},{title:"cov",type:"number",min:-1e3,max:1e3,value:800,key:"cov",onchange:n},{title:"rx",type:"number",min:0,max:1e3,value:98.21150163574005,key:"rx",onchange:r},{title:"ry",type:"number",min:0,max:1e3,value:37.5134555386868,key:"ry",onchange:r},{title:"rot",type:"number",min:-180,max:180,value:31.717474411461016,key:"rot",onchange:r},{title:"category",type:"category",min:0,max:100,value:1,key:"category"},{title:"count",type:"number",min:1,max:100,value:10,key:"count"}]}},eraser:(t,e)=>{let a=[];return{init:n=>{if(a.forEach((t=>t.remove())),a.length=0,"all"===n.mode)for(const n of t.points)a.push(e.append("circle").attr("r",n.radius).attr("fill","red").attr("cx",n.at[0]).attr("cy",n.at[1]));else"nearest"===n.mode?a.push(e.append("circle").attr("r",t.points[0].radius).attr("fill","red")):"circle"===n.mode&&a.push(e.append("circle").attr("r",50).attr("fill","red").attr("fill-opacity",.2))},move:(n,r)=>{if("nearest"===r.mode){let e=1/0,r=null;for(const a of t.points){const t=n.reduce(((t,e,n)=>t+(e-a.at[n])**2),0);t<e&&(r=a,e=t)}a[0].attr("cx",r.at[0]),a[0].attr("cy",r.at[1]),a[0].attr("r",r.radius)}else if("circle"===r.mode){a[0].attr("cx",n[0]),a[0].attr("cy",n[1]);for(let t=1;t<a.length;t++)a[t].remove();a.length=1;for(const r of t.points){const t=n.reduce(((t,e,a)=>t+(e-r.at[a])**2),0);Math.sqrt(t)<50&&a.push(e.append("circle").attr("r",r.radius).attr("fill","red").attr("cx",r.at[0]).attr("cy",r.at[1]))}}},click:(e,n)=>{if("all"===n.mode)t.remove(),a.forEach((t=>t.remove())),a.length=0;else if("nearest"===n.mode){let n=1/0,r=1/0,o=null,s=null;for(let a=0;a<t.length;a++){const i=e.reduce(((e,n,r)=>e+(n-t.points[a].at[r])**2),0);i<n?(s=o,o=a,r=n,n=i):i<r&&(s=a,r=i)}s&&(a[0].attr("cx",t.points[s].at[0]),a[0].attr("cy",t.points[s].at[1])),t.splice(o,1)}else if("circle"===n.mode){for(let a=t.length-1;a>=0;a--){const n=e.reduce(((e,n,r)=>e+(n-t.points[a].at[r])**2),0);Math.sqrt(n)<50&&t.splice(a,1)}for(let t=1;t<a.length;t++)a[t].remove();a.length=1}},terminate:()=>{a.forEach((t=>t.remove())),a.length=0},menu:[{title:"mode",type:"select",options:[{value:"nearest",text:"nearest"},{value:"circle",text:"circle"},{value:"all",text:"all"}],key:"mode"}]}}},dataPresets={clusters:{init:t=>{t.appendChild(document.createTextNode(" n "));const e=document.createElement("input");e.type="number",e.name="n",e.min=1,e.max=10,e.value=3,t.appendChild(e)},make:(t,e)=>{const a=+e.querySelector("[name=n]").value,n=t._manager.platform.width,r=t._manager.platform.height;let o=1;const s=[],i=[];for(let t=0;t<a;t++,o++){const t=[Math.random(),Math.random()];let e=0;for(;s.some((a=>Math.sqrt(t.reduce(((t,e,n)=>t+(e-a[n])**2),0))<Math.random()/((e++/5)**2+1)));)t[0]=Math.random(),t[1]=Math.random();s.push(t.concat()),t[0]=2*n/3*t[0]+n/6,t[1]=2*r/3*t[1]+r/6;for(let e=0;e<100;e++){let e=[0,0];0,e[0]=0*e[0]+t[0],e[1]=0*e[1]+t[1];{const t=normal_random(0,2500);e[0]+=t[0],e[1]+=t[1]}i.push(e,o)}}t.push(...i)}},moons:{make:(t,e)=>{const a=200;let n=1;const r=[];for(let e=0;e<2;e++,n++)for(let e=0;e<100;e++){const e=Math.random()*Math.PI,o=[Math.cos(e)*a,Math.sin(e)*a];{const t=normal_random(0,20);o[0]+=t[0],o[1]+=t[1]}2===n&&(o[0]=a-o[0],o[1]=a-o[1]-100),o[0]+=t._manager.platform.width/2-100,o[1]+=t._manager.platform.height/2-50,r.push(o,n)}t.push(...r)}},circle:{init:t=>{t.appendChild(document.createTextNode(" n "));const e=document.createElement("input");e.type="number",e.name="n",e.min=1,e.max=10,e.value=3,t.appendChild(e)},make:(t,e)=>{const a=+e.querySelector("[name=n]").value,n=Math.min(t._manager.platform.width,t._manager.platform.height)/(2*a),r=[];for(let e=0;e<a;e++)for(let a=0;a<100;a++){const a=2*Math.random()*Math.PI,o=[Math.cos(a)*n*e,Math.sin(a)*n*e];{const t=normal_random(0,50);o[0]+=t[0],o[1]+=t[1]}o[0]+=t._manager.platform.width/2,o[1]+=t._manager.platform.height/2,r.push(o,e+1)}t.push(...r)}},check:{make:(t,e)=>{const a=Math.min(t._manager.platform.width,t._manager.platform.height)/3,n=[t._manager.platform.width/2,t._manager.platform.height/2],r=[];for(let t=0;t<100;t++)r.push([n[0]+Math.random()*a,n[1]+Math.random()*a],1),r.push([n[0]-Math.random()*a,n[1]-Math.random()*a],1);for(let t=0;t<100;t++)r.push([n[0]+Math.random()*a,n[1]-Math.random()*a],2),r.push([n[0]-Math.random()*a,n[1]+Math.random()*a],2);t.push(...r)}}};class ContextMenu{constructor(){this._r=document.createElement("div"),this._r.classList.add("context-menu"),document.querySelector("body").appendChild(this._r),this._r.onclick=t=>t.stopPropagation(),this._showMenu=t=>{this.show([t.pageX,t.pageY]);const e=()=>{this.hide(),document.body.removeEventListener("click",e)};document.body.addEventListener("click",e)},this._orgoncontextmenu=document.body.oncontextmenu}terminate(){this.create(),this._r.remove()}create(t){if(this._r.replaceChildren(),!t||0===t.length)return document.body.removeEventListener("contextmenu",this._showMenu),void(document.body.oncontextmenu=this._orgoncontextmenu);document.body.addEventListener("contextmenu",this._showMenu),document.body.oncontextmenu=()=>!1;const e=document.createElement("ul");this._r.appendChild(e),this._properties={};for(let a=0;a<t.length;a++){const n=document.createElement("li");e.appendChild(n);const r=document.createElement("span");switch(r.classList.add("item-title"),r.innerText=t[a].title,n.appendChild(r),t[a].type){case"category":case"number":{const e=t=>{const e=getCategoryColor(t);n.style.backgroundColor=e;const a=.299*e.r+.587*e.g+.114*e.b<128?"white":"black";n.style.color=a},r=document.createElement("input");r.type="number",r.min=t[a].min,r.max=t[a].max,r.value=t[a].value,r.onchange=()=>{t[a].onchange?.(this._properties),"category"===t[a].type&&e(+r.value)},n.appendChild(r),"category"===t[a].type&&e(t[a].value),Object.defineProperty(this._properties,t[a].key,{get:()=>+r.value,set:t=>{r.value=t}});break}case"select":{const e=document.createElement("select");e.onchange=()=>t[a].onchange?.(this._properties);for(const n of t[a].options){const t=document.createElement("option");t.value=n.value,t.innerText=n.text,e.appendChild(t)}n.appendChild(e),Object.defineProperty(this._properties,t[a].key,{get:()=>e.value,set:t=>{e.value=t}});break}}}}show(t){this._r.classList.add("show"),this._r.style.left=t[0]+"px",this._r.style.top=t[1]+"px"}hide(){this._r.classList.remove("show")}values(){return this._properties}}export default class ManualData extends BaseData{constructor(t){super(t),this._org_padding=this._manager.platform._renderer.padding,this._manager.platform._renderer.padding=0,this._dim=2,this._scale=.001,this._tool=null,this._contextmenu=new ContextMenu,this._r=this.svg.append("g");const e=this._r.append("g"),a=this._manager.platform.width,n=this._manager.platform.height,r=this;this._r.append("rect").attr("x",0).attr("y",0).attr("width",a).attr("height",n).attr("opacity",0).on("mouseenter",(()=>{this._tool?.terminate(),this.svg.node().lastChild!==this._r.node()&&(this._r.remove(),this.svg.append((()=>this._r.node()))),this._tool?.init(r._contextmenu.values())})).on("mousemove",(t=>{const e=d3.pointer(t);r._tool?.move(e,r._contextmenu.values())})).on("mouseleave",(()=>{this._tool?.terminate()})).on("click",(t=>{const e=d3.pointer(t);r._tool?.click(e,r._contextmenu.values())}));const o=this.setting.data.configElement;o.appendChild(document.createTextNode("Dimension"));const s=document.createElement("input");s.type="number",s.name="dimension",s.min=1,s.max=2,s.value=this._dim,s.onchange=()=>{this._dim=+s.value,this.setting.ml.refresh(),this.setting.vue.$forceUpdate(),this._manager.platform.render(),this.setting.vue.pushHistory()},o.appendChild(s);const i=document.createElement("div");o.appendChild(i),i.appendChild(document.createTextNode("Preset"));const l=document.createElement("select");l.onchange=()=>{const t=l.value;this.remove(),c.replaceChildren(),dataPresets[t].init?.(c),dataPresets[t].make(this,c)};for(const t of Object.keys(dataPresets)){const e=document.createElement("option");e.value=t,e.innerText=t,l.appendChild(e)}i.appendChild(l);const c=document.createElement("span");i.appendChild(c);const h=document.createElement("input");h.type="button",h.value="Reset",h.onclick=()=>{const t=l.value;this.remove(),dataPresets[t].make(this,c)},i.appendChild(h);const m=document.createElement("input");m.type="button",m.value="Clear",m.onclick=()=>{this.remove()},i.appendChild(m);const d=document.createElement("div");o.appendChild(d),d.appendChild(document.createTextNode("Tools"));const p=document.createElement("div");p.classList.add("manual-data-tools"),d.appendChild(p);for(const t in dataCreateTools){const a=document.createElement("div");a.title=t,a.classList.add("icon",t),a.onclick=()=>{this._tool?.terminate(),a.classList.contains("selected")?(a.classList.remove("selected"),this._tool=null,this._contextmenu.create()):(p.querySelectorAll("div").forEach((t=>t.classList.remove("selected"))),this._tool=dataCreateTools[t](this,e),a.classList.add("selected"),this._contextmenu.create(this._tool.menu),this._tool.init(r._contextmenu.values()))},p.appendChild(a),this._tool||(this._tool=dataCreateTools[t](this,e),a.classList.add("selected"),this._contextmenu.create(this._tool.menu),this._tool.init(r._contextmenu.values()))}this.addCluster([a/4,n/3],0,2500,100,1),this.addCluster([a/2,2*n/3],0,2500,100,2),this.addCluster([3*a/4,n/3],0,2500,100,3),dataPresets[l.value].init?.(c)}get availTask(){return 1===this._dim?["RG","IN","AD","DE","TF","SM","TP","CP"]:["CT","CF","SC","RG","IN","AD","DR","FS","DE","GR","MD","GM","SM","TP","CP"]}get domain(){const t=this._manager.platform.width,e=this._manager.platform.height;return 1===this._dim?[[0,t*this._scale]]:[[0,t*this._scale],[0,e*this._scale]]}get range(){return 1===this._dim?[0,this._manager.platform.height*this._scale]:super.range}get dimension(){return this._dim}get x(){return 1===this._dim?this._x.map((t=>[t[0]*this._scale])):this._x.map((t=>t.map((t=>t*this._scale))))}get y(){return 1===this._dim?this._x.map((t=>t[1]*this._scale)):this._y}get params(){return{dimension:this._dim}}set params(t){if(t.dimension){this.setting.data.configElement.querySelector("[name=dimension]").value=t.dimension,this._dim=+t.dimension,this.setting.vue.$forceUpdate(),this._manager.platform.render()}}at(t){return Object.defineProperties({},{x:{get:()=>1===this._dim?[this._x[t][0]*this._scale]:this._x[t].map((t=>t*this._scale)),set:e=>{this._x[t]=e.map((t=>t/this._scale)),this._manager.platform.render()}},y:{get:()=>1===this._dim?this._x[t][1]:this._y[t],set:e=>{this._y[t]=e,this._manager.platform.render()}},point:{get:()=>this.points[t]}})}splice(t,e,...a){const n=[],r=[];for(let t=0;t<a.length;t+=2)n.push(a[t]),r.push(a[t+1]);const o=this._manager.platform._renderer.toValue?.(n[0])[0];let s,i;return void 0!==o?(s=this._x.splice(t,e),i=this._y.splice(t,e),this._x.splice(o,0,...n),this._y.splice(o,0,...r)):(s=this._x.splice(t,e,...n),i=this._y.splice(t,e,...r)),this._manager.platform.render(),s.map(((t,e)=>[t,i[e]]))}set(t,e,a){this.splice(t,1,e,a)}push(...t){this.splice(this.length,0,...t)}pop(){return this.splice(this.length-1,1)[0]}unshift(...t){this.splice(0,0,...t)}shift(){return this.splice(0,1)[0]}slice(t,e){const a=[];for(let n=t;n<e;n++)a.push(this.at(n));return a}forEach(t){const e=this.length;for(let a=0;a<e;a++)t(this.at(a),a,this)}map(t){const e=this.length,a=[];for(let n=0;n<e;n++)a.push(t(this.at(n),n,this));return a}swap(t,e){[this._x[t],this._x[e]]=[this._x[e],this._x[t]],[this._y[t],this._y[e]]=[this._y[e],this._y[t]]}sort(t){const e=this.length,a=[];for(let n=0;n<e;n++){a[n]=this.at(n);for(let e=n;e>0;e--)t(a[e-1],a[e])>0&&this.swap(e-1,e)}}remove(){this.splice(0,this.length)}terminate(){super.terminate(),this._tool?.terminate(),this._contextmenu.terminate(),this._r.remove(),this._manager.platform._renderer.padding=this._org_padding}addCluster(t,e,a,n,r){const o=[];for(let s=0;s<n;s++){let n=[0,0];if(e>0)do{n=[2*Math.random()-1,2*Math.random()-1]}while(n[0]**2+n[1]**2<=1);if(n[0]=n[0]*e+t[0],n[1]=n[1]*e+t[1],a>0){const t=normal_random(0,a);n[0]+=t[0],n[1]+=t[1]}o.push(n,+r)}this.push(...o)}}