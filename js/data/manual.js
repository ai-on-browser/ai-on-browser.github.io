import{BaseData}from"./base.js";import Matrix from"../../lib/util/matrix.js";import{specialCategory,getCategoryColor,DataPoint}from"../utils.js";const normal_random=function(t=0,e=1){const a=Math.sqrt(e),r=Math.random(),n=Math.random();return[Math.sqrt(-2*Math.log(r))*Math.cos(2*Math.PI*n)*a+t,Math.sqrt(-2*Math.log(r))*Math.sin(2*Math.PI*n)*a+t]},dataCreateTools={point:t=>{let e=null;return{init:(t,a)=>{e=new DataPoint(a,[0,0],specialCategory.dummy)},move:t=>{e.at=t},click:(e,a)=>{t.push(e,a.category)},terminate:()=>{e?.remove()},menu:[{title:"category",type:"category",min:0,max:100,value:1,key:"category"}]}},circle:t=>{let e=null;return{init:(t,a)=>{e=a.append("circle").attr("r",0).attr("fill","red").attr("fill-opacity",.2).attr("stroke","red")},move:(t,a)=>{e.attr("cx",t[0]),e.attr("cy",t[1]),e.attr("r",a.radius)},click:(e,a)=>{for(let r=0;r<a.count;r++){const r=[2*Math.random()-1,2*Math.random()-1];for(;r[0]**2+r[1]**2>1;)r[0]=2*Math.random()-1,r[1]=2*Math.random()-1;t.push([e[0]+r[0]*a.radius,e[1]+r[1]*a.radius],a.category)}},terminate:()=>{e?.remove()},menu:[{title:"radius",type:"number",min:1,max:200,value:50,key:"radius"},{title:"category",type:"category",min:0,max:100,value:1,key:"category"},{title:"count",type:"number",min:1,max:100,value:10,key:"count"}]}},square:t=>{let e=null;return{init:(t,a)=>{e=a.append("rect").attr("fill","red").attr("fill-opacity",.2).attr("stroke","red")},move:(t,a)=>{e.attr("x",t[0]-a.size),e.attr("y",t[1]-a.size),e.attr("width",2*a.size),e.attr("height",2*a.size)},click:(e,a)=>{for(let r=0;r<a.count;r++){const r=[2*Math.random()-1,2*Math.random()-1];t.push([e[0]+r[0]*a.size,e[1]+r[1]*a.size],a.category)}},terminate:()=>{e?.remove()},menu:[{title:"size",type:"number",min:1,max:200,value:50,key:"size"},{title:"category",type:"category",min:0,max:100,value:1,key:"category"},{title:"count",type:"number",min:1,max:100,value:10,key:"count"}]}},gaussian:t=>{let e=null;const a=t=>{const e=[t.varx,t.cov,t.cov,t.vary],a=(e[0]+e[3]+Math.sqrt((e[0]-e[3])**2+4*e[1]**2))/2,r=(e[0]+e[3]-Math.sqrt((e[0]-e[3])**2+4*e[1]**2))/2;let n=360*Math.atan((a-e[0])/e[1])/(2*Math.PI);isNaN(n)&&(n=0),t.rot=n,t.rx=2.146*Math.sqrt(a),t.ry=2.146*Math.sqrt(r)},r=t=>{const e=(t.rx/2.146)**2,a=(t.ry/2.146)**2,r=Math.tan(2*t.rot*Math.PI/360),n=r**2,o=1+1/n,i=e+a+2*e/n,s=Math.sqrt(i**2-4*o*(e**2/n+e*a));if(isNaN(s))return t.varx=e,t.vary=a,void(t.cov=0);const l=(i-s)/(2*o),m=e+a-l,c=(e-l)/r;t.varx=l,t.vary=m,t.cov=c};return{init:(t,a)=>{e=a.append("ellipse").attr("rx",0).attr("ry",0).attr("fill","red").attr("fill-opacity",.2).attr("stroke","red")},move:(t,a)=>{const r=t,n=[a.varx,a.cov,a.cov,a.vary],o=(n[0]+n[3]+Math.sqrt((n[0]-n[3])**2+4*n[1]**2))/2,i=(n[0]+n[3]-Math.sqrt((n[0]-n[3])**2+4*n[1]**2))/2;let s=360*Math.atan((o-n[0])/n[1])/(2*Math.PI);isNaN(s)&&(s=0),e.attr("rx",2.146*Math.sqrt(o)).attr("ry",2.146*Math.sqrt(i)).attr("transform","translate("+r[0]+","+r[1]+") rotate("+s+")")},click:(e,a)=>{const r=[[a.varx,a.cov],[a.cov,a.vary]],n=Matrix.randn(a.count,2,e,r).toArray();for(let e=0;e<n.length;e++)t.push(n[e],a.category)},terminate:()=>{e?.remove()},menu:[{title:"var x",type:"number",min:1,max:1e4,value:1600,key:"varx",onchange:a},{title:"var y",type:"number",min:1,max:1e4,value:800,key:"vary",onchange:a},{title:"cov",type:"number",min:-1e3,max:1e3,value:800,key:"cov",onchange:a},{title:"rx",type:"number",min:0,max:1e3,value:98.21150163574005,key:"rx",onchange:r},{title:"ry",type:"number",min:0,max:1e3,value:37.5134555386868,key:"ry",onchange:r},{title:"rot",type:"number",min:-180,max:180,value:31.717474411461016,key:"rot",onchange:r},{title:"category",type:"category",min:0,max:100,value:1,key:"category"},{title:"count",type:"number",min:1,max:100,value:10,key:"count"}]}},eraser:t=>{const e=t._manager.platform._renderer[0].points;let a=[],r=null;return{init:(t,n)=>{if(r=n,a.forEach((t=>t.remove())),a.length=0,"all"===t.mode)for(const t of e)a.push(r.append("circle").attr("r",t.radius).attr("fill","red").attr("cx",t.at[0]).attr("cy",t.at[1]));else"nearest"===t.mode?a.push(r.append("circle").attr("r",e[0].radius).attr("fill","red")):"circle"===t.mode&&a.push(r.append("circle").attr("r",50).attr("fill","red").attr("fill-opacity",.2))},move:(t,n)=>{if("nearest"===n.mode){let r=1/0,n=null;for(const a of e){const e=t.reduce(((t,e,r)=>t+(e-a.at[r])**2),0);e<r&&(n=a,r=e)}a[0].attr("cx",n.at[0]),a[0].attr("cy",n.at[1]),a[0].attr("r",n.radius)}else if("circle"===n.mode){a[0].attr("cx",t[0]),a[0].attr("cy",t[1]);for(let t=1;t<a.length;t++)a[t].remove();a.length=1;for(const n of e){const e=t.reduce(((t,e,a)=>t+(e-n.at[a])**2),0);Math.sqrt(e)<50&&a.push(r.append("circle").attr("r",n.radius).attr("fill","red").attr("cx",n.at[0]).attr("cy",n.at[1]))}}},click:(r,n)=>{if("all"===n.mode)t.remove(),a.forEach((t=>t.remove())),a.length=0;else if("nearest"===n.mode){let n=1/0,o=1/0,i=null,s=null;for(let a=0;a<t.length;a++){const t=r.reduce(((t,r,n)=>t+(r-e[a].at[n])**2),0);t<n?(s=i,i=a,o=n,n=t):t<o&&(s=a,o=t)}s&&(a[0].attr("cx",e[s].at[0]),a[0].attr("cy",e[s].at[1])),t.splice(i,1)}else if("circle"===n.mode){for(let a=t.length-1;a>=0;a--){const n=r.reduce(((t,r,n)=>t+(r-e[a].at[n])**2),0);Math.sqrt(n)<50&&t.splice(a,1)}for(let t=1;t<a.length;t++)a[t].remove();a.length=1}},terminate:()=>{a.forEach((t=>t.remove())),a.length=0},menu:[{title:"mode",type:"select",options:[{value:"nearest",text:"nearest"},{value:"circle",text:"circle"},{value:"all",text:"all"}],key:"mode"}]}}},dataPresets={clusters:{init:t=>{const e=document.createElement("input");e.type="number",e.name="n",e.min=1,e.max=10,e.value=3,t.append(" n ",e)},make:(t,e)=>{const a=+e.querySelector("[name=n]").value,r=t._manager.platform.width,n=t._manager.platform.height;let o=1;const i=[],s=[];for(let t=0;t<a;t++,o++){const t=[Math.random(),Math.random()];let e=0;for(;i.some((a=>Math.sqrt(t.reduce(((t,e,r)=>t+(e-a[r])**2),0))<Math.random()/((e++/5)**2+1)));)t[0]=Math.random(),t[1]=Math.random();i.push(t.concat()),t[0]=2*r/3*t[0]+r/6,t[1]=2*n/3*t[1]+n/6;for(let e=0;e<100;e++){let e=[0,0];0,e[0]=0*e[0]+t[0],e[1]=0*e[1]+t[1];{const t=normal_random(0,2500);e[0]+=t[0],e[1]+=t[1]}s.push(e,o)}}t.push(...s)}},moons:{make:t=>{const e=200;let a=1;const r=[];for(let n=0;n<2;n++,a++)for(let n=0;n<100;n++){const n=Math.random()*Math.PI,o=[Math.cos(n)*e,Math.sin(n)*e];{const t=normal_random(0,20);o[0]+=t[0],o[1]+=t[1]}2===a&&(o[0]=e-o[0],o[1]=e-o[1]-100),o[0]+=t._manager.platform.width/2-100,o[1]+=t._manager.platform.height/2-50,r.push(o,a)}t.push(...r)}},circle:{init:t=>{const e=document.createElement("input");e.type="number",e.name="n",e.min=1,e.max=10,e.value=3,t.append(" n ",e)},make:(t,e)=>{const a=+e.querySelector("[name=n]").value,r=Math.min(t._manager.platform.width,t._manager.platform.height)/(2*a),n=[];for(let e=0;e<a;e++)for(let a=0;a<100;a++){const a=2*Math.random()*Math.PI,o=[Math.cos(a)*r*e,Math.sin(a)*r*e];{const t=normal_random(0,50);o[0]+=t[0],o[1]+=t[1]}o[0]+=t._manager.platform.width/2,o[1]+=t._manager.platform.height/2,n.push(o,e+1)}t.push(...n)}},check:{make:t=>{const e=Math.min(t._manager.platform.width,t._manager.platform.height)/3,a=[t._manager.platform.width/2,t._manager.platform.height/2],r=[];for(let t=0;t<100;t++)r.push([a[0]+Math.random()*e,a[1]+Math.random()*e],1),r.push([a[0]-Math.random()*e,a[1]-Math.random()*e],1);for(let t=0;t<100;t++)r.push([a[0]+Math.random()*e,a[1]-Math.random()*e],2),r.push([a[0]-Math.random()*e,a[1]+Math.random()*e],2);t.push(...r)}}};class ContextMenu{constructor(){this._r=document.createElement("div"),this._r.classList.add("context-menu"),document.querySelector("body").appendChild(this._r),this._r.onclick=t=>t.stopPropagation(),this._showMenu=t=>{this.show([t.pageX,t.pageY]);const e=()=>{this.hide(),document.body.removeEventListener("click",e)};document.body.addEventListener("click",e)},this._orgoncontextmenu=document.body.oncontextmenu}terminate(){this.create(),this._r.remove()}create(t){if(this._r.replaceChildren(),!t||0===t.length)return document.body.removeEventListener("contextmenu",this._showMenu),void(document.body.oncontextmenu=this._orgoncontextmenu);document.body.addEventListener("contextmenu",this._showMenu),document.body.oncontextmenu=()=>!1;const e=document.createElement("ul");this._r.appendChild(e),this._properties={};for(let a=0;a<t.length;a++){const r=document.createElement("li");e.appendChild(r);const n=document.createElement("span");switch(n.classList.add("item-title"),n.innerText=t[a].title,r.appendChild(n),t[a].type){case"category":case"number":{const e=t=>{const e=getCategoryColor(t);r.style.backgroundColor=e;const a=.299*e.r+.587*e.g+.114*e.b<128?"white":"black";r.style.color=a},n=document.createElement("input");n.type="number",n.min=t[a].min,n.max=t[a].max,n.value=t[a].value,n.onchange=()=>{t[a].onchange?.(this._properties),"category"===t[a].type&&e(+n.value)},r.appendChild(n),"category"===t[a].type&&e(t[a].value),Object.defineProperty(this._properties,t[a].key,{get:()=>+n.value,set:t=>{n.value=t}});break}case"select":{const e=document.createElement("select");e.onchange=()=>t[a].onchange?.(this._properties);for(const r of t[a].options){const t=document.createElement("option");t.value=r.value,t.innerText=r.text,e.appendChild(t)}r.appendChild(e),Object.defineProperty(this._properties,t[a].key,{get:()=>e.value,set:t=>{e.value=t}});break}}}}show(t){this._r.classList.add("show"),this._r.style.left=t[0]+"px",this._r.style.top=t[1]+"px"}hide(){this._r.classList.remove("show")}values(){return this._properties}}export default class ManualData extends BaseData{constructor(t){super(t),this._org_padding=this._manager.platform._renderer[0].padding,this._manager.platform._renderer[0].padding=0,this._dim=2,this._scale=.001,this._tool=null,this._contextmenu=new ContextMenu;const e=this._manager.platform.width,a=this._manager.platform.height,r=this.setting.data.configElement,n=document.createElement("div");r.appendChild(n),n.append("Dimension");const o=document.createElement("input");o.type="number",o.name="dimension",o.min=1,o.max=2,o.value=this._dim,o.onchange=()=>{this._dim=+o.value,this.setting.ml.refresh(),this.setting.vue.$forceUpdate(),this._manager.platform.render(),this.setting.vue.pushHistory()},n.appendChild(o),n.append(" Scale");const i=document.createElement("input");i.type="number",i.name="scale",i.min=0,i.max=1e4,i.step=.001,i.value=this._scale,i.onchange=()=>{this._scale=i.value,this._manager.platform.render()},n.appendChild(i);const s=document.createElement("div");r.appendChild(s),s.append("Preset");const l=document.createElement("select");l.onchange=()=>{const t=l.value;this.remove(),m.replaceChildren(),dataPresets[t].init?.(m),dataPresets[t].make(this,m)};for(const t of Object.keys(dataPresets)){const e=document.createElement("option");e.value=e.innerText=t,l.appendChild(e)}s.appendChild(l);const m=document.createElement("span");s.appendChild(m);const c=document.createElement("input");c.type="button",c.value="Reset",c.onclick=()=>{const t=l.value;this.remove(),dataPresets[t].make(this,m)},s.appendChild(c);const h=document.createElement("input");h.type="button",h.value="Clear",h.onclick=()=>{this.remove()},s.appendChild(h);const d=document.createElement("div");r.appendChild(d),d.append("Tools");const u=document.createElement("div");u.classList.add("manual-data-tools"),d.appendChild(u);for(const t in dataCreateTools){const e=document.createElement("div");e.title=t,e.classList.add("icon",t),e.onclick=()=>{this._tool?.terminate(),e.classList.contains("selected")?(e.classList.remove("selected"),this._tool=null,this._contextmenu.create()):(u.querySelectorAll("div").forEach((t=>t.classList.remove("selected"))),this._tool=dataCreateTools[t](this),e.classList.add("selected"),this._contextmenu.create(this._tool.menu),this._tool.init(this._contextmenu.values(),this.dummyArea))},u.appendChild(e),this._tool||(this._tool=dataCreateTools[t](this),e.classList.add("selected"),this._contextmenu.create(this._tool.menu),this._tool.init(this._contextmenu.values(),this.dummyArea))}this.addCluster([e/4,a/3],0,2500,100,1),this.addCluster([e/2,2*a/3],0,2500,100,2),this.addCluster([3*e/4,a/3],0,2500,100,3),dataPresets[l.value].init?.(m),this._entersvg=()=>this.initSVG(),document.addEventListener("mousemove",this._entersvg)}get availTask(){return 1===this._dim?["RG","IN","AD","DE","TF","SM","TP","CP"]:["CT","CF","SC","RG","IN","AD","DR","FS","DE","GR","SM","TP","CP"]}get domain(){const t=this._manager.platform.width,e=this._manager.platform.height;return 1===this._dim?[[0,t*this._scale]]:[[0,t*this._scale],[0,e*this._scale]]}get range(){return 1===this._dim?[0,this._manager.platform.height*this._scale]:super.range}get dimension(){return this._dim}get originalX(){return 1===this._dim?this._x.map((t=>[t[0]])):this._x}get x(){return this.originalX.map((t=>t.map((t=>t*this._scale))))}get originalY(){return 1===this._dim?this._x.map((t=>t[1])):this._y}get y(){return 1===this._dim?this._x.map((t=>t[1]*this._scale)):this._y}get params(){return{dimension:this._dim}}set params(t){if(t.dimension){this.setting.data.configElement.querySelector("[name=dimension]").value=t.dimension,this._dim=+t.dimension,this.setting.vue.$forceUpdate(),this._manager.platform.render()}}get dummyArea(){this.initSVG();const t=this._r.select("g.manual-dummy-area");return 0===t.size()?this._r.insert("g",":first-child").classed("manual-dummy-area",!0):t}initSVG(){let t=this._manager.platform.svg;if(!t)return;t.select||(t=d3.select(t));if(0===t.select("g.manual-root-area").size()){const e=this._manager.platform.width,a=this._manager.platform.height;this._r=t.append("g").classed("manual-root-area",!0),this._r.append("rect").attr("x",0).attr("y",0).attr("width",e).attr("height",a).attr("opacity",0).on("mouseenter",(()=>{this._tool?.terminate(),this._tool?.init(this._contextmenu.values(),this.dummyArea)})).on("mousemove",(t=>{const e=d3.pointer(t);this._tool?.move(e,this._contextmenu.values())})).on("mouseleave",(()=>{this._tool?.terminate()})).on("click",(t=>{const e=d3.pointer(t);this._tool?.click(e,this._contextmenu.values())}))}}splice(t,e,...a){const r=[],n=[];for(let t=0;t<a.length;t+=2)r.push(a[t]),n.push(a[t+1]);const o=this._manager.platform._renderer[0].toValue?.(r[0])[0];let i,s;return void 0!==o?(i=this._x.splice(t,e),s=this._y.splice(t,e),this._x.splice(o,0,...r),this._y.splice(o,0,...n)):(i=this._x.splice(t,e,...r),s=this._y.splice(t,e,...n)),this._manager.platform.render(),i.map(((t,e)=>[t,s[e]]))}set(t,e,a){this.splice(t,1,e,a)}push(...t){this.splice(this.length,0,...t)}pop(){return this.splice(this.length-1,1)[0]}unshift(...t){this.splice(0,0,...t)}shift(){return this.splice(0,1)[0]}remove(){this.splice(0,this.length)}terminate(){super.terminate(),this._tool?.terminate(),this._contextmenu.terminate(),this._r?.remove(),this._manager.platform._renderer[0].padding=this._org_padding,document.removeEventListener("mousemove",this._entersvg)}addCluster(t,e,a,r,n){const o=[];for(let i=0;i<r;i++){let r=[0,0];if(e>0)do{r=[2*Math.random()-1,2*Math.random()-1]}while(r[0]**2+r[1]**2<=1);if(r[0]=r[0]*e+t[0],r[1]=r[1]*e+t[1],a>0){const t=normal_random(0,a);r[0]+=t[0],r[1]+=t[1]}o.push(r,+n)}this.push(...o)}}