var M=Object.defineProperty;var m=(l,t)=>M(l,"name",{value:t,configurable:!0});import{BaseData as w}from"./base.js";import A from"../../lib/util/matrix.js";import{specialCategory as k,getCategoryColor as E}from"../utils.js";import{DataPoint as C}from"../renderer/util/figure.js";const v=m(function(l=0,t=1){const n=Math.sqrt(t),e=Math.random(),s=Math.random(),r=Math.sqrt(-2*Math.log(e))*Math.cos(2*Math.PI*s),i=Math.sqrt(-2*Math.log(e))*Math.sin(2*Math.PI*s);return[r*n+l,i*n+l]},"normal_random"),x={point:m(l=>{let t=null;return{init:m((n,e)=>{t=new C(e,[0,0],k.dummy)},"init"),move:m(n=>{t.at=n},"move"),click:m((n,e)=>{l.push(n,e.category)},"click"),terminate:m(()=>{t?.remove()},"terminate"),menu:[{title:"category",type:"category",min:0,max:100,value:1,key:"category"}]}},"point"),circle:m(l=>{let t=null;return{init:m((n,e)=>{t=document.createElementNS("http://www.w3.org/2000/svg","circle"),t.setAttribute("r",0),t.setAttribute("fill","red"),t.setAttribute("fill-opacity",.2),t.setAttribute("stroke","red"),e.appendChild(t)},"init"),move:m((n,e)=>{t.setAttribute("cx",n[0]),t.setAttribute("cy",n[1]),t.setAttribute("r",e.radius)},"move"),click:m((n,e)=>{for(let s=0;s<e.count;s++){const r=[Math.random()*2-1,Math.random()*2-1];for(;r[0]**2+r[1]**2>1;)r[0]=Math.random()*2-1,r[1]=Math.random()*2-1;l.push([n[0]+r[0]*e.radius,n[1]+r[1]*e.radius],e.category)}},"click"),terminate:m(()=>{t?.remove()},"terminate"),menu:[{title:"radius",type:"number",min:1,max:200,value:50,key:"radius"},{title:"category",type:"category",min:0,max:100,value:1,key:"category"},{title:"count",type:"number",min:1,max:100,value:10,key:"count"}]}},"circle"),square:m(l=>{let t=null;return{init:m((n,e)=>{t=document.createElementNS("http://www.w3.org/2000/svg","rect"),t.setAttribute("fill","red"),t.setAttribute("fill-opacity",.2),t.setAttribute("stroke","red"),e.appendChild(t)},"init"),move:m((n,e)=>{t.setAttribute("x",n[0]-e.size),t.setAttribute("y",n[1]-e.size),t.setAttribute("width",2*e.size),t.setAttribute("height",2*e.size)},"move"),click:m((n,e)=>{for(let s=0;s<e.count;s++){const r=[Math.random()*2-1,Math.random()*2-1];l.push([n[0]+r[0]*e.size,n[1]+r[1]*e.size],e.category)}},"click"),terminate:m(()=>{t?.remove()},"terminate"),menu:[{title:"size",type:"number",min:1,max:200,value:50,key:"size"},{title:"category",type:"category",min:0,max:100,value:1,key:"category"},{title:"count",type:"number",min:1,max:100,value:10,key:"count"}]}},"square"),gaussian:m(l=>{let t=null;const n=m(s=>{const r=[s.varx,s.cov,s.cov,s.vary],i=(r[0]+r[3]+Math.sqrt((r[0]-r[3])**2+4*r[1]**2))/2,o=(r[0]+r[3]-Math.sqrt((r[0]-r[3])**2+4*r[1]**2))/2,a=2.146;let c=360*Math.atan((i-r[0])/r[1])/(2*Math.PI);isNaN(c)&&(c=0),s.rot=c,s.rx=a*Math.sqrt(i),s.ry=a*Math.sqrt(o)},"var2xy"),e=m(s=>{const i=(s.rx/2.146)**2,o=(s.ry/2.146)**2,a=Math.tan(s.rot*2*Math.PI/360),c=a**2,h=1+1/c,u=i+o+2*i/c,d=Math.sqrt(u**2-4*h*(i**2/c+i*o));if(isNaN(d)){s.varx=i,s.vary=o,s.cov=0;return}const _=(u-d)/(2*h),p=i+o-_,g=(i-_)/a;s.varx=_,s.vary=p,s.cov=g},"xy2var");return{init:m((s,r)=>{t=document.createElementNS("http://www.w3.org/2000/svg","ellipse"),t.setAttribute("rx",0),t.setAttribute("ry",0),t.setAttribute("fill","red"),t.setAttribute("fill-opacity",.2),t.setAttribute("stroke","red"),r.appendChild(t)},"init"),move:m((s,r)=>{const i=s,o=[r.varx,r.cov,r.cov,r.vary],a=(o[0]+o[3]+Math.sqrt((o[0]-o[3])**2+4*o[1]**2))/2,c=(o[0]+o[3]-Math.sqrt((o[0]-o[3])**2+4*o[1]**2))/2,h=2.146;let u=360*Math.atan((a-o[0])/o[1])/(2*Math.PI);isNaN(u)&&(u=0),t.setAttribute("rx",h*Math.sqrt(a)),t.setAttribute("ry",h*Math.sqrt(c)),t.setAttribute("transform","translate("+i[0]+","+i[1]+") rotate("+u+")")},"move"),click:m((s,r)=>{const i=[[r.varx,r.cov],[r.cov,r.vary]],o=A.randn(r.count,2,s,i).toArray();for(let a=0;a<o.length;a++)l.push(o[a],r.category)},"click"),terminate:m(()=>{t?.remove()},"terminate"),menu:[{title:"var x",type:"number",min:1,max:1e4,value:1600,key:"varx",onchange:n},{title:"var y",type:"number",min:1,max:1e4,value:800,key:"vary",onchange:n},{title:"cov",type:"number",min:-1e3,max:1e3,value:800,key:"cov",onchange:n},{title:"rx",type:"number",min:0,max:1e3,value:98.21150163574005,key:"rx",onchange:e},{title:"ry",type:"number",min:0,max:1e3,value:37.5134555386868,key:"ry",onchange:e},{title:"rot",type:"number",min:-180,max:180,value:31.717474411461016,key:"rot",onchange:e},{title:"category",type:"category",min:0,max:100,value:1,key:"category"},{title:"count",type:"number",min:1,max:100,value:10,key:"count"}]}},"gaussian"),eraser:m(l=>{const t=l._manager.platform._renderer[0].points;let n=[],e=null;return{init:m((s,r)=>{if(e=r,n.forEach(i=>i.remove()),n.length=0,s.mode==="all")for(const i of t){const o=document.createElementNS("http://www.w3.org/2000/svg","circle");o.setAttribute("r",i.radius),o.setAttribute("fill","red"),o.setAttribute("cx",i.at[0]),o.setAttribute("cy",i.at[1]),e.appendChild(o),n.push(o)}else if(s.mode==="nearest"){const i=document.createElementNS("http://www.w3.org/2000/svg","circle");i.setAttribute("r",t[0].radius),i.setAttribute("fill","red"),e.appendChild(i),n.push(i)}else if(s.mode==="circle"){const i=document.createElementNS("http://www.w3.org/2000/svg","circle");i.setAttribute("r",50),i.setAttribute("fill","red"),i.setAttribute("fill-opacity",.2),e.appendChild(i),n.push(i)}},"init"),move:m((s,r)=>{if(r.mode==="nearest"){let i=1/0,o=null;for(const a of t){const c=s.reduce((h,u,d)=>h+(u-a.at[d])**2,0);c<i&&(o=a,i=c)}n[0].setAttribute("cx",o.at[0]),n[0].setAttribute("cy",o.at[1]),n[0].setAttribute("r",o.radius)}else if(r.mode==="circle"){n[0].setAttribute("cx",s[0]),n[0].setAttribute("cy",s[1]);for(let i=1;i<n.length;i++)n[i].remove();n.length=1;for(const i of t){const o=s.reduce((a,c,h)=>a+(c-i.at[h])**2,0);if(Math.sqrt(o)<50){const a=document.createElementNS("http://www.w3.org/2000/svg","circle");a.setAttribute("r",i.radius),a.setAttribute("fill","red"),a.setAttribute("cx",i.at[0]),a.setAttribute("cy",i.at[1]),e.appendChild(a),n.push(a)}}}},"move"),click:m((s,r)=>{if(r.mode==="all")l.remove(),n.forEach(i=>i.remove()),n.length=0;else if(r.mode==="nearest"){let i=1/0,o=1/0,a=null,c=null;for(let h=0;h<l.length;h++){const u=s.reduce((d,_,p)=>d+(_-t[h].at[p])**2,0);u<i?(c=a,a=h,o=i,i=u):u<o&&(c=h,o=u)}c&&(n[0].setAttribute("cx",t[c].at[0]),n[0].setAttribute("cy",t[c].at[1])),l.splice(a,1)}else if(r.mode==="circle"){for(let i=l.length-1;i>=0;i--){const o=s.reduce((a,c,h)=>a+(c-t[i].at[h])**2,0);Math.sqrt(o)<50&&l.splice(i,1)}for(let i=1;i<n.length;i++)n[i].remove();n.length=1}},"click"),terminate:m(()=>{n.forEach(s=>s.remove()),n.length=0},"terminate"),menu:[{title:"mode",type:"select",options:[{value:"nearest",text:"nearest"},{value:"circle",text:"circle"},{value:"all",text:"all"}],key:"mode"}]}},"eraser")},y={clusters:{init:m(l=>{const t=document.createElement("input");t.type="number",t.name="n",t.min=1,t.max=10,t.value=3,l.append(" n ",t)},"init"),make:m((l,t)=>{const n=+t.querySelector("[name=n]").value,e=0,s=2500,r=100,i=l._size[0],o=l._size[1];let a=1;const c=[],h=[];for(let u=0;u<n;u++,a++){const d=[Math.random(),Math.random()];let _=0;for(;c.some(p=>Math.sqrt(d.reduce((g,f,b)=>g+(f-p[b])**2,0))<Math.random()/((_++/5)**2+1));)d[0]=Math.random(),d[1]=Math.random();c.push(d.concat()),d[0]=2*i/3*d[0]+i/6,d[1]=2*o/3*d[1]+o/6;for(let p=0;p<r;p++){let g=[0,0];if(e>0)do g=[Math.random()*2-1,Math.random()*2-1];while(g[0]**2+g[1]**2<=1);if(g[0]=g[0]*e+d[0],g[1]=g[1]*e+d[1],s>0){const f=v(0,s);g[0]+=f[0],g[1]+=f[1]}h.push(g,a)}}l.push(...h)},"make")},moons:{make:m(l=>{let s=1;const r=[];for(let i=0;i<2;i++,s++)for(let o=0;o<100;o++){const a=Math.random()*Math.PI,c=[Math.cos(a)*200,Math.sin(a)*200];{const h=v(0,20);c[0]+=h[0],c[1]+=h[1]}s===2&&(c[0]=200-c[0],c[1]=200-c[1]-200/2),c[0]+=l._size[0]/2-200/2,c[1]+=l._size[1]/2-200/4,r.push(c,s)}l.push(...r)},"make")},circle:{init:m(l=>{const t=document.createElement("input");t.type="number",t.name="n",t.min=1,t.max=10,t.value=3,l.append(" n ",t)},"init"),make:m((l,t)=>{const n=+t.querySelector("[name=n]").value,e=50,s=100,r=Math.min(l._size[0],l._size[1])/(2*n),i=[];for(let o=0;o<n;o++)for(let a=0;a<s;a++){const c=Math.random()*2*Math.PI,h=[Math.cos(c)*r*o,Math.sin(c)*r*o];if(e>0){const u=v(0,e);h[0]+=u[0],h[1]+=u[1]}h[0]+=l._size[0]/2,h[1]+=l._size[1]/2,i.push(h,o+1)}l.push(...i)},"make")},check:{make:m(l=>{const n=Math.min(l._size[0],l._size[1])/3,e=[l._size[0]/2,l._size[1]/2],s=[];for(let r=0;r<100;r++)s.push([e[0]+Math.random()*n,e[1]+Math.random()*n],1),s.push([e[0]-Math.random()*n,e[1]-Math.random()*n],1);for(let r=0;r<100;r++)s.push([e[0]+Math.random()*n,e[1]-Math.random()*n],2),s.push([e[0]-Math.random()*n,e[1]+Math.random()*n],2);l.push(...s)},"make")}};class z{static{m(this,"ContextMenu")}constructor(){this._r=document.createElement("div"),this._r.classList.add("context-menu"),document.querySelector("body").appendChild(this._r),this._r.onclick=t=>t.stopPropagation(),this._showMenu=t=>{this.show([t.pageX,t.pageY]);const n=m(()=>{this.hide(),document.body.removeEventListener("click",n)},"close");document.body.addEventListener("click",n)},this._orgoncontextmenu=document.body.oncontextmenu}terminate(){this.create(),this._r.remove()}create(t){if(this._r.replaceChildren(),!t||t.length===0){document.body.removeEventListener("contextmenu",this._showMenu),document.body.oncontextmenu=this._orgoncontextmenu;return}document.body.addEventListener("contextmenu",this._showMenu),document.body.oncontextmenu=()=>!1;const n=document.createElement("ul");this._r.appendChild(n),this._properties={};for(let e=0;e<t.length;e++){const s=document.createElement("li");n.appendChild(s);const r=document.createElement("span");switch(r.classList.add("item-title"),r.innerText=t[e].title,s.appendChild(r),t[e].type){case"category":case"number":{const i=m(a=>{const c=E(a);s.style.backgroundColor=c;const h=c.r*.299+c.g*.587+c.b*.114<128?"white":"black";s.style.color=h},"setColor"),o=document.createElement("input");o.type="number",o.min=t[e].min,o.max=t[e].max,o.value=t[e].value,o.onchange=()=>{t[e].onchange?.(this._properties),t[e].type==="category"&&i(+o.value)},s.appendChild(o),t[e].type==="category"&&i(t[e].value),Object.defineProperty(this._properties,t[e].key,{get:m(()=>+o.value,"get"),set:m(a=>{o.value=a},"set")});break}case"select":{const i=document.createElement("select");i.onchange=()=>t[e].onchange?.(this._properties);for(const o of t[e].options){const a=document.createElement("option");a.value=o.value,a.innerText=o.text,i.appendChild(a)}s.appendChild(i),Object.defineProperty(this._properties,t[e].key,{get:m(()=>i.value,"get"),set:m(o=>{i.value=o},"set")});break}}}}show(t){this._r.classList.add("show"),this._r.style.left=t[0]+"px",this._r.style.top=t[1]+"px"}hide(){this._r.classList.remove("show")}values(){return this._properties}}export default class S extends w{static{m(this,"ManualData")}constructor(t){super(t),this._org_padding=this._manager.platform._renderer[0].padding,this._manager.platform._renderer[0].padding=0,this._size=[960,500],this._dim=2,this._scale=1/1e3,this._tool=null,this._contextmenu=new z;const n=this.setting.data.configElement,e=document.createElement("div");n.appendChild(e),e.append("Dimension");const s=document.createElement("input");s.type="number",s.name="dimension",s.min=1,s.max=2,s.value=this._dim,s.onchange=()=>{this._dim=+s.value,this.setting.ml.refresh(),this.setting.$forceUpdate(),this._manager.platform.render(),this.setting.pushHistory()},e.appendChild(s),e.append(" Scale");const r=document.createElement("input");r.type="number",r.name="scale",r.min=0,r.max=1e4,r.step=.001,r.value=this._scale,r.onchange=()=>{this._scale=r.value,this._manager.platform.render()},e.appendChild(r);const i=document.createElement("div");n.appendChild(i),i.append("Preset");const o=document.createElement("select");o.onchange=()=>{const _=o.value;this.remove(),a.replaceChildren(),y[_].init?.(a),y[_].make(this,a)};for(const _ of Object.keys(y)){const p=document.createElement("option");p.value=p.innerText=_,o.appendChild(p)}i.appendChild(o);const a=document.createElement("span");i.appendChild(a);const c=document.createElement("input");c.type="button",c.value="Reset",c.onclick=()=>{const _=o.value;this.remove(),y[_].make(this,a)},i.appendChild(c);const h=document.createElement("input");h.type="button",h.value="Clear",h.onclick=()=>{this.remove()},i.appendChild(h);const u=document.createElement("div");n.appendChild(u),u.append("Tools");const d=document.createElement("div");d.classList.add("manual-data-tools"),u.appendChild(d);for(const _ in x){const p=document.createElement("div");p.title=_,p.classList.add("icon",_),p.onclick=()=>{this._tool?.terminate(),p.classList.contains("selected")?(p.classList.remove("selected"),this._tool=null,this._contextmenu.create()):(d.querySelectorAll("div").forEach(g=>g.classList.remove("selected")),this._tool=x[_](this),p.classList.add("selected"),this._contextmenu.create(this._tool.menu),this._tool.init(this._contextmenu.values(),this.dummyArea))},d.appendChild(p),this._tool||(this._tool=x[_](this),p.classList.add("selected"),this._contextmenu.create(this._tool.menu),this._tool.init(this._contextmenu.values(),this.dummyArea))}this.addCluster([this._size[0]/4,this._size[1]/3],0,2500,100,1),this.addCluster([this._size[0]/2,this._size[1]*2/3],0,2500,100,2),this.addCluster([this._size[0]*3/4,this._size[1]/3],0,2500,100,3),y[o.value].init?.(a),this._entersvg=()=>this.initSVG(),document.addEventListener("mousemove",this._entersvg),this._willrender=!1}get availTask(){return this._dim===1?["RG","IN","AD","DE","TF","SM","TP","CP"]:["CT","CF","SC","RG","IN","RL","AD","DR","FS","DE","GR","SM","TP","CP"]}get domain(){return this._dim===1?[[0,this._size[0]*this._scale]]:[[0,this._size[0]*this._scale],[0,this._size[1]*this._scale]]}get range(){return this._dim===1?[0,this._size[1]*this._scale]:super.range}get dimension(){return this._dim}get originalX(){return this._dim===1?this._x.map(t=>[t[0]]):this._x}get x(){return this.originalX.map(t=>t.map(n=>n*this._scale))}get originalY(){return this._dim===1?this._x.map(t=>t[1]):this._y}get y(){return this._dim===1?this._x.map(t=>t[1]*this._scale):this._y}get params(){return{dimension:this._dim}}set params(t){if(t.dimension){const n=this.setting.data.configElement;n.querySelector("[name=dimension]").value=t.dimension,this._dim=+t.dimension,this.setting.$forceUpdate(),this._manager.platform.render()}}get dummyArea(){this.initSVG();const t=this._r.querySelector("g.manual-dummy-area");if(!t){const n=document.createElementNS("http://www.w3.org/2000/svg","g");return n.classList.add("manual-dummy-area"),this._r.insertBefore(n,this._r.firstChild),n}return t}initSVG(){let t=this._manager.platform?.svg;if(!t)return;if(!t.querySelector("g.manual-root-area")){this._r=document.createElementNS("http://www.w3.org/2000/svg","g"),this._r.classList.add("manual-root-area"),t.appendChild(this._r);const e=document.createElementNS("http://www.w3.org/2000/svg","rect");this._r.appendChild(e),e.setAttribute("x",0),e.setAttribute("y",0),e.setAttribute("width",this._size[0]),e.setAttribute("height",this._size[1]),e.setAttribute("opacity",0),e.onmouseover=()=>{this._tool?.terminate(),this._tool?.init(this._contextmenu.values(),this.dummyArea)},e.onmousemove=s=>{const r=d3.pointer(s);this._tool?.move(r,this._contextmenu.values())},e.onmouseleave=()=>{this._tool?.terminate()},e.onclick=s=>{const r=d3.pointer(s);this._tool?.click(r,this._contextmenu.values())}}}splice(t,n,...e){const s=[],r=[];for(let c=0;c<e.length;c+=2)s.push(e[c]),r.push(e[c+1]);const i=this._manager.platform._renderer[0].toValue?.(s[0])[0];let o,a;return i!==void 0?(o=this._x.splice(t,n),a=this._y.splice(t,n),this._x.splice(i,0,...s),this._y.splice(i,0,...r)):(o=this._x.splice(t,n,...s),a=this._y.splice(t,n,...r)),this._willrender||(this._willrender=!0,setTimeout(()=>{this._manager.platform.render(),this._willrender=!1},0)),o.map((c,h)=>[c,a[h]])}set(t,n,e){this.splice(t,1,n,e)}push(...t){this.splice(this.length,0,...t)}pop(){return this.splice(this.length-1,1)[0]}unshift(...t){this.splice(0,0,...t)}shift(){return this.splice(0,1)[0]}remove(){this.splice(0,this.length)}terminate(){super.terminate(),this._tool?.terminate(),this._contextmenu.terminate(),this._r?.remove(),this._manager.platform._renderer[0].padding=this._org_padding,document.removeEventListener("mousemove",this._entersvg)}addCluster(t,n,e,s,r){const i=[];for(let o=0;o<s;o++){let a=[0,0];if(n>0)do a=[Math.random()*2-1,Math.random()*2-1];while(a[0]**2+a[1]**2<=1);if(a[0]=a[0]*n+t[0],a[1]=a[1]*n+t[1],e>0){const c=v(0,e);a[0]+=c[0],a[1]+=c[1]}i.push(a,+r)}this.push(...i)}}
