import{BaseData}from"./base.js";import Matrix from"../../lib/util/matrix.js";import{specialCategory,getCategoryColor,DataPoint}from"../utils.js";const normal_random=function(t=0,e=1){const a=Math.sqrt(e),r=Math.random(),n=Math.random();return[Math.sqrt(-2*Math.log(r))*Math.cos(2*Math.PI*n)*a+t,Math.sqrt(-2*Math.log(r))*Math.sin(2*Math.PI*n)*a+t]},dataCreateTools={point:(t,e)=>{let a=null;return{init:()=>{a=new DataPoint(e,[0,0],specialCategory.dummy)},move:(t,e)=>{a.at=t},click:(e,a)=>{t.push(e,a.category)},terminate:()=>{a?.remove()},menu:[{title:"category",type:"category",min:0,max:100,value:1,key:"category"}]}},circle:(t,e)=>{let a=null;return{init:()=>{a=e.append("circle").attr("r",0).attr("fill","red").attr("fill-opacity",.2).attr("stroke","red")},move:(t,e)=>{a.attr("cx",t[0]),a.attr("cy",t[1]),a.attr("r",e.radius)},click:(e,a)=>{for(let r=0;r<a.count;r++){const r=[2*Math.random()-1,2*Math.random()-1];for(;r[0]**2+r[1]**2>1;)r[0]=2*Math.random()-1,r[1]=2*Math.random()-1;t.push([e[0]+r[0]*a.radius,e[1]+r[1]*a.radius],a.category)}},terminate:()=>{a?.remove()},menu:[{title:"radius",type:"number",min:1,max:200,value:50,key:"radius"},{title:"category",type:"category",min:0,max:100,value:1,key:"category"},{title:"count",type:"number",min:1,max:100,value:10,key:"count"}]}},square:(t,e)=>{let a=null;return{init:()=>{a=e.append("rect").attr("fill","red").attr("fill-opacity",.2).attr("stroke","red")},move:(t,e)=>{a.attr("x",t[0]-e.size),a.attr("y",t[1]-e.size),a.attr("width",2*e.size),a.attr("height",2*e.size)},click:(e,a)=>{for(let r=0;r<a.count;r++){const r=[2*Math.random()-1,2*Math.random()-1];t.push([e[0]+r[0]*a.size,e[1]+r[1]*a.size],a.category)}},terminate:()=>{a?.remove()},menu:[{title:"size",type:"number",min:1,max:200,value:50,key:"size"},{title:"category",type:"category",min:0,max:100,value:1,key:"category"},{title:"count",type:"number",min:1,max:100,value:10,key:"count"}]}},gaussian:(t,e)=>{let a=null;const r=t=>{const e=[t.varx,t.cov,t.cov,t.vary],a=(e[0]+e[3]+Math.sqrt((e[0]-e[3])**2+4*e[1]**2))/2,r=(e[0]+e[3]-Math.sqrt((e[0]-e[3])**2+4*e[1]**2))/2;let n=360*Math.atan((a-e[0])/e[1])/(2*Math.PI);isNaN(n)&&(n=0),t.rot=n,t.rx=2.146*Math.sqrt(a),t.ry=2.146*Math.sqrt(r)},n=t=>{const e=(t.rx/2.146)**2,a=(t.ry/2.146)**2,r=Math.tan(2*t.rot*Math.PI/360),n=r**2,o=1+1/n,i=e+a+2*e/n,s=Math.sqrt(i**2-4*o*(e**2/n+e*a));if(isNaN(s))return t.varx=e,t.vary=a,void(t.cov=0);const l=(i-s)/(2*o),c=e+a-l,m=(e-l)/r;t.varx=l,t.vary=c,t.cov=m};return{init:()=>{a=e.append("ellipse").attr("rx",0).attr("ry",0).attr("fill","red").attr("fill-opacity",.2).attr("stroke","red")},move:(t,e)=>{const r=t,n=[e.varx,e.cov,e.cov,e.vary],o=(n[0]+n[3]+Math.sqrt((n[0]-n[3])**2+4*n[1]**2))/2,i=(n[0]+n[3]-Math.sqrt((n[0]-n[3])**2+4*n[1]**2))/2;let s=360*Math.atan((o-n[0])/n[1])/(2*Math.PI);isNaN(s)&&(s=0),a.attr("rx",2.146*Math.sqrt(o)).attr("ry",2.146*Math.sqrt(i)).attr("transform","translate("+r[0]+","+r[1]+") rotate("+s+")")},click:(e,a)=>{const r=[[a.varx,a.cov],[a.cov,a.vary]],n=Matrix.randn(a.count,2,e,r).toArray();for(let e=0;e<n.length;e++)t.push(n[e],a.category)},terminate:()=>{a?.remove()},menu:[{title:"var x",type:"number",min:1,max:1e4,value:1600,key:"varx",onchange:r},{title:"var y",type:"number",min:1,max:1e4,value:800,key:"vary",onchange:r},{title:"cov",type:"number",min:-1e3,max:1e3,value:800,key:"cov",onchange:r},{title:"rx",type:"number",min:0,max:1e3,value:98.21150163574005,key:"rx",onchange:n},{title:"ry",type:"number",min:0,max:1e3,value:37.5134555386868,key:"ry",onchange:n},{title:"rot",type:"number",min:-180,max:180,value:31.717474411461016,key:"rot",onchange:n},{title:"category",type:"category",min:0,max:100,value:1,key:"category"},{title:"count",type:"number",min:1,max:100,value:10,key:"count"}]}},eraser:(t,e)=>{const a=t._manager.platform._renderer.points;let r=[];return{init:t=>{if(r.forEach((t=>t.remove())),r.length=0,"all"===t.mode)for(const t of a)r.push(e.append("circle").attr("r",t.radius).attr("fill","red").attr("cx",t.at[0]).attr("cy",t.at[1]));else"nearest"===t.mode?r.push(e.append("circle").attr("r",a[0].radius).attr("fill","red")):"circle"===t.mode&&r.push(e.append("circle").attr("r",50).attr("fill","red").attr("fill-opacity",.2))},move:(t,n)=>{if("nearest"===n.mode){let e=1/0,n=null;for(const r of a){const a=t.reduce(((t,e,a)=>t+(e-r.at[a])**2),0);a<e&&(n=r,e=a)}r[0].attr("cx",n.at[0]),r[0].attr("cy",n.at[1]),r[0].attr("r",n.radius)}else if("circle"===n.mode){r[0].attr("cx",t[0]),r[0].attr("cy",t[1]);for(let t=1;t<r.length;t++)r[t].remove();r.length=1;for(const n of a){const a=t.reduce(((t,e,a)=>t+(e-n.at[a])**2),0);Math.sqrt(a)<50&&r.push(e.append("circle").attr("r",n.radius).attr("fill","red").attr("cx",n.at[0]).attr("cy",n.at[1]))}}},click:(e,n)=>{if("all"===n.mode)t.remove(),r.forEach((t=>t.remove())),r.length=0;else if("nearest"===n.mode){let n=1/0,o=1/0,i=null,s=null;for(let r=0;r<t.length;r++){const t=e.reduce(((t,e,n)=>t+(e-a[r].at[n])**2),0);t<n?(s=i,i=r,o=n,n=t):t<o&&(s=r,o=t)}s&&(r[0].attr("cx",a[s].at[0]),r[0].attr("cy",a[s].at[1])),t.splice(i,1)}else if("circle"===n.mode){for(let r=t.length-1;r>=0;r--){const n=e.reduce(((t,e,n)=>t+(e-a[r].at[n])**2),0);Math.sqrt(n)<50&&t.splice(r,1)}for(let t=1;t<r.length;t++)r[t].remove();r.length=1}},terminate:()=>{r.forEach((t=>t.remove())),r.length=0},menu:[{title:"mode",type:"select",options:[{value:"nearest",text:"nearest"},{value:"circle",text:"circle"},{value:"all",text:"all"}],key:"mode"}]}}},dataPresets={clusters:{init:t=>{t.appendChild(document.createTextNode(" n "));const e=document.createElement("input");e.type="number",e.name="n",e.min=1,e.max=10,e.value=3,t.appendChild(e)},make:(t,e)=>{const a=+e.querySelector("[name=n]").value,r=t._manager.platform.width,n=t._manager.platform.height;let o=1;const i=[],s=[];for(let t=0;t<a;t++,o++){const t=[Math.random(),Math.random()];let e=0;for(;i.some((a=>Math.sqrt(t.reduce(((t,e,r)=>t+(e-a[r])**2),0))<Math.random()/((e++/5)**2+1)));)t[0]=Math.random(),t[1]=Math.random();i.push(t.concat()),t[0]=2*r/3*t[0]+r/6,t[1]=2*n/3*t[1]+n/6;for(let e=0;e<100;e++){let e=[0,0];0,e[0]=0*e[0]+t[0],e[1]=0*e[1]+t[1];{const t=normal_random(0,2500);e[0]+=t[0],e[1]+=t[1]}s.push(e,o)}}t.push(...s)}},moons:{make:(t,e)=>{const a=200;let r=1;const n=[];for(let e=0;e<2;e++,r++)for(let e=0;e<100;e++){const e=Math.random()*Math.PI,o=[Math.cos(e)*a,Math.sin(e)*a];{const t=normal_random(0,20);o[0]+=t[0],o[1]+=t[1]}2===r&&(o[0]=a-o[0],o[1]=a-o[1]-100),o[0]+=t._manager.platform.width/2-100,o[1]+=t._manager.platform.height/2-50,n.push(o,r)}t.push(...n)}},circle:{init:t=>{t.appendChild(document.createTextNode(" n "));const e=document.createElement("input");e.type="number",e.name="n",e.min=1,e.max=10,e.value=3,t.appendChild(e)},make:(t,e)=>{const a=+e.querySelector("[name=n]").value,r=Math.min(t._manager.platform.width,t._manager.platform.height)/(2*a),n=[];for(let e=0;e<a;e++)for(let a=0;a<100;a++){const a=2*Math.random()*Math.PI,o=[Math.cos(a)*r*e,Math.sin(a)*r*e];{const t=normal_random(0,50);o[0]+=t[0],o[1]+=t[1]}o[0]+=t._manager.platform.width/2,o[1]+=t._manager.platform.height/2,n.push(o,e+1)}t.push(...n)}},check:{make:(t,e)=>{const a=Math.min(t._manager.platform.width,t._manager.platform.height)/3,r=[t._manager.platform.width/2,t._manager.platform.height/2],n=[];for(let t=0;t<100;t++)n.push([r[0]+Math.random()*a,r[1]+Math.random()*a],1),n.push([r[0]-Math.random()*a,r[1]-Math.random()*a],1);for(let t=0;t<100;t++)n.push([r[0]+Math.random()*a,r[1]-Math.random()*a],2),n.push([r[0]-Math.random()*a,r[1]+Math.random()*a],2);t.push(...n)}}};class ContextMenu{constructor(){this._r=document.createElement("div"),this._r.classList.add("context-menu"),document.querySelector("body").appendChild(this._r),this._r.onclick=t=>t.stopPropagation(),this._showMenu=t=>{this.show([t.pageX,t.pageY]);const e=()=>{this.hide(),document.body.removeEventListener("click",e)};document.body.addEventListener("click",e)},this._orgoncontextmenu=document.body.oncontextmenu}terminate(){this.create(),this._r.remove()}create(t){if(this._r.replaceChildren(),!t||0===t.length)return document.body.removeEventListener("contextmenu",this._showMenu),void(document.body.oncontextmenu=this._orgoncontextmenu);document.body.addEventListener("contextmenu",this._showMenu),document.body.oncontextmenu=()=>!1;const e=document.createElement("ul");this._r.appendChild(e),this._properties={};for(let a=0;a<t.length;a++){const r=document.createElement("li");e.appendChild(r);const n=document.createElement("span");switch(n.classList.add("item-title"),n.innerText=t[a].title,r.appendChild(n),t[a].type){case"category":case"number":{const e=t=>{const e=getCategoryColor(t);r.style.backgroundColor=e;const a=.299*e.r+.587*e.g+.114*e.b<128?"white":"black";r.style.color=a},n=document.createElement("input");n.type="number",n.min=t[a].min,n.max=t[a].max,n.value=t[a].value,n.onchange=()=>{t[a].onchange?.(this._properties),"category"===t[a].type&&e(+n.value)},r.appendChild(n),"category"===t[a].type&&e(t[a].value),Object.defineProperty(this._properties,t[a].key,{get:()=>+n.value,set:t=>{n.value=t}});break}case"select":{const e=document.createElement("select");e.onchange=()=>t[a].onchange?.(this._properties);for(const r of t[a].options){const t=document.createElement("option");t.value=r.value,t.innerText=r.text,e.appendChild(t)}r.appendChild(e),Object.defineProperty(this._properties,t[a].key,{get:()=>e.value,set:t=>{e.value=t}});break}}}}show(t){this._r.classList.add("show"),this._r.style.left=t[0]+"px",this._r.style.top=t[1]+"px"}hide(){this._r.classList.remove("show")}values(){return this._properties}}export default class ManualData extends BaseData{constructor(t){super(t),this._org_padding=this._manager.platform._renderer.padding,this._manager.platform._renderer.padding=0,this._dim=2,this._scale=.001,this._tool=null,this._contextmenu=new ContextMenu,this._r=this.setting.svg.append("g");const e=this._r.append("g"),a=this._manager.platform.width,r=this._manager.platform.height,n=this;this._r.append("rect").attr("x",0).attr("y",0).attr("width",a).attr("height",r).attr("opacity",0).on("mouseenter",(()=>{this._tool?.terminate(),this.setting.svg.node().lastChild!==this._r.node()&&(this._r.remove(),this.setting.svg.append((()=>this._r.node()))),this._tool?.init(n._contextmenu.values())})).on("mousemove",(t=>{const e=d3.pointer(t);n._tool?.move(e,n._contextmenu.values())})).on("mouseleave",(()=>{this._tool?.terminate()})).on("click",(t=>{const e=d3.pointer(t);n._tool?.click(e,n._contextmenu.values())}));const o=this.setting.data.configElement;o.appendChild(document.createTextNode("Dimension"));const i=document.createElement("input");i.type="number",i.name="dimension",i.min=1,i.max=2,i.value=this._dim,i.onchange=()=>{this._dim=+i.value,this.setting.ml.refresh(),this.setting.vue.$forceUpdate(),this._manager.platform.render(),this.setting.vue.pushHistory()},o.appendChild(i);const s=document.createElement("div");o.appendChild(s),s.appendChild(document.createTextNode("Preset"));const l=document.createElement("select");l.onchange=()=>{const t=l.value;this.remove(),c.replaceChildren(),dataPresets[t].init?.(c),dataPresets[t].make(this,c)};for(const t of Object.keys(dataPresets)){const e=document.createElement("option");e.value=t,e.innerText=t,l.appendChild(e)}s.appendChild(l);const c=document.createElement("span");s.appendChild(c);const m=document.createElement("input");m.type="button",m.value="Reset",m.onclick=()=>{const t=l.value;this.remove(),dataPresets[t].make(this,c)},s.appendChild(m);const h=document.createElement("input");h.type="button",h.value="Clear",h.onclick=()=>{this.remove()},s.appendChild(h);const d=document.createElement("div");o.appendChild(d),d.appendChild(document.createTextNode("Tools"));const u=document.createElement("div");u.classList.add("manual-data-tools"),d.appendChild(u);for(const t in dataCreateTools){const a=document.createElement("div");a.title=t,a.classList.add("icon",t),a.onclick=()=>{this._tool?.terminate(),a.classList.contains("selected")?(a.classList.remove("selected"),this._tool=null,this._contextmenu.create()):(u.querySelectorAll("div").forEach((t=>t.classList.remove("selected"))),this._tool=dataCreateTools[t](this,e),a.classList.add("selected"),this._contextmenu.create(this._tool.menu),this._tool.init(n._contextmenu.values()))},u.appendChild(a),this._tool||(this._tool=dataCreateTools[t](this,e),a.classList.add("selected"),this._contextmenu.create(this._tool.menu),this._tool.init(n._contextmenu.values()))}this.addCluster([a/4,r/3],0,2500,100,1),this.addCluster([a/2,2*r/3],0,2500,100,2),this.addCluster([3*a/4,r/3],0,2500,100,3),dataPresets[l.value].init?.(c)}get availTask(){return 1===this._dim?["RG","IN","AD","DE","TF","SM","TP","CP"]:["CT","CF","SC","RG","IN","AD","DR","FS","DE","GR","SM","TP","CP"]}get domain(){const t=this._manager.platform.width,e=this._manager.platform.height;return 1===this._dim?[[0,t*this._scale]]:[[0,t*this._scale],[0,e*this._scale]]}get range(){return 1===this._dim?[0,this._manager.platform.height*this._scale]:super.range}get dimension(){return this._dim}get originalX(){return 1===this._dim?this._x.map((t=>[t[0]])):this._x}get x(){return this.originalX.map((t=>t.map((t=>t*this._scale))))}get originalY(){return 1===this._dim?this._x.map((t=>t[1])):this._y}get y(){return 1===this._dim?this._x.map((t=>t[1]*this._scale)):this._y}get params(){return{dimension:this._dim}}set params(t){if(t.dimension){this.setting.data.configElement.querySelector("[name=dimension]").value=t.dimension,this._dim=+t.dimension,this.setting.vue.$forceUpdate(),this._manager.platform.render()}}splice(t,e,...a){const r=[],n=[];for(let t=0;t<a.length;t+=2)r.push(a[t]),n.push(a[t+1]);const o=this._manager.platform._renderer.toValue?.(r[0])[0];let i,s;return void 0!==o?(i=this._x.splice(t,e),s=this._y.splice(t,e),this._x.splice(o,0,...r),this._y.splice(o,0,...n)):(i=this._x.splice(t,e,...r),s=this._y.splice(t,e,...n)),this._manager.platform.render(),i.map(((t,e)=>[t,s[e]]))}set(t,e,a){this.splice(t,1,e,a)}push(...t){this.splice(this.length,0,...t)}pop(){return this.splice(this.length-1,1)[0]}unshift(...t){this.splice(0,0,...t)}shift(){return this.splice(0,1)[0]}remove(){this.splice(0,this.length)}terminate(){super.terminate(),this._tool?.terminate(),this._contextmenu.terminate(),this._r.remove(),this._manager.platform._renderer.padding=this._org_padding}addCluster(t,e,a,r,n){const o=[];for(let i=0;i<r;i++){let r=[0,0];if(e>0)do{r=[2*Math.random()-1,2*Math.random()-1]}while(r[0]**2+r[1]**2<=1);if(r[0]=r[0]*e+t[0],r[1]=r[1]*e+t[1],a>0){const t=normal_random(0,a);r[0]+=t[0],r[1]+=t[1]}o.push(r,+n)}this.push(...o)}}