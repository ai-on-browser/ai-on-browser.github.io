import JSONData from"./json.js";const BASE_URL="https://pokeapi.co/api/v2",DB_NAME="poke_api";class PokeDB{constructor(){this.db=null}async _ready(){if(this.db)return;const t=indexedDB.open(DB_NAME,1);return new Promise(((e,n)=>{t.onerror=n,t.onsuccess=()=>{this.db=t.result,e()},t.onupgradeneeded=t=>{const e=t.target.result;e.createObjectStore("count",{keyPath:"endpoint"});e.createObjectStore("pokemon",{keyPath:"id"}).createIndex("name","name",{unique:!0})}}))}async save(t,e){return await this._ready(),new Promise(((n,a)=>{const s=this.db.transaction([t],"readwrite"),o=s.objectStore(t);for(const t of e)o.add(t);s.oncomplete=n,s.onerror=a}))}async get(t,e){return await this._ready(),new Promise(((n,a)=>{const s=this.db.transaction(t).objectStore(t).get(e);s.onsuccess=t=>{n(t.target.result)},s.onerror=a}))}async list(t){return await this._ready(),new Promise(((e,n)=>{const a=this.db.transaction(t).objectStore(t).getAll();a.onsuccess=t=>{e(t.target.result)},a.onerror=n}))}async deleteDatabase(){return new Promise(((t,e)=>{this.db.close();const n=indexedDB.deleteDatabase(DB_NAME);n.onerror=e,n.onsuccess=()=>{this.db=null,t()}}))}}export default class PokeData extends JSONData{constructor(t){super(t),this._db=new PokeDB,this._object=[],this._target=-1,this._loading=!1;const e=this.setting.data.configElement,n=document.createElement("div");n.style.display="flex",n.style.justifyContent="space-between",e.appendChild(n);const a=document.createElement("div");n.appendChild(a),this._getDataButton=document.createElement("input"),this._getDataButton.type="button",this._getDataButton.value="Load data",this._getDataButton.style.display="none",this._getDataButton.onclick=()=>{this._loading?(this._loading=!1,this._getDataButton.disabled=!0):(this._loading=!0,this._getDataButton.value="Stop loading",this._getPokemons().catch((t=>{console.error(t)})).finally((()=>{this._getDataButton.value="Load data",this._getDataButton.disabled=!1,this._loading=!1,this.ready()})))},a.appendChild(this._getDataButton);const s=document.createElement("span");s.setAttribute("name","status"),s.style.margin="0 10px",a.appendChild(s);const o=document.createElement("a");n.appendChild(o),o.href="https://pokeapi.co/",o.setAttribute("ref","noreferrer noopener"),o.target="_blank",o.innerText="Pokémon API",this._progressBar=document.createElement("div"),this._progressBar.innerText="0 / 0",this._progressBar.style.width="100%",this._progressBar.style.fontSize="50%",this._progressBar.style.textAlign="center",this._progressBar.style.backgroundColor="white",this._progressBar.style.display="none",e.appendChild(this._progressBar);const i=document.createElement("span");i.innerText="Pokémon and Pokémon character names are trademarks of Nintendo.",i.style.fontSize="80%",e.appendChild(i),this._selector=document.createElement("div"),e.appendChild(this._selector),this.ready()}get availTask(){return["RG","AD"]}get columnNames(){return this._object.map((t=>this._feature_names[t]))}get x(){return this._x.map((t=>this._object.map((e=>t[e]))))}get y(){return this._target>=0?this._x.map((t=>t[this._target])):Array(this._x.length).fill(0)}get labels(){return this._names}async ready(){const t=this.setting.data.configElement,e=(await this._db.get("count","pokemon"))?.count??1/0,n=await this._db.list("pokemon");this._getDataButton.style.display=n.length<e?"inline":"none";const a=t.querySelector("[name=status]");0===n.length?a.innerText="No data":n.length<e?(a.innerText="Data loading is not completed",e!==1/0&&(a.innerText+=` (${n.length}/${e})`)):a.innerText="Data is ready!",0!==n.length&&(this._object=[0],this._target=1,this._names=n.map((t=>t.name)),this.setJSON(n.map((t=>({height:t.height,weight:t.weight}))),["height","weight"].map((t=>({name:t,nan:0})))),this._readySelector())}async _getPokemons(){const t=(await this._db.get("count","pokemon"))?.count??1/0,e=await this._db.list("pokemon");if(e.length>=t)return e;console.debug("request to /pokemon/{id or name}/");let n=`${BASE_URL}/pokemon?limit=100`;const a=e.concat();let s=0;this._progressBar.style.display="block";let o=[];const i=()=>{const t=100*a.length/s,e=Math.max(1,o.length-10),n=(o[o.length-1]-o[e-1])/(o.length-e),i=isNaN(n)?0:n/1e3*(s-a.length);this._progressBar.innerText=`${a.length} / ${s} (${Math.floor(i/60)}:${Math.floor(i)%60})`,this._progressBar.style.background=`linear-gradient(90deg, lightgray, ${t}%, gray, ${t}%, white)`};for(o.push((new Date).getTime());this._loading&&n;){const r=await fetch(n),l=await r.json();0===s&&(s=l.count,i(),t===1/0&&await this._db.save("count",[{endpoint:"pokemon",count:s,fetchDate:new Date}]));for(const t of l.results){if(e.some((e=>e.name===t.name)))continue;if(!this._loading)break;await new Promise((t=>setTimeout(t,100)));const n=await fetch(t.url),s=await n.json();a.push(s),await this._db.save("pokemon",[s]),o.push((new Date).getTime()),i()}n=l.next}return this._progressBar.innerText="0 / 0",this._progressBar.style.display="none",a}_readySelector(){if(this._selector.replaceChildren(),this._feature_names.length>1){const t=document.createElement("select");t.multiple=!0,t.onchange=()=>{this._object=[];let n="",a=!1;for(const s of t.options)s.selected?(this._object.push(this._feature_names.indexOf(s.value)),s.value===e.value&&(a=!0)):n||(n=s.value);a&&(this._target=this._feature_names.indexOf(n),e.value=n),this._domain=null,this._manager.onReady((()=>{this._manager.platform.init()}))},this._selector.append("Input",t);const e=document.createElement("select");e.onchange=()=>{let n=!1;for(const a of t.selectedOptions)if(a.value===e.value){a.selected=!1,this._object=this._object.filter((t=>this._feature_names[t]!==a.value)),n=!0;break}if(n||""===e.value&&this._target>=0)for(const e of t.options)e.value===this._feature_names[this._target]&&(e.selected=!0,this._object.push(this._target));this._target=this._feature_names.indexOf(e.value),this._domain=null,this._manager.onReady((()=>{this._manager.platform.init()}))},this._selector.append("Output",e),e.appendChild(document.createElement("option"));for(const n of this._feature_names){const a=document.createElement("option");a.value=n,a.innerText=n,t.appendChild(a),e.appendChild(a.cloneNode(!0))}t.size=Math.min(4,t.options.length);for(let e=0;e<this._feature_names.length-1;e++)t.options[e].selected=this._object.indexOf(e)>=0;e.value=this._feature_names[this._target]}}}