var f=Object.defineProperty;var u=(g,n)=>f(g,"name",{value:n,configurable:!0});import{FixData as y}from"./base.js";import k from"./db/base.js";import B from"./loader/json.js";import b from"./util/ioselector.js";const w="https://pokeapi.co/api/v2",x="poke_api";class D extends k{static{u(this,"PokeDB")}constructor(){super(x,1)}onupgradeneeded(n){const a=n.target.result;a.createObjectStore("count",{keyPath:"endpoint"}),a.createObjectStore("pokemon",{keyPath:"id"}).createIndex("name","name",{unique:!0})}}export default class E extends y{static{u(this,"PokeData")}constructor(n){super(n),this._db=new D,this._loading=!1;const a=this.setting.data.configElement,e=document.createElement("div");e.style.display="flex",e.style.justifyContent="space-between",a.appendChild(e);const o=document.createElement("div");e.appendChild(o),this._getDataButton=document.createElement("input"),this._getDataButton.type="button",this._getDataButton.value="Load data",this._getDataButton.style.display="none",this._getDataButton.onclick=()=>{this._loading?(this._loading=!1,this._getDataButton.disabled=!0):(this._loading=!0,this._getDataButton.value="Stop loading",this._getPokemons().catch(t=>{console.error(t)}).finally(()=>{this._getDataButton.value="Load data",this._getDataButton.disabled=!1,this._loading=!1,this.ready()}))},o.appendChild(this._getDataButton);const i=document.createElement("span");i.setAttribute("name","status"),i.style.margin="0 10px",o.appendChild(i);const s=document.createElement("a");e.appendChild(s),s.href="https://pokeapi.co/",s.setAttribute("ref","noreferrer noopener"),s.target="_blank",s.innerText="Pok\xE9mon API",this._progressBar=document.createElement("div"),this._progressBar.innerText="0 / 0",this._progressBar.style.width="100%",this._progressBar.style.fontSize="50%",this._progressBar.style.textAlign="center",this._progressBar.style.backgroundColor="white",this._progressBar.style.display="none",a.appendChild(this._progressBar);const r=document.createElement("span");r.innerText="Pok\xE9mon and Pok\xE9mon character names are trademarks of Nintendo.",r.style.fontSize="80%",a.appendChild(r),this._selector=new b(a),this._selector.onchange=()=>{this._domain=null,this._manager.onReady(()=>{this._manager.platform.init()})},this.ready()}get availTask(){return["RG","AD"]}get columnNames(){return this._selector.object.map(n=>this._feature_names[n])}get x(){return this._x.map(n=>this._selector.object.map(a=>n[a]))}get originalX(){return this.x}get y(){const n=this._selector.target;return n>=0?this._x.map(a=>a[n]):Array(this._x.length).fill(0)}get originalY(){return this.y}get labels(){return this._names}async ready(){const n=this.setting.data.configElement,e=(await this._db.get("count","pokemon"))?.count??1/0,o=await this._db.list("pokemon");this._getDataButton.style.display=o.length<e?"inline":"none";const i=n.querySelector("[name=status]");if(o.length===0?i.innerText="No data":o.length<e?(i.innerText="Data loading is not completed",e!==1/0&&(i.innerText+=` (${o.length}/${e})`)):i.innerText="Data is ready!",o.length===0)return;this._selector.target=1,this._selector.object=[0],this._names=o.map(t=>t.name);const s=["height","weight","hp","attack","defense","special-attack","special-defense","speed"].map(t=>({name:t,nan:0})),r=new B(o.map(t=>{const h={height:t.height,weight:t.weight};for(const l of t.stats)h[l.stat.name]=l.base_stat;return h}),{columnInfos:s});this.setArray(r.data,s),this._selector.columns=this._feature_names}async _getPokemons(){const a=(await this._db.get("count","pokemon"))?.count??1/0,e=await this._db.list("pokemon");if(e.length>=a)return e;console.debug("request to /pokemon/{id or name}/");let i=`${w}/pokemon?limit=100`;const s=e.concat();let r=0;this._progressBar.style.display="block";const t=[],h=u(()=>{const l=100*s.length/r,c=Math.max(1,t.length-10),d=(t[t.length-1]-t[c-1])/(t.length-c),p=Number.isNaN(d)?0:d/1e3*(r-s.length);this._progressBar.innerText=`${s.length} / ${r} (${Math.floor(p/60)}:${Math.floor(p)%60})`,this._progressBar.style.background=`linear-gradient(90deg, lightgray, ${l}%, gray, ${l}%, white)`},"updateProgress");for(t.push(Date.now());this._loading&&i;){const c=await(await fetch(i)).json();r===0&&(r=c.count,h(),a===1/0&&await this._db.save("count",[{endpoint:"pokemon",count:r,fetchDate:new Date}]));for(const d of c.results){if(e.some(m=>m.name===d.name))continue;if(!this._loading)break;await new Promise(m=>setTimeout(m,100));const _=await(await fetch(d.url)).json();s.push(_),await this._db.save("pokemon",[_]),t.push(Date.now()),h()}i=c.next}return this._progressBar.innerText="0 / 0",this._progressBar.style.display="none",s}terminate(){super.terminate(),this._loading=!1}}
