var f=Object.defineProperty;var u=(p,n)=>f(p,"name",{value:n,configurable:!0});import y from"./db/base.js";import{FixData as b}from"./base.js";import k from"./loader/json.js";const x="https://pokeapi.co/api/v2",B="poke_api";class w extends y{static{u(this,"PokeDB")}constructor(){super(B,1)}onupgradeneeded(n){const a=n.target.result;a.createObjectStore("count",{keyPath:"endpoint"}),a.createObjectStore("pokemon",{keyPath:"id"}).createIndex("name","name",{unique:!0})}}export default class D extends b{static{u(this,"PokeData")}constructor(n){super(n),this._db=new w,this._object=[],this._target=-1,this._loading=!1;const a=this.setting.data.configElement,t=document.createElement("div");t.style.display="flex",t.style.justifyContent="space-between",a.appendChild(t);const e=document.createElement("div");t.appendChild(e),this._getDataButton=document.createElement("input"),this._getDataButton.type="button",this._getDataButton.value="Load data",this._getDataButton.style.display="none",this._getDataButton.onclick=()=>{this._loading?(this._loading=!1,this._getDataButton.disabled=!0):(this._loading=!0,this._getDataButton.value="Stop loading",this._getPokemons().catch(o=>{console.error(o)}).finally(()=>{this._getDataButton.value="Load data",this._getDataButton.disabled=!1,this._loading=!1,this.ready()}))},e.appendChild(this._getDataButton);const s=document.createElement("span");s.setAttribute("name","status"),s.style.margin="0 10px",e.appendChild(s);const i=document.createElement("a");t.appendChild(i),i.href="https://pokeapi.co/",i.setAttribute("ref","noreferrer noopener"),i.target="_blank",i.innerText="Pok\xE9mon API",this._progressBar=document.createElement("div"),this._progressBar.innerText="0 / 0",this._progressBar.style.width="100%",this._progressBar.style.fontSize="50%",this._progressBar.style.textAlign="center",this._progressBar.style.backgroundColor="white",this._progressBar.style.display="none",a.appendChild(this._progressBar);const r=document.createElement("span");r.innerText="Pok\xE9mon and Pok\xE9mon character names are trademarks of Nintendo.",r.style.fontSize="80%",a.appendChild(r),this._selector=document.createElement("div"),a.appendChild(this._selector),this.ready()}get availTask(){return["RG","AD"]}get columnNames(){return this._object.map(n=>this._feature_names[n])}get x(){return this._x.map(n=>this._object.map(a=>n[a]))}get originalX(){return this.x}get y(){return this._target>=0?this._x.map(n=>n[this._target]):Array(this._x.length).fill(0)}get originalY(){return this.y}get labels(){return this._names}async ready(){const n=this.setting.data.configElement,t=(await this._db.get("count","pokemon"))?.count??1/0,e=await this._db.list("pokemon");this._getDataButton.style.display=e.length<t?"inline":"none";const s=n.querySelector("[name=status]");if(e.length===0?s.innerText="No data":e.length<t?(s.innerText="Data loading is not completed",t!==1/0&&(s.innerText+=` (${e.length}/${t})`)):s.innerText="Data is ready!",e.length===0)return;this._object=[0],this._target=1,this._names=e.map(o=>o.name);const i=["height","weight","hp","attack","defense","special-attack","special-defense","speed"].map(o=>({name:o,nan:0})),r=new k(e.map(o=>{const h={height:o.height,weight:o.weight};for(const l of o.stats)h[l.stat.name]=l.base_stat;return h}),{columnInfos:i});this.setArray(r.data,i),this._readySelector()}async _getPokemons(){const a=(await this._db.get("count","pokemon"))?.count??1/0,t=await this._db.list("pokemon");if(t.length>=a)return t;console.debug("request to /pokemon/{id or name}/");let s=`${x}/pokemon?limit=100`;const i=t.concat();let r=0;this._progressBar.style.display="block";let o=[];const h=u(()=>{const l=100*i.length/r,c=Math.max(1,o.length-10),d=(o[o.length-1]-o[c-1])/(o.length-c),m=isNaN(d)?0:d/1e3*(r-i.length);this._progressBar.innerText=`${i.length} / ${r} (${Math.floor(m/60)}:${Math.floor(m)%60})`,this._progressBar.style.background=`linear-gradient(90deg, lightgray, ${l}%, gray, ${l}%, white)`},"updateProgress");for(o.push(new Date().getTime());this._loading&&s;){const c=await(await fetch(s)).json();r===0&&(r=c.count,h(),a===1/0&&await this._db.save("count",[{endpoint:"pokemon",count:r,fetchDate:new Date}]));for(const d of c.results){if(t.some(g=>g.name===d.name))continue;if(!this._loading)break;await new Promise(g=>setTimeout(g,100));const _=await(await fetch(d.url)).json();i.push(_),await this._db.save("pokemon",[_]),o.push(new Date().getTime()),h()}s=c.next}return this._progressBar.innerText="0 / 0",this._progressBar.style.display="none",i}_readySelector(){if(this._selector.replaceChildren(),this._feature_names.length>1){const n=document.createElement("select");n.multiple=!0,n.onchange=()=>{this._object=[];let t="",e=!1;for(const s of n.options)s.selected?(this._object.push(this._feature_names.indexOf(s.value)),s.value===a.value&&(e=!0)):t||(t=s.value);e&&(this._target=this._feature_names.indexOf(t),a.value=t),this._domain=null,this._manager.onReady(()=>{this._manager.platform.init()})},this._selector.append("Input",n);const a=document.createElement("select");a.onchange=()=>{let t=!1;for(const e of n.selectedOptions)if(e.value===a.value){e.selected=!1,this._object=this._object.filter(s=>this._feature_names[s]!==e.value),t=!0;break}if(t||a.value===""&&this._target>=0)for(const e of n.options)e.value===this._feature_names[this._target]&&(e.selected=!0,this._object.push(this._target));this._target=this._feature_names.indexOf(a.value),this._domain=null,this._manager.onReady(()=>{this._manager.platform.init()})},this._selector.append("Output",a),a.appendChild(document.createElement("option"));for(const t of this._feature_names){const e=document.createElement("option");e.value=e.innerText=t,n.appendChild(e),a.appendChild(e.cloneNode(!0))}n.size=Math.min(4,n.options.length);for(let t=0;t<this._feature_names.length-1;t++)n.options[t].selected=this._object.includes(t);a.value=this._feature_names[this._target]}}}
