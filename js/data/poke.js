import BaseDB from"./db/base.js";import JSONData from"./json.js";const BASE_URL="https://pokeapi.co/api/v2",DB_NAME="poke_api";class PokeDB extends BaseDB{constructor(){super(DB_NAME,1)}onupgradeneeded(t){const e=t.target.result;e.createObjectStore("count",{keyPath:"endpoint"});e.createObjectStore("pokemon",{keyPath:"id"}).createIndex("name","name",{unique:!0})}}export default class PokeData extends JSONData{constructor(t){super(t),this._db=new PokeDB,this._object=[],this._target=-1,this._loading=!1;const e=this.setting.data.configElement,a=document.createElement("div");a.style.display="flex",a.style.justifyContent="space-between",e.appendChild(a);const n=document.createElement("div");a.appendChild(n),this._getDataButton=document.createElement("input"),this._getDataButton.type="button",this._getDataButton.value="Load data",this._getDataButton.style.display="none",this._getDataButton.onclick=()=>{this._loading?(this._loading=!1,this._getDataButton.disabled=!0):(this._loading=!0,this._getDataButton.value="Stop loading",this._getPokemons().catch((t=>{console.error(t)})).finally((()=>{this._getDataButton.value="Load data",this._getDataButton.disabled=!1,this._loading=!1,this.ready()})))},n.appendChild(this._getDataButton);const s=document.createElement("span");s.setAttribute("name","status"),s.style.margin="0 10px",n.appendChild(s);const i=document.createElement("a");a.appendChild(i),i.href="https://pokeapi.co/",i.setAttribute("ref","noreferrer noopener"),i.target="_blank",i.innerText="Pokémon API",this._progressBar=document.createElement("div"),this._progressBar.innerText="0 / 0",this._progressBar.style.width="100%",this._progressBar.style.fontSize="50%",this._progressBar.style.textAlign="center",this._progressBar.style.backgroundColor="white",this._progressBar.style.display="none",e.appendChild(this._progressBar);const o=document.createElement("span");o.innerText="Pokémon and Pokémon character names are trademarks of Nintendo.",o.style.fontSize="80%",e.appendChild(o),this._selector=document.createElement("div"),e.appendChild(this._selector),this.ready()}get availTask(){return["RG","AD"]}get columnNames(){return this._object.map((t=>this._feature_names[t]))}get x(){return this._x.map((t=>this._object.map((e=>t[e]))))}get originalX(){return this.x}get y(){return this._target>=0?this._x.map((t=>t[this._target])):Array(this._x.length).fill(0)}get originalY(){return this.y}get labels(){return this._names}async ready(){const t=this.setting.data.configElement,e=await this._db.get("count","pokemon"),a=e?.count??1/0,n=await this._db.list("pokemon");this._getDataButton.style.display=n.length<a?"inline":"none";const s=t.querySelector("[name=status]");0===n.length?s.innerText="No data":n.length<a?(s.innerText="Data loading is not completed",a!==1/0&&(s.innerText+=` (${n.length}/${a})`)):s.innerText="Data is ready!",0!==n.length&&(this._object=[0],this._target=1,this._names=n.map((t=>t.name)),this.setJSON(n.map((t=>({height:t.height,weight:t.weight}))),["height","weight"].map((t=>({name:t,nan:0})))),this._readySelector())}async _getPokemons(){const t=await this._db.get("count","pokemon"),e=t?.count??1/0,a=await this._db.list("pokemon");if(a.length>=e)return a;console.debug("request to /pokemon/{id or name}/");let n=`${BASE_URL}/pokemon?limit=100`;const s=a.concat();let i=0;this._progressBar.style.display="block";let o=[];const r=()=>{const t=100*s.length/i,e=Math.max(1,o.length-10),a=(o[o.length-1]-o[e-1])/(o.length-e),n=isNaN(a)?0:a/1e3*(i-s.length);this._progressBar.innerText=`${s.length} / ${i} (${Math.floor(n/60)}:${Math.floor(n)%60})`,this._progressBar.style.background=`linear-gradient(90deg, lightgray, ${t}%, gray, ${t}%, white)`};for(o.push((new Date).getTime());this._loading&&n;){const t=await fetch(n),h=await t.json();0===i&&(i=h.count,r(),e===1/0&&await this._db.save("count",[{endpoint:"pokemon",count:i,fetchDate:new Date}]));for(const t of h.results){if(a.some((e=>e.name===t.name)))continue;if(!this._loading)break;await new Promise((t=>setTimeout(t,100)));const e=await fetch(t.url),n=await e.json();s.push(n),await this._db.save("pokemon",[n]),o.push((new Date).getTime()),r()}n=h.next}return this._progressBar.innerText="0 / 0",this._progressBar.style.display="none",s}_readySelector(){if(this._selector.replaceChildren(),this._feature_names.length>1){const t=document.createElement("select");t.multiple=!0,t.onchange=()=>{this._object=[];let a="",n=!1;for(const s of t.options)s.selected?(this._object.push(this._feature_names.indexOf(s.value)),s.value===e.value&&(n=!0)):a||(a=s.value);n&&(this._target=this._feature_names.indexOf(a),e.value=a),this._domain=null,this._manager.onReady((()=>{this._manager.platform.init()}))},this._selector.append("Input",t);const e=document.createElement("select");e.onchange=()=>{let a=!1;for(const n of t.selectedOptions)if(n.value===e.value){n.selected=!1,this._object=this._object.filter((t=>this._feature_names[t]!==n.value)),a=!0;break}if(a||""===e.value&&this._target>=0)for(const e of t.options)e.value===this._feature_names[this._target]&&(e.selected=!0,this._object.push(this._target));this._target=this._feature_names.indexOf(e.value),this._domain=null,this._manager.onReady((()=>{this._manager.platform.init()}))},this._selector.append("Output",e),e.appendChild(document.createElement("option"));for(const a of this._feature_names){const n=document.createElement("option");n.value=n.innerText=a,t.appendChild(n),e.appendChild(n.cloneNode(!0))}t.size=Math.min(4,t.options.length);for(let e=0;e<this._feature_names.length-1;e++)t.options[e].selected=this._object.includes(e);e.value=this._feature_names[this._target]}}}