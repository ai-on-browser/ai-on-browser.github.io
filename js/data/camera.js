var r=Object.defineProperty;var l=(o,e)=>r(o,"name",{value:e,configurable:!0});import{BaseData as m}from"./base.js";import h from"./loader/image.js";import c from"../renderer/image.js";export default class p extends m{static{l(this,"CameraData")}constructor(e){super(e),this._size=[240,360];const i=this.setting.data.configElement;this._mngelm=document.createElement("div"),i.appendChild(this._mngelm);const t=document.createElement("input");t.type="button",t.value="Add data",t.onclick=()=>this.startVideo(),this._mngelm.appendChild(t),this._slctImg=document.createElement("select"),this._slctImg.onchange=()=>{this._manager.platform.render(),this._thumbnail.replaceChildren(),this._thumbnail.appendChild(h.createCanvas(this.x[0]))},this._mngelm.appendChild(this._slctImg),this._thumbnail=document.createElement("span"),this._mngelm.appendChild(this._thumbnail),this._videoElm=document.createElement("div"),i.appendChild(this._videoElm),this.startVideo(),this._x=[],this._y=[],this._manager.platform._renderer.push(new c(e)),this._manager.setting.render.selectItem("image")}get availTask(){return["SG","DN","ED"]}get x(){const e=+this._slctImg.value-1;return this._x.length===0||!this._x[e]?[]:[this._x[e]]}startVideo(e){this._mngelm.style.display="none",this._videoElm.append("Click video to use as data.");const i=document.createElement("div");this._videoElm.appendChild(i);const t=document.createElement("select");t.onchange=()=>{this.stopVideo(),this.startVideo(t.value)},i.appendChild(t),this._video=document.createElement("video"),this._videoElm.appendChild(this._video),this._video.width=this._size[1],this._video.height=this._size[0],this._video.autoplay=!0,this._video.onclick=()=>{h.load(this._video).then(s=>{this._x.push(s),this._y.push(0);const n=document.createElement("option");n.value=n.innerText=this._x.length,this._slctImg.appendChild(n),this._slctImg.value=this._x.length,this._thumbnail.replaceChildren(),this._thumbnail.appendChild(h.createCanvas(s)),this.stopVideo(),this._mngelm.style.display=null,this._manager.platform.render&&setTimeout(()=>{this._manager.platform.render()},0)})},navigator.mediaDevices.getUserMedia({video:{deviceId:e}}).then(s=>{this._video.srcObject=s,navigator.mediaDevices.enumerateDevices().then(n=>{for(const d of n.filter(a=>a.kind==="videoinput")){const a=document.createElement("option");a.value=d.deviceId,a.innerText=d.label,t.appendChild(a)}s.getTracks().forEach(d=>{t.value=d.getSettings().deviceId})})}).catch(s=>{console.error(s),this.stopVideo()})}stopVideo(){if(this._video){const e=this._video.srcObject;e&&(e.getTracks().forEach(i=>{i.stop()}),this._video.srcObject=null),this._video=null}this._videoElm.replaceChildren()}terminate(){super.terminate(),this.stopVideo()}}
