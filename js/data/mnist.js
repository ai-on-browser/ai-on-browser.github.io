import{FixData}from"./base.js";import BaseRenderer from"../renderer/base.js";import BaseDB from"./db/base.js";const mnistLinks={trainImages:"https://storage.googleapis.com/learnjs-data/model-builder/mnist_images.png",trainLabels:"https://storage.googleapis.com/learnjs-data/model-builder/mnist_labels_uint8"};let lock=!1;export default class MNISTData extends FixData{constructor(e){super(e),this._sampleCount=10,this._imageSize=[28,28];const t=this.setting.data.configElement,s=document.createElement("div");s.style.display="flex",s.style.justifyContent="space-between",t.appendChild(s);const a=document.createElement("span");s.appendChild(a);const n=document.createElement("input");n.type="number",n.min=1,n.max=1e4,n.value=10,n.onchange=async()=>{this._sampleCount=+n.value,await this._readyData(),this._manager.platform.init()},a.append("Sample number",n);const i=document.createElement("div");s.appendChild(i);const r=document.createElement("a");r.href="https://github.com/tensorflow/tfjs",r.setAttribute("ref","noreferrer noopener"),r.target="_blank",r.innerText="TensorFlow.js",i.append("The data is from the ",r),this._manager.requiredRenderers([MNISTRenderer]),this._readyData().then((()=>{this._manager.onReady((()=>{this._manager.platform.init()}))}))}get availTask(){return["CF","SC","AD","DR","FS"]}get domain(){const e=[];for(let t=0;t<this._imageSize[0]*this._imageSize[1];t++)e.push([0,255]);return e}get columnNames(){return this._cols||[]}_sample(e){const t=e.map(((e,t)=>[e.y,t])),s=[],a=[];for(let n=0;n<=9;n++){const i=t.filter((e=>e[0]===n)),r=Math.min(i.length,this._sampleCount),o=Array.from({length:r},((e,t)=>t));for(let e=o.length-1;e>0;e--){const t=Math.floor(Math.random()*(e+1));[o[e],o[t]]=[o[t],o[e]]}for(let t=0;t<r;t++){const n=i[o[t]][1];s.push(e[n].x),a.push(e[n].y)}}return[s,a]}async _readyData(){this._cols=[];for(let e=0,t=0;e<28;e++)for(let s=0;s<28;s++,t++)this._cols.push(`${e},${s}`);const e=new MNISTDB,t=await e.list(TABLE_NAME);if(t.length>0)[this._x,this._y]=this._sample(t);else if(!lock)return lock=!0,new Promise(((t,s)=>{const a=new Image;a.crossOrigin="Anonymous",a.addEventListener("load",(async()=>{const s=a.height,n=a.width,i=document.createElement("canvas");i.width=n,i.height=s;const r=i.getContext("2d");r.drawImage(a,0,0);const o=r.getImageData(0,0,n,s),l=await fetch(mnistLinks.trainLabels),d=new Int8Array(await l.arrayBuffer()),h=[];for(let e=0;e<s;e++){const t=[];for(let s=0;s<4*n;s+=4)t.push(o.data[e*n*4+s]);const s=d.slice(10*e,10*(e+1));h[e]={x:t,y:s.indexOf(1)}}e.save(TABLE_NAME,h),[this._x,this._y]=this._sample(h),lock=!1,t()}),!1),a.addEventListener("error",s),a.src=mnistLinks.trainImages}))}terminate(){super.terminate(),this._manager.requiredRenderers()}}class MNISTRenderer extends BaseRenderer{constructor(e){super(e),this._offset=0,this._pagesize=100,this._colsize=5,this._predict=null;const t=this.setting.render.addItem("mnist"),s=document.createElement("div");s.style.display="flex",s.style.justifyContent="space-between",s.style.position="sticky",s.style.top="0";const a=document.createElement("div");a.style.backgroundColor="white",a.style.padding="5px",a.style.marginBottom="-1px",a.style.borderBottom="1px solid black",s.append(a),this._navigator=document.createElement("span"),a.appendChild(this._navigator);const n=document.createElement("select");n.onchange=()=>{this._offset=0,this._pagesize=+n.value,this._renderPager()};for(const e of[10,50,100,500,1e3]){const t=document.createElement("option");t.value=e,t.innerText=e,n.append(t)}n.value=this._pagesize,a.appendChild(n);const i=document.createElement("button");i.innerHTML="&uarr;",i.onclick=()=>{window.scroll({top:0,behavior:"smooth"})},i.title="To top",i.style.margin="5px",i.style.borderRadius="50%",s.appendChild(i),this._table=document.createElement("table"),this._table.style.border="1px solid black",this._table.style.borderCollapse="collapse",t.append(s,this._table),this._manager.setting.render.selectItem("mnist")}set trainResult(e){"CF"===this._manager.platform.task&&this.datas.outputCategoryNames?e=e.map((e=>this.datas.outputCategoryNames[e-1])):"AD"===this._manager.platform.task&&(e=e.map((e=>e?"anomalous":""))),this._predict?(this._predict=e,this._renderData()):(this._predict=e,this.render())}init(){this._predict=null}render(){this._table.replaceChildren(),this._navigator.replaceChildren(),this._offset=0;if(!this.datas)return;const e=this._table.createTHead().insertRow(),t=["image","target"];this._predict&&t.push("predict");for(let s=0;s<this._colsize;s++)for(const s of t){const t=e.insertCell();t.innerText=s,t.style.border="1px solid black"}this._table.createTBody(),this._renderPager()}_renderPager(){this._navigator.replaceChildren(),this._renderData();const e=this.datas;if(!e)return;const t=Math.ceil(e.length/this._pagesize),s=Math.floor(this._offset/this._pagesize)+1;if(s>1){const e=document.createElement("input");e.type="button",e.value="<",e.onclick=()=>{this._offset=Math.max(0,this._offset-this._pagesize),this._renderPager()},this._navigator.appendChild(e)}const a=document.createElement("input");a.type="button",a.value="1",a.onclick=()=>{this._offset=0,this._renderPager()},1===s&&(a.disabled=!0),this._navigator.appendChild(a),s>3&&this._navigator.append(" ... ");for(let e=Math.max(2,s-1);e<=Math.min(t-1,s+1);e++){const t=document.createElement("input");t.type="button",t.value=e,t.onclick=()=>{this._offset=this._pagesize*(e-1),this._renderPager()},e===s&&(t.disabled=!0),this._navigator.appendChild(t)}if(s<t-2&&this._navigator.append(" ... "),t>1){const e=document.createElement("input");e.type="button",e.value=t,e.onclick=()=>{this._offset=this._pagesize*(t-1),this._renderPager()},s===t&&(e.disabled=!0),this._navigator.appendChild(e)}if(s<t){const t=document.createElement("input");t.type="button",t.value=">",t.onclick=()=>{this._offset=Math.min(e.length-1,this._offset+this._pagesize),this._renderPager()},this._navigator.appendChild(t)}this._navigator.append(` (${this._offset+1} - ${Math.min(this._offset+this._pagesize,e.length)} / ${e.length}) `)}_renderData(){const e=this._table.tBodies[0];e.replaceChildren();const t=this.datas;if(!t)return;const s=t.originalX,a="RG"===this._manager.platform.task?t.y:t.originalY,n=Math.min(t.length,this._offset+this._pagesize);for(let t=this._offset;t<n;){const i=e.insertRow();for(let e=0;e<this._colsize&&t<n;e++,t++){const e=document.createElement("canvas");e.height=28,e.width=28;const n=e.getContext("2d"),r=n.getImageData(0,0,28,28);for(let e=0;e<s[t].length;e++)r.data[4*e]=s[t][e],r.data[4*e+1]=s[t][e],r.data[4*e+2]=s[t][e],r.data[4*e+3]=255;n.putImageData(r,0,0);const o=i.insertCell();o.appendChild(e),o.style.border="1px solid black",o.style.textAlign="center";const l=[a[t]];this._predict&&l.push(this._predict[t]);for(const e of l){const t=i.insertCell();t.innerText=e,t.style.border="1px solid black"}}}}terminate(){this.setting.render.removeItem("mnist"),super.terminate()}}const DB_NAME="mnist",TABLE_NAME="data";class MNISTDB extends BaseDB{constructor(){super("mnist",1)}onupgradeneeded(e){e.target.result.createObjectStore(TABLE_NAME,{autoIncrement:!0})}}