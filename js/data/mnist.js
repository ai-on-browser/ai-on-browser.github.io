import{FixData}from"./base.js";import BaseRenderer from"../renderer/base.js";const mnistLinks={trainImages:"https://storage.googleapis.com/learnjs-data/model-builder/mnist_images.png",trainLabels:"https://storage.googleapis.com/learnjs-data/model-builder/mnist_labels_uint8"};let lock=!1;export default class MNISTData extends FixData{constructor(e){super(e),this._sampleCount=10,this._imageSize=[28,28];const t=this.setting.data.configElement,a=document.createElement("div");a.style.display="flex",a.style.justifyContent="space-between",t.appendChild(a);const n=document.createElement("span");a.appendChild(n);const s=document.createElement("input");s.type="number",s.min=1,s.max=1e4,s.value=10,s.onchange=async()=>{this._sampleCount=+s.value,await this._readyData(),this._manager.platform.init()},n.append("Sample number",s);const i=document.createElement("div");a.appendChild(i);const r=document.createElement("a");r.href="https://github.com/tensorflow/tfjs",r.setAttribute("ref","noreferrer noopener"),r.target="_blank",r.innerText="TensorFlow.js",i.append("The data is from the ",r),this._manager.requiredRenderers([MNISTRenderer]),this._readyData().then((()=>{this._manager.onReady((()=>{this._manager.platform.init()}))}))}get availTask(){return["CF","SC","AD","DR","FS"]}get domain(){const e=[];for(let t=0;t<this._imageSize[0]*this._imageSize[1];t++)e.push([0,255]);return e}get columnNames(){return this._cols||[]}_sample(e){const t=e.map(((e,t)=>[e.y,t])),a=[],n=[];for(let s=0;s<=9;s++){const i=t.filter((e=>e[0]===s)),r=Math.min(i.length,this._sampleCount),o=Array.from({length:r},((e,t)=>t));for(let e=o.length-1;e>0;e--){const t=Math.floor(Math.random()*(e+1));[o[e],o[t]]=[o[t],o[e]]}for(let t=0;t<r;t++){const s=i[o[t]][1];a.push(e[s].x),n.push(e[s].y)}}return[a,n]}async _readyData(){this._cols=[];for(let e=0,t=0;e<28;e++)for(let a=0;a<28;a++,t++)this._cols.push(`${e},${a}`);const e=new MNISTDB,t=await e.get();if(t.length>0)[this._x,this._y]=this._sample(t);else if(!lock)return lock=!0,new Promise(((t,a)=>{const n=new Image;n.crossOrigin="Anonymous",n.addEventListener("load",(async()=>{const a=n.height,s=n.width,i=document.createElement("canvas");i.width=s,i.height=a;const r=i.getContext("2d");r.drawImage(n,0,0);const o=r.getImageData(0,0,s,a),l=await fetch(mnistLinks.trainLabels),d=new Int8Array(await l.arrayBuffer()),c=[];for(let e=0;e<a;e++){const t=[];for(let a=0;a<4*s;a+=4)t.push(o.data[e*s*4+a]);const a=d.slice(10*e,10*(e+1));c[e]={x:t,y:a.indexOf(1)}}e.save(c),[this._x,this._y]=this._sample(c),lock=!1,t()}),!1),n.addEventListener("error",a),n.src=mnistLinks.trainImages}))}terminate(){super.terminate(),this._manager.requiredRenderers()}}class MNISTRenderer extends BaseRenderer{constructor(e){super(e),this._offset=0,this._pagesize=100,this._colsize=5,this._predict=null;const t=this.setting.render.addItem("mnist"),a=document.createElement("div");a.style.display="flex",a.style.justifyContent="space-between",a.style.position="sticky",a.style.top="0";const n=document.createElement("div");n.style.backgroundColor="white",n.style.padding="5px",n.style.marginBottom="-1px",n.style.borderBottom="1px solid black",a.append(n),this._navigator=document.createElement("span"),n.appendChild(this._navigator);const s=document.createElement("select");s.onchange=()=>{this._offset=0,this._pagesize=+s.value,this._renderPager()};for(const e of[10,50,100,500,1e3]){const t=document.createElement("option");t.value=e,t.innerText=e,s.append(t)}s.value=this._pagesize,n.appendChild(s);const i=document.createElement("button");i.innerHTML="&uarr;",i.onclick=()=>{window.scroll({top:0,behavior:"smooth"})},i.title="To top",i.style.margin="5px",i.style.borderRadius="50%",a.appendChild(i),this._table=document.createElement("table"),this._table.style.border="1px solid black",this._table.style.borderCollapse="collapse",t.append(a,this._table),this._manager.setting.render.selectItem("mnist")}set trainResult(e){"CF"===this._manager.platform.task&&this.datas.outputCategoryNames?e=e.map((e=>this.datas.outputCategoryNames[e-1])):"AD"===this._manager.platform.task&&(e=e.map((e=>e?"anomalous":""))),this._predict?(this._predict=e,this._renderData()):(this._predict=e,this.render())}init(){this._predict=null}render(){this._table.replaceChildren(),this._navigator.replaceChildren(),this._offset=0;if(!this.datas)return;const e=document.createElement("thead"),t=document.createElement("tr");e.appendChild(t);const a=["image","target"];this._predict&&a.push("predict");for(let e=0;e<this._colsize;e++)for(const e of a){const a=document.createElement("td");a.innerText=e,a.style.border="1px solid black",t.appendChild(a)}this._table.appendChild(e);const n=document.createElement("tbody");this._table.appendChild(n),this._renderPager()}_renderPager(){this._navigator.replaceChildren(),this._renderData();const e=this.datas;if(!e)return;const t=Math.ceil(e.length/this._pagesize),a=Math.floor(this._offset/this._pagesize)+1;if(a>1){const e=document.createElement("input");e.type="button",e.value="<",e.onclick=()=>{this._offset=Math.max(0,this._offset-this._pagesize),this._renderPager()},this._navigator.appendChild(e)}const n=document.createElement("input");n.type="button",n.value="1",n.onclick=()=>{this._offset=0,this._renderPager()},1===a&&(n.disabled=!0),this._navigator.appendChild(n),a>3&&this._navigator.append(" ... ");for(let e=Math.max(2,a-1);e<=Math.min(t-1,a+1);e++){const t=document.createElement("input");t.type="button",t.value=e,t.onclick=()=>{this._offset=this._pagesize*(e-1),this._renderPager()},e===a&&(t.disabled=!0),this._navigator.appendChild(t)}if(a<t-2&&this._navigator.append(" ... "),t>1){const e=document.createElement("input");e.type="button",e.value=t,e.onclick=()=>{this._offset=this._pagesize*(t-1),this._renderPager()},a===t&&(e.disabled=!0),this._navigator.appendChild(e)}if(a<t){const t=document.createElement("input");t.type="button",t.value=">",t.onclick=()=>{this._offset=Math.min(e.length-1,this._offset+this._pagesize),this._renderPager()},this._navigator.appendChild(t)}this._navigator.append(` (${this._offset+1} - ${Math.min(this._offset+this._pagesize,e.length)} / ${e.length}) `)}_renderData(){const e=this._table.querySelector("tbody");e.replaceChildren();const t=this.datas;if(!t)return;const a=t.originalX,n="RG"===this._manager.platform.task?t.y:t.originalY,s=Math.min(t.length,this._offset+this._pagesize);for(let t=this._offset;t<s;){const i=document.createElement("tr");for(let e=0;e<this._colsize&&t<s;e++,t++){const e=document.createElement("canvas");e.height=28,e.width=28;const s=e.getContext("2d"),r=s.getImageData(0,0,28,28);for(let e=0;e<a[t].length;e++)r.data[4*e]=a[t][e],r.data[4*e+1]=a[t][e],r.data[4*e+2]=a[t][e],r.data[4*e+3]=255;s.putImageData(r,0,0);const o=document.createElement("td");o.appendChild(e),o.style.border="1px solid black",o.style.textAlign="center",i.appendChild(o);const l=[n[t]];this._predict&&l.push(this._predict[t]);for(const e of l){const t=document.createElement("td");t.innerText=e,t.style.border="1px solid black",i.appendChild(t)}}e.appendChild(i)}}terminate(){this.setting.render.removeItem("mnist"),super.terminate()}}const DB_NAME="mnist",TABLE_NAME="data";class MNISTDB{constructor(){this.db=null}async _ready(){if(this.db)return;const e=indexedDB.open("mnist",1);return new Promise(((t,a)=>{e.onerror=a,e.onsuccess=()=>{this.db=e.result,t()},e.onupgradeneeded=e=>{e.target.result.createObjectStore("data",{autoIncrement:!0})}}))}async save(e){return await this._ready(),new Promise(((t,a)=>{const n=this.db.transaction(["data"],"readwrite"),s=n.objectStore("data");for(const t of e)s.add(t);n.oncomplete=t,n.onerror=a}))}async get(){return await this._ready(),new Promise(((e,t)=>{const a=this.db.transaction("data").objectStore("data").getAll();a.onsuccess=t=>{e(t.target.result)},a.onerror=t}))}async deleteDatabase(){return new Promise(((e,t)=>{this.db.close();const a=indexedDB.deleteDatabase("mnist");a.onerror=t,a.onsuccess=()=>{this.db=null,e()}}))}}