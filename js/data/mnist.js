import{FixData}from"./base.js";import BaseRenderer from"../renderer/base.js";import BaseDB from"./db/base.js";const mnistLinks={trainImages:"https://storage.googleapis.com/learnjs-data/model-builder/mnist_images.png",trainLabels:"https://storage.googleapis.com/learnjs-data/model-builder/mnist_labels_uint8"};let lock=!1;export default class MNISTData extends FixData{constructor(e){super(e),this._sampleCount=10,this._imageSize=[28,28];const t=this.setting.data.configElement,a=document.createElement("div");a.style.display="flex",a.style.justifyContent="space-between",t.appendChild(a);const s=document.createElement("span");a.appendChild(s);const n=document.createElement("input");n.type="number",n.min=1,n.max=1e4,n.value=10,n.onchange=async()=>{this._sampleCount=+n.value,await this._readyData(),this._manager.platform.init()},s.append("Sample number",n);const i=document.createElement("div");a.appendChild(i);const r=document.createElement("a");r.href="https://github.com/tensorflow/tfjs",r.setAttribute("ref","noreferrer noopener"),r.target="_blank",r.innerText="TensorFlow.js",i.append("The data is from the ",r),this._manager.requiredRenderers([MNISTRenderer]),this._readyData().then((()=>{this._manager.onReady((()=>{this._manager.platform.init()}))}))}get availTask(){return["CF","SC","AD","DR","FS"]}get domain(){const e=[];for(let t=0;t<this._imageSize[0]*this._imageSize[1];t++)e.push([0,255]);return e}get columnNames(){return this._cols||[]}_sample(e){const t=e.map(((e,t)=>[e.y,t])),a=[],s=[];for(let n=0;n<=9;n++){const i=t.filter((e=>e[0]===n)),r=Math.min(i.length,this._sampleCount),o=Array.from({length:r},((e,t)=>t));for(let e=o.length-1;e>0;e--){const t=Math.floor(Math.random()*(e+1));[o[e],o[t]]=[o[t],o[e]]}for(let t=0;t<r;t++){const n=i[o[t]][1];a.push(e[n].x),s.push(e[n].y)}}return[a,s]}async _readyData(){this._cols=[];for(let e=0,t=0;e<28;e++)for(let a=0;a<28;a++,t++)this._cols.push(`${e},${a}`);const e=new MNISTDB,t=await e.list(TABLE_NAME);if(t.length>0)[this._x,this._y]=this._sample(t);else if(!lock)return lock=!0,new Promise(((t,a)=>{const s=new Image;s.crossOrigin="Anonymous",s.addEventListener("load",(async()=>{const a=s.height,n=s.width,i=document.createElement("canvas");i.width=n,i.height=a;const r=i.getContext("2d");r.drawImage(s,0,0);const o=r.getImageData(0,0,n,a),l=await fetch(mnistLinks.trainLabels),d=new Int8Array(await l.arrayBuffer()),c=[];for(let e=0;e<a;e++){const t=[];for(let a=0;a<4*n;a+=4)t.push(o.data[e*n*4+a]);const a=d.slice(10*e,10*(e+1));c[e]={x:t,y:a.indexOf(1)}}e.save(TABLE_NAME,c),[this._x,this._y]=this._sample(c),lock=!1,t()}),!1),s.addEventListener("error",a),s.src=mnistLinks.trainImages}))}terminate(){super.terminate(),this._manager.requiredRenderers()}}class MNISTRenderer extends BaseRenderer{constructor(e){super(e),this._offset=0,this._pagesize=100,this._colsize=5,this._predict=null;const t=this.setting.render.addItem("mnist"),a=document.createElement("div");a.style.display="flex",a.style.justifyContent="space-between",a.style.position="sticky",a.style.top="0";const s=document.createElement("div");s.style.backgroundColor="white",s.style.padding="5px",s.style.marginBottom="-1px",s.style.borderBottom="1px solid black",a.append(s),this._navigator=document.createElement("span"),s.appendChild(this._navigator);const n=document.createElement("select");n.onchange=()=>{this._offset=0,this._pagesize=+n.value,this._renderPager()};for(const e of[10,50,100,500,1e3]){const t=document.createElement("option");t.value=e,t.innerText=e,n.append(t)}n.value=this._pagesize,s.appendChild(n);const i=document.createElement("button");i.innerHTML="&uarr;",i.onclick=()=>{window.scroll({top:0,behavior:"smooth"})},i.title="To top",i.style.margin="5px",i.style.borderRadius="50%",a.appendChild(i),this._table=document.createElement("table"),this._table.style.border="1px solid black",this._table.style.borderCollapse="collapse",t.append(a,this._table),this._manager.setting.render.selectItem("mnist")}set trainResult(e){"CF"===this._manager.platform.task&&this.datas.outputCategoryNames?e=e.map((e=>this.datas.outputCategoryNames[e-1])):"AD"===this._manager.platform.task&&(e=e.map((e=>e?"anomalous":""))),this._predict?(this._predict=e,this._renderData()):(this._predict=e,this.render())}init(){this._predict=null}render(){this._table.replaceChildren(),this._navigator.replaceChildren(),this._offset=0;if(!this.datas)return;const e=document.createElement("thead"),t=document.createElement("tr");e.appendChild(t);const a=["image","target"];this._predict&&a.push("predict");for(let e=0;e<this._colsize;e++)for(const e of a){const a=document.createElement("td");a.innerText=e,a.style.border="1px solid black",t.appendChild(a)}this._table.appendChild(e);const s=document.createElement("tbody");this._table.appendChild(s),this._renderPager()}_renderPager(){this._navigator.replaceChildren(),this._renderData();const e=this.datas;if(!e)return;const t=Math.ceil(e.length/this._pagesize),a=Math.floor(this._offset/this._pagesize)+1;if(a>1){const e=document.createElement("input");e.type="button",e.value="<",e.onclick=()=>{this._offset=Math.max(0,this._offset-this._pagesize),this._renderPager()},this._navigator.appendChild(e)}const s=document.createElement("input");s.type="button",s.value="1",s.onclick=()=>{this._offset=0,this._renderPager()},1===a&&(s.disabled=!0),this._navigator.appendChild(s),a>3&&this._navigator.append(" ... ");for(let e=Math.max(2,a-1);e<=Math.min(t-1,a+1);e++){const t=document.createElement("input");t.type="button",t.value=e,t.onclick=()=>{this._offset=this._pagesize*(e-1),this._renderPager()},e===a&&(t.disabled=!0),this._navigator.appendChild(t)}if(a<t-2&&this._navigator.append(" ... "),t>1){const e=document.createElement("input");e.type="button",e.value=t,e.onclick=()=>{this._offset=this._pagesize*(t-1),this._renderPager()},a===t&&(e.disabled=!0),this._navigator.appendChild(e)}if(a<t){const t=document.createElement("input");t.type="button",t.value=">",t.onclick=()=>{this._offset=Math.min(e.length-1,this._offset+this._pagesize),this._renderPager()},this._navigator.appendChild(t)}this._navigator.append(` (${this._offset+1} - ${Math.min(this._offset+this._pagesize,e.length)} / ${e.length}) `)}_renderData(){const e=this._table.querySelector("tbody");e.replaceChildren();const t=this.datas;if(!t)return;const a=t.originalX,s="RG"===this._manager.platform.task?t.y:t.originalY,n=Math.min(t.length,this._offset+this._pagesize);for(let t=this._offset;t<n;){const i=document.createElement("tr");for(let e=0;e<this._colsize&&t<n;e++,t++){const e=document.createElement("canvas");e.height=28,e.width=28;const n=e.getContext("2d"),r=n.getImageData(0,0,28,28);for(let e=0;e<a[t].length;e++)r.data[4*e]=a[t][e],r.data[4*e+1]=a[t][e],r.data[4*e+2]=a[t][e],r.data[4*e+3]=255;n.putImageData(r,0,0);const o=document.createElement("td");o.appendChild(e),o.style.border="1px solid black",o.style.textAlign="center",i.appendChild(o);const l=[s[t]];this._predict&&l.push(this._predict[t]);for(const e of l){const t=document.createElement("td");t.innerText=e,t.style.border="1px solid black",i.appendChild(t)}}e.appendChild(i)}}terminate(){this.setting.render.removeItem("mnist"),super.terminate()}}const DB_NAME="mnist",TABLE_NAME="data";class MNISTDB extends BaseDB{constructor(){super("mnist",1)}onupgradeneeded(e){e.target.result.createObjectStore(TABLE_NAME,{autoIncrement:!0})}}