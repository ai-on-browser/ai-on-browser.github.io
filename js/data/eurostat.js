var y=Object.defineProperty;var g=(p,t)=>y(p,"name",{value:t,configurable:!0});import x from"./db/base.js";import{FixData as b}from"./base.js";import D from"./util/ioselector.js";const E="https://ec.europa.eu/eurostat/api/dissemination",w=1e3*60*60*24*30,_={"Population and employment":{datasetCode:"nama_10_pe",query:{},filter:{geo:["FR"],unit:["THS_PER"]}},"Agricultural labour input statistics":{datasetCode:"aact_ali01",query:{},filter:{geo:["FR"]}},"GDP and main components":{datasetCode:"namq_10_gdp",query:{unit:"CLV_PCH_PRE",s_adj:"SCA"},filter:{na_item:["B1GQ"],geo:["DE","ES","FR","IT"]}}},f={};export default class k extends b{static{g(this,"EurostatData")}constructor(t){super(t),this._name="Population and employment",this._filterItems=null,this._lastRequested=0;const d=this.setting.data.configElement,n=document.createElement("div");n.style.display="flex",n.style.justifyContent="space-between",d.appendChild(n);const i=document.createElement("span");n.appendChild(i);const c=document.createElement("select");c.name="name",c.onchange=()=>{this._filterItems=null,this._name=c.value,this._readyData(),this.setting.pushHistory()};for(const h of Object.keys(_)){const e=document.createElement("option");e.value=h,e.innerText=_[h].caption||h,c.appendChild(e)}c.value=this._name,i.append("Name",c);const r=document.createElement("a");n.appendChild(r),r.href="https://ec.europa.eu/eurostat",r.setAttribute("ref","noreferrer noopener"),r.target="_blank",r.innerText="Eurostat",this._filter=document.createElement("div"),this._filter.classList.add("sub-menu"),d.appendChild(this._filter);const o=document.createElement("span");o.innerText="This service uses the API feature of Eurostat. In addition, the data is processed.",o.style.fontSize="80%",d.appendChild(o),this._selector=new D(d),this._selector.onchange=()=>{this._domain=null,this._manager.onReady(()=>{this._manager.platform.init()})},this._loader=document.createElement("div"),d.appendChild(this._loader),this._readyData()}get availTask(){return["RG","AD","SM","TP","CP"]}get _requireDateInput(){return this._selector.object.length===0&&this._datetime&&["","RG","AD"].includes(this._manager.task)}get columnNames(){return this._requireDateInput?["date"]:this._selector.objectNames}get originalX(){return this._requireDateInput?this._datetime.map(t=>[t]):this._x.map(t=>this._selector.object.map(d=>t[d]))}get x(){return this.originalX}get originalY(){return this._selector.target>=0?this._x.map(t=>t[this._selector.target]):Array(this._x.length).fill(0)}get y(){return this.originalY}get params(){return{dataname:this._name}}set params(t){if(t.dataname&&Object.keys(_).includes(t.dataname)){const d=this.setting.data.configElement;this._name=t.dataname,d.querySelector("[name=name]").value=t.dataname,this._readyData()}}async _getData(t,d){const n={format:"JSON",lang:"EN",...d},i=t+"?"+new URLSearchParams(n).toString(),c=new I,r=await c.get("data",i);if(!r||(r.error?.length??0)>0||new Date-r.fetchDate>w){if(f[t])return new Promise(l=>{f[t]?f[t].push(l):l(c.get("data",i))});for(;new Date-this._lastRequested<2e3;)await new Promise(l=>setTimeout(l,500));this._lastRequested=new Date;const o=`${E}/statistics/1.0/data/${i}`;console.debug(`Fetch to ${o}`),f[t]=[];const e=await(await fetch(o)).json();(e.error?.length??0)>0&&console.error(e.error),e.fetchDate=new Date,e.params=i,await c.save("data",e);for(const l of f[t])l(e);return f[t]=void 0,e}return r}async _readyData(){this._x=[],this._index=null,this._datetime=null,this._manager.platform?.init();const t=_[this._name],d=t.datasetCode;this._loader.classList.add("loader");const n=this._name,i=await this._getData(d,t.query);if(this._loader.classList.remove("loader"),this._name!==n)return;this._filterItems||this._readyFilter(i,t.filter);const c={};for(let e=0;e<i.id.length;e++){c[i.id[e]]=[];const l=i.dimension[i.id[e]].category;for(const s of Object.keys(l.index))c[i.id[e]][l.index[s]]={key:s,label:l.label[s]}}const r=[];this._index=[],this._x=[];const o=Array(i.id.length).fill(0);do{let e=0,l=null,s="",m=!1;for(let a=0;a<o.length;a++){const u=this._filterItems[i.id[a]]??[];if(u.length>0&&!u.includes(c[i.id[a]][o[a]].key)){m=!0;break}e=e*i.size[a]+o[a],i.id[a]==="time"?l=c[i.id[a]][o[a]].label:i.size[a]>1&&u.length!==1&&(s+=(s.length>0?" / ":"")+c[i.id[a]][o[a]].label)}if(!m){r.includes(s)||r.push(s);const a=r.indexOf(s);this._index.includes(l)||this._index.push(l);const u=this._index.indexOf(l);this._x[u]||(this._x[u]=[]),this._x[u][a]=i.value[e]}for(let a=0;a<o.length&&(o[a]++,!(o[a]<i.size[a]));a++)o[a]=0}while(o.some(e=>e>0));for(let e=this._x.length-1;e>=0;e--)this._x[e].some(l=>l===void 0)&&(this._x.splice(e,1),this._index.splice(e,1));this._selector.columns=r;const h=[];for(let e=0;e<r.length-1;e++)h.push(e);this._selector.object=h,this._selector.target=r.length-1,this._datetime=this._index.map(e=>e.match(/^[0-9]{4}-Q[1-4]$/)?+e.slice(0,4)*4+ +e.slice(6,7):+e),this._domain=null,this.setting.ml.refresh(),this.setting.$forceUpdate()}_readyFilter(t,d={}){this._filterItems={},this._filter.replaceChildren(),t.id.length>0&&this._filter.append("Dimensions");for(let n=0;n<t.id.length;n++){if(t.id[n]==="time"||t.size[n]===1)continue;this._filterItems[t.id[n]]=[];const i=t.dimension[t.id[n]],c=this._filter.appendChild(document.createElement("details")),r=c.appendChild(document.createElement("summary"));r.innerText=i.label,r.style.fontSize="80%";const o=document.createTextNode(`${d[t.id[n]]?.length||t.size[n]}`);r.append(i.label+" (",o,` / ${t.size[n]})`);const h=c.appendChild(document.createElement("select"));h.multiple=!0;const e=[],l=i.category;for(const s of Object.keys(l.index))e[l.index[s]]={key:s,label:l.label[s]};h.size=Math.min(4,e.length),e.length<=4&&(h.style.overflowY="hidden");for(let s=0;s<e.length;s++){const m=document.createElement("option");m.value=e[s].key,e[s].label.length>50?(m.title=e[s].label,m.innerText=e[s].label.slice(0,50)+"..."):m.innerText=e[s].label,d[t.id[n]]?.includes(e[s].key)&&(m.selected=!0,this._filterItems[t.id[n]].push(e[s].key)),h.append(m)}h.onchange=()=>{const s=this._filterItems[t.id[n]]=[];for(const m of h.selectedOptions)s.push(m.value);o.nodeValue=`${s.length||t.size[n]}`,this._readyData()}}}}const C="ec.europa.eu";class I extends x{static{g(this,"EurostatDB")}constructor(){super(C,1)}onupgradeneeded(t){t.target.result.createObjectStore("data",{keyPath:"params"})}}
