var S=Object.defineProperty;var p=(g,s)=>S(g,"name",{value:s,configurable:!0});import T from"./db/base.js";import{FixData as A}from"./base.js";import v from"./util/ioselector.js";const B="https://ec.europa.eu/eurostat/api/dissemination",$=1e3*60*60*24*30,w={},j={nama_10_pe:{query:{},filter:{geo:["FR"],unit:["THS_PER"]}},aact_ali01:{query:{},filter:{geo:["FR"]}},namq_10_gdp:{query:{unit:"CLV_PCH_PRE",s_adj:"SCA"},filter:{na_item:["B1GQ"],geo:["DE","ES","FR","IT"]}}},b={};export default class z extends A{static{p(this,"EurostatData")}constructor(s){super(s),this._code="nama_10_pe",this._filterItems=null,this._lastRequested=0,this._abortController=null;const r=this.setting.data.configElement,e=document.createElement("div");e.style.display="flex",e.style.justifyContent="space-between",r.appendChild(e);const t=document.createElement("span");e.appendChild(t);const a=document.createElement("select");a.name="theme",this._subthemeelm=document.createElement("div"),t.append("Theme",a,this._subthemeelm);const n=document.createElement("a");e.appendChild(n),n.href="https://ec.europa.eu/eurostat",n.setAttribute("ref","noreferrer noopener"),n.target="_blank",n.innerText="Eurostat";const h=document.createElement("div");this._loader=document.createElement("div"),this._loader.classList.add("loader"),this._loader.style.display="none",h.appendChild(this._loader),this._progressBar=document.createElement("div"),this._progressBar.style.width="100%",this._progressBar.style.fontSize="50%",this._progressBar.style.textAlign="center",this._progressBar.style.backgroundColor="white",this._progressBar.style.display="none",this._progressBar.style.marginTop="5px",h.appendChild(this._progressBar),this._errorMessage=document.createElement("div"),h.appendChild(this._errorMessage),r.appendChild(h),this._filter=document.createElement("div"),this._filter.classList.add("sub-menu"),r.appendChild(this._filter);const o=document.createElement("span");o.innerText="This service uses the API feature of Eurostat. In addition, the data is processed.",o.style.fontSize="80%",r.appendChild(o),this._selector=new v(r),this._selector.onchange=()=>{this._domain=null,this._manager.onReady(()=>{this._manager.platform.init()})},this._readyCatalogue()}get availTask(){return["RG","AD","SM","TP","CP"]}get _requireDateInput(){return this._selector.object.length===0&&this._datetime&&["","RG","AD"].includes(this._manager.task)}get columnNames(){return this._requireDateInput?["date"]:this._selector.objectNames}get originalX(){return this._requireDateInput?this._datetime.map(s=>[s]):this._x.map(s=>this._selector.object.map(r=>s[r]))}get x(){return this.originalX}get originalY(){return this._selector.target>=0?this._x.map(s=>s[this._selector.target]):Array(this._x.length).fill(0)}get y(){return this.originalY}get params(){return{datacode:this._code}}set params(s){s.datacode&&(this._code=s.datacode,this._catalogue&&this._makeSelections(w[this._code].slctIdx))}async _readyCatalogue(){if(!this._catalogue){const e=await fetch("/js/data/meta/catalogue.json.gz"),t=new DecompressionStream("gzip"),a=e.body.pipeThrough(t);this._catalogue=await new Response(a).json()}const s=p((e,t)=>{if(e.code&&(w[e.code]={code:e.code,title:e.title,slctIdx:t,query:{},filter:{geo:["FR"]},...j[e.code]}),e.children)for(let a=0;a<e.children.length;a++)s(e.children[a],[...t,a])},"getLeaf");s(this._catalogue,[]);const r=document.querySelector("[name=theme]");for(const e of this._catalogue.children){const t=document.createElement("option");t.value=t.innerText=e.title,r.appendChild(t)}r.onchange=()=>{this._makeSelections([r.selectedIndex])},this._code&&w[this._code]?this._makeSelections(w[this._code].slctIdx):this._makeSelections([r.selectedIndex])}_makeSelections(s){this._subthemeelm.replaceChildren();const r=document.querySelector("[name=theme]");r.selectedIndex=s[0];let e=this._catalogue.children[s[0]],t=1;for(;e.children;){const a=document.createElement("div");a.style.marginLeft=t*15+"px";const n=document.createElement("select");a.append("\u2514 ",n),this._subthemeelm.append(a);for(const h of e.children){const o=document.createElement("option");o.value=h.code??h.title,h.title.length<=100?o.innerText=h.title:o.innerText=h.title.slice(0,100)+"...",n.appendChild(o)}s[t]==null&&(s[t]=0),n.onchange=(h=>()=>{const o=s.slice(0,h);o.push(n.selectedIndex),this._makeSelections(o)})(t),n.selectedIndex=s[t],e=e.children[s[t]],t++}this._readyFilter(),this._code=e.code,this._readyData(),this.setting.pushHistory()}async _readyMetabase(){if(this._metabase)return;const s=await fetch("/js/data/meta/metabase.json.gz"),r=new DecompressionStream("gzip"),e=s.body.pipeThrough(r),t=await new Response(e).json();this._metabase=t}async _getData(s,r){const e={format:"JSON",lang:"EN",...r},t=s+"?"+new URLSearchParams(e).toString();this._errorMessage.innerText="";const a=new M,n=await a.get("data",t);if(!n||(n.error?.length??0)>0||new Date-n.fetchDate>$){if(b[t])return new Promise(m=>{b[t]?b[t].push(m):m(a.get("data",t))});const h=this._abortController=new AbortController;for(;new Date-this._lastRequested<2e3;)await new Promise(m=>setTimeout(m,500));await this._readyMetabase(),this._lastRequested=new Date;const o=`${B}/statistics/1.0/data/${t}`;console.debug(`Fetch to ${o}`),b[t]=[];const u=Object.values(this._metabase[s]).reduce((m,d)=>m*d.length,1),i=[],l=p(m=>`${Math.floor(m)}`.padStart(2,"0"),"pad0");this._progressBar.innerText="0 / 0",this._progressBar.style.display="block",this._progressBar.style.background="white",this._loader.style.display="none";let c;try{c=await q(o,{signal:h.signal,onprogress:p(({loaded:m})=>{if(!h.signal.aborted&&Date.now()-(i.at(-1)?.t??0)>100){i.push({c:m,t:Date.now()});const d=100*i[i.length-1].c/u,f=Math.max(1,i.length-100),C=(i[i.length-1].t-i[f-1].t)/(i[i.length-1].c-i[f-1].c),_=isNaN(C)?0:C/1e3*(u-m),y=_>=3600?`${Math.floor(_/3600)}:${l(Math.floor(_)%3600/60)}:${l(Math.floor(_)%60)}`:`${Math.floor(_/60)}:${l(Math.floor(_)%60)}`;this._progressBar.innerText=`${m} / ${u} (${y})`,this._progressBar.style.background=`linear-gradient(90deg, lightgray, ${d}%, gray, ${d}%, white)`}},"onprogress")})}catch(m){console.warn(m)}h.signal.aborted||!c?c=null:((c.error?.length??0)>0&&(this._errorMessage.innerText=c.error[0].label,console.error(c.error)),c.fetchDate=new Date,c.params=t,await a.save("data",c)),this._abortController===h&&(this._abortController=null);for(const m of b[t])m(c);return b[t]=void 0,c}return n}async _readyData(){this._x=[],this._index=null,this._datetime=null,this._selector.clear(),this._manager.platform?.init(),this._abortController?.abort(),this._abortController=null;const s=w[this._code];this._loader.style.display="block";const r=this._code,e=await this._getData(this._code,s.query);if(this._loader.style.display="none",this._code===r&&(this._progressBar.style.display="none"),this._code!==r||!e||(e.error?.length??0)>0)return;this._filterItems||this._readyFilter(e,s.filter);const t={};for(let i=0;i<e.id.length;i++){t[e.id[i]]=[];const l=e.dimension[e.id[i]].category;for(const c of Object.keys(l.index))t[e.id[i]][l.index[c]]={key:c,label:l.label[c]}}const a=[];this._index=[],this._x=[];const n={},h={},o=Array(e.id.length).fill(0);do{let i=0,l=null,c="",m=!1;for(let d=0;d<o.length;d++){const f=this._filterItems[e.id[d]]??[];if(f.length>0&&!f.includes(t[e.id[d]][o[d]].key)){m=!0;break}i=i*e.size[d]+o[d],e.id[d]==="time"?l=t[e.id[d]][o[d]].label:e.size[d]>1&&f.length!==1&&(c+=(c.length>0?" / ":"")+t[e.id[d]][o[d]].label)}if(!m){n[c]==null&&(a.push(c),n[c]=a.length-1);const d=n[c];h[l]==null&&(this._index.push(l),h[l]=this._index.length-1);const f=h[l];this._x[f]||(this._x[f]=[]),this._x[f][d]=e.value[i]}for(let d=0;d<o.length&&(o[d]++,!(o[d]<e.size[d]));d++)o[d]=0}while(o.some(i=>i>0));for(let i=this._x.length-1;i>=0;i--)this._x[i].some(l=>l===void 0)&&(this._x.splice(i,1),this._index.splice(i,1));this._selector.columns=a;const u=[];for(let i=0;i<a.length-1;i++)u.push(i);this._selector.object=u,this._selector.target=a.length-1,this._datetime=this._index.map(i=>i.match(/^[0-9]{4}-Q[1-4]$/)?+i.slice(0,4)*4+ +i.slice(6,7):+i),this._domain=null,this.setting.ml.refresh(),this.setting.$forceUpdate()}_readyFilter(s,r={}){if(this._filter.replaceChildren(),!s){this._filterItems=null;return}this._filterItems={},s.id.length>0&&this._filter.append("Dimensions");for(let e=0;e<s.id.length;e++){if(s.id[e]==="time"||s.size[e]===1)continue;this._filterItems[s.id[e]]=[];const t=s.dimension[s.id[e]],a=this._filter.appendChild(document.createElement("details")),n=a.appendChild(document.createElement("summary"));n.style.fontSize="80%";const h=document.createTextNode(`${r[s.id[e]]?.length||s.size[e]}`);n.append(t.label+" (",h,` / ${s.size[e]})`);const o=a.appendChild(document.createElement("select"));o.multiple=!0;const u=[],i=t.category;for(const l of Object.keys(i.index))u[i.index[l]]={key:l,label:i.label[l]};o.size=Math.min(4,u.length),u.length<=4&&(o.style.overflowY="hidden");for(let l=0;l<u.length;l++){const c=document.createElement("option");c.value=u[l].key,u[l].label.length>50?(c.title=u[l].label,c.innerText=u[l].label.slice(0,50)+"..."):c.innerText=u[l].label,r[s.id[e]]?.includes(u[l].key)&&(c.selected=!0,this._filterItems[s.id[e]].push(u[l].key)),o.append(c)}o.onchange=()=>{const l=this._filterItems[s.id[e]]=[];for(const c of o.selectedOptions)l.push(c.value);h.nodeValue=`${l.length||s.size[e]}`,this._readyData()}}}terminate(){super.terminate(),this._abortController?.abort()}}const I="ec.europa.eu";class M extends T{static{p(this,"EurostatDB")}constructor(){super(I,1)}onupgradeneeded(s){s.target.result.createObjectStore("data",{keyPath:"params"})}}const q=p(async(g,s)=>{const r=await fetch(g,s);let e=0,t=0;const a=new P;return a.onprogress=n=>{n.size&&(t=n.size.reduce((o,u)=>o*u,1));const h=e;n.value&&(e=Object.keys(n.value).length),h!==e&&s?.onprogress({loaded:e,total:t})},a.parse(r.body.pipeThrough(new TextDecoderStream,{}))},"fetchProgress"),R=/^[-+]?[0-9]+(\.[0-9]+)?$/;class P{static{p(this,"JSONStreamParser")}constructor(){this.onprogress=null}async parse(s){return await this.construct(this.tokenize(s)),this.obj._root}async*tokenize(s){let r=!1,e=!1,t="",a=0,n=Date.now();const h=34,o=92,u=32,i=13,l=10,c=123,m=125,d=91,f=93,C=58,_=44;for await(const y of s)for(let x=0;x<y.length;x++){const E=y[x],k=y.charCodeAt(x);if(r)!e&&k===h&&(r=!1),t+=E,e?e=!1:k===o&&(e=!0);else switch(k){case u:case i:case l:t&&(yield t,t="");break;case c:case m:case d:case f:case C:case _:t&&(yield t,t=""),yield E;break;case h:r=!0,t+=E;break;default:t+=E;break}(++a%1024===0||Date.now()-n>100)&&(await new Promise(D=>setTimeout(D,0)),a=0,n=Date.now())}t&&(yield t)}async construct(s){this.obj={_root:void 0},await this._construct(this.obj,"_root",s)}async _construct(s,r,e){const{value:t,done:a}=await e.next();if(!a&&t){if(t==="null")s[r]=null;else if(t==="true")s[r]=!0;else if(t==="false")s[r]=!1;else if(t.startsWith('"'))s[r]=t.slice(1,t.length-1);else if(R.test(t))s[r]=+t;else if(t==="["){s[r]=[];let n=0;for(;!await this._construct(s[r],n,e);){const{value:o,done:u}=await e.next();if(u||o==="]")break;n++}}else{if(t==="]")return!0;if(t==="{")for(s[r]={};;){let{value:n,done1:h}=await e.next();if(h||n==="}")break;n?.startsWith('"')&&(n=n.slice(1,n.length-1)),await e.next(),await this._construct(s[r],n,e);const{value:o,done2:u}=await e.next();if(u||o==="}")break}else throw new Error("Invalid token "+t)}this.onprogress?.(this.obj._root)}}}
