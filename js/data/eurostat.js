var x=Object.defineProperty;var g=(p,e)=>x(p,"name",{value:e,configurable:!0});import y from"./db/base.js";import{FixData as b}from"./base.js";import D from"./util/ioselector.js";const E="https://ec.europa.eu/eurostat/api/dissemination",k=1e3*60*60*24*30,f={"Population and employment":{datasetCode:"nama_10_pe",query:{},filter:{geo:["FR"],unit:["THS_PER"]}},"Agricultural labour input statistics":{datasetCode:"aact_ali01",query:{},filter:{geo:["FR"]}},"GDP and main components":{datasetCode:"namq_10_gdp",query:{unit:"CLV_PCH_PRE",s_adj:"SCA"},filter:{na_item:["B1GQ"],geo:["DE","ES","FR","IT"]}}},_={};export default class w extends b{static{g(this,"EurostatData")}constructor(e){super(e),this._name="Population and employment",this._shift=[],this._scale=[],this._scaled=!0,this._filterItems=null,this._lastRequested=0;const r=this.setting.data.configElement,l=document.createElement("div");l.style.display="flex",l.style.justifyContent="space-between",r.appendChild(l);const s=document.createElement("span");l.appendChild(s);const i=document.createElement("select");i.name="name",i.onchange=()=>{this._filterItems=null,this._name=i.value,this._readyData(),this.setting.pushHistory()};for(const o of Object.keys(f)){const a=document.createElement("option");a.value=o,a.innerText=f[o].caption||o,i.appendChild(a)}i.value=this._name,s.append("Name",i);const n=document.createElement("a");l.appendChild(n),n.href="https://ec.europa.eu/eurostat",n.setAttribute("ref","noreferrer noopener"),n.target="_blank",n.innerText="Eurostat",this._filter=document.createElement("div"),this._filter.classList.add("sub-menu"),r.appendChild(this._filter);const h=document.createElement("span");h.innerText="This service uses the API feature of Eurostat. In addition, the data is processed.",h.style.fontSize="80%",r.appendChild(h),this._selector=new D(r),this._selector.onchange=()=>{this._domain=null,this._manager.onReady(()=>{this._manager.platform.init()})},this._loader=document.createElement("div"),r.appendChild(this._loader);const d=document.createElement("div"),t=document.createElement("input");t.type="checkbox",t.checked=!0,t.onchange=()=>{this._scaled=t.checked,this._readyData()},d.append("Scale",t),r.appendChild(d),this._readyData()}get availTask(){return["RG","AD","SM","TP","CP"]}get _requireDateInput(){return this._selector.object.length===0&&this._datetime&&["","RG","AD"].includes(this._manager.task)}get columnNames(){return this._requireDateInput?["date"]:this._selector.objectNames}get originalX(){return this._requireDateInput?this._datetime.map(e=>[e]):this._x.map(e=>this._selector.object.map(r=>e[r]))}get x(){return this._scaled?this._requireDateInput?this._datetime.map(e=>[e]):(this._readyScaledData(),this._x.map(e=>{const r=e.map((l,s)=>(l-this._shift[s])/this._scale[s]);return this._selector.object.map(l=>r[l])})):this.originalX}get originalY(){return this._selector.target>=0?this._x.map(e=>e[this._selector.target]):Array(this._x.length).fill(0)}get y(){if(!this._scaled)return this.originalY;this._readyScaledData();const e=this._selector.target;return e>=0?this._x.map(r=>(r[e]-this._shift[e])/this._scale[e]):Array(this._x.length).fill(0)}get params(){return{dataname:this._name}}set params(e){if(e.dataname&&Object.keys(f).includes(e.dataname)){const r=this.setting.data.configElement;this._name=e.dataname,r.querySelector("[name=name]").value=e.dataname,this._readyData()}}_readyScaledData(){if(!(this._scale.length>0)&&(this._shift=[],this._scale=[],this._x.length>0)){const e=Array(this._x[0].length).fill(1/0),r=Array(this._x[0].length).fill(-1/0);for(let i=0;i<this._x.length;i++)for(let n=0;n<this._x[i].length;n++)e[n]=Math.min(e[n],this._x[i][n]),r[n]=Math.max(r[n],this._x[i][n]);const l=10,s=0;for(let i=0;i<e.length;i++)e[i]===r[i]&&(r[i]=e[i]+1),this._scale[i]=(r[i]-e[i])/(l-s),this._shift[i]=e[i]-s*this._scale[i]}}async _getData(e,r){const l={format:"JSON",lang:"EN",...r},s=e+"?"+new URLSearchParams(l).toString(),i=new C,n=await i.get("data",s);if(!n||(n.error?.length??0)>0||new Date-n.fetchDate>k){if(_[e])return new Promise(o=>{_[e]?_[e].push(o):o(i.get("data",s))});for(;new Date-this._lastRequested<2e3;)await new Promise(o=>setTimeout(o,500));this._lastRequested=new Date;const h=`${E}/statistics/1.0/data/${s}`;console.debug(`Fetch to ${h}`),_[e]=[];const t=await(await fetch(h)).json();(t.error?.length??0)>0&&console.error(t.error),t.fetchDate=new Date,t.params=s,await i.save("data",t);for(const o of _[e])o(t);return _[e]=void 0,t}return n}async _readyData(){this._x=[],this._shift=[],this._scale=[],this._index=null,this._datetime=null,this._manager.platform?.init();const e=f[this._name],r=e.datasetCode;this._loader.classList.add("loader");const l=this._name,s=await this._getData(r,e.query);if(this._loader.classList.remove("loader"),this._name!==l)return;this._filterItems||this._readyFilter(s,e.filter);const i={};for(let t=0;t<s.id.length;t++){i[s.id[t]]=[];const o=s.dimension[s.id[t]].category;for(const a of Object.keys(o.index))i[s.id[t]][o.index[a]]={key:a,label:o.label[a]}}const n=[];this._index=[],this._x=[];const h=Array(s.id.length).fill(0);do{let t=0,o=null,a="",m=!1;for(let c=0;c<h.length;c++){const u=this._filterItems[s.id[c]]??[];if(u.length>0&&!u.includes(i[s.id[c]][h[c]].key)){m=!0;break}t=t*s.size[c]+h[c],s.id[c]==="time"?o=i[s.id[c]][h[c]].label:s.size[c]>1&&u.length!==1&&(a+=(a.length>0?" / ":"")+i[s.id[c]][h[c]].label)}if(!m){n.includes(a)||n.push(a);const c=n.indexOf(a);this._index.includes(o)||this._index.push(o);const u=this._index.indexOf(o);this._x[u]||(this._x[u]=[]),this._x[u][c]=s.value[t]}for(let c=0;c<h.length&&(h[c]++,!(h[c]<s.size[c]));c++)h[c]=0}while(h.some(t=>t>0));for(let t=this._x.length-1;t>=0;t--)this._x[t].some(o=>o===void 0)&&(this._x.splice(t,1),this._index.splice(t,1));this._selector.columns=n;const d=[];for(let t=0;t<n.length-1;t++)d.push(t);this._selector.object=d,this._selector.target=n.length-1,this._datetime=this._index.map(t=>t.match(/^[0-9]{4}-Q[1-4]$/)?+t.slice(0,4)*4+ +t.slice(6,7):+t),this._domain=null,this.setting.ml.refresh(),this.setting.$forceUpdate()}_readyFilter(e,r={}){this._filterItems={},this._filter.replaceChildren(),e.id.length>0&&this._filter.append("Dimensions");for(let l=0;l<e.id.length;l++){if(e.id[l]==="time"||e.size[l]===1)continue;this._filterItems[e.id[l]]=[];const s=e.dimension[e.id[l]],i=this._filter.appendChild(document.createElement("details")),n=i.appendChild(document.createElement("summary"));n.innerText=s.label,n.style.fontSize="80%";const h=document.createTextNode(`${r[e.id[l]]?.length||e.size[l]}`);n.append(s.label+" (",h,` / ${e.size[l]})`);const d=i.appendChild(document.createElement("select"));d.multiple=!0;const t=[],o=s.category;for(const a of Object.keys(o.index))t[o.index[a]]={key:a,label:o.label[a]};d.size=Math.min(4,t.length),t.length<=4&&(d.style.overflowY="hidden");for(let a=0;a<t.length;a++){const m=document.createElement("option");m.value=t[a].key,t[a].label.length>50?(m.title=t[a].label,m.innerText=t[a].label.slice(0,50)+"..."):m.innerText=t[a].label,r[e.id[l]]?.includes(t[a].key)&&(m.selected=!0,this._filterItems[e.id[l]].push(t[a].key)),d.append(m)}d.onchange=()=>{const a=this._filterItems[e.id[l]]=[];for(const m of d.selectedOptions)a.push(m.value);h.nodeValue=`${a.length||e.size[l]}`,this._readyData()}}}}const I="ec.europa.eu";class C extends y{static{g(this,"EurostatDB")}constructor(){super(I,1)}onupgradeneeded(e){e.target.result.createObjectStore("data",{keyPath:"params"})}}
