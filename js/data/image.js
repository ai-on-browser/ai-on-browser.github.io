import{BaseData}from"./base.js";import ImageRenderer from"../renderer/image.js";export default class ImageData extends BaseData{constructor(e){super(e),this._manager.platform._renderer.push(new ImageRenderer(e)),this._manager.setting.render.selectItem("image")}static get colorSpaces(){return{RGB:"rgb",COL8:"8 colors",GRAY:"gray",BINARY:"binary",HLS:"hls",HSV:"hsv"}}static get grayScales(){return{AVERAGE:{name:"average",calc:(e,t,a)=>(e+t+a)/3},AMMA_AVERAGE:{name:"Gamma correction average",calc:(e,t,a)=>(e+t+a)/3},CIEXYZ:{name:"CIE XYZ",calc:(e,t,a)=>.2126*e+.7152*t+.0722*a},BT601:{name:"ITU-R Rec BT.601",calc:(e,t,a)=>.299*e+.587*t+.114*a},BT601_ROUGH1:{name:"Second decimal place of BT.601",calc:(e,t,a)=>.3*e+.59*t+.11*a},BT601_ROUGH2:{name:"First decimal place of BT.601",calc:(e,t,a)=>.3*e+.6*t+.1*a},BT709:{name:"ITU-R Rec BT.709",calc:(e,t,a)=>.2126*e+.7152*t+.0722*a},YCgCo:{name:"Y of YCgCo",calc:(e,t,a)=>e/4+t/2+a/4},HSV:{name:"V of HSV",calc:(e,t,a)=>Math.max(e,t,a)},HLS:{name:"V of HSV",calc:(e,t,a)=>(Math.max(e,t,a)+Math.min(e,t,a))/2},G:{name:"Green",calc:(e,t,a)=>t},B:{name:"Blue",calc:(e,t,a)=>a}}}get availTask(){return["SG","DN","ED"]}async readImage(e){if(e instanceof Blob)return new Promise((t=>{const a=new FileReader;a.readAsDataURL(e),a.onload=()=>{const e=new Image;e.src=a.result,e.onload=()=>{const a=document.createElement("canvas");a.width=e.width,a.height=e.height;const n=a.getContext("2d");n.drawImage(e,0,0);const r=n.getImageData(0,0,a.width,a.height),c=[];for(let e=0,t=0;e<a.height;e++){c[e]=[];for(let n=0;n<a.width;n++,t+=4)c[e][n]=[r.data[t],r.data[t+1],r.data[t+2],r.data[t+3]]}t(c)}}}));if(e instanceof HTMLImageElement||e instanceof HTMLVideoElement){const e=document.createElement("canvas");e.width=this._video.videoWidth,e.height=this._video.videoHeight;const t=e.getContext("2d");t.drawImage(this._video,0,0,e.width,e.height);const a=t.getImageData(0,0,e.width,e.height),n=[];for(let t=0,r=0;t<e.height;t++){n[t]=[];for(let c=0;c<e.width;c++,r+=4)n[t][c]=Array.from(a.data.slice(r,r+4))}return n}}_reduce(e,t,a="mean"){const n=[],r=e[0][0].length;let c=null;"max"===a?c=Math.max:"mean"===a&&(c=(e,t)=>e+t);for(let o=0,l=0;o<e.length;o+=t,l++){n[l]=[];for(let i=0,h=0;i<e[o].length;i+=t,h++){const s=Array(r).fill(0);for(let a=0;a<t;a++)if(!(e.length<=o+a))for(let n=0;n<t;n++)if(!(e[o].length<=i+n))for(let t=0;t<r;t++)s[t]=c(s[t],e[o+a][i+n][t]);n[l][h]=s,"mean"===a&&(n[l][h]=s.map((e=>e/(t*t))))}}return n}_convertSpace(e,t,a=!1,n=180){const[r,c,o,l]=e;if("rgb"===t)return a?[r/255,c/255,o/255]:[r,c,o];if("8 colors"===t){const e=r>>7?255:0,t=c>>7?255:0,n=o>>7?255:0;return a?[e/255,t/255,n/255]:[e,t,n]}if("gray"===t){const e=ImageData.grayScales.BT709.calc(r,c,o);return a?[e/255]:[e]}if("binary"===t){let e=ImageData.grayScales.BT709.calc(r,c,o);return e=e<n?0:255,a?[e/255]:[e]}if("hls"===t){const e=Math.max(r,c,o),t=Math.min(r,c,o);let n=null;e!==t&&(t===o?n=60*(c-r)/(e-t)+60:t===r?n=60*(o-c)/(e-t)+180:t===c&&(n=60*(r-o)/(e-t)+300));const l=(e+t)/2,i=e-t;return a?[n/360,l/255,i/255]:[n,l,i]}if("hsv"===t){const e=Math.max(r,c,o),t=Math.min(r,c,o);let n=null;e!==t&&(t===o?n=60*(c-r)/(e-t)+60:t===r?n=60*(o-c)/(e-t)+180:t===c&&(n=60*(r-o)/(e-t)+300));const l=e-t;return a?[n/360,e/255,l/255]:[n,e,l]}}_applySpace(e,t,a=!1,n=180){const r=[];for(let c=0;c<e.length;c++){r[c]=[];for(let o=0;o<e[c].length;o++)r[c][o]=this._convertSpace(e[c][o],t,a,n)}return r}_createCanvas(e,t=80,a=null){const n=e[0].length,r=e.length;a||(a=Math.ceil(t*r/n));const c=document.createElement("canvas");c.width=n,c.height=r;const o=c.getContext("2d"),l=o.createImageData(c.width,c.height);for(let t=0,a=0;t<c.height;t++)for(let n=0;n<c.width;n++,a+=4)l.data[a]=e[t][n][0],1===e[t][n].length?(l.data[a+1]=e[t][n][0],l.data[a+2]=e[t][n][0],l.data[a+3]=255):e[t][n].length>=3&&(l.data[a+1]=e[t][n][1],l.data[a+2]=e[t][n][2],l.data[a+3]=e[t][n][3]||255);o.putImageData(l,0,0);const i=document.createElement("canvas");i.width=t,i.height=a;return i.getContext("2d").drawImage(c,0,0,c.width,c.height,0,0,t,a),i}}