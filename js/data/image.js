var w=Object.defineProperty;var u=(v,e)=>w(v,"name",{value:e,configurable:!0});import{BaseData as x}from"./base.js";import B from"../renderer/image.js";export default class d extends x{static{u(this,"ImageData")}constructor(e){super(e),this._manager.platform._renderer.push(new B(e)),this._manager.setting.render.selectItem("image")}static get colorSpaces(){return{RGB:"rgb",COL8:"8 colors",GRAY:"gray",BINARY:"binary",HLS:"hls",HSV:"hsv"}}static get grayScales(){return{AVERAGE:{name:"average",calc:(e,t,n)=>(e+t+n)/3},AMMA_AVERAGE:{name:"Gamma correction average",calc:(e,t,n)=>(e+t+n)/3},CIEXYZ:{name:"CIE XYZ",calc:(e,t,n)=>.2126*e+.7152*t+.0722*n},BT601:{name:"ITU-R Rec BT.601",calc:(e,t,n)=>.299*e+.587*t+.114*n},BT601_ROUGH1:{name:"Second decimal place of BT.601",calc:(e,t,n)=>.3*e+.59*t+.11*n},BT601_ROUGH2:{name:"First decimal place of BT.601",calc:(e,t,n)=>.3*e+.6*t+.1*n},BT709:{name:"ITU-R Rec BT.709",calc:(e,t,n)=>.2126*e+.7152*t+.0722*n},YCgCo:{name:"Y of YCgCo",calc:(e,t,n)=>e/4+t/2+n/4},HSV:{name:"V of HSV",calc:(e,t,n)=>Math.max(e,t,n)},HLS:{name:"V of HSV",calc:(e,t,n)=>(Math.max(e,t,n)+Math.min(e,t,n))/2},G:{name:"Green",calc:(e,t,n)=>t},B:{name:"Blue",calc:(e,t,n)=>n}}}get availTask(){return["SG","DN","ED"]}async readImage(e){if(e instanceof Blob)return new Promise(t=>{const n=new FileReader;n.readAsDataURL(e),n.onload=()=>{const f=new Image;f.src=n.result,f.onload=()=>{const l=document.createElement("canvas");l.width=f.width,l.height=f.height;const a=l.getContext("2d");a.drawImage(f,0,0);const c=a.getImageData(0,0,l.width,l.height),i=[];for(let r=0,s=0;r<l.height;r++){i[r]=[];for(let o=0;o<l.width;o++,s+=4)i[r][o]=[c.data[s],c.data[s+1],c.data[s+2],c.data[s+3]]}t(i)}}});if(e instanceof HTMLImageElement||e instanceof HTMLVideoElement){const t=document.createElement("canvas");t.width=e.videoWidth||e.width,t.height=e.videoHeight||e.height;const n=t.getContext("2d");n.drawImage(e,0,0,t.width,t.height);const f=n.getImageData(0,0,t.width,t.height),l=[];for(let a=0,c=0;a<t.height;a++){l[a]=[];for(let i=0;i<t.width;i++,c+=4)l[a][i]=Array.from(f.data.slice(c,c+4))}return l}}_reduce(e,t,n="mean"){const f=[],l=e[0][0].length;let a=null;n==="max"?a=Math.max:n==="mean"&&(a=u((c,i)=>c+i,"f"));for(let c=0,i=0;c<e.length;c+=t,i++){f[i]=[];for(let r=0,s=0;r<e[c].length;r+=t,s++){const o=Array(l).fill(0);for(let h=0;h<t;h++)if(!(e.length<=c+h)){for(let g=0;g<t;g++)if(!(e[c].length<=r+g))for(let m=0;m<l;m++)o[m]=a(o[m],e[c+h][r+g][m])}f[i][s]=o,n==="mean"&&(f[i][s]=o.map(h=>h/(t*t)))}}return f}_convertSpace(e,t,n=!1,f=180){const[l,a,c,i]=e;if(t==="rgb")return n?[l/255,a/255,c/255]:[l,a,c];if(t==="8 colors"){const r=l>>7?255:0,s=a>>7?255:0,o=c>>7?255:0;return n?[r/255,s/255,o/255]:[r,s,o]}else if(t==="gray"){const r=d.grayScales.BT709.calc(l,a,c);return n?[r/255]:[r]}else if(t==="binary"){let r=d.grayScales.BT709.calc(l,a,c);return r=r<f?0:255,n?[r/255]:[r]}else if(t==="hls"){const r=Math.max(l,a,c),s=Math.min(l,a,c);let o=null;r!==s&&(s===c?o=60*(a-l)/(r-s)+60:s===l?o=60*(c-a)/(r-s)+180:s===a&&(o=60*(l-c)/(r-s)+300));const h=(r+s)/2,g=r-s;return n?[o/360,h/255,g/255]:[o,h,g]}else if(t==="hsv"){const r=Math.max(l,a,c),s=Math.min(l,a,c);let o=null;r!==s&&(s===c?o=60*(a-l)/(r-s)+60:s===l?o=60*(c-a)/(r-s)+180:s===a&&(o=60*(l-c)/(r-s)+300));const h=r,g=r-s;return n?[o/360,h/255,g/255]:[o,h,g]}}_applySpace(e,t,n=!1,f=180){const l=[];for(let a=0;a<e.length;a++){l[a]=[];for(let c=0;c<e[a].length;c++)l[a][c]=this._convertSpace(e[a][c],t,n,f)}return l}_createCanvas(e,t=80,n=null){const f=e[0].length,l=e.length;n||(n=Math.ceil(t*l/f));const a=document.createElement("canvas");a.width=f,a.height=l;const c=a.getContext("2d"),i=c.createImageData(a.width,a.height);for(let o=0,h=0;o<a.height;o++)for(let g=0;g<a.width;g++,h+=4)i.data[h]=e[o][g][0],e[o][g].length===1?(i.data[h+1]=e[o][g][0],i.data[h+2]=e[o][g][0],i.data[h+3]=255):e[o][g].length>=3&&(i.data[h+1]=e[o][g][1],i.data[h+2]=e[o][g][2],i.data[h+3]=e[o][g][3]||255);c.putImageData(i,0,0);const r=document.createElement("canvas");return r.width=t,r.height=n,r.getContext("2d").drawImage(a,0,0,a.width,a.height,0,0,t,n),r}}
