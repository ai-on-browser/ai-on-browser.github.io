import AudioData from"./audio.js";export default class MicrophoneData extends AudioData{constructor(t){super(t),this._size=[120,360];const e=this.setting.data.configElement;this._mngelm=document.createElement("div"),e.appendChild(this._mngelm);const i=document.createElement("input");i.type="button",i.value="Add data",i.onclick=()=>this.startAudio(),this._mngelm.appendChild(i),this._slctImg=document.createElement("select"),this._slctImg.onchange=()=>{this.selectAudio()},this._mngelm.appendChild(this._slctImg),this._audio=document.createElement("audio"),this._audio.controls=!0,this._mngelm.appendChild(this._audio),this._mngelm.appendChild(document.createTextNode("Sampling Rate: ")),this._slctRate=document.createElement("select"),this._slctRate.onchange=()=>{this._manager.platform.render()},this._mngelm.appendChild(this._slctRate),this._audioElm=document.createElement("div"),e.appendChild(this._audioElm),this.startAudio(),this._x=[],this._y=[],this._audioDatas=[]}get availTask(){return["SM"]}get domain(){return[[-1,1]]}get x(){const t=this.selectedIndex;if(0===this._x.length||!this._x[t])return[];const e=+this._slctRate.value,i=[];for(let a=0;a<this._x[t].length;a+=e)i.push([this._x[t][a]]);return i}get selectedIndex(){return+this._slctImg.value-1}selectAudio(){const t=this._audioDatas[this.selectedIndex];this._audio.src=URL.createObjectURL(t.blob),this._audio.title=`data_${this.selectedIndex+1}.webm`,this._slctRate.replaceChildren();let e=1;for(;Number.isInteger(t.buff.sampleRate/e);){const i=document.createElement("option");i.value=e,i.text=t.buff.sampleRate/e,this._slctRate.appendChild(i),e*=2}this._manager.platform.render()}startAudio(t){this._mngelm.style.display="none",this._audioElm.appendChild(document.createTextNode("Click stop to use as data."));const e=new AudioContext;let i=null;const a=[],s=document.createElement("div");this._audioElm.appendChild(s);const n=document.createElement("select");n.onchange=()=>{this.stopAudio(),this.startAudio(n.value)},s.appendChild(n);const o=document.createElement("input");o.type="button",o.value="Record",o.onclick=()=>{if(i)return i.stop(),void(i=null);this._audioStream&&(o.value="Stop",i=new MediaRecorder(this._audioStream,{mimeType:"audio/webm"}),i.addEventListener("dataavailable",(t=>{t.data.size>0&&a.push(t.data)})),i.addEventListener("stop",(t=>{const e=new Blob(a);this.readAudio(e).then((t=>{this._x.push(Array.from(t.getChannelData(0))),this._y.push(0),this._audioDatas.push({blob:e,buff:t});const i=document.createElement("option");i.value=this._x.length,i.innerText=this._x.length,this._slctImg.appendChild(i),this._slctImg.value=this._x.length,this.selectAudio()})),this.stopAudio(),this._mngelm.style.display=null})),i.start())},this._audioElm.appendChild(o),navigator.mediaDevices.getUserMedia({audio:{deviceId:t}}).then((t=>{this._audioStream=t,navigator.mediaDevices.enumerateDevices().then((e=>{for(const t of e.filter((t=>"audioinput"===t.kind))){const e=document.createElement("option");e.value=t.deviceId,e.innerText=t.label,n.appendChild(e)}t.getTracks().forEach((t=>{n.value=t.getSettings().deviceId}))}));const i=e.createAnalyser();e.createMediaStreamSource(t).connect(i),i.fftSize=2048;let a=this._audioElm.querySelector("canvas");a||(a=document.createElement("canvas"),a.style.border="1px solid black",this._audioElm.appendChild(a)),a.width=this._size[1],a.height=this._size[0];const s=()=>{this._audioStream&&(this.drawFreq(i,a),setTimeout(s,10))};s()})).catch((t=>{console.error(t),this.stopAudio()}))}drawWave(t,e){const i=t.frequencyBinCount,a=new Uint8Array(i);t.getByteTimeDomainData(a);const s=e.getContext("2d");s.clearRect(0,0,e.width,e.height),s.lineWidth=2,s.strokeStyle="rgb(0, 0, 0)",s.beginPath();const n=1*e.width/i;let o=0;for(let t=0;t<i;t++){const i=a[t]/128*e.height/2;0===t?s.moveTo(o,i):s.lineTo(o,i),o+=n}s.lineTo(e.width,e.height/2),s.stroke()}drawFreq(t,e){const i=t.frequencyBinCount,a=new Uint8Array(i);t.getByteFrequencyData(a);const s=e.getContext("2d");s.clearRect(0,0,e.width,e.height),s.fillStyle="rgb(0, 0, 0)";const n=e.width/i*2.5;let o=0;for(let t=0;t<i;t++){const i=a[t]/2;s.fillStyle="rgb("+(i+100)+",50,50)",s.fillRect(o,e.height-i/2,n,i),o+=n+1}}stopAudio(){if(this._audioStream){const t=this._audioStream;t&&t.getTracks().forEach((t=>{t.stop()})),this._audioStream=null}this._audioElm.replaceChildren()}terminate(){super.terminate(),this.stopAudio()}}