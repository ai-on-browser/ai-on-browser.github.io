var f=Object.defineProperty;var m=(p,e)=>f(p,"name",{value:e,configurable:!0});import{BaseData as x}from"./base.js";import b from"./loader/audio.js";export default class v extends x{static{m(this,"MicrophoneData")}constructor(e){super(e),this._size=[120,360];const t=this.setting.data.configElement;this._mngelm=document.createElement("div"),t.appendChild(this._mngelm);const i=document.createElement("input");i.type="button",i.value="Add data",i.onclick=()=>this.startAudio(),this._mngelm.appendChild(i),this._slctImg=document.createElement("select"),this._slctImg.onchange=()=>{this.selectAudio()},this._mngelm.appendChild(this._slctImg),this._audio=document.createElement("audio"),this._audio.controls=!0,this._mngelm.appendChild(this._audio),this._slctRate=document.createElement("select"),this._slctRate.onchange=()=>{this._manager.platform.render()},this._mngelm.append("Sampling Rate: ",this._slctRate),this._audioElm=document.createElement("div"),t.appendChild(this._audioElm),this.startAudio(),this._x=[],this._y=[],this._audioDatas=[],this._domains=[]}get availTask(){return["SM"]}get dimension(){return 1}get domain(){const e=this.selectedIndex;if(this._domains[e])return this._domains[e];let t=0;for(let i=0;i<this._x[e].length;i++)t=Math.max(t,Math.abs(this._x[e][i]));return this._domains[e]=[[-t,t]]}get length(){const e=this.selectedIndex;if(this._x.length===0||!this._x[e])return 0;const t=+this._slctRate.value;return Math.ceil(this._x[e].length/t)}get x(){const e=this.selectedIndex;if(this._x.length===0||!this._x[e])return[];const t=+this._slctRate.value,i=[];for(let a=0;a<this._x[e].length;a+=t)i.push([this._x[e][a]]);return i}get selectedIndex(){return+this._slctImg.value-1}selectAudio(){const e=this._audioDatas[this.selectedIndex];this._audio.src=URL.createObjectURL(e.blob),this._audio.title=`data_${this.selectedIndex+1}.webm`,this._slctRate.replaceChildren();let t=1;for(;Number.isInteger(e.buff.sampleRate/t);){const i=document.createElement("option");i.value=t,i.text=e.buff.sampleRate/t,this._slctRate.appendChild(i),t*=2}this._manager.platform.render()}startAudio(e){this._mngelm.style.display="none",this._audioElm.append("Click stop to use as data.");const t=new AudioContext;let i=null;const a=[],n=document.createElement("div");this._audioElm.appendChild(n);const l=document.createElement("select");l.onchange=()=>{this.stopAudio(),this.startAudio(l.value)},n.appendChild(l);const o=document.createElement("input");o.type="button",o.value="Record",o.onclick=()=>{if(i){i.stop(),i=null;return}this._audioStream&&(o.value="Stop",i=new MediaRecorder(this._audioStream,{mimeType:"audio/webm"}),i.addEventListener("dataavailable",s=>{s.data.size>0&&a.push(s.data)}),i.addEventListener("stop",()=>{const s=new Blob(a);b.load(s).then(d=>{this._x.push(Array.from(d.getChannelData(0))),this._y.push(0),this._audioDatas.push({blob:s,buff:d});const h=document.createElement("option");h.value=h.innerText=this._x.length,this._slctImg.appendChild(h),this._slctImg.value=this._x.length,this.selectAudio()}),this.stopAudio(),this._mngelm.style.display=null}),i.start())},this._audioElm.appendChild(o),navigator.mediaDevices.getUserMedia({audio:{deviceId:e}}).then(s=>{this._audioStream=s,navigator.mediaDevices.enumerateDevices().then(g=>{for(const u of g.filter(c=>c.kind==="audioinput")){const c=document.createElement("option");c.value=u.deviceId,c.innerText=u.label,l.appendChild(c)}s.getTracks().forEach(u=>{l.value=u.getSettings().deviceId})});const d=t.createAnalyser();t.createMediaStreamSource(s).connect(d),d.fftSize=2048;let r=this._audioElm.querySelector("canvas");r||(r=document.createElement("canvas"),r.style.border="1px solid black",this._audioElm.appendChild(r)),r.width=this._size[1],r.height=this._size[0];const _=m(()=>{this._audioStream&&(this.drawFreq(d,r),setTimeout(_,10))},"loop");_()}).catch(s=>{console.error(s),this.stopAudio()})}drawWave(e,t){const i=e.frequencyBinCount,a=new Uint8Array(i);e.getByteTimeDomainData(a);const n=t.getContext("2d");n.clearRect(0,0,t.width,t.height),n.lineWidth=2,n.strokeStyle="rgb(0, 0, 0)",n.beginPath();const l=t.width*1/i;let o=0;for(let s=0;s<i;s++){const h=a[s]/128*t.height/2;s===0?n.moveTo(o,h):n.lineTo(o,h),o+=l}n.lineTo(t.width,t.height/2),n.stroke()}drawFreq(e,t){const i=e.frequencyBinCount,a=new Uint8Array(i);e.getByteFrequencyData(a);const n=t.getContext("2d");n.clearRect(0,0,t.width,t.height),n.fillStyle="rgb(0, 0, 0)";const l=t.width/i*2.5;let o=0;for(let s=0;s<i;s++){const d=a[s]/2;n.fillStyle=`rgb(${d+100},50,50)`,n.fillRect(o,t.height-d/2,l,d),o+=l+1}}stopAudio(){if(this._audioStream){const e=this._audioStream;e&&e.getTracks().forEach(t=>{t.stop()}),this._audioStream=null}this._audioElm.replaceChildren()}terminate(){super.terminate(),this.stopAudio()}}
