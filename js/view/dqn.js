var B=Object.defineProperty;var r=(e,s)=>B(e,"name",{value:s,configurable:!0});import E from"../neuralnetwork_builder.js";import Q from"../../lib/model/dqn.js";import C from"../controller.js";class f{static{r(this,"DQNCBAgent")}constructor(s,a,n,l,o,t){this._agent=new Q(s,a,n,l),t&&t()}set method(s){this._agent.method=s}terminate(){}get_score(){return this._agent.get_score()}get_action(s,a=.002){return this._agent.get_action(s,a)}update(s,a,n,l,o,t,d){return this._agent.update(s,a,n,l,o,t,d)}}export default function L(e){e.setting.ml.usage='Click "step" to update.';let s=20;e.type==="grid"&&(e.env._reward={step:-1,wall:-1,goal:1,fail:-1},e.env._max_step=3e3,s=Math.max(...e.env.size));const a=new E,n=new C(e),l=!1;let o=!1,t=null;e.reset(t);const d=r((i,c=!0)=>{if(!o){i&&i();return}const v=e.state(),_=t.get_action(v,Math.max(N.value,h.value*k.value)),{state:w,reward:S,done:b,invalid:T}=e.step(_);if(T){i&&i();return}const x=t.update(_,v,w,S,b,D.value,R.value);x!=null&&e.plotLoss(x);const z=r(()=>{(b||e.epoch%1e3===999)&&(h.value=h.value*k.value),i&&i(b)},"end_proc");c&&e.render(()=>t.get_score()),z()},"step"),m=r(i=>{if(!o){i&&i();return}e.reset(t),e.render(()=>t.get_score()),i&&i()},"reset");n.text(" Hidden Layers "),a.makeHtml(e.setting.ml.configElement,{optimizer:!0}),t=new f(e,s,a.layers,a.optimizer,l,()=>{o=!0,setTimeout(()=>{e.render(()=>t.get_score()),g.element.disabled=!1,p.element.disabled=!1},0)}),n.input.button("New agent").on("click",()=>{t.terminate(),t=new f(e,s,a.layers,a.optimizer,l,()=>{o=!0,m()}),h.value=1}),n.input.button("Reset").on("click",()=>m());const y=n.select(["DQN","DDQN"]).on("change",()=>{t.method=y.value}),N=n.input.number({label:"greedy rate = max(",min:0,max:1,step:.01,value:.01}),h=n.input.number({label:", ",min:0,max:1,step:.01,value:1}),k=n.input.number({label:" * ",min:0,max:1,step:.01,value:.995});n.text(") ");const D=n.input.number({label:" Learning rate ",min:0,max:100,step:.01,value:.001}),R=n.input.number({label:" Batch size ",min:1,max:100,value:10});n.input.button("Step").on("click",()=>d());let u=!1;const g=n.input.button("Epoch").on("click",()=>{u=!u,g.element.value=u?"Stop":"Epoch",p.element.disabled=u,u&&r(function i(){u?d(c=>{setTimeout(()=>c?m(i):i())}):setTimeout(()=>{e.render(()=>t.get_score()),g.element.value="Epoch"},0)},"loop")()});g.element.disabled=!0;const p=n.input.button("Skip").on("click",()=>{if(u=!u,p.element.value=u?"Stop":"Skip",g.element.disabled=u,u){let i=new Date().getTime();r(function c(){for(;u;){let v=!1;if(d(w=>{v=w,l&&(w?m(c):c())},!0),l)return;const _=new Date().getTime();if(v&&m(),_-i>200){i=_,setTimeout(c,0);return}}e.render(()=>t.get_score()),p.element.value="Skip"},"loop")()}});return p.element.disabled=!0,e.plotRewards(n.element),()=>{u=!1,t.terminate()}}r(L,"default");
