import NeuralNetworkBuilder from"../neuralnetwork_builder.js";import DQNAgent from"../../lib/model/dqn.js";import Controller from"../controller.js";class DQNCBAgent{constructor(e,t,n,l,a,i){this._agent=new DQNAgent(e,t,n,l),i&&i()}set method(e){this._agent.method=e}terminate(){}get_score(e){const t=this._agent.get_score();e&&e(t)}get_action(e,t=.002,n){const l=this._agent.get_action(e,t);n&&n(l)}update(e,t,n,l,a,i,o,r){const s=this._agent.update(e,t,n,l,a,i,o);r&&r(s)}}var dispDQN=function(e,t){let n=20;"grid"===t.type&&(t.env._reward={step:-1,wall:-1,goal:1,fail:-1},t.env._max_step=3e3,n=Math.max(...t.env.size));const l=new NeuralNetworkBuilder,a=new Controller(t),i=!1;let o=!1,r=null,s=t.reset(r);const u=e=>{"grid"===t.type?r.get_score((n=>{t.render((()=>n)),e&&e()})):(t.render(),e&&e())},m=(e,n=!0)=>{o?r.get_action(s,Math.max(d.value,g.value*v.value),(l=>{const{state:a,reward:i,done:o}=t.step(l,r);r.update(l,s,a,i,o,b.value,h.value,(l=>{null!=l&&t.plotLoss(l);const i=()=>{s=a,(o||t.epoch%1e3==999)&&(g.value=g.value*v.value),e&&e(o)};n?u(i):i()}))})):e&&e()},p=e=>{o?(s=t.reset(r),u((()=>{e&&e()}))):e&&e()};e.append("span").text(" Hidden Layers "),l.makeHtml(e,{optimizer:!0}),r=new DQNCBAgent(t,n,l.layers,l.optimizer,i,(()=>{o=!0,setTimeout((()=>{u((()=>{e.selectAll("input").property("disabled",!1)}))}),0)})),a.input.button("New agent").on("click",(()=>{r.terminate(),r=new DQNCBAgent(t,n,l.layers,l.optimizer,i,(()=>{o=!0,p()})),g.value=1})),a.input.button("Reset").on("click",(()=>p()));const c=a.select(["DQN","DDQN"]).on("change",(()=>{r.method=c.value})),d=a.input.number({label:"greedy rate = max(",min:0,max:1,step:.01,value:.01}),g=a.input.number({label:", ",min:0,max:1,step:.01,value:1}),v=a.input.number({label:" * ",min:0,max:1,step:.01,value:.995});a.text(") ");const b=a.input.number({label:" Learning rate ",min:0,max:100,step:.01,value:.001}),h=a.input.number({label:" Batch size ",min:1,max:100,value:10});a.input.button("Step").on("click",(()=>m()));let w=!1;const _=a.input.button("Epoch").on("click",(()=>{w=!w,_.element.value=w?"Stop":"Epoch",N.element.disabled=w,w&&function e(){w?m((t=>{setTimeout((()=>t?p(e):e()))})):setTimeout((()=>{u((()=>{_.element.value="Epoch"}))}),0)}()}));_.element.disabled=!0;const N=a.input.button("Skip").on("click",(()=>{if(w=!w,N.element.value=w?"Stop":"Skip",_.element.disabled=w,w){let e=(new Date).getTime();!function t(){for(;w;){let n=!1;m((e=>{n=e}),!0);const l=(new Date).getTime();if(n&&p(),l-e>200)return e=l,void setTimeout(t,0)}u((()=>{N.element.value="Skip"}))}()}}));return N.element.disabled=!0,t.plotRewards(e),()=>{w=!1,r.terminate()}};export default function(e){e.setting.ml.usage='Click "step" to update.',e.setting.terminate=dispDQN(e.setting.ml.configElement,e)}