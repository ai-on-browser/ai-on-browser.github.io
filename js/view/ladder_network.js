import Controller from"../controller.js";import{BaseWorker}from"../utils.js";class LadderNetworkWorker extends BaseWorker{constructor(){super("js/view/worker/ladder_network_worker.js",{type:"module"})}initialize(e,t,a,n){return this._postMessage({mode:"init",hidden_sizes:e,lambdas:t,activation:a,optimizer:n})}fit(e,t,a,n,i){return this._postMessage({mode:"fit",x:e,y:t,iteration:a,rate:n,batch:i})}predict(e){return this._postMessage({mode:"predict",x:e})}}export default function(e){e.setting.ml.usage='Click and add data point. Next, click "Initialize". Finally, click "Fit" button repeatedly.',e.setting.ml.reference={author:"H. Valpola",title:"From Neural PCA to Deep Unsupervised Learning",year:2015};const t=new Controller(e),a=new LadderNetworkWorker,n=[10];let i=0;t.text(" Hidden Layers ");const r=e.setting.ml.configElement.append("span"),l=()=>{r.selectAll("*").remove();for(let e=0;e<n.length;e++){const t=r.append("input").attr("type","number").attr("min",1).attr("max",100).attr("value",n[e]).on("change",(()=>{n[e]=+t.property("value")}))}n.length>0&&r.append("input").attr("type","button").attr("value","-").on("click",(()=>{n.pop(),l()}))};t.input.button("+").on("click",(()=>{n.push(10),l()})),l();const s=t.select({label:" Activation ",values:["sigmoid","tanh","relu","elu","leaky_relu","rrelu","prelu","gaussian","softplus","softsign","identity"]}),o=t.select({label:" Optimizer ",values:["sgd","adam","momentum","rmsprop"]}),u=t.stepLoopButtons().init((t=>{if(0===e.datas.length)return void t();const i=Array(n.length+2).fill(.001);a.initialize(n,i,s.value,o.value).then(t),e.init()})),p=t.select({label:" Iteration ",values:[1,10,100,1e3,1e4]}),d=t.input.number({label:" Learning rate ",min:0,max:100,step:.01,value:.001}),c=t.input.number({label:" Batch size ",min:1,max:1e3,value:1e3});u.step((async t=>{const n=e.datas.dimension,r=e.trainOutput.map((e=>e[0])),l=await a.fit(e.trainInput,r,+p.value,d.value,c.value);i=l.data.epoch,e.plotLoss({labeled:l.data.labeledLoss,unlabeled:l.data.unlabeledLoss});const s=(await a.predict(e.testInput(1===n?2:4))).data;e.testResult(s),t&&t()})).epoch((()=>i)),e.setting.ternimate=()=>{a.terminate()}}