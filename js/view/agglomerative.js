import{CompleteLinkageAgglomerativeClustering,SingleLinkageAgglomerativeClustering,GroupAverageAgglomerativeClustering,WardsAgglomerativeClustering,CentroidAgglomerativeClustering,WeightedAverageAgglomerativeClustering,MedianAgglomerativeClustering}from"../../lib/model/agglomerative.js";import Controller from"../controller.js";import{getCategoryColor,DataConvexHull}from"../utils.js";const argmin=function(e,t){return 0===e.length?-1:(e=t?e.map(t):e).indexOf(Math.min(...e))},argmax=function(e,t){return 0===e.length?-1:(e=t?e.map(t):e).indexOf(Math.max(...e))};var dispAgglomerative=function(e,t){const l=t.svg,n=d3.line().x((e=>e[0])).y((e=>e[1])),a=new Controller(t);let i=null,r=null,o=null;l.insert("g",":first-child").attr("class","grouping");const s=e=>{let a=[];const i=p.value;let o=1;const s=[];r.getClusters(i).forEach((l=>{if(l.size>1){let n=[];const i=[l];for(;i.length>0;){const t=i.pop();t.size>1?(t.line||(t.line=e(t.children[0],t.children[1])),n=n.concat(t.line)):t.children||(s[t.index]=o),t.children&&i.push(...t.children)}n=n.map((e=>({path:e.map((e=>t._renderer[0].toPoint(e))),color:getCategoryColor(o)}))),a=a.concat(n)}else s[l.index]=o;o+=l.size})),t.trainResult=s,l.selectAll(".grouping path").remove(),l.select(".grouping").selectAll("path").data(a).enter().append("path").attr("d",(e=>n(e.path))).attr("stroke",(e=>e.color))},g=function(){l.selectAll(".grouping polygon").remove();const e=p.value;let n=1;const a=[];r.getClusters(e).forEach((e=>{if(e.size>1){const i=[e];for(;i.length>0;){const e=i.pop();e.poly?e.poly.remove():e.children||(a[e.index]=n),e.children&&i.push(...e.children)}e.poly=new DataConvexHull(l.select(".grouping"),e.leafs.map((e=>t._renderer[0].points[e.index]))),e.poly.color=getCategoryColor(n)}else a[e.index]=n;n+=e.size})),t.trainResult=a};e.append("select").on("change",(function(){var e=d3.select(this);e.selectAll("option").filter((t=>t.value===e.property("value"))).each((e=>i=e.class)).each((e=>o=e.plot))})).selectAll("option").data([{value:"Complete Linkage",class:CompleteLinkageAgglomerativeClustering,plot:()=>{s(((e,t)=>{const l=e.leafs,n=t.leafs;let a=l.map((e=>[e,n[argmax(n,(t=>e.distances[t.index]))]])),i=a[argmax(a,(e=>e[0].distances[e[1].index]))];return[[i[0].point,i[1].point]]}))}},{value:"Single Linkage",class:SingleLinkageAgglomerativeClustering,plot:()=>{s(((e,t)=>{const l=e.leafs,n=t.leafs;let a=l.map((e=>[e,n[argmin(n,(t=>e.distances[t.index]))]])),i=a[argmin(a,(e=>e[0].distances[e[1].index]))];return[[i[0].point,i[1].point]]}))}},{value:"Group Average",class:GroupAverageAgglomerativeClustering,plot:()=>g()},{value:"Ward's",class:WardsAgglomerativeClustering,plot:()=>g()},{value:"Centroid",class:CentroidAgglomerativeClustering,plot:()=>g()},{value:"Weighted Average",class:WeightedAverageAgglomerativeClustering,plot:()=>g()},{value:"Median",class:MedianAgglomerativeClustering,plot:()=>g()}]).enter().append("option").attr("value",(e=>e.value)).text((e=>e.value)).each(((e,t)=>0===t&&(i=e.class))).each(((e,t)=>0===t&&(o=e.plot)));const c=a.select(["euclid","manhattan","chebyshev"]);a.input.button("Initialize").on("click",(()=>{i&&(r=new i(c.value),r.fit(t.trainInput),u.element.max=t.datas.length,u.element.value=10,u.element.disabled=!1,p.element.max=t.datas.length,p.element.value=10,p.element.disabled=!1,l.selectAll("path").remove(),l.selectAll(".grouping *").remove(),o())}));const u=a.input.number({label:"Cluster #",min:1,max:1,value:1,disabled:"disabled"}).on("change",(()=>{p.value=u.value,o()})),p=a.input.range({min:1,disabled:"disabled"}).on("change",(()=>{u.value=p.value,o()})).on("input",(()=>{u.value=p.value}))};export default function(e){e.setting.ml.usage='Click and add data point. Next, select distance type and click "Initialize". Finally, select cluster number.',dispAgglomerative(e.setting.ml.configElement,e),e.setting.terminate=()=>{d3.selectAll("svg .grouping").remove()}}