import Matrix from"../../lib/util/matrix.js";import stringToFunction from"../expression.js";const combination_repetition=(e,t)=>{const n=[],s=Array(t).fill(0);for(;s[s.length-1]<e;){n.push(s.concat());for(let t=s.length-1;t>=0;t--)if(s[t]++,s[t]<e){for(let e=t+1;e<s.length;e++)s[e]=s[t];break}}return n};export default class FunctionPreprocessor{constructor(e){this._manager=e,this._f=[],this.init()}get functions(){return this._f.map((e=>stringToFunction(e)))}init(){if(this._r)this._r.replaceChildren();else{const e=this._manager.setting.preprocess.configElement;this._r=document.createElement("div"),e.append(this._r)}const e=()=>{const e=this._manager.datas.dimension,a=n.value;if(this._f.length=0,t.querySelectorAll(".ls_params").forEach((e=>e.style.display="none")),"default"===a)for(let t=0;t<e;t++)this._f.push(`x[${t}]`);else if("polynomial"===a){s.style.display=null,this._f.push("1");const t=+o.value;if(t>=0)for(let n=0;n<=t;n++){const t=combination_repetition(e,n);for(const n of t){const t=Array(e).fill(0);for(const e of n)t[e]++;let s="",o="";for(let e=0;e<t.length;e++)1===t[e]?(s+=o+`x[${e}]`,o="*"):t[e]>1&&(s+=o+`x[${e}]^${t[e]}`,o="*");this._f.push(s)}}}r()},t=document.createElement("div");t.onchange=e,this._r.append(t);const n=document.createElement("select");for(const e of["default","polynomial"]){const t=document.createElement("option");t.value=t.innerText=e,n.append(t)}t.append("preset",n);const s=document.createElement("span");t.append(s),s.classList.add("ls_params"),s.style.display="none";const o=document.createElement("input");o.type="number",o.min=0,o.max=10,o.value=2,o.onchange=e,s.append(" p ",o);const a=this._manager.datas.dimension;for(let e=0;e<a;e++)this._f.push(`x[${e}]`);const i=document.createElement("span");this._r.append(i),i.classList.add("expr-list");const r=()=>{i.replaceChildren("f(x) =");for(let e=0;e<this._f.length;e++){const t=document.createElement("input");t.type="text",t.value=this._f[e]||="x[0] ^ 2",t.size=8,t.onchange=()=>this._f[e]=t.value;const n=document.createElement("span");n.classList.add("trash"),n.onclick=()=>{this._f.splice(e,1),r()};const s=document.createElement("span"),o=document.createElement("sub");o.innerText=e,s.append("a",o);const a=document.createElement("span");a.append(0===e?"":"+ ",s,"âˆ—",t,n),a.classList.add("expr"),i.append(a)}const e=document.createElement("input");e.type="button",e.value="+",e.onclick=()=>{this._f.push(null),r()},i.append(" ",e)};r()}apply(e){const t=e.length,n=this.functions,s=new Matrix(t,n.length);for(let o=0;o<t;o++)for(let t=0;t<n.length;t++)s.set(o,t,n[t]({x:e[o]}));return s.toArray()}terminate(){this._r?.remove()}}